

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_compute_predictand &mdash; wass2s 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">wass2s.was_download</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_compute_predictand</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_compute_predictand</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>

<div class="viewcode-block" id="WAS_compute_onset">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_onset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class that encapsulates methods for transforming precipitation data</span>
<span class="sd">    from different formats (CPT, CDT) and computing onset dates based on</span>
<span class="sd">    rainfall criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default class-level criteria dictionary</span>
    <span class="n">default_criteria</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-30&quot;</span><span class="p">},</span>       
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>         <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span><span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_compute_onset class with user-defined or default criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_criteria : dict, optional</span>
<span class="sd">            A dictionary containing zone-specific criteria. If not provided,</span>
<span class="sd">            the class will use the default criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">user_criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">default_criteria</span>

<div class="viewcode-block" id="WAS_compute_onset.adjust_duplicates">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.adjust_duplicates">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_duplicates</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If any values in the Series repeat, nudge them by a tiny increment</span>
<span class="sd">        so that all are unique (to avoid indexing collisions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span></div>


 
<div class="viewcode-block" id="WAS_compute_onset.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame with:</span>
<span class="sd">          - Row 0 = LON</span>
<span class="sd">          - Row 1 = LAT</span>
<span class="sd">          - Row 2 = ELEV</span>
<span class="sd">          - Rows 3+ = daily data (or any date) with &#39;ID&#39; column containing dates.</span>

<span class="sd">        Returns an xarray DataArray with coords = (T, Y, X), variable = &#39;Observation&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1) Extract metadata (first 3 rows) ---</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">])</span>

        <span class="c1"># --- 2) Extract actual data, rename ID -&gt; DATE ---</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long form</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

        <span class="c1"># Merge metadata back into the melted data</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure DATE is treated as a proper datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a complete date range from the first day of the first year to the last day of the last year in the data</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Create a DataFrame with all combinations of dates and stations</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge the complete date-station combinations with the final_df to ensure all dates are present</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing values in the VALUE column with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Remove invalid rainfall values before computing the mean</span>
        <span class="c1"># Calculate the annual rainfall by summing the values for each year and station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Calculate the mean annual rainfall for each station</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="c1"># Merge back into final_df</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Generate the zonename column based on the conditions for each station</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>



<div class="viewcode-block" id="WAS_compute_onset.day_of_year">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.day_of_year">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dem_rech1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a year &#39;i&#39; and a month-day string &#39;dem_rech1&#39; (e.g., &#39;07-23&#39;),</span>
<span class="sd">        return the day of the year (1-based).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">full_date_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dem_rech1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">full_date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">origin_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">day_of_year_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">-</span> <span class="n">origin_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">day_of_year_value</span></div>


<div class="viewcode-block" id="WAS_compute_onset.rainf_zone">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.rainf_zone">[docs]</a>
    <span class="k">def</span> <span class="nf">rainf_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">):</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">mask_4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
            <span class="o">&amp;</span>
            <span class="p">((</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)),</span>  
            <span class="mi">4</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
        <span class="n">mask_3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">),</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_0</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">mask_5</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_4</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_3</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_2</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_0</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="WAS_compute_onset.onset_function">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.onset_function">[docs]</a>
    <span class="k">def</span> <span class="nf">onset_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">cumul</span><span class="p">,</span> <span class="n">nbsec</span><span class="p">,</span> <span class="n">jour_pluvieux</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the onset date of a season based on cumulative rainfall criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall or similar values.</span>
<span class="sd">        idebut : int</span>
<span class="sd">            Start index to begin searching for the onset.</span>
<span class="sd">        cumul : float</span>
<span class="sd">            Cumulative rainfall threshold to trigger onset.</span>
<span class="sd">        nbsec : int</span>
<span class="sd">            Maximum number of dry days allowed in the sequence.</span>
<span class="sd">        jour_pluvieux : float</span>
<span class="sd">            Minimum rainfall to consider a day as rainy.</span>
<span class="sd">        irch_fin : int</span>
<span class="sd">            Maximum index limit for the onset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or float</span>
<span class="sd">            Index of the onset date or NaN if onset not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">idebut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span>
            <span class="n">nbsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span>
            <span class="n">irch_fin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span>

            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">idate</span> <span class="o">=</span> <span class="n">idebut</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">idate</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ipreced</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">isuiv</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># Check for missing data or out-of-bounds</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ipreced</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">idate</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">isuiv</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">])</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">])</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">])):</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">break</span>

                <span class="c1"># Check for end search of date</span>
                <span class="k">if</span> <span class="n">idate</span> <span class="o">&gt;</span> <span class="n">irch_fin</span><span class="p">:</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate cumulative rainfall over 1, 2, and 3 days</span>
                <span class="n">cumul3jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]</span>
                <span class="n">cumul2jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span>
                <span class="n">cumul1jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span>

                <span class="c1"># Check if any cumulative rainfall meets the threshold</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cumul1jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> 
                    <span class="n">cumul2jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> 
                    <span class="n">cumul3jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span><span class="p">):</span>
                    <span class="n">troisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]])</span>
                    <span class="n">itroisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ipreced</span><span class="p">,</span> <span class="n">idate</span><span class="p">,</span> <span class="n">isuiv</span><span class="p">])</span>
                    <span class="n">maxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">troisp</span><span class="p">)</span>
                    <span class="n">imaxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">troisp</span> <span class="o">==</span> <span class="n">maxp</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ideb</span> <span class="o">=</span> <span class="n">itroisp</span><span class="p">[</span><span class="n">imaxp</span><span class="p">]</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">ideb</span>
                    <span class="n">trouv</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># Check for sequences of dry days within the next 30 days</span>
                    <span class="n">finp</span> <span class="o">=</span> <span class="n">ideb</span> <span class="o">+</span> <span class="mi">30</span>
                    <span class="n">pluie30jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:</span><span class="n">finp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">finp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:]</span>
                    <span class="n">isec</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">isec</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">isecf</span> <span class="o">=</span> <span class="n">isec</span> <span class="o">+</span> <span class="n">nbsec</span>
                        <span class="k">if</span> <span class="n">isecf</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pluie30jr</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="n">donneeverif</span> <span class="o">=</span> <span class="n">pluie30jr</span><span class="p">[</span><span class="n">isec</span><span class="p">:</span><span class="n">isecf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># Count days with rainfall below jour_pluvieux</span>
                        <span class="n">test1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">donneeverif</span> <span class="o">&lt;</span> <span class="n">jour_pluvieux</span><span class="p">)</span>

                        <span class="c1"># If a dry sequence is found, reset trouv to 0</span>
                        <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="c1"># Break if a dry sequence is found or we&#39;ve reached the end of the window</span>
                        <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isec</span> <span class="o">==</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">nbsec</span><span class="p">):</span>
                            <span class="k">break</span>

                <span class="c1"># Break if onset is found</span>
                <span class="k">if</span> <span class="n">trouv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">deb_saison</span></div>


    
<div class="viewcode-block" id="WAS_compute_onset.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_df</span><span class="p">,):</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="n">unique_stations</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
                <span class="c1"># Filter data for the current station and year</span>
                <span class="n">station_data</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)]</span>
                <span class="c1"># Replace missing values with NaN</span>
                <span class="n">station_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="c1"># Extract unique zonenames</span>
                <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="c1"># Extract the onset criteria for the current zonename</span>
                <span class="n">idebut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;start_search&quot;</span><span class="p">])</span>
                <span class="n">irch_fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;end_search&quot;</span><span class="p">])</span>
                <span class="n">cumul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">]</span>
                <span class="n">nbsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">]</span>
                <span class="n">jour_pluvieux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">]</span>
                <span class="c1"># Compute the onset date</span>
                <span class="n">onset_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onset_function</span><span class="p">(</span><span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">cumul</span><span class="p">,</span> <span class="n">nbsec</span><span class="p">,</span> <span class="n">jour_pluvieux</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;onset&quot;</span><span class="p">:</span> <span class="n">onset_date</span>
                <span class="p">})</span>
        <span class="c1"># Convert results to a DataFrame</span>
        <span class="n">onset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">onset_df</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>

        <span class="c1"># transform the onset_df to the CPT format</span>
        <span class="c1"># Extract unique stations and their corresponding lat/lon</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">onset_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Pivot df_yyy to match the wide format (years as rows, stations as columns)</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">onset_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;onset&quot;</span><span class="p">)</span>

        <span class="c1"># Extract latitude and longitude values based on station order in pivoted DataFrame</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Reset index to ensure correct structure</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename the &quot;year&quot; column to &quot;STATION&quot; to match the required format</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Concatenate latitude, longitude, and pivoted onset values to form the final structure</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>



<div class="viewcode-block" id="WAS_compute_onset.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">,</span> <span class="n">nb_cores</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute onset dates for each pixel in a given daily rainfall DataArray</span>
<span class="sd">        using different criteria based on isohyet zones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Array with onset dates computed per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # Load zone file &amp; slice it</span>
        <span class="c1"># mask_char = xr.open_dataset(&#39;./utilities/Isohyet_zones.nc&#39;)</span>
        <span class="c1"># mask_char = mask_char.sel(X=slice(extent[1], extent[3]),</span>
        <span class="c1">#                           Y=slice(extent[0], extent[2]))</span>
        <span class="c1"># mask_char = mask_char.isel(Y=slice(None, None, -1)).to_array().drop_vars(&#39;variable&#39;).squeeze()</span>

        <span class="c1"># daily_data = daily_data.sel(</span>
        <span class="c1">#     X=mask_char.coords[&#39;X&#39;],</span>
        <span class="c1">#     Y=mask_char.coords[&#39;Y&#39;])</span>

        <span class="c1"># mask_ = xr.where(daily_data.resample(T=&quot;YE&quot;).sum(skipna=True).mean(dim=&#39;T&#39;) &lt; 75, np.nan, 1)</span>
        
        <span class="n">mask_char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rainf_zone</span><span class="p">(</span><span class="n">daily_data</span><span class="p">)</span>
        <span class="c1"># Get unique zone IDs</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_char</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">unique_zone</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">)]</span>

        <span class="c1"># Compute year range and partial T dimension (start_search)</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># Choose a date to store results</span>
        <span class="k">if</span> <span class="n">unique_zone</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid zones found in the mask.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use zone in low latitude</span>
            <span class="n">zone_id_to_use</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">))</span>
        
        <span class="n">T_from_here</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">zone_id_to_use</span><span class="p">][</span><span class="s1">&#39;start_search&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">])</span>

        <span class="c1"># Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># Initialize placeholders</span>
        <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">mask_char</span>

        <span class="n">store_onset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unique_zone</span><span class="p">:</span>
                <span class="c1"># Replace zone values with numeric parameters</span>
                <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_start_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;start_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_start_search</span>
                <span class="p">)</span>
                <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_cumulative</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_cumulative</span>
                <span class="p">)</span>
                <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_number_dry_days</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_number_dry_days</span>
                <span class="p">)</span>
                <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_thrd_rain_day</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_thrd_rain_day</span>
                <span class="p">)</span>
                <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_end_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;end_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_end_search</span>
                <span class="p">)</span>

            <span class="c1"># Select data for this particular year</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># Set up parallel processing</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">onset_function</span><span class="p">,</span>  <span class="c1"># &lt;-- Now calling via self</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_start_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_cumulative</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_number_dry_days</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_thrd_rain_day</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_end_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_onset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># Concatenate final result</span>
        <span class="n">store_onset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_onset</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_onset</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_from_here</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">store_onset</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Onset&quot;</span>

        <span class="k">return</span> <span class="n">store_onset</span><span class="c1">#.to_array().drop_vars(&#39;variable&#39;).squeeze(&#39;variable&#39;)</span></div>
</div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_onset_dry_spell</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for computing the longest dry spell length </span>
<span class="sd">    after the onset of a rainy season, based on user-defined criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default class-level criteria dictionary</span>
    <span class="n">default_criteria</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-30&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">},</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>         <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span><span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span>
    <span class="p">}</span>

    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_compute_dry_spell class with user-defined or default criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_criteria : dict, optional</span>
<span class="sd">            A dictionary containing zone-specific criteria. If not provided,</span>
<span class="sd">            the class will use the default criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">user_criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">WAS_compute_onset_dry_spell</span><span class="o">.</span><span class="n">default_criteria</span>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.adjust_duplicates">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.adjust_duplicates">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_duplicates</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If any values in the Series repeat, nudge them by a tiny increment</span>
<span class="sd">        so that all are unique (to avoid indexing collisions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame with:</span>
<span class="sd">          - Row 0 = LON</span>
<span class="sd">          - Row 1 = LAT</span>
<span class="sd">          - Row 2 = ELEV</span>
<span class="sd">          - Rows 3+ = daily data (or any date) with &#39;ID&#39; column containing dates.</span>

<span class="sd">        Returns an xarray DataArray with coords = (T, Y, X), variable = &#39;Observation&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1) Extract metadata (first 3 rows) ---</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">])</span>

        <span class="c1"># --- 2) Extract actual data, rename ID -&gt; DATE ---</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long form</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

        <span class="c1"># Merge metadata back into the melted data</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure DATE is treated as a proper datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a complete date range from the first day of the first year to the last day of the last year in the data</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Create a DataFrame with all combinations of dates and stations</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge the complete date-station combinations with the final_df to ensure all dates are present</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing values in the VALUE column with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Remove invalid rainfall values before computing the mean</span>
        <span class="c1"># Calculate the annual rainfall by summing the values for each year and station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Calculate the mean annual rainfall for each station</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="c1"># Merge back into final_df</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Generate the zonename column based on the conditions for each station</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.rainf_zone">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.rainf_zone">[docs]</a>
    <span class="k">def</span> <span class="nf">rainf_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">):</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">mask_4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
            <span class="o">&amp;</span>
            <span class="p">((</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)),</span>  
            <span class="mi">4</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
        <span class="n">mask_3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">),</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_0</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="c1"># Fill NaN values with the next available value</span>
        <span class="k">return</span> <span class="n">mask_5</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_4</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_3</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_2</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_0</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.dry_spell_onset_function">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.dry_spell_onset_function">[docs]</a>
    <span class="k">def</span> <span class="nf">dry_spell_onset_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">cumul</span><span class="p">,</span> <span class="n">nbsec</span><span class="p">,</span> <span class="n">jour_pluvieux</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">,</span> <span class="n">nbjour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the onset date of a season based on cumulative rainfall criteria, and</span>
<span class="sd">        determine the longest dry spell sequence within a specified period after the onset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># &lt;-- Always defined</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbjour</span><span class="p">))</span>
    
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">idebut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span>
            <span class="n">nbsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span>
            <span class="n">irch_fin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span>
            <span class="n">nbjour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbjour</span><span class="p">)</span>
            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">idate</span> <span class="o">=</span> <span class="n">idebut</span>
            <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># &lt;--- Initialize here too</span>
    
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">idate</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ipreced</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">isuiv</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">+</span> <span class="mi">1</span>
    
                <span class="k">if</span> <span class="p">(</span><span class="n">ipreced</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">idate</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isuiv</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">])</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">])):</span>
                    <span class="k">break</span>
    
                <span class="k">if</span> <span class="n">idate</span> <span class="o">&gt;</span> <span class="n">irch_fin</span><span class="p">:</span>
                    <span class="c1"># deb_saison = random.randint(max(idebut, irch_fin - 5), irch_fin)</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span>
                    <span class="k">break</span>
    
                <span class="n">cumul3jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]</span>
                <span class="n">cumul2jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span>
                <span class="n">cumul1jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span>
    
                <span class="k">if</span> <span class="p">(</span><span class="n">cumul1jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> <span class="n">cumul2jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> <span class="n">cumul3jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span><span class="p">):</span>
                    <span class="n">troisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]])</span>
                    <span class="n">itroisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ipreced</span><span class="p">,</span> <span class="n">idate</span><span class="p">,</span> <span class="n">isuiv</span><span class="p">])</span>
                    <span class="n">maxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">troisp</span><span class="p">)</span>
                    <span class="n">imaxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">troisp</span> <span class="o">==</span> <span class="n">maxp</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ideb</span> <span class="o">=</span> <span class="n">itroisp</span><span class="p">[</span><span class="n">imaxp</span><span class="p">]</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">ideb</span>
                    <span class="n">trouv</span> <span class="o">=</span> <span class="mi">1</span>
    
                    <span class="n">finp</span> <span class="o">=</span> <span class="n">ideb</span> <span class="o">+</span> <span class="mi">30</span>
                    <span class="n">pluie30jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:</span><span class="n">finp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">finp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:]</span>
                    <span class="n">isec</span> <span class="o">=</span> <span class="mi">0</span>
    
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">isec</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">isecf</span> <span class="o">=</span> <span class="n">isec</span> <span class="o">+</span> <span class="n">nbsec</span>
                        <span class="k">if</span> <span class="n">isecf</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pluie30jr</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="n">donneeverif</span> <span class="o">=</span> <span class="n">pluie30jr</span><span class="p">[</span><span class="n">isec</span><span class="p">:</span><span class="n">isecf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">test1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">donneeverif</span> <span class="o">&lt;</span> <span class="n">jour_pluvieux</span><span class="p">)</span>
    
                        <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">break</span>
    
                        <span class="k">if</span> <span class="n">isec</span> <span class="o">==</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">nbsec</span><span class="p">):</span>
                            <span class="k">break</span>
    
                <span class="k">if</span> <span class="n">trouv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">):</span>
                <span class="n">pluie_nbjour</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">)</span> <span class="o">+</span> <span class="n">nbjour</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
                <span class="n">rainy_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pluie_nbjour</span> <span class="o">&gt;</span> <span class="n">jour_pluvieux</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">))</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pluie_nbjour</span><span class="p">)])</span>
                <span class="n">seq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
        <span class="k">return</span> <span class="n">seq_max</span></div>

    
    
<div class="viewcode-block" id="WAS_compute_onset_dry_spell.dry_spell_onset_function_">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.dry_spell_onset_function_">[docs]</a>
    <span class="k">def</span> <span class="nf">dry_spell_onset_function_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">cumul</span><span class="p">,</span> <span class="n">nbsec</span><span class="p">,</span> <span class="n">jour_pluvieux</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">,</span> <span class="n">nbjour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the onset date of a season based on cumulative rainfall criteria, and</span>
<span class="sd">        determine the longest dry spell sequence within a specified period after the onset.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall or similar values.</span>
<span class="sd">        idebut : int</span>
<span class="sd">            Start index to begin searching for the onset.</span>
<span class="sd">        cumul : float</span>
<span class="sd">            Cumulative rainfall threshold to trigger onset.</span>
<span class="sd">        nbsec : int</span>
<span class="sd">            Maximum number of dry days allowed in the sequence.</span>
<span class="sd">        jour_pluvieux : float</span>
<span class="sd">            Minimum rainfall to consider a day as rainy.</span>
<span class="sd">        irch_fin : int</span>
<span class="sd">            Maximum index limit for the onset.</span>
<span class="sd">        nbjour : int</span>
<span class="sd">            Number of days to check for the longest dry spell after onset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Length of the longest dry spell sequence after onset or NaN if onset not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure all input values are valid</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span> <span class="ow">and</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbjour</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">idebut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span>
            <span class="n">nbsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span>
            <span class="n">irch_fin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span>
            <span class="n">nbjour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbjour</span><span class="p">)</span>
            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">idate</span> <span class="o">=</span> <span class="n">idebut</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">idate</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ipreced</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">isuiv</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># Check for missing data or out-of-bounds</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ipreced</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">idate</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">isuiv</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">])</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">])</span> <span class="ow">or</span> 
                    <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">])):</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">break</span>

                <span class="c1"># Check for end search of date</span>
                <span class="k">if</span> <span class="n">idate</span> <span class="o">&gt;</span> <span class="n">irch_fin</span><span class="p">:</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># Calculate cumulative rainfall over 1, 2, and 3 days</span>
                <span class="n">cumul3jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]</span>
                <span class="n">cumul2jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span>
                <span class="n">cumul1jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span>

                <span class="c1"># Check if any cumulative rainfall meets the threshold</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cumul1jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> 
                    <span class="n">cumul2jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> 
                    <span class="n">cumul3jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span><span class="p">):</span>
                    <span class="n">troisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]])</span>
                    <span class="n">itroisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ipreced</span><span class="p">,</span> <span class="n">idate</span><span class="p">,</span> <span class="n">isuiv</span><span class="p">])</span>
                    <span class="n">maxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">troisp</span><span class="p">)</span>
                    <span class="n">imaxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">troisp</span> <span class="o">==</span> <span class="n">maxp</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ideb</span> <span class="o">=</span> <span class="n">itroisp</span><span class="p">[</span><span class="n">imaxp</span><span class="p">]</span>
                    <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">ideb</span>
                    <span class="n">trouv</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># Check for sequences of dry days within the next 30 days</span>
                    <span class="n">finp</span> <span class="o">=</span> <span class="n">ideb</span> <span class="o">+</span> <span class="mi">30</span>
                    <span class="n">pluie30jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:</span><span class="n">finp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">finp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:]</span>
                    <span class="n">isec</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">isec</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">isecf</span> <span class="o">=</span> <span class="n">isec</span> <span class="o">+</span> <span class="n">nbsec</span>
                        <span class="k">if</span> <span class="n">isecf</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pluie30jr</span><span class="p">):</span>
                            <span class="k">break</span>
                        <span class="n">donneeverif</span> <span class="o">=</span> <span class="n">pluie30jr</span><span class="p">[</span><span class="n">isec</span><span class="p">:</span><span class="n">isecf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># Count days with rainfall below jour_pluvieux</span>
                        <span class="n">test1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">donneeverif</span> <span class="o">&lt;</span> <span class="n">jour_pluvieux</span><span class="p">)</span>

                        <span class="c1"># If a dry sequence is found, reset trouv to 0</span>
                        <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="c1"># Break if a dry sequence is found or we&#39;ve reached the end of the window</span>
                        <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isec</span> <span class="o">==</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">nbsec</span><span class="p">):</span>
                            <span class="k">break</span>

                <span class="c1"># Break if onset is found</span>
                <span class="k">if</span> <span class="n">trouv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># Compute the longest dry spell within `nbjour` days after the onset</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">):</span>
                <span class="n">pluie_nbjour</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">)</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">)</span> <span class="o">+</span> <span class="n">nbjour</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
                <span class="n">rainy_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pluie_nbjour</span> <span class="o">&gt;</span> <span class="n">jour_pluvieux</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Build two arrays to measure intervals between rainy days</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">))</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pluie_nbjour</span><span class="p">)])</span>
                <span class="n">seq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># -1 so that the difference is the gap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">seq_max</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.day_of_year">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.day_of_year">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dem_rech1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a year &#39;i&#39; and a month-day string &#39;dem_rech1&#39; (e.g., &#39;07-23&#39;),</span>
<span class="sd">        return the 1-based day of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">full_date_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dem_rech1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">full_date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">origin_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">day_of_year_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">-</span> <span class="n">origin_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">day_of_year_value</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_df</span><span class="p">,):</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="n">unique_stations</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
                <span class="c1"># Filter data for the current station and year</span>
                <span class="n">station_data</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)]</span>
                <span class="c1"># Replace missing values with NaN</span>
                <span class="n">station_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="c1"># Extract unique zonenames</span>
                <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="c1"># x, idebut, cumul, nbsec, jour_pluvieux, irch_fin, nbjour</span>
                <span class="c1"># Extract the onset criteria for the current zonename</span>
                <span class="n">idebut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;start_search&quot;</span><span class="p">])</span>
                <span class="n">irch_fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;end_search&quot;</span><span class="p">])</span>
                <span class="n">cumul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">]</span>
                <span class="n">nbsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">]</span>
                <span class="n">jour_pluvieux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">]</span>
                <span class="n">nbjour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nbjour&quot;</span><span class="p">]</span>
                <span class="c1"># Compute the onset date</span>
                <span class="n">onset_dryspell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_spell_onset_function</span><span class="p">(</span><span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">cumul</span><span class="p">,</span> <span class="n">nbsec</span><span class="p">,</span> <span class="n">jour_pluvieux</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">,</span> <span class="n">nbjour</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;onsetdryspell&quot;</span><span class="p">:</span> <span class="n">onset_dryspell</span>
                <span class="p">})</span>
        <span class="c1"># Convert results to a DataFrame</span>
        <span class="n">onset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">onset_df</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;onsetdryspell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;onsetdryspell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
 
        <span class="c1"># transform the onset_df to the CPT format</span>
        <span class="c1"># Extract unique stations and their corresponding lat/lon</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">onset_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Pivot df_yyy to match the wide format (years as rows, stations as columns)</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">onset_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;onsetdryspell&quot;</span><span class="p">)</span>

        <span class="c1"># Extract latitude and longitude values based on station order in pivoted DataFrame</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Reset index to ensure correct structure</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename the &quot;year&quot; column to &quot;STATION&quot; to match the required format</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Concatenate latitude, longitude, and pivoted onset values to form the final structure</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="WAS_compute_onset_dry_spell.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_onset_dry_spell.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">,</span> <span class="n">nb_cores</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the longest dry spell length after the onset for each pixel in a</span>
<span class="sd">        given daily rainfall DataArray, using different criteria based on isohyet zones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Array with the longest dry spell length per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # Load zone file &amp; slice it to the area of interest</span>
        <span class="c1"># mask_char = xr.open_dataset(&#39;./utilities/Isohyet_zones.nc&#39;)</span>
        <span class="c1"># mask_char = mask_char.sel(X=slice(extent[1], extent[3]),</span>
        <span class="c1">#                           Y=slice(extent[0], extent[2]))</span>
        
        <span class="c1"># # Flip Y if needed</span>
        <span class="c1"># mask_char = mask_char.isel(Y=slice(None, None, -1)).to_array().drop_vars(&#39;variable&#39;).squeeze()</span>
        
        <span class="c1"># daily_data = daily_data.sel(</span>
        <span class="c1">#     X=mask_char.coords[&#39;X&#39;],</span>
        <span class="c1">#     Y=mask_char.coords[&#39;Y&#39;])</span>

        <span class="n">mask_char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rainf_zone</span><span class="p">(</span><span class="n">daily_data</span><span class="p">)</span>

        <span class="c1"># Get unique zone IDs</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_char</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">unique_zone</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">)]</span>

        <span class="c1"># Compute year range</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># Create T dimension for the earliest (or any) zone&#39;s start date as reference</span>
        <span class="n">zone_id_to_use</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">))</span>  <span class="c1"># or some logic of your choosing</span>
        <span class="n">T_from_here</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">zone_id_to_use</span><span class="p">][</span><span class="s1">&#39;start_search&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">])</span>

        <span class="c1"># Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># Initialize placeholders</span>
        <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">mask_char_nbjour</span> <span class="o">=</span> <span class="n">mask_char</span>

        <span class="n">store_dry_spell</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unique_zone</span><span class="p">:</span>
                <span class="c1"># Replace zone values with numeric parameters</span>
                <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_start_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;start_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_start_search</span>
                <span class="p">)</span>
                <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_cumulative</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_cumulative</span>
                <span class="p">)</span>
                <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_number_dry_days</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_number_dry_days</span>
                <span class="p">)</span>
                <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_thrd_rain_day</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_thrd_rain_day</span>
                <span class="p">)</span>
                <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_end_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;end_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_end_search</span>
                <span class="p">)</span>
                <span class="n">mask_char_nbjour</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_nbjour</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;nbjour&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_nbjour</span>
                <span class="p">)</span>
            <span class="c1"># Select data for this particular year</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># Parallel processing</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dry_spell_onset_function</span><span class="p">,</span>  <span class="c1"># &lt;-- Call our instance method</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_start_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_cumulative</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_number_dry_days</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_thrd_rain_day</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_end_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_nbjour</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_dry_spell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># Concatenate final result</span>
        <span class="n">store_dry_spell</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_dry_spell</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_dry_spell</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_from_here</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">store_dry_spell</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Onset_dryspell&quot;</span>

        <span class="k">return</span> <span class="n">store_dry_spell</span><span class="c1">#.to_array().drop_vars(&#39;variable&#39;).squeeze(&#39;variable&#39;)</span></div>
</div>


<div class="viewcode-block" id="WAS_compute_cessation">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_cessation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute cessation dates based on soil moisture balance for different</span>
<span class="sd">    regions and criteria, leveraging parallel computation for efficiency.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default class-level criteria dictionary</span>
    <span class="n">default_criteria</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-30&quot;</span><span class="p">},</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span><span class="p">,</span> <span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-10&quot;</span><span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-15&quot;</span><span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-30&quot;</span><span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-15&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;12-01&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_compute_cessation class with user-defined or default criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_criteria : dict, optional</span>
<span class="sd">            A dictionary containing zone-specific criteria. If not provided,</span>
<span class="sd">            the class will use the default criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">user_criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">WAS_compute_cessation</span><span class="o">.</span><span class="n">default_criteria</span>

<div class="viewcode-block" id="WAS_compute_cessation.adjust_duplicates">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.adjust_duplicates">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_duplicates</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If any values in the Series repeat, nudge them by a tiny increment</span>
<span class="sd">        so that all are unique (to avoid indexing collisions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span></div>

    
<div class="viewcode-block" id="WAS_compute_cessation.day_of_year">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.day_of_year">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dem_rech1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a year &#39;i&#39; and a month-day string &#39;dem_rech1&#39; (e.g., &#39;07-23&#39;),</span>
<span class="sd">        return the 1-based day of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">full_date_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dem_rech1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">full_date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">origin_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">day_of_year_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">-</span> <span class="n">origin_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">day_of_year_value</span></div>


<div class="viewcode-block" id="WAS_compute_cessation.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame with:</span>
<span class="sd">          - Row 0 = LON</span>
<span class="sd">          - Row 1 = LAT</span>
<span class="sd">          - Row 2 = ELEV</span>
<span class="sd">          - Rows 3+ = daily data (or any date) with &#39;ID&#39; column containing dates.</span>

<span class="sd">        Returns an xarray DataArray with coords = (T, Y, X), variable = &#39;Observation&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1) Extract metadata (first 3 rows) ---</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_onset</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">])</span>

        <span class="c1"># --- 2) Extract actual data, rename ID -&gt; DATE ---</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long form</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

        <span class="c1"># Merge metadata back into the melted data</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure DATE is treated as a proper datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a complete date range from the first day of the first year to the last day of the last year in the data</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Create a DataFrame with all combinations of dates and stations</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge the complete date-station combinations with the final_df to ensure all dates are present</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing values in the VALUE column with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Remove invalid rainfall values before computing the mean</span>
        <span class="c1"># Calculate the annual rainfall by summing the values for each year and station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Calculate the mean annual rainfall for each station</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="c1"># Merge back into final_df</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Generate the zonename column based on the conditions for each station</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>           
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>



<div class="viewcode-block" id="WAS_compute_cessation.cessation_function">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.cessation_function">[docs]</a>
    <span class="k">def</span> <span class="nf">cessation_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ijour_dem_cal</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">ETP</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute cessation date using soil moisture balance criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ETP</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Cap_ret_maxi</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">idebut</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut</span><span class="p">)</span>
        <span class="n">ijour_dem_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">)</span>
        <span class="n">irch_fin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin</span><span class="p">)</span>
        <span class="n">ru</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">,</span> <span class="n">idebut</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">ru</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETP</span>
            <span class="n">ru</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">))</span>

        <span class="n">ifin_saison</span> <span class="o">=</span> <span class="n">idebut</span>
        <span class="k">while</span> <span class="n">ifin_saison</span> <span class="o">&lt;</span> <span class="n">irch_fin</span><span class="p">:</span>
            <span class="n">ifin_saison</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ifin_saison</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">ru</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">ifin_saison</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETP</span>
            <span class="n">ru</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ru</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">ifin_saison</span> <span class="k">if</span> <span class="n">ifin_saison</span> <span class="o">&lt;=</span> <span class="n">irch_fin</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_compute_cessation.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_df</span><span class="p">):</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="n">unique_stations</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
                <span class="c1"># Filter data for the current station and year</span>
                <span class="n">station_data</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)]</span>
                <span class="c1"># Replace missing values with NaN</span>
                <span class="n">station_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="c1"># Extract unique zonenames</span>
                <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="c1"># Extract the onset criteria for the current zonename</span>
                <span class="n">ijour_dem_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;date_dry_soil&quot;</span><span class="p">])</span>
                <span class="n">idebut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;start_search&quot;</span><span class="p">])</span>
                <span class="n">irch_fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;end_search&quot;</span><span class="p">])</span>
                <span class="n">ETP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;ETP&quot;</span><span class="p">]</span>
                <span class="n">Cap_ret_maxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">]</span>
                
                <span class="c1"># Compute the onset date</span>
                <span class="n">cessation_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cessation_function</span><span class="p">(</span><span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ijour_dem_cal</span><span class="p">,</span> <span class="n">idebut</span><span class="p">,</span> <span class="n">ETP</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">,</span> <span class="n">irch_fin</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;cessation&quot;</span><span class="p">:</span> <span class="n">cessation_date</span>
                <span class="p">})</span>
        <span class="c1"># Convert results to a DataFrame</span>
        <span class="n">cessation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">cessation_df</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;cessation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;cessation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>

        <span class="c1"># transform the onset_df to the CPT format</span>
        <span class="c1"># Extract unique stations and their corresponding lat/lon</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">cessation_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Pivot df_yyy to match the wide format (years as rows, stations as columns)</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">cessation_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;cessation&quot;</span><span class="p">)</span>

        <span class="c1"># Extract latitude and longitude values based on station order in pivoted DataFrame</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Reset index to ensure correct structure</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename the &quot;year&quot; column to &quot;STATION&quot; to match the required format</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Concatenate latitude, longitude, and pivoted onset values to form the final structure</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="WAS_compute_cessation.rainf_zone">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.rainf_zone">[docs]</a>
    <span class="k">def</span> <span class="nf">rainf_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">):</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">mask_4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
            <span class="o">&amp;</span>
            <span class="p">((</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)),</span>  
            <span class="mi">4</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
        <span class="n">mask_3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">),</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_0</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">mask_5</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_4</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_3</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_2</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_0</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="WAS_compute_cessation.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">,</span> <span class="n">nb_cores</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute cessation dates for each pixel using criteria based on regions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # Load zone file &amp; slice it to the area of interest</span>
        <span class="c1"># mask_char = xr.open_dataset(&#39;./utilities/Isohyet_zones.nc&#39;)</span>
        <span class="c1"># mask_char = mask_char.sel(X=slice(extent[1], extent[3]),</span>
        <span class="c1">#                           Y=slice(extent[0], extent[2]))</span>
        <span class="c1"># # Flip Y if needed (as done in your example)</span>
        <span class="c1"># mask_char = mask_char.isel(Y=slice(None, None, -1)).to_array().drop_vars(&#39;variable&#39;).squeeze()</span>

        <span class="c1"># daily_data = daily_data.sel(</span>
        <span class="c1">#     X=mask_char.coords[&#39;X&#39;],</span>
        <span class="c1">#     Y=mask_char.coords[&#39;Y&#39;])</span>
        
        <span class="n">mask_char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rainf_zone</span><span class="p">(</span><span class="n">daily_data</span><span class="p">)</span>
        
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_char</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">unique_zone</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">)]</span>

        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">zone_id_to_use</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">))</span>
        <span class="n">T_from_here</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
            <span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">zone_id_to_use</span><span class="p">][</span><span class="s1">&#39;start_search&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">mask_char_date_dry_soil</span> <span class="o">=</span> <span class="n">mask_char_ETP</span> <span class="o">=</span> <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">=</span> <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">mask_char</span>

        <span class="n">store_cessation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unique_zone</span><span class="p">:</span>
                <span class="n">mask_char_date_dry_soil</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_date_dry_soil</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;date_dry_soil&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_date_dry_soil</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mask_char_start_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_start_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;start_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_start_search</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mask_char_ETP</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_char_ETP</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;ETP&quot;</span><span class="p">],</span> <span class="n">mask_char_ETP</span><span class="p">)</span>
                <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_Cap_ret_maxi</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mask_char_end_search</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_end_search</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;end_search&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_end_search</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cessation_function</span><span class="p">,</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_date_dry_soil</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_start_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_ETP</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_Cap_ret_maxi</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_end_search</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_cessation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="n">store_cessation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_cessation</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_cessation</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_from_here</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">store_cessation</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cessation&quot;</span>

        <span class="k">return</span> <span class="n">store_cessation</span> <span class="c1">#.to_array().drop_vars(&#39;variable&#39;).squeeze(&#39;variable&#39;)</span></div>
</div>




<div class="viewcode-block" id="WAS_compute_cessation_dry_spell">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_cessation_dry_spell</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for computing the longest dry spell length </span>
<span class="sd">    after the onset of a rainy season, based on user-defined criteria.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default class-level criteria dictionary</span>
    <span class="n">default_criteria</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-30&quot;</span>
        <span class="p">},</span>
        <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span>
        <span class="p">},</span>
        <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-10&quot;</span>
        <span class="p">},</span>
        <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-15&quot;</span>
        <span class="p">},</span>
        <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-30&quot;</span>
        <span class="p">},</span>
        <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
            <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
            <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;12-01&quot;</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_compute_cessation_dry_spell class with user-defined or default criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user_criteria : dict, optional</span>
<span class="sd">            A dictionary containing zone-specific criteria. If not provided,</span>
<span class="sd">            the class will use the default criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user_criteria</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">user_criteria</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">WAS_compute_cessation_dry_spell</span><span class="o">.</span><span class="n">default_criteria</span>

<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.adjust_duplicates">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.adjust_duplicates">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_duplicates</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If any values in the Series repeat, nudge them by a tiny increment</span>
<span class="sd">        so that all are unique (to avoid indexing collisions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span></div>


<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame with:</span>
<span class="sd">          - Row 0 = LON</span>
<span class="sd">          - Row 1 = LAT</span>
<span class="sd">          - Row 2 = ELEV</span>
<span class="sd">          - Rows 3+ = daily data (or any date) with &#39;ID&#39; column containing dates.</span>

<span class="sd">        Returns an xarray DataArray with coords = (T, Y, X), variable = &#39;Observation&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --- 1) Extract metadata (first 3 rows) ---</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_cessation_dry_spell</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_cessation_dry_spell</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_compute_cessation_dry_spell</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">])</span>

        <span class="c1"># --- 2) Extract actual data, rename ID -&gt; DATE ---</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long form</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

        <span class="c1"># Merge metadata back into the melted data</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure DATE is treated as a proper datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a complete date range from the first day of the first year to the last day of the last year in the data</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Create a DataFrame with all combinations of dates and stations</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge the complete date-station combinations with the final_df to ensure all dates are present</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing values in the VALUE column with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Remove invalid rainfall values before computing the mean</span>
        <span class="c1"># Calculate the annual rainfall by summing the values for each year and station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Calculate the mean annual rainfall for each station</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="c1"># Merge back into final_df</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Generate the zonename column based on the conditions for each station</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>    
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.rainf_zone">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.rainf_zone">[docs]</a>
    <span class="k">def</span> <span class="nf">rainf_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">):</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">mask_5</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">mask_4</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">annual_rainfall</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> 
            <span class="o">&amp;</span>
            <span class="p">((</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">600</span><span class="p">)),</span>  
            <span class="mi">4</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="p">)</span>
        <span class="n">mask_3</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">),</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="n">mask_0</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">annual_rainfall</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">mask_5</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_4</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_3</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_2</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mask_0</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.dry_spell_cessation_function">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.dry_spell_cessation_function">[docs]</a>
    <span class="k">def</span> <span class="nf">dry_spell_cessation_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                     <span class="n">x</span><span class="p">,</span>
                                     <span class="n">idebut1</span><span class="p">,</span>
                                     <span class="n">cumul</span><span class="p">,</span>
                                     <span class="n">nbsec</span><span class="p">,</span>
                                     <span class="n">jour_pluvieux</span><span class="p">,</span>
                                     <span class="n">irch_fin1</span><span class="p">,</span>
                                     <span class="n">idebut2</span><span class="p">,</span>
                                     <span class="n">ijour_dem_cal</span><span class="p">,</span>
                                     <span class="n">ETP</span><span class="p">,</span>
                                     <span class="n">Cap_ret_maxi</span><span class="p">,</span>
                                     <span class="n">irch_fin2</span><span class="p">,</span>
                                     <span class="n">nbjour</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the longest dry spell length after the onset and</span>
<span class="sd">        determines the cessation date (when soil water returns to 0)</span>
<span class="sd">        based on water balance, then checks for a dry spell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall or similar values.</span>
<span class="sd">        idebut1 : int</span>
<span class="sd">            Start index to begin searching for the onset.</span>
<span class="sd">        cumul : float</span>
<span class="sd">            Cumulative rainfall threshold to trigger onset.</span>
<span class="sd">        nbsec : int</span>
<span class="sd">            Maximum number of dry days allowed in the sequence.</span>
<span class="sd">        jour_pluvieux : float</span>
<span class="sd">            Minimum rainfall to consider a day as rainy.</span>
<span class="sd">        irch_fin1 : int</span>
<span class="sd">            Maximum index limit for the onset search.</span>
<span class="sd">        idebut2 : int</span>
<span class="sd">            Start index for the cessation search.</span>
<span class="sd">        ijour_dem_cal : int</span>
<span class="sd">            Start index from which the water balance is calculated.</span>
<span class="sd">        ETP : float</span>
<span class="sd">            Daily evapotranspiration (mm).</span>
<span class="sd">        Cap_ret_maxi : float</span>
<span class="sd">            Maximum soil water retention capacity (mm).</span>
<span class="sd">        irch_fin2 : int</span>
<span class="sd">            Maximum index limit for the cessation search.</span>
<span class="sd">        nbjour : int</span>
<span class="sd">            Number of days after onset to check for the dry spell.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Length of the longest dry spell sequence after onset and before soil water</span>
<span class="sd">            returns to zero, or NaN if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut1</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin1</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">idebut2</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ETP</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">Cap_ret_maxi</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">irch_fin2</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nbjour</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Convert to int where needed</span>
        <span class="n">idebut1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut1</span><span class="p">)</span>
        <span class="n">nbsec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbsec</span><span class="p">)</span>
        <span class="n">irch_fin1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin1</span><span class="p">)</span>
        <span class="n">idebut2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idebut2</span><span class="p">)</span>
        <span class="n">ijour_dem_cal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">)</span>
        <span class="n">irch_fin2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">irch_fin2</span><span class="p">)</span>
        <span class="n">nbjour</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbjour</span><span class="p">)</span>

        <span class="n">ru</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idate</span> <span class="o">=</span> <span class="n">idebut1</span>

        <span class="c1"># --- 1) Find onset date ---</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">idate</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ipreced</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">isuiv</span> <span class="o">=</span> <span class="n">idate</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Check for missing data or out-of-bounds</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ipreced</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">idate</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">isuiv</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">])</span> <span class="ow">or</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">])</span> <span class="ow">or</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">break</span>

            <span class="c1"># Check if we&#39;ve exceeded the search limit</span>
            <span class="k">if</span> <span class="n">idate</span> <span class="o">&gt;</span> <span class="n">irch_fin1</span><span class="p">:</span>
                <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin1</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin1</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># Calculate cumulative rainfall for 1, 2, 3 days</span>
            <span class="n">cumul3jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]</span>
            <span class="n">cumul2jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">]</span>
            <span class="n">cumul1jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">]</span>

            <span class="c1"># Check if threshold is met</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cumul1jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> <span class="n">cumul2jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span> <span class="ow">or</span> <span class="n">cumul3jr</span> <span class="o">&gt;=</span> <span class="n">cumul</span><span class="p">):</span>
                <span class="n">troisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ipreced</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">idate</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">isuiv</span><span class="p">]])</span>
                <span class="n">itroisp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ipreced</span><span class="p">,</span> <span class="n">idate</span><span class="p">,</span> <span class="n">isuiv</span><span class="p">])</span>
                <span class="n">maxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">troisp</span><span class="p">)</span>
                <span class="n">imaxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">troisp</span> <span class="o">==</span> <span class="n">maxp</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ideb</span> <span class="o">=</span> <span class="n">itroisp</span><span class="p">[</span><span class="n">imaxp</span><span class="p">]</span>
                <span class="n">deb_saison</span> <span class="o">=</span> <span class="n">ideb</span>
                <span class="n">trouv</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="c1"># Check for sequences of dry days within the next 30 days</span>
                <span class="n">finp</span> <span class="o">=</span> <span class="n">ideb</span> <span class="o">+</span> <span class="mi">30</span>
                <span class="k">if</span> <span class="n">finp</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">pluie30jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:</span> <span class="n">finp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pluie30jr</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ideb</span><span class="p">:]</span>

                <span class="n">isec</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">isec</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">isecf</span> <span class="o">=</span> <span class="n">isec</span> <span class="o">+</span> <span class="n">nbsec</span>
                    <span class="k">if</span> <span class="n">isecf</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pluie30jr</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">donneeverif</span> <span class="o">=</span> <span class="n">pluie30jr</span><span class="p">[</span><span class="n">isec</span> <span class="p">:</span> <span class="n">isecf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Count days with rainfall below &#39;jour_pluvieux&#39;</span>
                    <span class="n">test1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">donneeverif</span> <span class="o">&lt;</span> <span class="n">jour_pluvieux</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># found a fully dry subsequence</span>
                        <span class="n">trouv</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">test1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nbsec</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isec</span> <span class="o">==</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">nbsec</span><span class="p">):</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">trouv</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># If deb_saison not found, no need to calculate further</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">deb_saison</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># --- 2) Soil water balance from ijour_dem_cal up to idebut2 ---</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ijour_dem_cal</span><span class="p">,</span> <span class="n">idebut2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">ru</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETP</span>
            <span class="c1"># Confine to [0, Cap_ret_maxi]</span>
            <span class="n">ru</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">))</span>

        <span class="c1"># --- 3) Move forward until soil water returns to 0 or we hit irch_fin2 ---</span>
        <span class="n">ifin_saison</span> <span class="o">=</span> <span class="n">idebut2</span>
        <span class="k">while</span> <span class="n">ifin_saison</span> <span class="o">&lt;</span> <span class="n">irch_fin2</span><span class="p">:</span>
            <span class="n">ifin_saison</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ifin_saison</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">ifin_saison</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">ru</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">ifin_saison</span><span class="p">]</span> <span class="o">-</span> <span class="n">ETP</span>
            <span class="n">ru</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="n">Cap_ret_maxi</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ru</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">fin_saison</span> <span class="o">=</span> <span class="n">ifin_saison</span> <span class="k">if</span> <span class="n">ifin_saison</span> <span class="o">&lt;=</span> <span class="n">irch_fin2</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">irch_fin2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">irch_fin2</span><span class="p">)</span>

        <span class="c1"># --- 4) If we found a valid fin_saison beyond (deb_saison + nbjour), </span>
        <span class="c1">#         check the longest dry spell between them.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fin_saison</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="n">fin_saison</span> <span class="o">-</span> <span class="p">(</span><span class="n">deb_saison</span> <span class="o">+</span> <span class="n">nbjour</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="n">deb_saison</span> <span class="o">+</span> <span class="n">nbjour</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">pluie_period</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">deb_saison</span> <span class="o">+</span> <span class="n">nbjour</span> <span class="p">:</span> <span class="n">fin_saison</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pluie_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># Find indices of rainy days in that window</span>
            <span class="n">rainy_days</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pluie_period</span> <span class="o">&gt;</span> <span class="n">jour_pluvieux</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">))</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rainy_days</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pluie_period</span><span class="p">)])</span>
            <span class="n">seq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">seq_max</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.day_of_year">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.day_of_year">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dem_rech1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert year i and MM-DD string dem_rech1 (e.g., &#39;07-23&#39;) </span>
<span class="sd">        into a 1-based day of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">full_date_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dem_rech1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">full_date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="n">origin_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">-</span> <span class="n">origin_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_df</span><span class="p">):</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>
        <span class="n">unique_stations</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">unique_stations</span><span class="p">:</span>
                <span class="c1"># Filter data for the current station and year</span>
                <span class="n">station_data</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">station</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)]</span>
                <span class="c1"># Replace missing values with NaN</span>
                <span class="n">station_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="c1"># Extract unique zonenames</span>
                <span class="n">unique_zonenames</span> <span class="o">=</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="c1"># Extract the onset criteria for the current zonename</span>
                <span class="n">idebut1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;start_search1&quot;</span><span class="p">])</span>
                <span class="n">irch_fin1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;end_search1&quot;</span><span class="p">])</span>
                <span class="n">cumul</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">]</span>
                <span class="n">nbsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">]</span>
                <span class="n">jour_pluvieux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">]</span>

                <span class="n">ijour_dem_cal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;date_dry_soil&quot;</span><span class="p">])</span>
                <span class="n">idebut2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;start_search2&quot;</span><span class="p">])</span>
                <span class="n">irch_fin2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;end_search2&quot;</span><span class="p">])</span>
                <span class="n">ETP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;ETP&quot;</span><span class="p">]</span>
                <span class="n">Cap_ret_maxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">]</span>
                <span class="n">nbjour</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">unique_zonenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nbjour&quot;</span><span class="p">]</span>
                
                <span class="c1"># Compute the cessation dryspell</span>
                <span class="n">cessation_dryspell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_spell_cessation_function</span><span class="p">(</span><span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                                                   <span class="n">idebut1</span><span class="p">,</span>
                                                                   <span class="n">cumul</span><span class="p">,</span>
                                                                   <span class="n">nbsec</span><span class="p">,</span>
                                                                   <span class="n">jour_pluvieux</span><span class="p">,</span>
                                                                   <span class="n">irch_fin1</span><span class="p">,</span>
                                                                   <span class="n">idebut2</span><span class="p">,</span>
                                                                   <span class="n">ijour_dem_cal</span><span class="p">,</span>
                                                                   <span class="n">ETP</span><span class="p">,</span>
                                                                   <span class="n">Cap_ret_maxi</span><span class="p">,</span>
                                                                   <span class="n">irch_fin2</span><span class="p">,</span>
                                                                   <span class="n">nbjour</span><span class="p">)</span>
                
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                    <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">station</span><span class="p">,</span>
                    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">station_data</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;cessation_dryspell&quot;</span><span class="p">:</span> <span class="n">cessation_dryspell</span>
                <span class="p">})</span>
        <span class="c1"># Convert results to a DataFrame</span>
        <span class="n">cessation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">cessation_df</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;cessation_dryspell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;cessation_dryspell&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>

        <span class="c1"># transform the onset_df to the CPT format</span>
        <span class="c1"># Extract unique stations and their corresponding lat/lon</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">cessation_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># Pivot df_yyy to match the wide format (years as rows, stations as columns)</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">cessation_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;cessation_dryspell&quot;</span><span class="p">)</span>

        <span class="c1"># Extract latitude and longitude values based on station order in pivoted DataFrame</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span> 
                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Reset index to ensure correct structure</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename the &quot;year&quot; column to &quot;STATION&quot; to match the required format</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Concatenate latitude, longitude, and pivoted onset values to form the final structure</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>




<div class="viewcode-block" id="WAS_compute_cessation_dry_spell.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_cessation_dry_spell.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_data</span><span class="p">,</span> <span class="n">nb_cores</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the longest dry spell length after the rainy season onset </span>
<span class="sd">        for each pixel in the given daily rainfall DataArray, using different </span>
<span class="sd">        criteria (both for onset and cessation) based on isohyet zones.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes (workers) to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Array with the longest dry spell length per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # 1) Load zone file &amp; slice it</span>
        <span class="c1"># mask_char = xr.open_dataset(&quot;./utilities/Isohyet_zones.nc&quot;)</span>
        <span class="c1"># mask_char = mask_char.sel(X=slice(extent[1], extent[3]),</span>
        <span class="c1">#                           Y=slice(extent[0], extent[2]))</span>

        <span class="c1"># # 2) Flip Y if needed</span>
        <span class="c1"># mask_char = mask_char.isel(Y=slice(None, None, -1)).to_array().drop_vars(&quot;variable&quot;).squeeze()</span>

        <span class="c1"># daily_data = daily_data.sel(</span>
        <span class="c1">#     X=mask_char.coords[&#39;X&#39;],</span>
        <span class="c1">#     Y=mask_char.coords[&#39;Y&#39;])</span>
        
        <span class="n">mask_char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rainf_zone</span><span class="p">(</span><span class="n">daily_data</span><span class="p">)</span>
        
        <span class="c1"># 3) Get unique zone IDs</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mask_char</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
        <span class="n">unique_zone</span> <span class="o">=</span> <span class="n">unique_zone</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">)]</span>

        <span class="c1"># 4) Determine years from the dataset</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># 5) For illustration, pick the largest zone to define T dimension</span>
        <span class="n">zone_id_to_use</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">unique_zone</span><span class="p">))</span>
        <span class="n">T_from_here</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
            <span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">zone_id_to_use</span><span class="p">][</span><span class="s1">&#39;start_search2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 6) Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># 7) Create placeholders for all required masks </span>
        <span class="n">mask_char_start_search1</span> <span class="o">=</span> <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> \
            <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">mask_char_end_search1</span> <span class="o">=</span> <span class="n">mask_char_nbjour</span> <span class="o">=</span> \
            <span class="n">mask_char_start_search2</span> <span class="o">=</span> <span class="n">mask_char_date_dry_soil</span> <span class="o">=</span> <span class="n">mask_char_ETP</span> <span class="o">=</span> \
            <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">=</span> <span class="n">mask_char_end_search2</span> <span class="o">=</span> <span class="n">mask_char</span>

        <span class="n">store_dry_spell</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="c1"># Update masks for each zone &#39;j&#39;</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unique_zone</span><span class="p">:</span>
                <span class="n">mask_char_start_search1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_start_search1</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;start_search1&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_start_search1</span>
                <span class="p">)</span>
                <span class="n">mask_char_cumulative</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_cumulative</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;cumulative&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_cumulative</span>
                <span class="p">)</span>
                <span class="n">mask_char_number_dry_days</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_number_dry_days</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;number_dry_days&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_number_dry_days</span>
                <span class="p">)</span>
                <span class="n">mask_char_thrd_rain_day</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_thrd_rain_day</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_thrd_rain_day</span>
                <span class="p">)</span>
                <span class="n">mask_char_end_search1</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_end_search1</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;end_search1&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_end_search1</span>
                <span class="p">)</span>
                <span class="n">mask_char_nbjour</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_nbjour</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;nbjour&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_nbjour</span>
                <span class="p">)</span>
                <span class="n">mask_char_date_dry_soil</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_date_dry_soil</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;date_dry_soil&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_date_dry_soil</span>
                <span class="p">)</span>
                <span class="n">mask_char_start_search2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_start_search2</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;start_search2&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_start_search2</span>
                <span class="p">)</span>
                <span class="n">mask_char_ETP</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_ETP</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;ETP&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_ETP</span>
                <span class="p">)</span>
                <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_Cap_ret_maxi</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">],</span>
                    <span class="n">mask_char_Cap_ret_maxi</span>
                <span class="p">)</span>
                <span class="n">mask_char_end_search2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">mask_char_end_search2</span> <span class="o">==</span> <span class="n">j</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;end_search2&quot;</span><span class="p">]),</span>
                    <span class="n">mask_char_end_search2</span>
                <span class="p">)</span>

            <span class="c1"># Select the daily data for year i</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="c1"># 8) Parallel processing with Dask</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dry_spell_cessation_function</span><span class="p">,</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_start_search1</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_cumulative</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_number_dry_days</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_thrd_rain_day</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_end_search1</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_start_search2</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_date_dry_soil</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_ETP</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_Cap_ret_maxi</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_end_search2</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">mask_char_nbjour</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_dry_spell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># 9) Concatenate final result across years</span>
        <span class="n">store_dry_spell</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_dry_spell</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_dry_spell</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_from_here</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
        <span class="n">store_dry_spell</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Cessation_dryspell&quot;</span>

        <span class="k">return</span> <span class="n">store_dry_spell</span> <span class="c1">#.to_array().drop_vars(&#39;variable&#39;).squeeze(&#39;variable&#39;)</span></div>
</div>

    

<div class="viewcode-block" id="WAS_count_dry_spells">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_count_dry_spells</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the number of dry spells within a specified period</span>
<span class="sd">    (onset to cessation) for each pixel or station in a daily rainfall dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_count_dry_spells.adjust_duplicates">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.adjust_duplicates">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">adjust_duplicates</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If any values in the Series repeat, nudge them by a tiny increment</span>
<span class="sd">        so that all are unique (to avoid indexing collisions).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">series</span><span class="p">[</span><span class="n">series</span> <span class="o">==</span> <span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                <span class="n">series</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">increment</span> <span class="o">*</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">series</span></div>


<div class="viewcode-block" id="WAS_count_dry_spells.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame with:</span>
<span class="sd">          - Row 0 = LON</span>
<span class="sd">          - Row 1 = LAT</span>
<span class="sd">          - Row 2 = ELEV</span>
<span class="sd">          - Rows 3+ = daily data with &#39;ID&#39; column containing dates.</span>

<span class="sd">        Returns a DataFrame with columns like:</span>
<span class="sd">          DATE | STATION | VALUE | LON | LAT | ELEV | MEAN_ANNUAL_RAINFALL | zonename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Extract metadata (first 3 rows)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_count_dry_spells</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_count_dry_spells</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_count_dry_spells</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;ELEV&quot;</span><span class="p">])</span>

        <span class="c1"># 2) Extract daily data, rename ID -&gt; DATE</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long form</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

        <span class="c1"># Merge metadata</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Convert DATE to datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create complete date range</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># All combinations of (date, station)</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
            <span class="p">[</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge to ensure every (date, station) is present</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing rainfall values with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Compute mean annual rainfall per station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Generate a zonename column (optional example logic)</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="WAS_count_dry_spells.transform_cpt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.transform_cpt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cpt</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">missing_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame in CPT format with:</span>
<span class="sd">         - Row 0 = LAT</span>
<span class="sd">         - Row 1 = LON</span>
<span class="sd">         - Rows 2+ = numeric year data in wide format (stations in columns).</span>

<span class="sd">        Returns a DataFrame with columns like:</span>
<span class="sd">          YEAR | STATION | VALUE | LAT | LON</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Extract metadata (first 2 rows: LAT, LON)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>  <span class="c1"># index = [&quot;LAT&quot;, &quot;LON&quot;]</span>
            <span class="o">.</span><span class="n">T</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>         <span class="c1"># columns: [&quot;index&quot;, &quot;LAT&quot;, &quot;LON&quot;]</span>
        <span class="p">)</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">]</span>
        
        <span class="c1"># Adjust duplicates in LAT / LON</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_count_dry_spells</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">])</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_count_dry_spells</span><span class="o">.</span><span class="n">adjust_duplicates</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">])</span>
        
        <span class="c1"># 2) Extract the data part from row 2 onward</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;YEAR&quot;</span><span class="p">})</span>
        <span class="n">data_part</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_part</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># 3) Wide to long</span>
        <span class="n">long_data</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;YEAR&quot;</span><span class="p">,</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span>
        <span class="p">)</span>

        <span class="c1"># 4) Merge with metadata</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">long_data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>          

        <span class="k">return</span> <span class="n">final_df</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_cpt_to_long</span><span class="p">(</span><span class="n">df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset_or_cessation&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a DataFrame in CPT-like format to a long DataFrame with columns:</span>
<span class="sd">            [year, station, value_name, lat, lon]</span>

<span class="sd">        Assumes:</span>
<span class="sd">         - Row 0 = [&quot;LAT&quot;, lat_stn1, lat_stn2, ...]</span>
<span class="sd">         - Row 1 = [&quot;LON&quot;, lon_stn1, lon_stn2, ...]</span>
<span class="sd">         - Rows 2+ = [year, station1_val, station2_val, ...]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_cpt : pd.DataFrame</span>
<span class="sd">            CPT-like DataFrame (as returned by, e.g., compute_insitu).</span>
<span class="sd">        value_name : str</span>
<span class="sd">            Name to give to the column containing the value (e.g. &quot;onset&quot;, &quot;cessation&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Columns: [station, year, &lt;value_name&gt;, lat, lon]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Row 0 for LAT, row 1 for LON</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># all station lat</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># all station lon</span>

        <span class="c1"># Station names from columns</span>
        <span class="n">station_cols</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Rows from index=2 are year + station values</span>
        <span class="n">df_years</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Transform to long</span>
        <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_years</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">value_name</span>
        <span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

        <span class="c1"># Map station -&gt; lat/lon</span>
        <span class="n">lat_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_cols</span><span class="p">,</span> <span class="n">lat_row</span><span class="p">))</span>
        <span class="n">lon_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_cols</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">))</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lat_map</span><span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lon_map</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_long</span>

<div class="viewcode-block" id="WAS_count_dry_spells.count_dry_spells">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.count_dry_spells">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">count_dry_spells</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onset</span><span class="p">,</span> <span class="n">cessation</span><span class="p">,</span> <span class="n">dry_spell_length</span><span class="p">,</span> <span class="n">dry_threshold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of dry spells of a specific length between onset and cessation dates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall values.</span>
<span class="sd">        onset : int</span>
<span class="sd">            Start index for the calculation (onset date).</span>
<span class="sd">        cessation : int</span>
<span class="sd">            End index for the calculation (cessation date).</span>
<span class="sd">        dry_spell_length : int</span>
<span class="sd">            The length of a dry spell to count.</span>
<span class="sd">        dry_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;dry.&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or float</span>
<span class="sd">            The number of dry spells of the specified length (NaN if invalid).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">onset</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cessation</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">onset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">onset</span><span class="p">)</span>
        <span class="n">cessation</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cessation</span><span class="p">)</span>

        <span class="c1"># Prevent out-of-bounds</span>
        <span class="k">if</span> <span class="n">onset</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cessation</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">onset</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">cessation</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">cessation</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># truncate</span>

        <span class="n">dry_spells_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_dry_days</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">onset</span><span class="p">,</span> <span class="n">cessation</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dry_threshold</span><span class="p">:</span>
                <span class="n">current_dry_days</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_dry_days</span> <span class="o">==</span> <span class="n">dry_spell_length</span><span class="p">:</span>
                    <span class="n">dry_spells_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">current_dry_days</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Check if the final run of dry days meets the criterion</span>
        <span class="k">if</span> <span class="n">current_dry_days</span> <span class="o">==</span> <span class="n">dry_spell_length</span><span class="p">:</span>
            <span class="n">dry_spells_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">dry_spells_count</span></div>


<div class="viewcode-block" id="WAS_count_dry_spells.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daily_df</span><span class="p">,</span> <span class="n">onset_df_cpt</span><span class="p">,</span> <span class="n">cessation_df_cpt</span><span class="p">,</span> <span class="n">dry_spell_length</span><span class="p">,</span> <span class="n">dry_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the number of dry spells (of length = dry_spell_length) between the</span>
<span class="sd">        onset and cessation dates for in-situ stations (CDT format).</span>

<span class="sd">        Returns a DataFrame in CPT format:</span>
<span class="sd">         - Row 0: [&quot;LAT&quot;, lat_stn1, lat_stn2, ...]</span>
<span class="sd">         - Row 1: [&quot;LON&quot;, lon_stn1, lon_stn2, ...]</span>
<span class="sd">         - Subsequent rows: [year, station1_value, station2_value, ...]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_df : pd.DataFrame</span>
<span class="sd">            CDT rainfall data (ID column = date, station columns).</span>
<span class="sd">        onset_df_cpt : pd.DataFrame</span>
<span class="sd">            CPT-format DataFrame containing onset dates (as returned by some method).</span>
<span class="sd">        cessation_df_cpt : pd.DataFrame</span>
<span class="sd">            CPT-format DataFrame containing cessation dates.</span>
<span class="sd">        dry_spell_length : int</span>
<span class="sd">            The length of the dry spell to look for.</span>
<span class="sd">        dry_threshold : float, optional</span>
<span class="sd">            Rainfall threshold below which a day is considered &quot;dry.&quot; Defaults to 1.0 mm.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Final dry-spell counts in CPT pivot format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Transform daily_df from CDT to a standard table</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="c1"># 2) Convert onset and cessation DataFrames from CPT to long format</span>
        <span class="n">onset_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">onset_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset&quot;</span><span class="p">)</span>
        <span class="n">cess_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">cessation_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;cessation&quot;</span><span class="p">)</span>

        <span class="c1"># 3) Merge onset &amp; cessation by [station, year]</span>
        <span class="n">merged_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">onset_long</span><span class="p">,</span> <span class="n">cess_long</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;_cess&quot;</span><span class="p">))</span>

        <span class="c1"># Consolidate lat/lon columns</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat_cess&quot;</span><span class="p">])</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon_cess&quot;</span><span class="p">])</span>
        <span class="n">merged_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lat_cess&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_cess&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 4) Loop over (station, year) to compute the count of dry spells</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">yr</span><span class="p">),</span> <span class="n">subdf</span> <span class="ow">in</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">]):</span>
            <span class="n">onset_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cess_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;cessation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Filter daily data for this station and year</span>
            <span class="n">stn_data_year</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">yr</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Replace -99.0 with NaN</span>
            <span class="n">stn_data_year</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stn_data_year</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># Convert the daily values to a NumPy array</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">stn_data_year</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Apply count_dry_spells</span>
            <span class="n">nb_dry_spells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_dry_spells</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onset_val</span><span class="p">,</span> <span class="n">cess_val</span><span class="p">,</span> <span class="n">dry_spell_length</span><span class="p">,</span> <span class="n">dry_threshold</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">yr</span><span class="p">,</span>
                <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">stn</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat_val</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon_val</span><span class="p">,</span>
                <span class="s2">&quot;dry_spells_count&quot;</span><span class="p">:</span> <span class="n">nb_dry_spells</span>
            <span class="p">})</span>

        <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># 5) Pivot back to CPT format</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;dry_spells_count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Build LAT and LON rows using the first occurrence of each station in df_res</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>

        <span class="c1"># Concatenate lat, lon, and pivot</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="WAS_count_dry_spells.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_dry_spells.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">daily_data</span><span class="p">,</span>
        <span class="n">onset_date</span><span class="p">,</span>
        <span class="n">cessation_date</span><span class="p">,</span>
        <span class="n">dry_spell_length</span><span class="p">,</span>
        <span class="n">dry_threshold</span><span class="p">,</span>
        <span class="n">nb_cores</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the number of dry spells for each pixel within the onset and cessation period</span>
<span class="sd">        in a daily xarray DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        onset_date : xarray.DataArray</span>
<span class="sd">            DataArray containing onset dates for each pixel.</span>
<span class="sd">        cessation_date : xarray.DataArray</span>
<span class="sd">            DataArray containing cessation dates for each pixel.</span>
<span class="sd">        dry_spell_length : int</span>
<span class="sd">            The length of a dry spell to count.</span>
<span class="sd">        dry_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;dry.&quot;</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            An array with the count of dry spells per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure alignment</span>
        <span class="n">cessation_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
        <span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">onset_date</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">],</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">onset_date</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># Prepare chunk sizes for parallelization</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="n">store_nb_dryspell</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="c1"># Select data for the current year</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">year_cessation_date</span> <span class="o">=</span> <span class="n">cessation_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">year_onset_date</span> <span class="o">=</span> <span class="n">onset_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="c1"># Set up parallel processing</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count_dry_spells</span><span class="p">,</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_onset_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_cessation_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;dry_spell_length&quot;</span><span class="p">:</span> <span class="n">dry_spell_length</span><span class="p">,</span>
                    <span class="s2">&quot;dry_threshold&quot;</span><span class="p">:</span> <span class="n">dry_threshold</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_nb_dryspell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># Concatenate final result</span>
        <span class="n">store_nb_dryspell</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_nb_dryspell</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_nb_dryspell</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
        <span class="n">store_nb_dryspell</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Count_dryspell&quot;</span>

        <span class="k">return</span> <span class="n">store_nb_dryspell</span></div>
</div>



<div class="viewcode-block" id="WAS_count_wet_spells">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_wet_spells">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_count_wet_spells</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the number of wet spells within a specified period</span>
<span class="sd">    (onset to cessation) for each pixel or station in a daily rainfall dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_count_wet_spells.count_wet_spells">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_wet_spells.count_wet_spells">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">count_wet_spells</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onset_date</span><span class="p">,</span> <span class="n">cessation_date</span><span class="p">,</span> <span class="n">wet_spell_length</span><span class="p">,</span> <span class="n">wet_threshold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of wet spells of a specific length between onset and cessation dates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall values.</span>
<span class="sd">        onset_date : int</span>
<span class="sd">            Start index for the calculation (onset date).</span>
<span class="sd">        cessation_date : int</span>
<span class="sd">            End index for the calculation (cessation date).</span>
<span class="sd">        wet_spell_length : int</span>
<span class="sd">            The length of a wet spell to count.</span>
<span class="sd">        wet_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;wet.&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or float</span>
<span class="sd">            The number of wet spells of the specified length (NaN if data is invalid).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">onset_date</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Convert to int and prevent out-of-bounds</span>
        <span class="n">onset_date</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">onset_date</span><span class="p">)</span>
        <span class="n">cessation_date</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">onset_date</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cessation_date</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">onset_date</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">cessation_date</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">cessation_date</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">wet_spells_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_wet_days</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">onset_date</span><span class="p">,</span> <span class="n">cessation_date</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wet_threshold</span><span class="p">:</span>
                <span class="n">current_wet_days</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_wet_days</span> <span class="o">==</span> <span class="n">wet_spell_length</span><span class="p">:</span>
                    <span class="n">wet_spells_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">current_wet_days</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Check if the last run of wet days also qualifies</span>
        <span class="k">if</span> <span class="n">current_wet_days</span> <span class="o">==</span> <span class="n">wet_spell_length</span><span class="p">:</span>
            <span class="n">wet_spells_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">wet_spells_count</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_cpt_to_long</span><span class="p">(</span><span class="n">df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset_or_cessation&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a CPT-format DataFrame into a long DataFrame with columns:</span>
<span class="sd">            [year, station, value_name, lat, lon]</span>

<span class="sd">        Assumes:</span>
<span class="sd">         - Row 0: [&quot;LAT&quot;, lat_stn1, lat_stn2, ...]</span>
<span class="sd">         - Row 1: [&quot;LON&quot;, lon_stn1, lon_stn2, ...]</span>
<span class="sd">         - Rows 2+: [year, station1_val, station2_val, ...]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_cpt : pd.DataFrame</span>
<span class="sd">            DataFrame in CPT-wide format (as returned by certain compute_insitu methods).</span>
<span class="sd">        value_name : str</span>
<span class="sd">            Name for the output column containing the values (e.g. &quot;onset&quot;, &quot;cessation&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Columns: [station, year, &lt;value_name&gt;, lat, lon]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Row 0 = LAT, Row 1 = LON</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># all station lat</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># all station lon</span>

        <span class="c1"># Station names (from columns)</span>
        <span class="n">station_cols</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Rows from index=2 =&gt; year + station values</span>
        <span class="n">df_years</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Melt (wide -&gt; long)</span>
        <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_years</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">value_name</span>
        <span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

        <span class="c1"># Map station -&gt; lat/lon</span>
        <span class="n">lat_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_cols</span><span class="p">,</span> <span class="n">lat_row</span><span class="p">))</span>
        <span class="n">lon_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_cols</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">))</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lat_map</span><span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lon_map</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_long</span>

<div class="viewcode-block" id="WAS_count_wet_spells.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_wet_spells.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a CDT-format DataFrame into a standard table.</span>

<span class="sd">        CDT format assumptions:</span>
<span class="sd">         - Row 0 = LON</span>
<span class="sd">         - Row 1 = LAT</span>
<span class="sd">         - Row 2 = ELEV</span>
<span class="sd">         - Rows 3+ = daily data, &#39;ID&#39; column has dates in YYYYMMDD.</span>

<span class="sd">        Returns a DataFrame with columns:</span>
<span class="sd">          [DATE, STATION, VALUE, LON, LAT, ELEV, MEAN_ANNUAL_RAINFALL, zonename]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Example reuse from previous classes (adjust for your own logic if needed)</span>

        <span class="c1"># 1) Extract metadata (first 3 rows)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>

        <span class="c1"># 2) Extract daily data</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Convert DATE to datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Create a complete date range and expand data accordingly</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
            <span class="p">[</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># Compute mean annual rainfall by station</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>

        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Assign a &#39;zonename&#39;</span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="WAS_count_wet_spells.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_wet_spells.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">daily_data</span><span class="p">,</span>
        <span class="n">onset_date</span><span class="p">,</span>
        <span class="n">cessation_date</span><span class="p">,</span>
        <span class="n">wet_spell_length</span><span class="p">,</span>
        <span class="n">wet_threshold</span><span class="p">,</span>
        <span class="n">nb_cores</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the number of wet spells for each pixel within the onset and cessation period</span>
<span class="sd">        in a daily xarray DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        onset_date : xarray.DataArray</span>
<span class="sd">            DataArray containing onset dates for each pixel.</span>
<span class="sd">        cessation_date : xarray.DataArray</span>
<span class="sd">            DataArray containing cessation dates for each pixel.</span>
<span class="sd">        wet_spell_length : int</span>
<span class="sd">            The length of a wet spell to count.</span>
<span class="sd">        wet_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;wet.&quot;</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Array with the count of wet spells per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Align onset and cessation</span>
        <span class="n">cessation_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
        <span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span><span class="p">)</span>

        <span class="c1"># Determine each year</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># Chunk sizes for parallel processing</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="n">store_nb_wetspell</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="c1"># Data for the current year</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">year_cessation_date</span> <span class="o">=</span> <span class="n">cessation_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">year_onset_date</span> <span class="o">=</span> <span class="n">onset_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="c1"># Set up parallel</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count_wet_spells</span><span class="p">,</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_onset_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_cessation_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;wet_spell_length&quot;</span><span class="p">:</span> <span class="n">wet_spell_length</span><span class="p">,</span>
                    <span class="s2">&quot;wet_threshold&quot;</span><span class="p">:</span> <span class="n">wet_threshold</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;float&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_nb_wetspell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># Concatenate across all years</span>
        <span class="n">store_nb_wetspell</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_nb_wetspell</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_nb_wetspell</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
        <span class="n">store_nb_wetspell</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Count_wetspell&quot;</span>

        <span class="k">return</span> <span class="n">store_nb_wetspell</span></div>


<div class="viewcode-block" id="WAS_count_wet_spells.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_wet_spells.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">daily_df</span><span class="p">,</span>
        <span class="n">onset_df_cpt</span><span class="p">,</span>
        <span class="n">cessation_df_cpt</span><span class="p">,</span>
        <span class="n">wet_spell_length</span><span class="p">,</span>
        <span class="n">wet_threshold</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the number of wet spells (of length = wet_spell_length) between</span>
<span class="sd">        onset and cessation for in-situ stations (CDT data).</span>

<span class="sd">        Returns a DataFrame in CPT format:</span>
<span class="sd">         - Row 0: [&quot;LAT&quot;, lat_station1, lat_station2, ...]</span>
<span class="sd">         - Row 1: [&quot;LON&quot;, lon_station1, lon_station2, ...]</span>
<span class="sd">         - Then one row per year: [year, station1_value, station2_value, ...]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_df : pd.DataFrame</span>
<span class="sd">            CDT rainfall data (ID column = date, station columns).</span>
<span class="sd">        onset_df_cpt : pd.DataFrame</span>
<span class="sd">            CPT-format DataFrame with onset dates (same station columns).</span>
<span class="sd">        cessation_df_cpt : pd.DataFrame</span>
<span class="sd">            CPT-format DataFrame with cessation dates (same station columns).</span>
<span class="sd">        wet_spell_length : int</span>
<span class="sd">            The length of a wet spell to count.</span>
<span class="sd">        wet_threshold : float, optional</span>
<span class="sd">            Rainfall threshold classifying a day as &quot;wet.&quot; Defaults to 1.0 mm.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Final wet-spell counts in CPT pivot format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Transform the daily CDT data into a standard DataFrame</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="c1"># 2) Parse onset and cessation from CPT -&gt; long format</span>
        <span class="n">onset_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">onset_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset&quot;</span><span class="p">)</span>
        <span class="n">cess_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">cessation_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;cessation&quot;</span><span class="p">)</span>

        <span class="c1"># 3) Merge on station/year</span>
        <span class="n">merged_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">onset_long</span><span class="p">,</span> <span class="n">cess_long</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;_cess&quot;</span><span class="p">))</span>
        
        <span class="c1"># Consolidate lat/lon columns</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lat_cess&quot;</span><span class="p">])</span>
        <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">merged_data</span><span class="p">[</span><span class="s2">&quot;lon_cess&quot;</span><span class="p">])</span>
        <span class="n">merged_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lat_cess&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_cess&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 4) Loop through station-year pairs and count wet spells</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">yr</span><span class="p">),</span> <span class="n">subdf</span> <span class="ow">in</span> <span class="n">merged_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">]):</span>
            <span class="n">onset_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cess_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;cessation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Filter daily data for (station, year)</span>
            <span class="n">stn_data_year</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">yr</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Replace -99 with NaN</span>
            <span class="n">stn_data_year</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stn_data_year</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># Convert to array</span>
            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">stn_data_year</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Apply count_wet_spells</span>
            <span class="n">nb_wet_spells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_wet_spells</span><span class="p">(</span>
                <span class="n">x_vals</span><span class="p">,</span> <span class="n">onset_val</span><span class="p">,</span> <span class="n">cess_val</span><span class="p">,</span>
                <span class="n">wet_spell_length</span><span class="p">,</span> <span class="n">wet_threshold</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">yr</span><span class="p">,</span>
                <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">stn</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat_val</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon_val</span><span class="p">,</span>
                <span class="s2">&quot;wet_spells_count&quot;</span><span class="p">:</span> <span class="n">nb_wet_spells</span>
            <span class="p">})</span>

        <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># 5) Pivot back to CPT format</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;wet_spells_count&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Build LAT and LON rows</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>

        <span class="c1"># Concatenate LAT, LON, and pivot</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>
</div>




<div class="viewcode-block" id="WAS_count_rainy_days">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_rainy_days">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_count_rainy_days</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the number of rainy days between onset and cessation dates</span>
<span class="sd">    for each pixel or station in a daily rainfall dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_count_rainy_days.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_rainy_days.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame in CDT format into a standardized long DataFrame.</span>

<span class="sd">        CDT format assumptions:</span>
<span class="sd">         - Row 0 = LON</span>
<span class="sd">         - Row 1 = LAT</span>
<span class="sd">         - Row 2 = ELEV</span>
<span class="sd">         - Rows 3+ = daily data with &#39;ID&#39; column holding dates in YYYYMMDD format.</span>

<span class="sd">        This method returns a DataFrame with columns:</span>
<span class="sd">            DATE, STATION, VALUE, LON, LAT, ELEV, (optional) MEAN_ANNUAL_RAINFALL, zonename</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Extract metadata (first 3 rows)</span>
        <span class="c1">#    - &#39;ID&#39; column in these rows has labels [&quot;LON&quot;, &quot;LAT&quot;, &quot;ELEV&quot;]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>

        <span class="c1"># 2) Extract the daily data portion (from row 3 onward); rename &quot;ID&quot; -&gt; &quot;DATE&quot;</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long format: columns = [&quot;DATE&quot;, &quot;STATION&quot;, &quot;VALUE&quot;]</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Merge station metadata</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Convert &quot;DATE&quot; from string YYYYMMDD to datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 3) Ensure a complete date range from Jan 1 of earliest year to Dec 31 of latest year</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

        <span class="c1"># Create all (date, station) pairs so we don&#39;t miss any station or date</span>
        <span class="n">all_combinations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
            <span class="p">[</span><span class="n">date_range</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Merge to fill in missing rows</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">all_combinations</span><span class="p">,</span> <span class="n">final_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;STATION&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing rainfall values with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="c1"># 4) Compute mean annual rainfall per station for classification</span>
        <span class="n">annual_rainfall</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">final_df</span><span class="p">[</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">mean_annual_rainfall</span> <span class="o">=</span> <span class="n">annual_rainfall</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">)[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">mean_annual_rainfall</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">final_df</span><span class="p">,</span> <span class="n">mean_annual_rainfall</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="c1"># Assign a &#39;zonename&#39; </span>
        <span class="k">def</span> <span class="nf">determine_zonename</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">5</span>
            <span class="k">elif</span> <span class="mi">600</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">3</span>
            <span class="k">elif</span> <span class="mi">400</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="mi">200</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="mi">100</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;MEAN_ANNUAL_RAINFALL&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">75</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">4</span>

        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;zonename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">determine_zonename</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


<div class="viewcode-block" id="WAS_count_rainy_days.count_rainy_days">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_rainy_days.count_rainy_days">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">count_rainy_days</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">onset_date</span><span class="p">,</span> <span class="n">cessation_date</span><span class="p">,</span> <span class="n">rain_threshold</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of rainy days between onset and cessation dates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array-like</span>
<span class="sd">            Daily rainfall values.</span>
<span class="sd">        onset_date : int</span>
<span class="sd">            Start index for the calculation (onset date).</span>
<span class="sd">        cessation_date : int</span>
<span class="sd">            End index for the calculation (cessation date).</span>
<span class="sd">        rain_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;rainy.&quot;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or float</span>
<span class="sd">            Number of rainy days (returns NaN if data is invalid).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">onset_date</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Convert onset and cessation indices to integers</span>
        <span class="n">onset_date</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">onset_date</span><span class="p">)</span>
        <span class="n">cessation_date</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">)</span>

        <span class="c1"># Prevent out-of-bounds indices</span>
        <span class="k">if</span> <span class="n">onset_date</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cessation_date</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">onset_date</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">cessation_date</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">cessation_date</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># Truncate if needed</span>

        <span class="n">rainy_days_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">onset_date</span><span class="p">,</span> <span class="n">cessation_date</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">day</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rain_threshold</span><span class="p">:</span>
                <span class="n">rainy_days_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">rainy_days_count</span></div>


<div class="viewcode-block" id="WAS_count_rainy_days.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_rainy_days.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">daily_data</span><span class="p">,</span>
        <span class="n">onset_date</span><span class="p">,</span>
        <span class="n">cessation_date</span><span class="p">,</span>
        <span class="n">rain_threshold</span><span class="p">,</span>
        <span class="n">nb_cores</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the number of rainy days for each pixel between onset and cessation dates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_data : xarray.DataArray</span>
<span class="sd">            Daily rainfall data, coords = (T, Y, X).</span>
<span class="sd">        onset_date : xarray.DataArray</span>
<span class="sd">            DataArray containing onset dates for each pixel.</span>
<span class="sd">        cessation_date : xarray.DataArray</span>
<span class="sd">            DataArray containing cessation dates for each pixel.</span>
<span class="sd">        rain_threshold : float</span>
<span class="sd">            Rainfall threshold to classify a day as &quot;rainy.&quot;</span>
<span class="sd">        nb_cores : int</span>
<span class="sd">            Number of parallel processes to use.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Array with the count of rainy days per pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Align onset and cessation dates</span>
        <span class="n">cessation_date</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">cessation_date</span><span class="p">,</span> <span class="n">onset_date</span><span class="p">)</span>

        <span class="c1"># Compute year range</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">daily_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

        <span class="c1"># Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">daily_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="n">store_nb_rainy_days</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="c1"># Select data for the current year</span>
            <span class="n">year_data</span> <span class="o">=</span> <span class="n">daily_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">year_cessation_date</span> <span class="o">=</span> <span class="n">cessation_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">year_onset_date</span> <span class="o">=</span> <span class="n">onset_date</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            
            <span class="c1"># Set up parallel processing</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count_rainy_days</span><span class="p">,</span>
                <span class="n">year_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_onset_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">year_cessation_date</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rain_threshold&#39;</span><span class="p">:</span> <span class="n">rain_threshold</span><span class="p">},</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">store_nb_rainy_days</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_</span><span class="p">)</span>

        <span class="c1"># Concatenate the final result</span>
        <span class="n">store_nb_rainy_days</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">store_nb_rainy_days</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">store_nb_rainy_days</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset_date</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">store_nb_rainy_days</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;nb_rainy_days&quot;</span>

        <span class="k">return</span> <span class="n">store_nb_rainy_days</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parse_cpt_to_long</span><span class="p">(</span><span class="n">df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset_or_cessation&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a DataFrame in CPT format (like the one returned by &#39;compute_insitu&#39;)</span>
<span class="sd">        into a long format DataFrame: columns = [year, station, value_name, lat, lon].</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_cpt : pd.DataFrame</span>
<span class="sd">            - Row 0: [&quot;LAT&quot;, lat_stn1, lat_stn2, ...]</span>
<span class="sd">            - Row 1: [&quot;LON&quot;, lon_stn1, lon_stn2, ...]</span>
<span class="sd">            - Rows 2+: [year, station1_value, station2_value, ...]</span>

<span class="sd">        value_name : str</span>
<span class="sd">            Name for the column containing the values (e.g., &quot;onset&quot;, &quot;cessation&quot;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_long : pd.DataFrame</span>
<span class="sd">            Columns = [station, year, value_name, lat, lon]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Extract row 0 (LAT) and row 1 (LON)</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># 2) Extract station names (the columns) to map lat/lon</span>
        <span class="n">station_names</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># 3) Extract years + values</span>
        <span class="n">df_years</span> <span class="o">=</span> <span class="n">df_cpt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_years</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 4) Reshape to long format</span>
        <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_years</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">value_name</span>
        <span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

        <span class="c1"># 5) Add LAT/LON information</span>
        <span class="n">lat_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_names</span><span class="p">,</span> <span class="n">lat_row</span><span class="p">))</span>
        <span class="n">lon_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">station_names</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">))</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lat_map</span><span class="p">)</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lon_map</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_long</span>

<div class="viewcode-block" id="WAS_count_rainy_days.compute_insitu">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_count_rainy_days.compute_insitu">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">daily_df</span><span class="p">,</span>
        <span class="n">onset_df_cpt</span><span class="p">,</span>
        <span class="n">cessation_df_cpt</span><span class="p">,</span>
        <span class="n">rain_threshold</span><span class="o">=</span><span class="mf">0.85</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute, for in-situ stations (CDT data), the number of rainy days between</span>
<span class="sd">        onset and cessation, for each station and year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        daily_df : pd.DataFrame</span>
<span class="sd">            CDT precipitation data (ID column = date; columns = stations).</span>
<span class="sd">            Follows the standard CDT format.</span>
<span class="sd">        onset_df_cpt : pd.DataFrame</span>
<span class="sd">            Result of `WAS_compute_onset.compute_insitu(...)` for onset (CPT format).</span>
<span class="sd">        cessation_df_cpt : pd.DataFrame</span>
<span class="sd">            Same format for cessation (CPT format).</span>
<span class="sd">        rain_threshold : float, optional</span>
<span class="sd">            Precipitation threshold for counting a day as &quot;rainy,&quot; by default 0.85 mm.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_final : pd.DataFrame</span>
<span class="sd">            The count of rainy days in CPT pivot format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Transform daily_df (CDT format) into a standard table</span>
        <span class="n">daily_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">daily_df</span><span class="p">)</span>

        <span class="c1"># 2) Convert onset_df_cpt and cessation_df_cpt to long format</span>
        <span class="n">onset_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">onset_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;onset&quot;</span><span class="p">)</span>
        <span class="n">cess_long</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cpt_to_long</span><span class="p">(</span><span class="n">cessation_df_cpt</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;cessation&quot;</span><span class="p">)</span>

        <span class="c1"># 3) Merge onset &amp; cessation =&gt; single DataFrame</span>
        <span class="n">merged_onset_cess</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">onset_long</span><span class="p">,</span>
            <span class="n">cess_long</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;_cess&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Consolidate lat/lon columns</span>
        <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lat_cess&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lon_onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">merged_onset_cess</span><span class="p">[</span><span class="s2">&quot;lon_cess&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">merged_onset_cess</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lat_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lat_cess&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_onset&quot;</span><span class="p">,</span> <span class="s2">&quot;lon_cess&quot;</span><span class="p">],</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># 4) Loop over (station, year) to compute rainy-day counts</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">stn</span><span class="p">,</span> <span class="n">yr</span><span class="p">),</span> <span class="n">subdf</span> <span class="ow">in</span> <span class="n">merged_onset_cess</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">]):</span>
            <span class="n">onset_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cess_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;cessation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lon_val</span> <span class="o">=</span> <span class="n">subdf</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Filter daily_df for this station and year</span>
            <span class="n">stn_year_data</span> <span class="o">=</span> <span class="n">daily_df</span><span class="p">[</span>
                <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">daily_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">yr</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Replace -99 with NaN</span>
            <span class="n">stn_year_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stn_year_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># Convert to array</span>
            <span class="n">x_values</span> <span class="o">=</span> <span class="n">stn_year_data</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># Apply count_rainy_days</span>
            <span class="n">nb_rainy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_rainy_days</span><span class="p">(</span>
                <span class="n">x_values</span><span class="p">,</span> <span class="n">onset_val</span><span class="p">,</span> <span class="n">cess_val</span><span class="p">,</span> <span class="n">rain_threshold</span>
            <span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">yr</span><span class="p">,</span>
                <span class="s2">&quot;station&quot;</span><span class="p">:</span> <span class="n">stn</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat_val</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon_val</span><span class="p">,</span>
                <span class="s2">&quot;nb_rainy_days&quot;</span><span class="p">:</span> <span class="n">nb_rainy</span>
            <span class="p">})</span>

        <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

        <span class="c1"># 5) Pivot to CPT format</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;nb_rainy_days&quot;</span><span class="p">)</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Build LAT and LON rows</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">lat_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">)</span>

        <span class="c1"># Concatenate LAT, LON, and pivot</span>
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_row</span><span class="p">,</span> <span class="n">lon_row</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>
</div>


        
<div class="viewcode-block" id="WAS_r95_99p">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_r95_99p</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the R95p and R99p climate indices using either:</span>
<span class="sd">    - Dask-enabled xarray for large raster/time-series</span>
<span class="sd">    - An &quot;insitu&quot; method for station-based (CDT) data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_period</span><span class="p">:</span> <span class="nb">slice</span><span class="p">,</span> <span class="n">season</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the R95p/R99p computation class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base_period : slice</span>
<span class="sd">            Base period for computing the percentiles, e.g., slice(&quot;1961-01-01&quot;, &quot;1990-12-31&quot;).</span>
<span class="sd">            This should be something like slice(&quot;YYYY-MM-DD&quot;, &quot;YYYY-MM-DD&quot;) or </span>
<span class="sd">            slice(&quot;YYYY&quot;, &quot;YYYY&quot;) if you only have year-level bounds.</span>
<span class="sd">        season : list, optional</span>
<span class="sd">            List of months to include in the analysis (e.g., [6, 7, 8] for JJA).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_period</span> <span class="o">=</span> <span class="n">base_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">season</span> <span class="o">=</span> <span class="n">season</span>

<div class="viewcode-block" id="WAS_r95_99p.transform_cdt">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p.transform_cdt">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_cdt</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a DataFrame in CDT format into a standardized long DataFrame.</span>

<span class="sd">        CDT format assumptions:</span>
<span class="sd">         - Row 0 = LON</span>
<span class="sd">         - Row 1 = LAT</span>
<span class="sd">         - Row 2 = ELEV</span>
<span class="sd">         - Rows 3+ = daily data with &#39;ID&#39; column holding dates in YYYYMMDD format.</span>

<span class="sd">        Returns a DataFrame with columns:</span>
<span class="sd">            [DATE, STATION, VALUE, LON, LAT, ELEV]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Extract metadata (first 3 rows)</span>
        <span class="c1">#    - &#39;ID&#39; column in these rows has labels [&quot;LON&quot;, &quot;LAT&quot;, &quot;ELEV&quot;]</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEV&quot;</span><span class="p">]</span>

        <span class="c1"># 2) Extract the daily data portion (from row 3 onward); rename &quot;ID&quot; -&gt; &quot;DATE&quot;</span>
        <span class="n">data_part</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="s2">&quot;DATE&quot;</span><span class="p">})</span>

        <span class="c1"># Melt to long format: columns = [&quot;DATE&quot;, &quot;STATION&quot;, &quot;VALUE&quot;]</span>
        <span class="n">data_long</span> <span class="o">=</span> <span class="n">data_part</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span>
            <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Merge station metadata</span>
        <span class="n">final_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">data_long</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;STATION&quot;</span><span class="p">)</span>

        <span class="c1"># Convert &quot;DATE&quot; from string YYYYMMDD to datetime</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fill missing rainfall values with -99.0</span>
        <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_df</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final_df</span></div>


    <span class="k">def</span> <span class="nf">_compute_percentile_index_insitu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_full</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal method that computes the &#39;Rxp&#39; index (R95p or R99p) for insitu data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_full : pd.DataFrame</span>
<span class="sd">            Must have columns [DATE, STATION, VALUE, LAT, LON, ELEV].</span>
<span class="sd">        percentile : float</span>
<span class="sd">            Percentile to compute (e.g., 95 for R95p or 99 for R99p).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_result : pd.DataFrame</span>
<span class="sd">            DataFrame with [year, station, lat, lon, rX_p_value],</span>
<span class="sd">            where rX_p_value is total precipitation above the threshold for each year.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Possibly filter by season</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">:</span>
            <span class="c1"># Keep only rows whose month is in self.season</span>
            <span class="n">df_full</span> <span class="o">=</span> <span class="n">df_full</span><span class="p">[</span><span class="n">df_full</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">)]</span>

        <span class="c1"># 2) Separate out the base period to compute thresholds</span>
        <span class="c1">#    self.base_period is typically something like slice(&quot;1961-01-01&quot;, &quot;1990-12-31&quot;)</span>
        <span class="c1">#    We&#39;ll interpret it so we can do: df_base = df_full[(df_full[&quot;DATE&quot;] &gt;= start) &amp; (df_full[&quot;DATE&quot;] &lt;= end)]</span>
        <span class="n">start_str</span><span class="p">,</span> <span class="n">end_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_period</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_period</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_str</span><span class="p">)</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_str</span><span class="p">)</span>
        <span class="n">df_base</span> <span class="o">=</span> <span class="n">df_full</span><span class="p">[(</span><span class="n">df_full</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_full</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">)]</span>

        <span class="c1"># 3) Compute day-of-year in both data sets</span>
        <span class="n">df_full</span><span class="p">[</span><span class="s2">&quot;DOY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_full</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="n">df_base</span><span class="p">[</span><span class="s2">&quot;DOY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_base</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>

        <span class="c1"># 4) For each station and day-of-year in the base period, compute the percentile threshold</span>
        <span class="c1">#    We&#39;ll group by (STATION, DOY) and compute np.nanpercentile</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_base</span><span class="p">[</span><span class="n">df_base</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># ignore negative placeholder</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;DOY&quot;</span><span class="p">])[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">percentile</span><span class="p">))</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;VALUE&quot;</span><span class="p">:</span> <span class="s2">&quot;THRESHOLD&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="c1"># Merge thresholds back into df_full on (STATION, DOY)</span>
        <span class="n">df_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_full</span><span class="p">,</span> 
            <span class="n">thresholds</span><span class="p">,</span> 
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;DOY&quot;</span><span class="p">],</span> 
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
        <span class="p">)</span>

        <span class="c1"># 5) Identify days exceeding that threshold and sum them up (precip total) by station &amp; year</span>
        <span class="c1">#    We&#39;ll also ignore negative precipitation (i.e. -99.0)</span>
        <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;EXCEEDS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;THRESHOLD&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">],</span>
            <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

        <span class="c1"># 6) Sum precipitation on those &quot;extreme&quot; days for each station-year</span>
        <span class="c1">#    Then keep lat/lon from the first occurrence (assuming station lat/lon is fixed)</span>
        <span class="n">df_result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_merged</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;EXCEEDS&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;EXCEEDS&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;R</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">p&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df_result</span>

<div class="viewcode-block" id="WAS_r95_99p.compute_insitu_r95p">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p.compute_insitu_r95p">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu_r95p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_cdt</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute R95p index (total precipitation on days above the daily 95th percentile)</span>
<span class="sd">        for station-based data in CDT format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_cdt : pd.DataFrame</span>
<span class="sd">            CDT-format DataFrame (rows 0..2 = LON/LAT/ELEV, row 3+ = daily data).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_final : pd.DataFrame</span>
<span class="sd">            A DataFrame in CPT format with the R95p values pivoted by station vs. year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Transform CDT to standard DataFrame</span>
        <span class="n">df_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">df_cdt</span><span class="p">)</span>

        <span class="c1"># 2) Compute R95p</span>
        <span class="n">df_r95</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_percentile_index_insitu</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span>

        <span class="c1"># 3) Pivot back to CPT format</span>
        <span class="c1">#    a) Station in columns, year in rows</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_r95</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;R95p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># b) Build LAT/LON rows, using first occurrence for each station</span>
        <span class="n">station_metadata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_r95</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># ensure same station order as pivot</span>
        <span class="p">)</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># c) Insert them above the pivoted DataFrame</span>
        <span class="n">lat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">lat_row</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">lon_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">lon_row</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_df</span><span class="p">,</span> <span class="n">lon_df</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_final</span></div>


<div class="viewcode-block" id="WAS_r95_99p.compute_insitu_r99p">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p.compute_insitu_r99p">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_insitu_r99p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_cdt</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute R99p index (total precipitation on days above the daily 99th percentile)</span>
<span class="sd">        for station-based data in CDT format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_cdt : pd.DataFrame</span>
<span class="sd">            CDT-format DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df_final : pd.DataFrame (CPT format)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Transform</span>
        <span class="n">df_full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_cdt</span><span class="p">(</span><span class="n">df_cdt</span><span class="p">)</span>

        <span class="c1"># 2) Compute R99p</span>
        <span class="n">df_r99</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_percentile_index_insitu</span><span class="p">(</span><span class="n">df_full</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span>

        <span class="c1"># 3) Pivot to CPT format</span>
        <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_r99</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;station&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;R99p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_pivot</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">station_metadata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_r99</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;station&quot;</span><span class="p">)[[</span><span class="s2">&quot;LAT&quot;</span><span class="p">,</span> <span class="s2">&quot;LON&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="p">)</span>
        <span class="n">lat_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="p">[</span><span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">lon_row</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">station_metadata</span><span class="p">[</span><span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">lat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">lat_row</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">lon_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">lon_row</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">lat_df</span><span class="p">,</span> <span class="n">lon_df</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_final</span></div>


    <span class="c1">#</span>
    <span class="c1"># The existing xarray-based methods for large raster data remain the same:</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="WAS_r95_99p.compute_r95p">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p.compute_r95p">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_r95p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">:</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Existing method for xarray-based data (unchanged).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_percentile_index</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_r95_99p.compute_r99p">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_r95_99p.compute_r99p">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_r99p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">:</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Existing method for xarray-based data (unchanged).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_percentile_index</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">99</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_compute_percentile_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pr</span><span class="p">:</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">,</span> <span class="n">percentile</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;xr.DataArray&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Existing private method for xarray-based data (unchanged).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Subset to base period</span>
        <span class="n">pr_base</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_period</span><span class="p">)</span>

        <span class="c1"># Apply seasonal filtering if specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pr_base</span> <span class="o">=</span> <span class="n">pr_base</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pr_base</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">season</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Compute the percentile for each day-of-year in the base period</span>
        <span class="n">pr_thresh</span> <span class="o">=</span> <span class="n">pr_base</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="n">percentile</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Broadcast threshold to full time dimension</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="n">threshold_broadcast</span> <span class="o">=</span> <span class="n">pr_thresh</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">dayofyear</span><span class="o">=</span><span class="n">doy</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Identify very wet days exceeding the threshold</span>
        <span class="n">extreme_days</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pr</span> <span class="o">&gt;</span> <span class="n">threshold_broadcast</span><span class="p">)</span>

        <span class="c1"># Sum precipitation on very wet days for each year</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">extreme_days</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

        
        
        

<span class="c1">#### look this part again -----</span>
<div class="viewcode-block" id="WAS_compute_HWSDI">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_HWSDI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the Heat Wave Severity Duration Index (HWSDI),</span>
<span class="sd">    including calculating TXin90 (90th percentile of daily max temperature) </span>
<span class="sd">    and annual counts of heatwave days with at least 6 consecutive hot days.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_compute_HWSDI.calculate_TXin90">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI.calculate_TXin90">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_TXin90</span><span class="p">(</span><span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the daily 90th percentile temperature (TXin90) centered on a 5-day window</span>
<span class="sd">        for each calendar day based on the base period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period (default is &#39;1990&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            TXin90 for each day of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter the data for the base period</span>
        <span class="n">base_period</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">))</span>

        <span class="c1"># Group by day of the year (DOY) and calculate the 90th percentile over a centered 5-day window</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="n">base_period</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="s2">&quot;window_dim&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;window_dim&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">TXin90</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_count_consecutive_days</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count sequences of at least `min_days` consecutive True values in a boolean array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray</span>
<span class="sd">            Boolean array.</span>
<span class="sd">        min_days : int</span>
<span class="sd">            Minimum number of consecutive True values to count as a sequence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Count of sequences with at least `min_days` consecutive True values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">current_streak</span> <span class="o">==</span> <span class="n">min_days</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="WAS_compute_HWSDI.count_hot_days">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI.count_hot_days">[docs]</a>
    <span class="k">def</span> <span class="nf">count_hot_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">TXin90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of days per year with at least 6 consecutive days</span>
<span class="sd">        where daily maximum temperature is above the 90th percentile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        TXin90 : xarray.DataArray</span>
<span class="sd">            90th percentile temperature for each day of the year.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Annual count of hot days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure TXin90 covers each day of the year by broadcasting</span>
        <span class="n">TXin90_full</span> <span class="o">=</span> <span class="n">TXin90</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">dayofyear</span><span class="o">=</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span>

        <span class="c1"># Find days where daily temperature exceeds the 90th percentile</span>
        <span class="n">hot_days</span> <span class="o">=</span> <span class="n">temperature_data</span> <span class="o">&gt;</span> <span class="n">TXin90_full</span>

        <span class="c1"># Convert to integer (1 for hot day, 0 otherwise) and group by year</span>
        <span class="n">hot_days_per_year</span> <span class="o">=</span> <span class="n">hot_days</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span>

        <span class="c1"># Count sequences of at least 6 consecutive hot days within each year</span>
        <span class="n">annual_hot_days_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_count_consecutive_days</span><span class="p">(</span><span class="n">year_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> 
                <span class="k">for</span> <span class="n">year_data</span> <span class="ow">in</span> <span class="n">hot_days_per_year</span>
            <span class="p">]),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">hot_days_per_year</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())},</span>
            <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;year&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">annual_hot_days_count</span></div>


<div class="viewcode-block" id="WAS_compute_HWSDI.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Heat Wave Severity Duration Index (HWSDI) for each pixel</span>
<span class="sd">        in a given daily temperature DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature data, coords = (T, Y, X).</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period for TXin90 calculation (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period for TXin90 calculation (default is &#39;1990&#39;).</span>
<span class="sd">        nb_cores : int, optional</span>
<span class="sd">            Number of parallel processes to use (default is 4).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            HWSDI computed for each pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rename &#39;T&#39; dimension to &#39;time&#39; so dayofyear and year grouping work as expected</span>
        <span class="n">temperature_data</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>

        <span class="c1"># Compute TXin90</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_TXin90</span><span class="p">(</span><span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">)</span>

        <span class="c1"># Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># Set up parallel processing</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply function</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count_hot_days</span><span class="p">,</span>
            <span class="n">temperature_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
            <span class="n">TXin90</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;dayofyear&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;year&#39;</span><span class="p">,)],</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result_</span></div>
</div>




<div class="viewcode-block" id="WAS_compute_HWSDI_monthly">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_monthly">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_HWSDI_monthly</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the Heat Wave Severity Duration Index (HWSDI) **monthly**,</span>
<span class="sd">    calculating TXin90 (90th percentile of daily max temperature) and counting heatwave days</span>
<span class="sd">    for each month with at least 6 consecutive hot days.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_compute_HWSDI_monthly.calculate_TXin90">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_monthly.calculate_TXin90">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_TXin90</span><span class="p">(</span><span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the monthly 90th percentile temperature (TXin90) centered on a 5-day window</span>
<span class="sd">        for each calendar day based on the base period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period (default is &#39;1990&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            TXin90 for each month of the year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter data for the base period</span>
        <span class="n">base_period</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">))</span>

        <span class="c1"># Compute the rolling 90th percentile temperature for each **month**</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="n">base_period</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="s2">&quot;window_dim&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;window_dim&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">TXin90</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_count_consecutive_days</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count sequences of at least `min_days` consecutive True values in a boolean array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray</span>
<span class="sd">            Boolean array.</span>
<span class="sd">        min_days : int</span>
<span class="sd">            Minimum number of consecutive True values to count as a sequence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Count of sequences with at least `min_days` consecutive True values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">current_streak</span> <span class="o">==</span> <span class="n">min_days</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="WAS_compute_HWSDI_monthly.count_hot_days">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_monthly.count_hot_days">[docs]</a>
    <span class="k">def</span> <span class="nf">count_hot_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">TXin90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of days per month with at least 6 consecutive days</span>
<span class="sd">        where daily maximum temperature is above the 90th percentile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        TXin90 : xarray.DataArray</span>
<span class="sd">            90th percentile temperature for each month.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Monthly count of hot days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure TXin90 covers each month by broadcasting</span>
        <span class="n">TXin90_full</span> <span class="o">=</span> <span class="n">TXin90</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span>

        <span class="c1"># Find days where daily temperature exceeds the 90th percentile</span>
        <span class="n">hot_days</span> <span class="o">=</span> <span class="n">temperature_data</span> <span class="o">&gt;</span> <span class="n">TXin90_full</span>

        <span class="c1"># Convert to integer (1 for hot day, 0 otherwise) and group by month</span>
        <span class="n">hot_days_per_month</span> <span class="o">=</span> <span class="n">hot_days</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span>

        <span class="c1"># Count sequences of at least 6 consecutive hot days within each month</span>
        <span class="n">monthly_hot_days_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_count_consecutive_days</span><span class="p">(</span><span class="n">month_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> 
                <span class="k">for</span> <span class="n">month_data</span> <span class="ow">in</span> <span class="n">hot_days_per_month</span>
            <span class="p">]),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">hot_days_per_month</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())},</span>
            <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;month&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">monthly_hot_days_count</span></div>


<div class="viewcode-block" id="WAS_compute_HWSDI_monthly.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_monthly.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Monthly Heat Wave Severity Duration Index (HWSDI)</span>
<span class="sd">        for each pixel in a given daily temperature DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature data, coords = (T, Y, X).</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period for TXin90 calculation (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period for TXin90 calculation (default is &#39;1990&#39;).</span>
<span class="sd">        nb_cores : int, optional</span>
<span class="sd">            Number of parallel processes to use (default is 4).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            HWSDI computed for each pixel per month.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rename &#39;T&#39; dimension to &#39;time&#39; so month grouping works as expected</span>
        <span class="n">temperature_data</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>

        <span class="c1"># Compute TXin90</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_TXin90</span><span class="p">(</span><span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">)</span>

        <span class="c1"># Prepare chunk sizes for parallel processing</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># Set up parallel processing</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply function in parallel</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count_hot_days</span><span class="p">,</span>
            <span class="n">temperature_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
            <span class="n">TXin90</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;month&#39;</span><span class="p">,)],</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result_</span></div>
</div>



<div class="viewcode-block" id="WAS_compute_HWSDI_Seasonal">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_Seasonal">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_compute_HWSDI_Seasonal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to compute the Heat Wave Severity Duration Index (HWSDI) for a given season.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_compute_HWSDI_Seasonal.calculate_TXin90">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_Seasonal.calculate_TXin90">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_TXin90</span><span class="p">(</span><span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="n">season</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the daily 90th percentile temperature (TXin90) for each calendar day </span>
<span class="sd">        based on the base period, but only considering the specified season.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period (default is &#39;1990&#39;).</span>
<span class="sd">        season : list, optional</span>
<span class="sd">            List of months to include in the calculation (default is [6, 7, 8] for JJA).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            TXin90 for each day of the selected season.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter the data for the base period and only the selected season</span>
        <span class="n">base_period</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">))</span>
        <span class="n">seasonal_data</span> <span class="o">=</span> <span class="n">base_period</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">base_period</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">season</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Group by day of the year (DOY) and calculate the 90th percentile</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="n">seasonal_data</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="s2">&quot;window_dim&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;window_dim&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">TXin90</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_count_consecutive_days</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count sequences of at least `min_days` consecutive True values in a boolean array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray</span>
<span class="sd">            Boolean array.</span>
<span class="sd">        min_days : int</span>
<span class="sd">            Minimum number of consecutive True values to count as a sequence.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Count of sequences with at least `min_days` consecutive True values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">current_streak</span> <span class="o">==</span> <span class="n">min_days</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_streak</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="WAS_compute_HWSDI_Seasonal.count_hot_days">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_Seasonal.count_hot_days">[docs]</a>
    <span class="k">def</span> <span class="nf">count_hot_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">TXin90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Count the number of days per season with at least 6 consecutive days</span>
<span class="sd">        where daily maximum temperature is above the 90th percentile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature with time dimension.</span>
<span class="sd">        TXin90 : xarray.DataArray</span>
<span class="sd">            90th percentile temperature for each day of the year.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Seasonal count of hot days.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure TXin90 covers each day of the season by broadcasting</span>
        <span class="n">TXin90_full</span> <span class="o">=</span> <span class="n">TXin90</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">dayofyear</span><span class="o">=</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span>

        <span class="c1"># Find days where daily temperature exceeds the 90th percentile</span>
        <span class="n">hot_days</span> <span class="o">=</span> <span class="n">temperature_data</span> <span class="o">&gt;</span> <span class="n">TXin90_full</span>

        <span class="c1"># Convert to integer (1 for hot day, 0 otherwise) and group by year</span>
        <span class="n">hot_days_per_year</span> <span class="o">=</span> <span class="n">hot_days</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.year&quot;</span><span class="p">)</span>

        <span class="c1"># Count sequences of at least 6 consecutive hot days within each season</span>
        <span class="n">seasonal_hot_days_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_count_consecutive_days</span><span class="p">(</span><span class="n">year_data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">min_days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> 
                <span class="k">for</span> <span class="n">year_data</span> <span class="ow">in</span> <span class="n">hot_days_per_year</span>
            <span class="p">]),</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">hot_days_per_year</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())},</span>
            <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;year&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">seasonal_hot_days_count</span></div>


<div class="viewcode-block" id="WAS_compute_HWSDI_Seasonal.compute">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_compute_predictand.WAS_compute_HWSDI_Seasonal.compute">[docs]</a>
    <span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="o">=</span><span class="s1">&#39;1961&#39;</span><span class="p">,</span> <span class="n">base_period_end</span><span class="o">=</span><span class="s1">&#39;1990&#39;</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">season</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the HWSDI for each pixel in a given daily temperature DataArray for a specific season.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        temperature_data : xarray.DataArray</span>
<span class="sd">            Daily maximum temperature data, coords = (T, Y, X).</span>
<span class="sd">        base_period_start : str, optional</span>
<span class="sd">            Start year of the base period for TXin90 calculation (default is &#39;1961&#39;).</span>
<span class="sd">        base_period_end : str, optional</span>
<span class="sd">            End year of the base period for TXin90 calculation (default is &#39;1990&#39;).</span>
<span class="sd">        nb_cores : int, optional</span>
<span class="sd">            Number of parallel processes to use (default is 4).</span>
<span class="sd">        season : list, optional</span>
<span class="sd">            List of months to include in the calculation (default is [6, 7, 8] for JJA).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            HWSDI computed for each pixel for the given season.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Rename &#39;T&#39; dimension to &#39;time&#39; so dayofyear and year grouping work as expected</span>
        <span class="n">temperature_data</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">})</span>

        <span class="c1"># Filter data to only include selected season</span>
        <span class="n">seasonal_temperature_data</span> <span class="o">=</span> <span class="n">temperature_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">season</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Compute TXin90 based on the season</span>
        <span class="n">TXin90</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_TXin90</span><span class="p">(</span><span class="n">seasonal_temperature_data</span><span class="p">,</span> <span class="n">base_period_start</span><span class="p">,</span> <span class="n">base_period_end</span><span class="p">,</span> <span class="n">season</span><span class="p">)</span>

        <span class="c1"># Prepare chunk sizes</span>
        <span class="n">chunksize_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>
        <span class="n">chunksize_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">nb_cores</span><span class="p">))</span>

        <span class="c1"># Set up parallel processing</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Apply function</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count_hot_days</span><span class="p">,</span>
            <span class="n">seasonal_temperature_data</span><span class="o">.</span><span class="n">chunk</span><span class="p">({</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">chunksize_y</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">chunksize_x</span><span class="p">}),</span>
            <span class="n">TXin90</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;time&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;dayofyear&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;year&#39;</span><span class="p">,)],</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">result_</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result_</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>