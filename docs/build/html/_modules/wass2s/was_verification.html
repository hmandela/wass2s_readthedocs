

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_verification &mdash; wass2s 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">wass2s api</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_verification</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_verification</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">linregress</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">resample</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">gamma</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">import</span> <span class="nn">properscoring</span>
<span class="kn">import</span> <span class="nn">xskillscore</span> <span class="k">as</span> <span class="nn">xs</span>
<span class="kn">from</span> <span class="nn">wass2s.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>

<div class="viewcode-block" id="WAS_Verification">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_Verification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verification class for evaluating weather and climate forecasts.</span>

<span class="sd">    Provides methods to compute deterministic, probabilistic, and ensemble-based metrics,</span>
<span class="sd">    as well as visualization tools for model performance assessment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dist_method : str, optional</span>
<span class="sd">        Distribution method for tercile probability calculations</span>
<span class="sd">        (&#39;t&#39;, &#39;gamma&#39;, &#39;nonparam&#39;, &#39;normal&#39;, &#39;lognormal&#39;, &#39;weibull_min&#39;). Default is &#39;gamma&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;KGE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Kling Gupta Efficiency&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kling_gupta_efficiency</span><span class="p">),</span>
            <span class="s2">&quot;Pearson&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Pearson Correlation&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_corr</span><span class="p">),</span>
            <span class="s2">&quot;IOA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Index Of Agreement&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_of_agreement</span><span class="p">),</span>
            <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Mean Absolute Error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">),</span>
            <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Root Mean Square Error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_mean_square_error</span><span class="p">),</span>
            <span class="s2">&quot;NSE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nash Sutcliffe Efficiency&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nash_sutcliffe_efficiency</span><span class="p">),</span>
            <span class="s2">&quot;TAYLOR_DIAGRAM&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Taylor Diagram&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_det_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taylor_diagram</span><span class="p">),</span>
            <span class="s2">&quot;GROC&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Generalized Discrimination Score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_groc</span><span class="p">),</span>
            <span class="s2">&quot;RPSS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Ranked Probability Skill Score&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rpss</span><span class="p">),</span>
            <span class="s2">&quot;IGS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Ignorance Score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignorance_score</span><span class="p">),</span>
            <span class="s2">&quot;RES&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Resolution&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution_score_grid</span><span class="p">),</span>
            <span class="s2">&quot;REL&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Reliability&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reliability_score_grid</span><span class="p">),</span>
            <span class="s2">&quot;RELIABILITY_DIAGRAM&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Reliability Diagram&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reliability_diagram</span><span class="p">),</span>
            <span class="s2">&quot;ROC_CURVE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;ROC CURVE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_roc_curves</span><span class="p">),</span>
            <span class="s2">&quot;CRPS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Continuous Ranked Probability Score with the ensemble distribution&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_crps</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">=</span> <span class="n">dist_method</span>

<div class="viewcode-block" id="WAS_Verification.get_scores_metadata">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.get_scores_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_scores_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve metadata for all available scoring metrics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing score names as keys and tuples of metadata</span>
<span class="sd">            (description, min_value, max_value, score_type, colormap, function) as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Deterministic Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.kling_gupta_efficiency">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.kling_gupta_efficiency">[docs]</a>
    <span class="k">def</span> <span class="nf">kling_gupta_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Kling-Gupta Efficiency (KGE) metric.</span>

<span class="sd">        KGE combines correlation, bias, and variability ratios to assess model performance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            KGE score, ranging from -Inf to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">y_pred_clean</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.pearson_corr">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.pearson_corr">[docs]</a>
    <span class="k">def</span> <span class="nf">pearson_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Pearson Correlation Coefficient.</span>

<span class="sd">        Measures the linear correlation between observed and predicted values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Pearson correlation coefficient, ranging from -1 to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">y_pred_clean</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.index_of_agreement">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.index_of_agreement">[docs]</a>
    <span class="k">def</span> <span class="nf">index_of_agreement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Index of Agreement (IOA).</span>

<span class="sd">        Measures the degree of model prediction accuracy relative to observed variability.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            IOA score, ranging from 0 to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_pred_clean</span> <span class="o">-</span> <span class="n">y_true_clean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">))</span> <span class="o">+</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.mean_absolute_error">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.mean_absolute_error">[docs]</a>
    <span class="k">def</span> <span class="nf">mean_absolute_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Mean Absolute Error (MAE).</span>

<span class="sd">        Measures the average magnitude of errors in predictions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            MAE value, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">mae</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.root_mean_square_error">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.root_mean_square_error">[docs]</a>
    <span class="k">def</span> <span class="nf">root_mean_square_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Root Mean Square Error (RMSE).</span>

<span class="sd">        Measures the square root of the average squared errors in predictions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RMSE value, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rmse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.nash_sutcliffe_efficiency">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.nash_sutcliffe_efficiency">[docs]</a>
    <span class="k">def</span> <span class="nf">nash_sutcliffe_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Nash-Sutcliffe Efficiency (NSE).</span>

<span class="sd">        Measures the predictive skill of the model compared to the mean of observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            NSE score, ranging from -Inf to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nse</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.taylor_diagram">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.taylor_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">taylor_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Placeholder for Taylor Diagram visualization.</span>

<span class="sd">        Visualizes model performance in terms of correlation, standard deviation, and RMSE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Implementation pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="WAS_Verification.compute_deterministic_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_deterministic_score">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_deterministic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_func</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a deterministic scoring function over xarray DataArrays.</span>

<span class="sd">        Computes the specified metric across the time dimension for each grid point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        score_func : callable</span>
<span class="sd">            Scoring function to apply (e.g., pearson_corr, kling_gupta_efficiency).</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        pred : xarray.DataArray</span>
<span class="sd">            Predicted data with dimensions (T, Y, X).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">score_func</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Probabilistic Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.classify">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify">[docs]</a>
    <span class="k">def</span> <span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify data into terciles based on climatological thresholds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y : array-like</span>
<span class="sd">            Input data to classify.</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - y_class : array-like</span>
<span class="sd">                Classified data (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">            - tercile_33 : float</span>
<span class="sd">                33rd percentile threshold.</span>
<span class="sd">            - tercile_67 : float</span>
<span class="sd">                67th percentile threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y_class</span><span class="p">,</span> <span class="n">terciles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">terciles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.compute_class">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_class">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile class labels for observed data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Classified data with dimensions (T, Y, X), where values are</span>
<span class="sd">            0 (below-normal), 1 (near-normal), or 2 (above-normal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">Predictant_class</span><span class="p">,</span> <span class="n">tercile_33</span><span class="p">,</span> <span class="n">tercile_67</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">,</span>
            <span class="n">Predictant</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index_start&#39;</span><span class="p">:</span> <span class="n">index_start</span><span class="p">,</span> <span class="s1">&#39;index_end&#39;</span><span class="p">:</span> <span class="n">index_end</span><span class="p">},</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Predictant_class</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Verification.classify_data_into_terciles">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify_data_into_terciles">[docs]</a>
    <span class="k">def</span> <span class="nf">classify_data_into_terciles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify data into terciles based on given thresholds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y : array-like</span>
<span class="sd">            Input data to classify.</span>
<span class="sd">        T1 : float</span>
<span class="sd">            First tercile threshold (33rd percentile).</span>
<span class="sd">        T2 : float</span>
<span class="sd">            Second tercile threshold (67th percentile).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            Classified data (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">classified_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">classified_data</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">classified_data</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">classified_data</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">T1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">T2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">classified_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_groc">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_groc">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_groc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Generalized Receiver Operating Characteristic (GROC) score.</span>

<span class="sd">        Averages the Area Under the Curve (AUC) for each tercile category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        n_classes : int, optional</span>
<span class="sd">            Number of classes (default is 3 for terciles).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            GROC score, ranging from 0 to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">groc</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
                <span class="n">y_true_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_clean_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_i</span><span class="p">,</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">groc</span> <span class="o">+=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">groc</span> <span class="o">/</span> <span class="n">n_classes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_rpss">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_rpss">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_rpss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ranked Probability Skill Score (RPSS).</span>

<span class="sd">        Compares the Ranked Probability Score (RPS) of the forecast to a climatological reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RPSS score, ranging from -Inf to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])],</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">one_hot_encoded_outcomes</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">cumulative_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">y_probs_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">one_hot_encoded_outcomes</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cumulative_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">climatology</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumulative_outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">one_hot_encoded_outcomes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rps_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_forecast</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rps_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_reference</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">rps_forecast</span> <span class="o">/</span> <span class="n">rps_reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.ignorance_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.ignorance_score">[docs]</a>
    <span class="k">def</span> <span class="nf">ignorance_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ignorance Score based on Weijs (2010).</span>

<span class="sd">        Measures the logarithmic loss of forecast probabilities for the true category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Ignorance score, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">y_true_clean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ignorance_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">y_true_clean_category</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">y_true_clean_category</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ignorance_sum</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ignorance_sum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">ignorance_sum</span> <span class="o">/</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.resolution_score_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_score_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">resolution_score_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span>
                             <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                            <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                            <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.700</span><span class="p">,</span> <span class="mf">0.750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                            <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Resolution Score on a grid based on Weijs (2010).</span>

<span class="sd">        Measures the ability of the forecast to distinguish between different outcomes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Resolution score, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y_bar</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">)]</span>
        <span class="n">resolution_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">resolution_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolution_sum</span></div>


<div class="viewcode-block" id="WAS_Verification.reliability_score_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.reliability_score_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">reliability_score_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span>
                              <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                             <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                             <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.700</span><span class="p">,</span> <span class="mf">0.750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                             <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Reliability Score on a grid based on Weijs (2010).</span>

<span class="sd">        Measures the calibration of forecast probabilities against observed frequencies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Reliability score. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">reliability_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">reliability_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reliability_sum</span></div>


<div class="viewcode-block" id="WAS_Verification.resolution_and_reliability_over_all_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_and_reliability_over_all_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">resolution_and_reliability_over_all_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span>
                                                <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                                               <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                                               <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.700</span><span class="p">,</span> <span class="mf">0.750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                                               <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Resolution and Reliability scores over all grid points.</span>

<span class="sd">        Based on Weijs (2010), computes scores by aggregating across all grid points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dir_to_save_score : str or Path</span>
<span class="sd">            Directory to save score outputs.</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - resolution_sum : float</span>
<span class="sd">                Aggregated resolution score.</span>
<span class="sd">            - reliability_sum : float</span>
<span class="sd">                Aggregated reliability score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_classes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y_bar</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">)]</span>
        <span class="n">resolution_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">resolution_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="n">reliability_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">reliability_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolution_sum</span><span class="p">,</span> <span class="n">reliability_sum</span></div>


<div class="viewcode-block" id="WAS_Verification.reliability_diagram">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.reliability_diagram">[docs]</a>
    <span class="k">def</span> <span class="nf">reliability_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span>
                           <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                          <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.700</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Reliability Diagrams for probabilistic forecasts.</span>

<span class="sd">        Visualizes the calibration of forecast probabilities against observed frequencies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        modelname : str</span>
<span class="sd">            Name of the model for labeling the plot.</span>
<span class="sd">        dir_to_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Below-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-normal&quot;</span><span class="p">]</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_classes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">resolution</span><span class="p">,</span> <span class="n">reliability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution_and_reliability_over_all_grid</span><span class="p">(</span>
            <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">bins</span>
        <span class="p">)</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">observed_freqs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)}</span>
        <span class="n">forecast_counts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predicted_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">tercile</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">observed_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">bin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">bin_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_index</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">bin_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="o">==</span> <span class="n">tercile</span><span class="p">:</span>
                    <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">bin_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">],</span>
                <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">],</span>
                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Below-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-normal&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reliability Curve&quot;</span><span class="p">)</span>
            <span class="n">non_zero_mask</span> <span class="o">=</span> <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">non_zero_mask</span><span class="p">):</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">non_zero_mask</span><span class="p">],</span> <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">non_zero_mask</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Regression Fit&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perfect Reliability&quot;</span><span class="p">)</span>
            <span class="n">total_observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observed_classes</span> <span class="o">==</span> <span class="n">tercile</span><span class="p">)</span>
            <span class="n">total_forecasts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">)</span>
            <span class="n">relative_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_observed</span> <span class="o">/</span> <span class="n">total_forecasts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">relative_frequency</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Relative Frequency&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">relative_frequency</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">no_skill_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">no_skill_y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">no_skill_x</span> <span class="o">+</span> <span class="n">relative_frequency</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No Skill Line&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">no_skill_x</span> <span class="o">&lt;=</span> <span class="n">relative_frequency</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">no_skill_x</span> <span class="o">&gt;=</span> <span class="n">relative_frequency</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;REL: </span><span class="si">{</span><span class="n">reliability</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.71</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RES: </span><span class="si">{</span><span class="n">resolution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_forecasts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">tercile</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Forecast Probability (%)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Observed Relative Frequency (%)&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Reliability Diagrams&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">/RELIABILITY_</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">_.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.plot_roc_curves">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_roc_curves">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_roc_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span>
                        <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot ROC Curves with Confidence Intervals for probabilistic forecasts.</span>

<span class="sd">        Visualizes the Receiver Operating Characteristic for each tercile category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        modelname : str</span>
<span class="sd">            Name of the model for labeling the plot.</span>
<span class="sd">        dir_to_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        n_bootstraps : int, optional</span>
<span class="sd">            Number of bootstrap samples for confidence intervals. Default is 200.</span>
<span class="sd">        ci : float, optional</span>
<span class="sd">            Confidence interval level (e.g., 0.95 for 95%). Default is 0.95.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Below-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-normal&quot;</span><span class="p">]</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">binary_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_outcomes</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">binary_labels</span><span class="p">,</span> <span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
            <span class="n">tprs_bootstrap</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mean_fpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">boot_binary_labels</span> <span class="o">=</span> <span class="n">binary_labels</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">boot_predicted_probs</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">boot_binary_labels</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">boot_fpr</span><span class="p">,</span> <span class="n">boot_tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">boot_binary_labels</span><span class="p">,</span> <span class="n">boot_predicted_probs</span><span class="p">)</span>
                <span class="n">interp_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mean_fpr</span><span class="p">,</span> <span class="n">boot_fpr</span><span class="p">,</span> <span class="n">boot_tpr</span><span class="p">)</span>
                <span class="n">interp_tpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">tprs_bootstrap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_tpr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tprs_bootstrap</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid bootstrap samples for </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> category.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tprs_bootstrap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">)</span>
            <span class="n">mean_tpr</span> <span class="o">=</span> <span class="n">tprs_bootstrap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mean_tpr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">lower_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upper_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">mean_fpr</span><span class="p">,</span> <span class="n">lower_tpr</span><span class="p">,</span> <span class="n">upper_tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">ci</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">% CI&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Skill&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ROC Curve for </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> Category&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC Curves for </span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">/ROC_</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">_.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Ensemble Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.compute_crps">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_crps">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_crps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Continuous Ranked Probability Score (CRPS) for ensemble forecasts.</span>

<span class="sd">        Measures the difference between the forecast ensemble distribution and observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_pred : xarray.DataArray</span>
<span class="sd">            Ensemble forecast data with dimensions (T, number, Y, X).</span>
<span class="sd">        member_dim : str, optional</span>
<span class="sd">            Dimension name for ensemble members. Default is &#39;number&#39;.</span>
<span class="sd">        dim : str, optional</span>
<span class="sd">            Dimension to compute CRPS over (typically time). Default is &#39;T&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            CRPS values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xs</span><span class="o">.</span><span class="n">crps_ensemble</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="n">member_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Probabilistic Scoring</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.compute_probabilistic_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_probabilistic_score">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_probabilistic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_func</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a probabilistic scoring function over xarray DataArrays.</span>

<span class="sd">        Computes the specified probabilistic metric across the time dimension for each grid point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        score_func : callable</span>
<span class="sd">            Probabilistic scoring function to apply (e.g., calculate_rpss, calculate_groc).</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        prob_pred : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">score_func</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">prob_pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index_start&#39;</span><span class="p">:</span> <span class="n">index_start</span><span class="p">,</span> <span class="s1">&#39;index_end&#39;</span><span class="p">:</span> <span class="n">index_end</span><span class="p">},</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Plotting Utilities</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.plot_model_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_model_score">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_model_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_metric</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">dir_save_score</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="s2">&quot;WAS_MLR&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a deterministic score on a map.</span>

<span class="sd">        Creates a geographical plot of the specified metric for a single model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_metric : xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        score : str</span>
<span class="sd">            Name of the score to plot (e.g., &#39;Pearson&#39;, &#39;MAE&#39;).</span>
<span class="sd">        dir_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        figure_name : str, optional</span>
<span class="sd">            Prefix for the figure filename. Default is &#39;WAS_MLR&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_save_score</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_save_score</span><span class="p">)</span>
        <span class="n">dir_save_score</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">score_meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">model_metric</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">figure_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                              <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">])</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir_save_score</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">figure_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.plot_models_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_models_score">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_models_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_metrics</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">dir_save_score</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple model scores on a grid of maps.</span>

<span class="sd">        Creates a subplot grid with geographical plots for each model&#39;s score.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_metrics : dict</span>
<span class="sd">            Dictionary of model names and their corresponding score DataArrays (Y, X).</span>
<span class="sd">        score : str</span>
<span class="sd">            Name of the score to plot (e.g., &#39;Pearson&#39;, &#39;MAE&#39;).</span>
<span class="sd">        dir_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_save_score</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_save_score</span><span class="p">)</span>
        <span class="n">dir_save_score</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">score_meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
        <span class="n">n_scores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_scores</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_scores</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()}</span>
        <span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.12</span><span class="p">,</span>
                                  <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir_save_score</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">_all_models.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># GCM Validation</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using Student&#39;s t-distribution.</span>

<span class="sd">        Computes probabilities for below-normal, normal, and above-normal categories.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_variance : array-like</span>
<span class="sd">            Variance of forecast errors.</span>
<span class="sd">        first_tercile : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        second_tercile : array-like</span>
<span class="sd">            Second tercile threshold values.</span>
<span class="sd">        dof : int</span>
<span class="sd">            Degrees of freedom for the t-distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">first_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>
            <span class="n">second_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">second_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_weibull_min">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_weibull_min">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_weibull_min</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using Weibull minimum distribution.</span>

<span class="sd">        Assumes `best_guess` as the location, `error_std` as the scale, and `dof` as the shape parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_variance : array-like</span>
<span class="sd">            Variance of forecast errors.</span>
<span class="sd">        first_tercile : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        second_tercile : array-like</span>
<span class="sd">            Second tercile threshold values.</span>
<span class="sd">        dof : float or array-like</span>
<span class="sd">            Shape parameter for the Weibull minimum distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> \
                              <span class="n">stats</span><span class="o">.</span><span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_gamma">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_gamma">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_gamma</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using Gamma distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_variance : array-like</span>
<span class="sd">            Variance of forecast errors.</span>
<span class="sd">        T1 : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        T2 : array-like</span>
<span class="sd">            Second tercile threshold values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>
        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>
        <span class="n">cdf_t1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">cdf_t2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t2</span> <span class="o">-</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_t2</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_nonparametric">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_nonparametric">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_nonparametric</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_samples</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using a non-parametric method.</span>

<span class="sd">        Uses historical error samples to estimate probabilities empirically.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_samples : array-like</span>
<span class="sd">            Historical error samples.</span>
<span class="sd">        first_tercile : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        second_tercile : array-like</span>
<span class="sd">            Second tercile threshold values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_samples</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">first_tercile</span><span class="p">)</span>
            <span class="n">p_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">first_tercile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">second_tercile</span><span class="p">))</span>
            <span class="n">p_above</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_below</span> <span class="o">+</span> <span class="n">p_between</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_below</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_between</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_above</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_normal">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_normal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_normal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using Normal distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_variance : array-like</span>
<span class="sd">            Variance of forecast errors.</span>
<span class="sd">        first_tercile : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        second_tercile : array-like</span>
<span class="sd">            Second tercile threshold values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> \
                              <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_lognormal">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_lognormal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_lognormal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate tercile probabilities using Lognormal distribution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        best_guess : array-like</span>
<span class="sd">            Forecast or best-guess values.</span>
<span class="sd">        error_variance : array-like</span>
<span class="sd">            Variance of forecast errors.</span>
<span class="sd">        first_tercile : array-like</span>
<span class="sd">            First tercile threshold values.</span>
<span class="sd">        second_tercile : array-like</span>
<span class="sd">            Second tercile threshold values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pred_prob : np.ndarray</span>
<span class="sd">            Array of shape (3, n_time) with probabilities for below, normal, and above categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> \
                          <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_compute_prob_ensemble_method">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_compute_prob_ensemble_method">[docs]</a>
    <span class="k">def</span> <span class="nf">gcm_compute_prob_ensemble_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">ensemble</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute probabilistic forecasts for GCM ensemble data.</span>

<span class="sd">        Uses the specified ensemble statistic to derive best-guess forecasts and computes</span>
<span class="sd">        tercile probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Obs_data : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        model_data : xarray.DataArray</span>
<span class="sd">            Model ensemble data with dimensions (T, number, Y, X).</span>
<span class="sd">        ensemble : str, optional</span>
<span class="sd">            Ensemble statistic to use (&#39;mean&#39; or other supported methods). Default is &#39;mean&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Tercile probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">best_guess_member</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
        <span class="n">error_variance_member</span> <span class="o">=</span> <span class="p">(</span><span class="n">Obs_data</span> <span class="o">-</span> <span class="n">model_data</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
        <span class="n">model_data_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span><span class="p">,</span>
            <span class="n">best_guess_member</span><span class="p">,</span>
            <span class="n">error_variance_member</span><span class="p">,</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">model_data_prob</span> <span class="o">=</span> <span class="n">model_data_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_data_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_compute_prob">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_compute_prob">[docs]</a>
    <span class="k">def</span> <span class="nf">gcm_compute_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile probabilities for GCM hindcasts.</span>

<span class="sd">        Supports multiple distribution methods for calculating probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic hindcast data with dimensions (T, Y, X).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Tercile probabilities with dimensions (probability, T, Y, X), where</span>
<span class="sd">            &#39;probability&#39; includes [&#39;PB&#39;, &#39;PN&#39;, &#39;PA&#39;] (below-normal, normal, above-normal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;weibull_min&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_weibull_min</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_normal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_lognormal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">. Choose &#39;t&#39;, &#39;gamma&#39;, &#39;normal&#39;, &#39;lognormal&#39;, or &#39;nonparam&#39;.&quot;</span><span class="p">)</span>
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_validation_compute_">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_validation_compute_">[docs]</a>
    <span class="k">def</span> <span class="nf">gcm_validation_compute_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_variable</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="p">,</span> <span class="n">lead_time</span><span class="p">,</span>
                               <span class="n">dir_model</span><span class="p">,</span> <span class="n">Obs</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span>
                               <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate GCM forecasts using specified metrics.</span>

<span class="sd">        Computes deterministic, probabilistic, or ensemble scores for GCM hindcasts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center_variable : list of str</span>
<span class="sd">            List of model identifiers (e.g., &#39;center.variable&#39;).</span>
<span class="sd">        month_of_initialization : int</span>
<span class="sd">            Month of forecast initialization (1-12).</span>
<span class="sd">        lead_time : list of int</span>
<span class="sd">            Lead times in months for the forecast season.</span>
<span class="sd">        dir_model : str or Path</span>
<span class="sd">            Directory containing model hindcast files.</span>
<span class="sd">        Obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        year_start : int</span>
<span class="sd">            Start year of the validation period.</span>
<span class="sd">        year_end : int</span>
<span class="sd">            End year of the validation period.</span>
<span class="sd">        clim_year_start : int</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        area : str</span>
<span class="sd">            Geographical area for validation (not used in current implementation).</span>
<span class="sd">        score : str</span>
<span class="sd">            Score to compute (e.g., &#39;Pearson&#39;, &#39;RPSS&#39;, &#39;ROC_CURVE&#39;).</span>
<span class="sd">        dir_to_save_roc_reliability : str or Path</span>
<span class="sd">            Directory to save ROC and reliability plots.</span>
<span class="sd">        ensemble_mean : str, optional</span>
<span class="sd">            Ensemble statistic to use if needed (e.g., &#39;mean&#39;). Default is None.</span>
<span class="sd">        gridded : bool, optional</span>
<span class="sd">            Whether to perform gridded validation. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or None</span>
<span class="sd">            Dictionary of model scores with keys as model identifiers and values as xarray.DataArray,</span>
<span class="sd">            or None for plotting scores (e.g., ROC_CURVE, RELIABILITY_DIAGRAM).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">center_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_metric</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">gridded</span><span class="p">:</span>
            <span class="n">Obs_data_</span> <span class="o">=</span> <span class="n">Obs</span>
            <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="n">mean_rainfall</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">mask_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean_rainfall</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mask_</span> <span class="o">=</span> <span class="n">mask_</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mask_</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">:</span>
                <span class="n">score_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">model_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_model</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                <span class="n">model_data_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
                <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
                <span class="n">year_start_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year_end_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Obs_data</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_</span><span class="p">)))</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">Y</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
                <span class="n">Obs_data</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data_</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;det_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_deterministic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_probabilistic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble score does not require an ensemble mean or median.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_crps</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                        <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;ROC_CURVE&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_roc_curves</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                             <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;RELIABILITY_DIAGRAM&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reliability_diagram</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                                <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting for score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_det_score&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-gridded data validation is not implemented yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_metric</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_validation_compute">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_validation_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">gcm_validation_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models_files_path</span><span class="p">,</span> <span class="n">Obs</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span>
                              <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate multiple General Circulation Model (GCM) forecasts using specified metrics.</span>

<span class="sd">        Computes deterministic, probabilistic, or ensemble-based scores for GCM hindcasts</span>
<span class="sd">        by processing model data from provided file paths and comparing against observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models_files_path : dict</span>
<span class="sd">            Dictionary mapping model identifiers (e.g., model names) to file paths of hindcast NetCDF files.</span>
<span class="sd">        Obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        score : str</span>
<span class="sd">            Score to compute, must be a key in self.scores (e.g., &#39;Pearson&#39;, &#39;RPSS&#39;, &#39;ROC_CURVE&#39;, &#39;RELIABILITY_DIAGRAM&#39;).</span>
<span class="sd">        month_of_initialization : int</span>
<span class="sd">            Month of forecast initialization (1-12).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        dir_to_save_roc_reliability : str or Path</span>
<span class="sd">            Directory to save ROC curves and reliability diagram plots.</span>
<span class="sd">        lead_time : list of int, optional</span>
<span class="sd">            Lead times in months to define the forecast season (e.g., [1, 2, 3] for a 3-month season).</span>
<span class="sd">            If None, no season is specified.</span>
<span class="sd">        ensemble_mean : str, optional</span>
<span class="sd">            Ensemble statistic to use for deterministic or probabilistic scores (e.g., &#39;mean&#39;).</span>
<span class="sd">            If None, ensemble mean is computed automatically when required.</span>
<span class="sd">        gridded : bool, optional</span>
<span class="sd">            Whether to perform gridded validation (True) or non-gridded (not implemented). Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or None</span>
<span class="sd">            If score_type is &#39;det_score&#39;, &#39;prob_score&#39;, or &#39;ensemble_score&#39;:</span>
<span class="sd">                Dictionary with model identifiers as keys and xarray.DataArray of scores (dimensions Y, X) as values.</span>
<span class="sd">            If score_type is &#39;all_grid_prob_score&#39; (e.g., ROC_CURVE, RELIABILITY_DIAGRAM):</span>
<span class="sd">                None, as results are saved as plots.</span>
<span class="sd">            If score_type is &#39;all_grid_det_score&#39;:</span>
<span class="sd">                None (not implemented).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the score is not recognized or if non-gridded validation is attempted (not implemented).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
            <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>
        <span class="n">x_metric</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">gridded</span><span class="p">:</span>
            <span class="n">Obs_data_</span> <span class="o">=</span> <span class="n">Obs</span>
            <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">models_files_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">score_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">model_data_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">models_files_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
                <span class="n">year_start_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year_end_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Obs_data</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_</span><span class="p">)))</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">Y</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data_</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;det_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_deterministic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_probabilistic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble score does not require an ensemble mean or median.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_crps</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                        <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;ROC_CURVE&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_roc_curves</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                             <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;RELIABILITY_DIAGRAM&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reliability_diagram</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                                <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting for score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_det_score&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-gridded data validation is not implemented yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_metric</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WAS_Verification.weighted_gcm_forecasts">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.weighted_gcm_forecasts">[docs]</a>
    <span class="k">def</span> <span class="nf">weighted_gcm_forecasts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Obs</span><span class="p">,</span>
        <span class="n">best_models</span><span class="p">,</span>
        <span class="n">scores</span><span class="p">,</span>
        <span class="n">lead_time</span><span class="p">,</span>
        <span class="n">model_dir</span><span class="p">,</span>
        <span class="n">clim_year_start</span><span class="p">,</span>
        <span class="n">clim_year_end</span><span class="p">,</span>
        <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;PRCP&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate weighted ensemble forecasts from selected GCMs based on their performance scores.</span>

<span class="sd">        Combines hindcasts and forecasts from multiple models using weights derived from</span>
<span class="sd">        the GROC score, scales the results to match observed climatology, and computes</span>
<span class="sd">        tercile probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), used for scaling and probability calculations.</span>
<span class="sd">        best_models : dict</span>
<span class="sd">            Dictionary of model identifiers (keys) to be included in the ensemble.</span>
<span class="sd">        scores : dict</span>
<span class="sd">            Dictionary containing scores (e.g., GROC) for each model, with model identifiers as keys.</span>
<span class="sd">        lead_time : list of int</span>
<span class="sd">            Lead times in months for the forecast season (e.g., [1, 2, 3] for a 3-month season).</span>
<span class="sd">        model_dir : str or Path</span>
<span class="sd">            Directory containing hindcast and forecast NetCDF files.</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        variable : str, optional</span>
<span class="sd">            Variable name in the NetCDF files (e.g., &#39;PRCP&#39; for precipitation). Default is &#39;PRCP&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - hindcast_det : xarray.DataArray</span>
<span class="sd">                Weighted deterministic hindcast with dimensions (T, Y, X).</span>
<span class="sd">            - hindcast_prob : xarray.DataArray</span>
<span class="sd">                Tercile probabilities for hindcasts with dimensions (probability, T, Y, X).</span>
<span class="sd">            - forecast_prob : xarray.DataArray</span>
<span class="sd">                Tercile probabilities for forecasts with dimensions (probability, Y, X).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Model files are expected to follow a naming convention like</span>
<span class="sd">          &#39;hindcast_{center}_{variable}_{init_month}_{season}_{lead}.nc&#39;.</span>
<span class="sd">        - The GROC score is used as the weighting metric.</span>
<span class="sd">        - A scaling factor is applied based on the ratio of observed to hindcast mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span><span class="p">)</span>
        <span class="n">score_sum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">best_models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">score_array</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;GROC&quot;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">score_array</span> <span class="o">=</span> <span class="n">score_array</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">hindcast_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="p">)</span>
            <span class="n">forecast_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="p">)</span>
            <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hincast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
            <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">forecast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
            <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">hincast_weighted</span> <span class="o">=</span> <span class="n">hincast_data</span> <span class="o">*</span> <span class="n">score_array</span>
            <span class="n">forecast_weighted</span> <span class="o">=</span> <span class="n">forecast_data</span> <span class="o">*</span> <span class="n">score_array</span>
            <span class="k">if</span> <span class="n">hindcast_det</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hincast_weighted</span>
                <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_weighted</span>
                <span class="n">score_sum</span> <span class="o">=</span> <span class="n">score_array</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">+</span> <span class="n">hincast_weighted</span>
                <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">+</span> <span class="n">forecast_weighted</span>
                <span class="n">score_sum</span> <span class="o">=</span> <span class="n">score_sum</span> <span class="o">+</span> <span class="n">score_array</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">/</span> <span class="n">score_sum</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">/</span> <span class="n">score_sum</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Obs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">hindcast_det</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hindcast_det</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">forecast_det</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">)</span>
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob_forecast</span><span class="p">(</span><span class="n">Obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">hindcast_prob</span><span class="p">,</span> <span class="n">forecast_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.classify_percent">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify_percent">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">classify_percent</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify a percentage value into predefined categories based on thresholds.</span>

<span class="sd">        Maps a percentage ratio to one of five categories representing deviation from average.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p : float or array-like</span>
<span class="sd">            Percentage value(s) to classify, typically representing a ratio to normal (%).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or array-like</span>
<span class="sd">            Category code:</span>
<span class="sd">            - 1: Well Above Average (&gt;= 150%)</span>
<span class="sd">            - 2: Above Average (&gt;= 110%)</span>
<span class="sd">            - 3: Near Average (&gt;= 90%)</span>
<span class="sd">            - 4: Below Average (&gt;= 50%)</span>
<span class="sd">            - 5: Well Below Average (&lt; 50%)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">150</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Well Above Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># Above Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>  <span class="c1"># Near Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">4</span>  <span class="c1"># Below Average</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>  <span class="c1"># Well Below Average</span></div>


<div class="viewcode-block" id="WAS_Verification.ratio_to_average">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.ratio_to_average">[docs]</a>
    <span class="k">def</span> <span class="nf">ratio_to_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and visualize the ratio of a specific year&#39;s data to the climatological mean.</span>

<span class="sd">        Calculates the percentage ratio of the predictand for a given year relative to</span>
<span class="sd">        the mean over a climatology period, classifies it into categories, and plots the</span>
<span class="sd">        result on a geographical map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        year : int or str</span>
<span class="sd">            Specific year to compute the ratio for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays a geographical plot of the classified ratios with a custom colormap and legend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="o">/</span> <span class="n">clim_mean</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">mask</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">classified</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classify_percent</span><span class="p">,</span>
            <span class="n">ratio</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;#1a9641&#39;</span><span class="p">,</span> <span class="s1">&#39;#a6d96a&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffffbf&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdae61&#39;</span><span class="p">,</span> <span class="s1">&#39;#d7191c&#39;</span><span class="p">])</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Well Above Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Above Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Near Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Below Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Well Below Avg&quot;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">classified</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
        <span class="n">legend_patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_patches</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Ratio to Normal [%]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_rpss_">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_rpss_">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_rpss_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ranked Probability Skill Score (RPSS) for a single grid point or sample.</span>

<span class="sd">        Compares the Ranked Probability Score (RPS) of the forecast to a climatological</span>
<span class="sd">        reference with uniform probabilities (1/3 for each tercile).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like of shape (n_samples,)</span>
<span class="sd">            True class labels, already classified into terciles (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">        y_probs : array-like of shape (3, n_samples)</span>
<span class="sd">            Forecast probabilities for each tercile category.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RPSS score, ranging from -Inf to 1 (1 indicates perfect forecast skill).</span>
<span class="sd">            Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">one_hot</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_true_clean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">cumulative_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">y_probs_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumulative_outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">one_hot</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cumulative_climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span>
            <span class="n">rps_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_forecast</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rps_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_climatology</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">rps_forecast</span> <span class="o">/</span> <span class="n">rps_reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.compute_one_year_rpss">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_one_year_rpss">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_one_year_rpss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and visualize the Ranked Probability Skill Score (RPSS) for a specific year.</span>

<span class="sd">        Applies the RPSS calculation across a gridded dataset for a single year, using</span>
<span class="sd">        tercile classifications based on a climatology period, and plots the results on a map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        prob_pred : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X), where probability includes</span>
<span class="sd">            [&#39;PB&#39;, &#39;PN&#39;, &#39;PA&#39;] (below-normal, near-normal, above-normal).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for tercile classification.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for tercile classification.</span>
<span class="sd">        year : int or str</span>
<span class="sd">            Specific year to compute the RPSS for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays a geographical plot of the RPSS values with a colorbar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
        <span class="n">prob_pred</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rpss_</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">prob_pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">A_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">A_</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;RPSS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;extend&#39;</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
                <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ranked Probability Skill Score - </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

           
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>