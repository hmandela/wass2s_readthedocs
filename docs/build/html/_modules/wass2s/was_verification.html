

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_verification &mdash; wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel. 0.3.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1e28cc32"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_verification</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_verification</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">resample</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">gamma</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>                     
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span> <span class="k">as</span> <span class="n">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">properscoring</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xskillscore</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>


<div class="viewcode-block" id="WAS_Verification">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WAS_Verification</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verification class for evaluating weather and climate forecasts.</span>

<span class="sd">    Provides methods to compute deterministic, probabilistic, and ensemble-based metrics,</span>
<span class="sd">    as well as visualization tools for model performance assessment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dist_method : str, optional</span>
<span class="sd">        Distribution method for tercile probability calculations</span>
<span class="sd">        (&#39;t&#39;, &#39;gamma&#39;, &#39;nonparam&#39;, &#39;normal&#39;, &#39;lognormal&#39;, &#39;weibull_min&#39;). Default is &#39;gamma&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_Verification.__init__">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;KGE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Kling Gupta Efficiency&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kling_gupta_efficiency</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;Pearson&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Pearson Correlation&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_corr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;IOA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Index Of Agreement&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_of_agreement</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Mean Absolute Error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">,</span> <span class="s2">&quot;[mm]&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Root Mean Square Error&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_mean_square_error</span><span class="p">,</span> <span class="s2">&quot;[mm]&quot;</span><span class="p">),</span>
            <span class="s2">&quot;NSE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nash Sutcliffe Efficiency&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nash_sutcliffe_efficiency</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;TAYLOR_DIAGRAM&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Taylor Diagram&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_det_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taylor_diagram</span><span class="p">),</span>
            <span class="s2">&quot;GROC&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Generalized Discrimination Score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_groc</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RPSS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Ranked Probability Skill Score&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rpss</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;IGS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Ignorance Score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignorance_score</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RES&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Resolution&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution_score_grid</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;REL&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Reliability&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reliability_score_grid</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;RELIABILITY_DIAGRAM&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Reliability Diagram&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reliability_diagram</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Brier Score&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brier_score</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;BSS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Brier Skill Score vs climatology&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brier_skill_score</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ROC_CURVE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;ROC CURVE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_roc_curves</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;CRPS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Continuous Ranked Probability Score with the ensemble distribution&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_crps</span><span class="p">,</span> <span class="s2">&quot;[mm]&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">=</span> <span class="n">dist_method</span></div>


<div class="viewcode-block" id="WAS_Verification.get_scores_metadata">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.get_scores_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scores_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve metadata for all available scoring metrics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing score names as keys and tuples of metadata</span>
<span class="sd">            (description, min_value, max_value, score_type, colormap, function) as values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Deterministic Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.kling_gupta_efficiency">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.kling_gupta_efficiency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kling_gupta_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Kling-Gupta Efficiency (KGE) metric.</span>

<span class="sd">        KGE combines correlation, bias, and variability ratios to assess model performance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            KGE score, ranging from -Inf to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">y_pred_clean</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.pearson_corr">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.pearson_corr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pearson_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Pearson Correlation Coefficient.</span>

<span class="sd">        Measures the linear correlation between observed and predicted values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Pearson correlation coefficient, ranging from -1 to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">y_pred_clean</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.spearman_corr">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.spearman_corr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spearman_corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Spearman rank correlation coefficient.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values (1D).</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values (1D).</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Spearman&#39;s rho in [-1, 1]; np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="c1"># Use scipy.stats via `stats` already imported above</span>
            <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">y_pred_clean</span><span class="p">)</span><span class="o">.</span><span class="n">correlation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


    
<div class="viewcode-block" id="WAS_Verification.index_of_agreement">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.index_of_agreement">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_of_agreement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Index of Agreement (IOA).</span>

<span class="sd">        Measures the degree of model prediction accuracy relative to observed variability.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            IOA score, ranging from 0 to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_pred_clean</span> <span class="o">-</span> <span class="n">y_true_clean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">))</span> <span class="o">+</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>



<div class="viewcode-block" id="WAS_Verification.mean_absolute_error">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.mean_absolute_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mean_absolute_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Mean Absolute Error (MAE).</span>

<span class="sd">        Measures the average magnitude of errors in predictions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            MAE value, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">mae</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.root_mean_square_error">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.root_mean_square_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">root_mean_square_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Root Mean Square Error (RMSE).</span>

<span class="sd">        Measures the square root of the average squared errors in predictions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RMSE value, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rmse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.nash_sutcliffe_efficiency">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.nash_sutcliffe_efficiency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">nash_sutcliffe_efficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Nash-Sutcliffe Efficiency (NSE).</span>

<span class="sd">        Measures the predictive skill of the model compared to the mean of observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_pred : array-like</span>
<span class="sd">            Predicted values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            NSE score, ranging from -Inf to 1 (1 is perfect). Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_pred_clean</span> <span class="o">=</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">y_pred_clean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true_clean</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nse</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.taylor_diagram">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.taylor_diagram">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">taylor_diagram</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">obs</span><span class="p">,</span>
        <span class="n">models</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">correlation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pearson&quot;</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Taylor diagram&quot;</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">savepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hide_rms_numbers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a Taylor diagram comparing one or more model series against observations.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : xarray.DataArray or np.ndarray</span>
<span class="sd">            Observations. If xarray, can be (T), (T,Y,X), etc.</span>
<span class="sd">        models : dict[str, xarray.DataArray | np.ndarray]</span>
<span class="sd">            Mapping of model name -&gt; forecast array (same shape as obs or broadcastable).</span>
<span class="sd">        normalize : bool, optional</span>
<span class="sd">            If True (default), normalize std and CRMSD by std(obs).</span>
<span class="sd">        correlation : {&quot;pearson&quot;,&quot;spearman&quot;}, optional</span>
<span class="sd">            Correlation metric used on paired, finite values.</span>
<span class="sd">        labels : dict[str,str], optional</span>
<span class="sd">            Custom display labels for model markers. Defaults to model keys.</span>
<span class="sd">        title : str or None, optional</span>
<span class="sd">            Figure title.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            Matplotlib figure size.</span>
<span class="sd">        savepath : str or None, optional</span>
<span class="sd">            If provided, save figure to this path.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (fig, ax) : matplotlib Figure and Axes</span>
<span class="sd">        &quot;&quot;&quot;</span>
   
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">skill_metrics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;SkillMetrics is required. Install with: pip install SkillMetrics&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    
        <span class="k">def</span><span class="w"> </span><span class="nf">_to_aligned_1d</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;dims&quot;</span><span class="p">):</span>
                <span class="n">o_al</span><span class="p">,</span> <span class="n">f_al</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
                <span class="n">o_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">o_al</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f_al</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">f_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">o_vals</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">f_vals</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">o_vals</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">f_vals</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
    
        <span class="n">model_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">}</span>
    
        <span class="n">sdev_list</span><span class="p">,</span> <span class="n">crmsd_list</span><span class="p">,</span> <span class="n">corr_list</span><span class="p">,</span> <span class="n">used_names</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">std_obs_plot</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
            <span class="n">o</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">_to_aligned_1d</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">correlation</span> <span class="k">if</span> <span class="n">correlation</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;spearman&quot;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">std_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">std_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">std_o</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">std_f</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">std_o</span> <span class="o">*</span> <span class="n">std_f</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">normalize</span> <span class="ow">and</span> <span class="n">std_o</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">std_o_plot</span><span class="p">,</span> <span class="n">std_f_plot</span><span class="p">,</span> <span class="n">cr_plot</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">std_f</span> <span class="o">/</span> <span class="n">std_o</span><span class="p">,</span> <span class="n">cr</span> <span class="o">/</span> <span class="n">std_o</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">std_o_plot</span><span class="p">,</span> <span class="n">std_f_plot</span><span class="p">,</span> <span class="n">cr_plot</span> <span class="o">=</span> <span class="n">std_o</span><span class="p">,</span> <span class="n">std_f</span><span class="p">,</span> <span class="n">cr</span>
            <span class="k">if</span> <span class="n">std_obs_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">std_obs_plot</span> <span class="o">=</span> <span class="n">std_o_plot</span>
            <span class="n">sdev_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_f_plot</span><span class="p">)</span>
            <span class="n">crmsd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr_plot</span><span class="p">)</span>
            <span class="n">corr_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">used_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">used_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No model had 3 paired finite values w.r.t. observations.&quot;</span><span class="p">)</span>
    
        <span class="n">sdev</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">std_obs_plot</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sdev_list</span><span class="p">)))</span>
        <span class="n">crmsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">0.0</span><span class="p">],</span>        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">crmsd_list</span><span class="p">)))</span>
        <span class="n">ccoef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mf">1.0</span><span class="p">],</span>        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corr_list</span><span class="p">)))</span>
        <span class="n">marker_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;OBS&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">used_names</span><span class="p">]</span>
        <span class="n">axis_max</span> <span class="o">=</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">sdev</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">crmsd</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">taylor_diagram</span><span class="p">(</span>
            <span class="n">sdev</span><span class="p">,</span> <span class="n">crmsd</span><span class="p">,</span> <span class="n">ccoef</span><span class="p">,</span>
            <span class="n">numberPanels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">axisMax</span><span class="o">=</span><span class="n">axis_max</span><span class="p">,</span>
            <span class="n">markerDisplayed</span><span class="o">=</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span>
            <span class="n">markerLabel</span><span class="o">=</span><span class="n">marker_labels</span><span class="p">,</span>
            <span class="n">markerLegend</span><span class="o">=</span><span class="s2">&quot;on&quot;</span><span class="p">,</span>
            <span class="n">styleOBS</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
            <span class="n">colOBS</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
            <span class="n">markerObs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="n">titleOBS</span><span class="o">=</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span>
            <span class="n">labelRMS</span><span class="o">=</span><span class="s2">&quot;CRMSD&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s2">&quot;CRMSD (norm.)&quot;</span><span class="p">,</span>
            <span class="n">titleSTD</span><span class="o">=</span><span class="s2">&quot;on&quot;</span><span class="p">,</span>
            <span class="n">titleCOR</span><span class="o">=</span><span class="s2">&quot;on&quot;</span><span class="p">,</span>
            <span class="n">colCOR</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
            <span class="n">colSTD</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">colRMS</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    
        <span class="k">if</span> <span class="n">hide_rms_numbers</span><span class="p">:</span>
            <span class="n">green</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="s2">&quot;tab:green&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">findobj</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Text</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Remove green numeric labels on RMS arcs</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">get_color</span><span class="p">()),</span> <span class="n">green</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
    
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">savepath</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


    <span class="c1"># def taylor_diagram_(</span>
    <span class="c1">#     self,</span>
    <span class="c1">#     obs,</span>
    <span class="c1">#     models,</span>
    <span class="c1">#     *,</span>
    <span class="c1">#     normalize: bool = True,</span>
    <span class="c1">#     correlation: str = &quot;pearson&quot;,   # &quot;pearson&quot; or &quot;spearman&quot;</span>
    <span class="c1">#     labels: dict | None = None,     # optional pretty labels per model key</span>
    <span class="c1">#     title: str | None = &quot;Taylor diagram&quot;,</span>
    <span class="c1">#     figsize=(7, 6),</span>
    <span class="c1">#     savepath: str | None = None,</span>
    <span class="c1"># ):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Plot a Taylor diagram comparing one or more model series against observations.</span>
    
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     obs : xarray.DataArray or np.ndarray</span>
    <span class="c1">#         Observations. If xarray, can be (T), (T,Y,X), etc.</span>
    <span class="c1">#     models : dict[str, xarray.DataArray | np.ndarray]</span>
    <span class="c1">#         Mapping of model name -&gt; forecast array (same shape as obs or broadcastable).</span>
    <span class="c1">#     normalize : bool, optional</span>
    <span class="c1">#         If True (default), normalize std and CRMSD by std(obs).</span>
    <span class="c1">#     correlation : {&quot;pearson&quot;,&quot;spearman&quot;}, optional</span>
    <span class="c1">#         Correlation metric used on paired, finite values.</span>
    <span class="c1">#     labels : dict[str,str], optional</span>
    <span class="c1">#         Custom display labels for model markers. Defaults to model keys.</span>
    <span class="c1">#     title : str or None, optional</span>
    <span class="c1">#         Figure title.</span>
    <span class="c1">#     figsize : tuple, optional</span>
    <span class="c1">#         Matplotlib figure size.</span>
    <span class="c1">#     savepath : str or None, optional</span>
    <span class="c1">#         If provided, save figure to this path.</span>
    
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     (fig, ax) : matplotlib Figure and Axes</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         import skill_metrics as sm</span>
    <span class="c1">#     except Exception as e:</span>
    <span class="c1">#         raise ImportError(</span>
    <span class="c1">#             &quot;SkillMetrics is required. Install with: pip install SkillMetrics&quot;</span>
    <span class="c1">#         ) from e</span>
    
    <span class="c1">#     def _to_aligned_1d(o, f):</span>
    <span class="c1">#         # Align xarray objects on shared coords; otherwise just np.asarray.</span>
    <span class="c1">#         if hasattr(o, &quot;dims&quot;) or hasattr(f, &quot;dims&quot;):</span>
    <span class="c1">#             o_al, f_al = xr.align(o, f, join=&quot;inner&quot;)</span>
    <span class="c1">#             o_vals = np.asarray(o_al).ravel()</span>
    <span class="c1">#             f_vals = np.asarray(f_al).ravel()</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             o_vals = np.asarray(o).ravel()</span>
    <span class="c1">#             f_vals = np.asarray(f).ravel()</span>
    <span class="c1">#         m = np.isfinite(o_vals) &amp; np.isfinite(f_vals)</span>
    <span class="c1">#         return o_vals[m], f_vals[m]</span>
    
    <span class="c1">#     # Prepare labels</span>
    <span class="c1">#     model_names = list(models.keys())</span>
    <span class="c1">#     if labels is None:</span>
    <span class="c1">#         labels = {k: k for k in model_names}</span>
    
    <span class="c1">#     # Compute stats for each model</span>
    <span class="c1">#     sdev_list, crmsd_list, corr_list, used_names = [], [], [], []</span>
    <span class="c1">#     std_obs_plot = None  # will hold reference STD on diagram scale</span>
    
    <span class="c1">#     # We compute obs std using the first model&#39;s mask (pairwise); then re-compute per model.</span>
    <span class="c1">#     # For normalization, each model uses its *own* paired-data obs std to be consistent.</span>
    <span class="c1">#     for name in model_names:</span>
    <span class="c1">#         o, f = _to_aligned_1d(obs, models[name])</span>
    <span class="c1">#         if o.size &lt; 3:</span>
    <span class="c1">#             continue</span>
    
    <span class="c1">#         # correlation</span>
    <span class="c1">#         if correlation.lower() == &quot;spearman&quot;:</span>
    <span class="c1">#             r = stats.spearmanr(o, f).correlation</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             r = np.corrcoef(o, f)[0, 1]</span>
    
    <span class="c1">#         # standard deviations (population)</span>
    <span class="c1">#         std_o = np.std(o, ddof=0)</span>
    <span class="c1">#         std_f = np.std(f, ddof=0)</span>
    
    <span class="c1">#         # centered RMS difference</span>
    <span class="c1">#         cr = np.sqrt(std_o**2 + std_f**2 - 2.0 * std_o * std_f * r)</span>
    
    <span class="c1">#         # normalize if requested</span>
    <span class="c1">#         if normalize and std_o &gt; 0:</span>
    <span class="c1">#             std_o_plot = 1.0</span>
    <span class="c1">#             std_f_plot = std_f / std_o</span>
    <span class="c1">#             cr_plot = cr / std_o</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             std_o_plot = std_o</span>
    <span class="c1">#             std_f_plot = std_f</span>
    <span class="c1">#             cr_plot = cr</span>
    
    <span class="c1">#         if std_obs_plot is None:</span>
    <span class="c1">#             std_obs_plot = std_o_plot</span>
    
    <span class="c1">#         sdev_list.append(std_f_plot)</span>
    <span class="c1">#         crmsd_list.append(cr_plot)</span>
    <span class="c1">#         corr_list.append(r)</span>
    <span class="c1">#         used_names.append(name)</span>
    
    <span class="c1">#     if not used_names:</span>
    <span class="c1">#         raise ValueError(&quot;No model had 3 paired finite values w.r.t. observations.&quot;)</span>
    
    <span class="c1">#     # Build inputs for SkillMetrics (first entry is OBS reference)</span>
    <span class="c1">#     sdev  = np.concatenate(([std_obs_plot], np.asarray(sdev_list)))</span>
    <span class="c1">#     crmsd = np.concatenate(([0.0],        np.asarray(crmsd_list)))</span>
    <span class="c1">#     ccoef = np.concatenate(([1.0],        np.asarray(corr_list)))</span>
    <span class="c1">#     marker_labels = [&quot;OBS&quot;] + [labels[n] for n in used_names]</span>
    
    <span class="c1">#     # Axis extent</span>
    <span class="c1">#     axis_max = 1.25 * max(sdev.max(), crmsd.max(), 1.0)</span>
    
    <span class="c1">#     # Plot</span>
    <span class="c1">#     fig, ax = plt.subplots(figsize=figsize)</span>
    <span class="c1">#     sm.taylor_diagram(</span>
    <span class="c1">#         sdev,</span>
    <span class="c1">#         crmsd,</span>
    <span class="c1">#         ccoef,</span>
    <span class="c1">#         numberPanels=1,</span>
    <span class="c1">#         axisMax=axis_max,</span>
    <span class="c1">#         markerDisplayed=&quot;marker&quot;,</span>
    <span class="c1">#         markerLabel=marker_labels,</span>
    <span class="c1">#         markerLegend=&quot;on&quot;,</span>
    <span class="c1">#         styleOBS=&quot;-&quot;,</span>
    <span class="c1">#         colOBS=&quot;k&quot;,</span>
    <span class="c1">#         markerObs=&quot;*&quot;,</span>
    <span class="c1">#         titleOBS=&quot;obs&quot;,</span>
    <span class="c1">#         labelRMS=&quot;CRMSD&quot; if not normalize else &quot;CRMSD (norm.)&quot;,</span>
    <span class="c1">#         # Note: SkillMetrics has no &#39;labelSTD&#39; option; showing default titles:</span>
    <span class="c1">#         titleSTD=&quot;on&quot;,</span>
    <span class="c1">#         titleCOR=&quot;on&quot;,</span>
    <span class="c1">#         colCOR=&quot;tab:blue&quot;,</span>
    <span class="c1">#         colSTD=&quot;black&quot;,</span>
    <span class="c1">#         colRMS=&quot;tab:green&quot;,</span>
    <span class="c1">#     )</span>
    
    <span class="c1">#     if title:</span>
    <span class="c1">#         ax.set_title(title)</span>
    
    <span class="c1">#     if savepath:</span>
    <span class="c1">#         fig.savefig(savepath, dpi=300, bbox_inches=&quot;tight&quot;)</span>
    
    <span class="c1">#     return fig, ax</span>


<div class="viewcode-block" id="WAS_Verification.compute_deterministic_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_deterministic_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_deterministic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_func</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a deterministic scoring function over xarray DataArrays.</span>

<span class="sd">        Computes the specified metric across the time dimension for each grid point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        score_func : callable</span>
<span class="sd">            Scoring function to apply (e.g., pearson_corr, kling_gupta_efficiency).</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        pred : xarray.DataArray</span>
<span class="sd">            Predicted data with dimensions (T, Y, X).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">score_func</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Probabilistic Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.classify">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify data into terciles based on climatological thresholds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y : array-like</span>
<span class="sd">            Input data to classify.</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - y_class : array-like</span>
<span class="sd">                Classified data (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">            - tercile_33 : float</span>
<span class="sd">                33rd percentile threshold.</span>
<span class="sd">            - tercile_67 : float</span>
<span class="sd">                67th percentile threshold.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y_class</span><span class="p">,</span> <span class="n">terciles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">terciles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


    <span class="c1"># def classify(self, y, index_start, index_end):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Classify data into terciles based on climatological thresholds.</span>
    
    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     y : array-like</span>
    <span class="c1">#         Input data to classify.</span>
    <span class="c1">#     index_start : int</span>
    <span class="c1">#         Start index of the climatology period.</span>
    <span class="c1">#     index_end : int</span>
    <span class="c1">#         End index of the climatology period.</span>
    
    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     tuple</span>
    <span class="c1">#         - y_class : array-like</span>
    <span class="c1">#             Classified data (0: below-normal, 1: near-normal, 2: above-normal).</span>
    <span class="c1">#         - tercile_33 : float</span>
    <span class="c1">#             33rd percentile threshold.</span>
    <span class="c1">#         - tercile_67 : float</span>
    <span class="c1">#             67th percentile threshold.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Check if climatology period has enough valid data</span>
    <span class="c1">#     clim_data = y[index_start:index_end]</span>
    <span class="c1">#     clim_mask = np.isfinite(clim_data)</span>
        
    <span class="c1">#     if np.sum(clim_mask) &lt; 5:  # Need minimum data points</span>
    <span class="c1">#         return np.full(y.shape, np.nan), np.nan, np.nan</span>
        
    <span class="c1">#     # Calculate terciles from climatology period</span>
    <span class="c1">#     terciles = np.nanpercentile(clim_data, [33.33, 66.67])</span>
        
    <span class="c1">#     # Classify all data using these terciles</span>
    <span class="c1">#     y_class = np.full(y.shape, np.nan)  # Initialize with NaN</span>
    <span class="c1">#     valid_mask = np.isfinite(y)</span>
        
    <span class="c1">#     if np.any(valid_mask):</span>
    <span class="c1">#         # Standard tercile classification</span>
    <span class="c1">#         # Below normal: y &lt; terciles[0]</span>
    <span class="c1">#         y_class[valid_mask &amp; (y &lt; terciles[0])] = 0</span>
    <span class="c1">#         # Above normal: y &gt; terciles[1]</span>
    <span class="c1">#         y_class[valid_mask &amp; (y &gt; terciles[1])] = 2</span>
    <span class="c1">#         # Near normal: terciles[0] &lt;= y &lt;= terciles[1]</span>
    <span class="c1">#         near_normal_mask = valid_mask &amp; (y &gt;= terciles[0]) &amp; (y &lt;= terciles[1])</span>
    <span class="c1">#         y_class[near_normal_mask] = 1</span>
            
    <span class="c1">#         # Alternative: Handle exactly equal to boundaries consistently</span>
    <span class="c1">#         # Values exactly equal to lower tercile go to near-normal</span>
    <span class="c1">#         y_class[valid_mask &amp; (y == terciles[0])] = 1</span>
    <span class="c1">#         # Values exactly equal to upper tercile go to above-normal</span>
    <span class="c1">#         y_class[valid_mask &amp; (y == terciles[1])] = 2</span>
        
    <span class="c1">#     return y_class, terciles[0], terciles[1]</span>

    
<div class="viewcode-block" id="WAS_Verification.compute_class">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_class">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile class labels for observed data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Classified data with dimensions (T, Y, X), where values are</span>
<span class="sd">            0 (below-normal), 1 (near-normal), or 2 (above-normal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">Predictant_class</span><span class="p">,</span> <span class="n">tercile_33</span><span class="p">,</span> <span class="n">tercile_67</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="p">,</span>
            <span class="n">Predictant</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index_start&#39;</span><span class="p">:</span> <span class="n">index_start</span><span class="p">,</span> <span class="s1">&#39;index_end&#39;</span><span class="p">:</span> <span class="n">index_end</span><span class="p">},</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Predictant_class</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Verification.classify_data_into_terciles">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify_data_into_terciles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify_data_into_terciles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify data into terciles based on given thresholds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y : array-like</span>
<span class="sd">            Input data to classify.</span>
<span class="sd">        T1 : float</span>
<span class="sd">            First tercile threshold (33rd percentile).</span>
<span class="sd">        T2 : float</span>
<span class="sd">            Second tercile threshold (67th percentile).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array-like</span>
<span class="sd">            Classified data (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">classified_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">classified_data</span><span class="p">[</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">classified_data</span><span class="p">[</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">classified_data</span><span class="p">[(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">T1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">T2</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">classified_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_groc_">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_groc_">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_groc_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Generalized Discrimination (GROC) score.</span>

<span class="sd">        Averages the Area Under the Curve (AUC) for each tercile category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        n_classes : int, optional</span>
<span class="sd">            Number of classes (default is 3 for terciles).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            GROC score, ranging from 0 to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">groc</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
                <span class="n">y_true_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_clean_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_i</span><span class="p">,</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">groc</span> <span class="o">+=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">groc</span> <span class="o">/</span> <span class="n">n_classes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_groc">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_groc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_groc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Generalized Discrimination (GROC) score according to Weigel and Mason (2011).</span>
<span class="sd">        </span>
<span class="sd">        The GROC score averages the Area Under the ROC Curve (AUC) for each category,</span>
<span class="sd">        measuring the ability to distinguish occurrences from non-occurrences of each category.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period for computing terciles.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period for computing terciles.</span>
<span class="sd">        n_classes : int, optional</span>
<span class="sd">            Number of classes (default is 3 for terciles).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            GROC score, ranging from 0 to 1. </span>
<span class="sd">            Returns np.nan if insufficient valid data.</span>
<span class="sd">        </span>
<span class="sd">        Reference</span>
<span class="sd">        ---------</span>
<span class="sd">        Weigel, A. P. and Mason, S. J. (2011). </span>
<span class="sd">        The generalized discrimination score for ensemble forecasts.</span>
<span class="sd">        Monthly Weather Review, 139(9):3069-3074.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
        
        <span class="c1"># Calculate terciles from climatology period BEFORE masking</span>
        <span class="k">if</span> <span class="n">index_end</span> <span class="o">&lt;=</span> <span class="n">index_start</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">clim_period</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">valid_clim_data</span> <span class="o">=</span> <span class="n">clim_period</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clim_period</span><span class="p">)]</span>
        
        <span class="c1"># Need at least n_classes data points to calculate percentiles</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate thresholds for n_classes (e.g., terciles for n_classes=3)</span>
        <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
        
        <span class="c1"># Apply mask to clean the full dataset</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        
        <span class="c1"># Need at least some data to compute ROC</span>
        <span class="k">if</span> <span class="n">valid_count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_classes</span><span class="p">:</span>  <span class="c1"># At least 2 samples per class ideally</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="c1"># Classify observations into categories</span>
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Ensure we have n_classes</span>
        <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="c1"># Some classes might be missing in the data</span>
            <span class="c1"># We&#39;ll still compute, but warn if in debug mode</span>
            <span class="k">pass</span>
        
        <span class="c1"># Compute AUC for each category and average</span>
        <span class="n">auc_scores</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="c1"># Binary classification: 1 if category i occurred, 0 otherwise</span>
            <span class="n">y_true_binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># Check if we have both positive and negative samples</span>
            <span class="n">n_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">n_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">n_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_neg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If no positive or negative samples, AUC is undefined</span>
                <span class="c1"># According to the paper, we should skip or assign 0.5?</span>
                <span class="c1"># In practice, assign 0.5 (no discrimination skill for this category)</span>
                <span class="n">auc_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Forecast probability for category i</span>
            <span class="n">y_prob_i</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            
            <span class="c1"># Compute ROC curve and AUC</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_binary</span><span class="p">,</span> <span class="n">y_prob_i</span><span class="p">)</span>
            
            <span class="c1"># Check if ROC curve is valid (should have at least 2 points)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">auc_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use trapezoidal rule for AUC (as in the paper)</span>
                <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
                <span class="n">auc_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc_auc</span><span class="p">)</span>
        
        <span class="c1"># Average AUC across all categories (unweighted)</span>
        <span class="n">groc_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auc_scores</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">groc_score</span></div>




<div class="viewcode-block" id="WAS_Verification.calculate_groc_weighted">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_groc_weighted">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_groc_weighted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Generalized Discrimination (GROC) score with category weighting.</span>
<span class="sd">        </span>
<span class="sd">        Weighted average of AUCs by climatological frequency of each category.</span>
<span class="sd">        Alternative: Weighted by climatological frequency as in some applications</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        n_classes : int, optional</span>
<span class="sd">            Number of classes (default is 3 for terciles).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Weighted GROC score, ranging from 0 to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
        
        <span class="c1"># Calculate thresholds</span>
        <span class="n">clim_period</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">valid_clim_data</span> <span class="o">=</span> <span class="n">clim_period</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clim_period</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
        
        <span class="c1"># Apply mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">valid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">valid_count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_classes</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="c1"># Classify</span>
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Calculate climatological base rates for weighting</span>
        <span class="n">base_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">base_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">base_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_rate</span><span class="p">)</span>
        
        <span class="c1"># Normalize base rates (should sum to 1)</span>
        <span class="n">base_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">base_rates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">base_rates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">base_rates</span> <span class="o">=</span> <span class="n">base_rates</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">base_rates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_classes</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_classes</span>
        
        <span class="c1"># Compute weighted AUC</span>
        <span class="n">weighted_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">y_true_binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">n_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">n_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">n_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_neg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Assign 0.5 for undefined AUC, but weight by base rate</span>
                <span class="n">weighted_sum</span> <span class="o">+=</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_prob_i</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_binary</span><span class="p">,</span> <span class="n">y_prob_i</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fpr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tpr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">roc_auc</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
                
                <span class="n">weighted_sum</span> <span class="o">+=</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">roc_auc</span>
        
        <span class="k">return</span> <span class="n">weighted_sum</span></div>




<div class="viewcode-block" id="WAS_Verification.calculate_groc_fixed">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_groc_fixed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_groc_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fixed from version calculate_groc_ of GROC calculation.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        n_classes : int, optional</span>
<span class="sd">            Number of classes (default is 3 for terciles).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            GROC score, ranging from 0 to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span>
        
        <span class="k">if</span> <span class="n">index_end</span> <span class="o">&lt;=</span> <span class="n">index_start</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Use climatology period from original y_true</span>
        <span class="n">clim_data</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">clim_data_clean</span> <span class="o">=</span> <span class="n">clim_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clim_data</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clim_data_clean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">if</span> <span class="n">n_classes</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">33.33</span><span class="p">,</span> <span class="mf">66.67</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">100</span><span class="o">/</span><span class="n">n_classes</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">thresholds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">clim_data_clean</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span>
        
        <span class="c1"># Apply mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="n">y_true_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">thresholds</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Compute unweighted average of AUCs</span>
        <span class="n">auc_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">valid_categories</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_classes</span><span class="p">):</span>
            <span class="n">y_true_binary</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_class</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="c1"># Skip if no positive or negative samples</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">y_true_binary</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="n">y_prob_i</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true_binary</span><span class="p">,</span> <span class="n">y_prob_i</span><span class="p">)</span>
            <span class="n">category_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
            
            <span class="n">auc_sum</span> <span class="o">+=</span> <span class="n">category_auc</span>
            <span class="n">valid_categories</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">valid_categories</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">return</span> <span class="n">auc_sum</span> <span class="o">/</span> <span class="n">valid_categories</span></div>

    
<div class="viewcode-block" id="WAS_Verification.calculate_rpss">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_rpss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_rpss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ranked Probability Skill Score (RPSS).</span>

<span class="sd">        Compares the Ranked Probability Score (RPS) of the forecast to a climatological reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RPSS score, ranging from -Inf to 1. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])],</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">one_hot_encoded_outcomes</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">cumulative_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">y_probs_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">one_hot_encoded_outcomes</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cumulative_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">climatology</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumulative_outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">one_hot_encoded_outcomes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">rps_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_forecast</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rps_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_reference</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">rps_forecast</span> <span class="o">/</span> <span class="n">rps_reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.ignorance_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.ignorance_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignorance_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ignorance Score based on Weijs (2010).</span>

<span class="sd">        Measures the logarithmic loss of forecast probabilities for the true category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Ignorance score, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
            <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">y_true_clean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ignorance_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">y_true_clean_category</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">y_true_clean_category</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ignorance_sum</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ignorance_sum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">ignorance_sum</span> <span class="o">/</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>



<div class="viewcode-block" id="WAS_Verification.brier_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.brier_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">brier_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s2">&quot;PA&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        BS for a single tercile event (PB/PN/PA). y_probs has shape (3, N).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
    
        <span class="c1"># terciles from calibration slice</span>
        <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        <span class="n">y_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 0,1,2</span>
    
        <span class="n">emap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PB&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;PN&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">emap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
        <span class="n">o</span>   <span class="o">=</span> <span class="p">(</span><span class="n">y_class</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">p_k</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">p_k</span> <span class="o">-</span> <span class="n">o</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span></div>

    
    
<div class="viewcode-block" id="WAS_Verification.brier_skill_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.brier_skill_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">brier_skill_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">y_true</span><span class="p">,</span>
                            <span class="n">y_probs</span><span class="p">,</span>
                            <span class="n">index_start</span><span class="p">,</span>
                            <span class="n">index_end</span><span class="p">,</span>
                            <span class="n">event</span><span class="o">=</span><span class="s2">&quot;PA&quot;</span><span class="p">,</span>
                            <span class="n">reference</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Event-wise Brier Skill Score (BSS) for tercile forecasts.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : 1D array-like</span>
<span class="sd">            Observed values (time series for one grid point).</span>
<span class="sd">        y_probs : 2D array-like, shape (3, N)</span>
<span class="sd">            Forecast probabilities for PB/PN/PA over time.</span>
<span class="sd">        index_start, index_end : int</span>
<span class="sd">            Indices delimiting the calibration slice inside the *masked* series.</span>
<span class="sd">        event : {&quot;PB&quot;,&quot;PN&quot;,&quot;PA&quot;,0,1,2}, optional</span>
<span class="sd">            Event to score (default &quot;PA&quot; = above-normal).</span>
<span class="sd">        reference : {&quot;uniform&quot;,&quot;empirical&quot;}, optional</span>
<span class="sd">            - &quot;uniform&quot;: climatology is [1/3,1/3,1/3]</span>
<span class="sd">            - &quot;empirical&quot;: base rate computed from calibration slice</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            BSS = 1 - BS / BS_ref (np.nan if not computable).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">brier_score_event</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">bs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
    

        <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        <span class="n">y_class_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">],</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 0,1,2</span>
    

        <span class="n">emap</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PB&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;PN&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">emap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    

        <span class="n">o_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_class_all</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    

        <span class="n">ref</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;unif&quot;</span><span class="p">,</span> <span class="s2">&quot;1/3&quot;</span><span class="p">,</span> <span class="s2">&quot;13&quot;</span><span class="p">):</span>
            <span class="n">p_ref</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;empirical&quot;</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;clim&quot;</span><span class="p">,</span> <span class="s2">&quot;climatology&quot;</span><span class="p">):</span>

            <span class="n">p_ref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o_all</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;reference must be &#39;uniform&#39; or &#39;empirical&#39;&quot;</span><span class="p">)</span>
    
        <span class="n">bs_ref</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">p_ref</span> <span class="o">-</span> <span class="n">o_all</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">bs_ref</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">bs</span> <span class="o">/</span> <span class="n">bs_ref</span><span class="p">)</span></div>




    <span class="c1"># def resolution_score_grid_(self, y_true, y_probs, index_start, index_end,</span>
    <span class="c1">#                          bins=np.array([0.000, 0.025, 0.050, 0.100, 0.150, 0.200,</span>
    <span class="c1">#                                         0.250, 0.300, 0.350, 0.400, 0.450, 0.500,</span>
    <span class="c1">#                                         0.550, 0.600, 0.650, 0.6700, 0.6750, 0.800,</span>
    <span class="c1">#                                         0.850, 0.900, 0.950, 0.975, 1.000])):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Compute Resolution Score on a grid based on Weijs (2010).</span>

    <span class="c1">#     Measures the ability of the forecast to distinguish between different outcomes.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     y_true : array-like</span>
    <span class="c1">#         Observed values.</span>
    <span class="c1">#     y_probs : array-like</span>
    <span class="c1">#         Forecast probabilities with shape (n_classes, n_samples).</span>
    <span class="c1">#     index_start : int</span>
    <span class="c1">#         Start index of the climatology period.</span>
    <span class="c1">#     index_end : int</span>
    <span class="c1">#         End index of the climatology period.</span>
    <span class="c1">#     bins : array-like, optional</span>
    <span class="c1">#         Probability bins for discretizing forecast probabilities.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     float</span>
    <span class="c1">#         Resolution score, non-negative. Returns np.nan if insufficient valid data.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     mask = np.isfinite(y_true) &amp; np.isfinite(y_probs).all(axis=0)</span>
    <span class="c1">#     if not np.any(mask):</span>
    <span class="c1">#         return np.nan</span>
    <span class="c1">#     y_true_clean = y_true[mask]</span>
    <span class="c1">#     y_probs_clean = y_probs[:, mask]</span>
    <span class="c1">#     terciles = np.nanpercentile(y_true_clean[index_start:index_end], [33, 67])</span>
    <span class="c1">#     y_true_clean_class = np.digitize(y_true_clean, bins=terciles, right=True)</span>
    <span class="c1">#     n_categories, n_instances = y_probs_clean.shape</span>
    <span class="c1">#     y_bar = [np.mean(y_true_clean_class == k) for k in range(n_categories)]</span>
    <span class="c1">#     resolution_sum = 0.0</span>
    <span class="c1">#     for k in range(n_categories):</span>
    <span class="c1">#         y_probs_clean_k = y_probs_clean[k, :]</span>
    <span class="c1">#         binned_indices = np.digitize(y_probs_clean_k, bins) - 1</span>
    <span class="c1">#         for b in range(len(bins) - 1):</span>
    <span class="c1">#             bin_mask = binned_indices == b</span>
    <span class="c1">#             n_kb = np.sum(bin_mask)</span>
    <span class="c1">#             if n_kb &gt; 0:</span>
    <span class="c1">#                 y_kb = np.mean(y_true_clean_class[bin_mask] == k)</span>
    <span class="c1">#                 if y_kb &gt; 0 and y_kb &lt; 1:</span>
    <span class="c1">#                     term1 = y_kb * np.log2(y_kb / y_bar[k]) if y_bar[k] &gt; 0 else 0</span>
    <span class="c1">#                     term2 = (1 - y_kb) * np.log2((1 - y_kb) / (1 - y_bar[k])) if y_bar[k] &lt; 1 else 0</span>
    <span class="c1">#                     resolution_sum += (n_kb / n_instances) * (term1 + term2)</span>
    <span class="c1">#     return resolution_sum</span>

<div class="viewcode-block" id="WAS_Verification.resolution_score_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_score_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolution_score_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span>
                             <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                            <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                            <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">,</span> <span class="mf">0.6750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                            <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Resolution Score on a grid based on Weijs (2010).</span>
<span class="sd">    </span>
<span class="sd">        Measures the ability of the forecast to distinguish between different outcomes.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Resolution score, non-negative. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># First, calculate terciles from the climatology period in the original y_true</span>
        <span class="k">if</span> <span class="n">index_end</span> <span class="o">&lt;=</span> <span class="n">index_start</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Extract climatology period from original y_true</span>
        <span class="n">clim_period</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        
        <span class="c1"># Check if we have enough data in climatology period</span>
        <span class="n">valid_clim_data</span> <span class="o">=</span> <span class="n">clim_period</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clim_period</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Arbitrary threshold</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate terciles from climatology period</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">clim_period</span><span class="p">,</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        
        <span class="c1"># Now apply mask to clean the full dataset</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># Ensure we have exactly 3 categories (terciles)</span>
        <span class="k">if</span> <span class="n">n_categories</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Try to see what happened</span>
            <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate base rates (climatological frequencies) for each category</span>
        <span class="n">y_bar</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">base_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">y_bar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_rate</span><span class="p">)</span>
        
        <span class="n">resolution_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    
                    <span class="c1"># Check for valid probabilities to avoid log(0)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Handle cases where base rate is 0 or 1</span>
                        <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If base rate is 0 or 1, resolution is undefined for that category</span>
                            <span class="c1"># Skip this category&#39;s contribution</span>
                            <span class="k">continue</span>
                        
                        <span class="n">resolution_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">resolution_sum</span></div>


    <span class="c1"># def reliability_score_grid_(self, y_true, y_probs, index_start, index_end,</span>
    <span class="c1">#                           bins=np.array([0.000, 0.025, 0.050, 0.100, 0.150, 0.200,</span>
    <span class="c1">#                                          0.250, 0.300, 0.350, 0.400, 0.450, 0.500,</span>
    <span class="c1">#                                          0.550, 0.600, 0.650, 0.6700, 0.6750, 0.800,</span>
    <span class="c1">#                                          0.850, 0.900, 0.950, 0.975, 1.000])):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Compute Reliability Score on a grid based on Weijs (2010).</span>

    <span class="c1">#     Measures the calibration of forecast probabilities against observed frequencies.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     y_true : array-like</span>
    <span class="c1">#         Observed values.</span>
    <span class="c1">#     y_probs : array-like</span>
    <span class="c1">#         Forecast probabilities with shape (n_classes, n_samples).</span>
    <span class="c1">#     index_start : int</span>
    <span class="c1">#         Start index of the climatology period.</span>
    <span class="c1">#     index_end : int</span>
    <span class="c1">#         End index of the climatology period.</span>
    <span class="c1">#     bins : array-like, optional</span>
    <span class="c1">#         Probability bins for discretizing forecast probabilities.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     float</span>
    <span class="c1">#         Reliability score. Returns np.nan if insufficient valid data.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     mask = np.isfinite(y_true) &amp; np.isfinite(y_probs).all(axis=0)</span>
    <span class="c1">#     if not np.any(mask):</span>
    <span class="c1">#         return np.nan</span>
    <span class="c1">#     y_true_clean = y_true[mask]</span>
    <span class="c1">#     y_probs_clean = y_probs[:, mask]</span>
    <span class="c1">#     terciles = np.nanpercentile(y_true_clean[index_start:index_end], [33, 67])</span>
    <span class="c1">#     y_true_clean_class = np.digitize(y_true_clean, bins=terciles, right=True)</span>
    <span class="c1">#     n_categories, n_instances = y_probs_clean.shape</span>
    <span class="c1">#     reliability_sum = 0.0</span>
    <span class="c1">#     for k in range(n_categories):</span>
    <span class="c1">#         y_probs_clean_k = y_probs_clean[k, :]</span>
    <span class="c1">#         binned_indices = np.digitize(y_probs_clean_k, bins) - 1</span>
    <span class="c1">#         for b in range(len(bins) - 1):</span>
    <span class="c1">#             bin_mask = binned_indices == b</span>
    <span class="c1">#             n_kb = np.sum(bin_mask)</span>
    <span class="c1">#             if n_kb &gt; 0:</span>
    <span class="c1">#                 y_kb = np.mean(y_true_clean_class[bin_mask] == k)</span>
    <span class="c1">#                 p_kb = np.mean(y_probs_clean_k[bin_mask])</span>
    <span class="c1">#                 if y_kb &gt; 0 and y_kb &lt; 1 and p_kb &gt; 0 and p_kb &lt; 1:</span>
    <span class="c1">#                     term1 = y_kb * np.log2(y_kb / p_kb) if p_kb &gt; 0 else 0</span>
    <span class="c1">#                     term2 = (1 - y_kb) * np.log2((1 - y_kb) / (1 - p_kb)) if p_kb &lt; 1 else 0</span>
    <span class="c1">#                     reliability_sum += (n_kb / n_instances) * (term1 + term2)</span>
    <span class="c1">#     return reliability_sum</span>

<div class="viewcode-block" id="WAS_Verification.reliability_score_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.reliability_score_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reliability_score_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span>
                              <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                             <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                             <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">,</span> <span class="mf">0.6750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                             <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Reliability Score on a grid based on Weijs (2010).</span>
<span class="sd">    </span>
<span class="sd">        Measures the calibration of forecast probabilities against observed frequencies.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            Reliability score. Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate terciles from climatology period in original y_true</span>
        <span class="k">if</span> <span class="n">index_end</span> <span class="o">&lt;=</span> <span class="n">index_start</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">clim_period</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">]</span>
        <span class="n">valid_clim_data</span> <span class="o">=</span> <span class="n">clim_period</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clim_period</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_clim_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">clim_period</span><span class="p">,</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        
        <span class="c1"># Apply mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="c1"># Classify observations</span>
        <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">reliability_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    
                    <span class="c1"># Check for valid probabilities</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span>
                        <span class="n">reliability_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">reliability_sum</span></div>

    
<div class="viewcode-block" id="WAS_Verification.resolution_and_reliability_per_category_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_and_reliability_per_category_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolution_and_reliability_per_category_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">,</span>
                                              <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                                             <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                                             <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">,</span> <span class="mf">0.6750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                                             <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Resolution and Reliability scores per category based on Weijs (2010).</span>
<span class="sd">        </span>
<span class="sd">        Returns both total scores and per-category breakdowns.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like</span>
<span class="sd">            Observed values.</span>
<span class="sd">        y_probs : array-like</span>
<span class="sd">            Forecast probabilities with shape (n_classes, n_samples).</span>
<span class="sd">        index_start : int</span>
<span class="sd">            Start index of the climatology period.</span>
<span class="sd">        index_end : int</span>
<span class="sd">            End index of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing:</span>
<span class="sd">            - &#39;total_resolution&#39;: float</span>
<span class="sd">            - &#39;total_reliability&#39;: float</span>
<span class="sd">            - &#39;category_resolution&#39;: list of floats for each category</span>
<span class="sd">            - &#39;category_reliability&#39;: list of floats for each category</span>
<span class="sd">            - &#39;category_base_rates&#39;: list of floats (climatological frequencies)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate terciles from climatology period BEFORE masking</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">index_start</span><span class="p">:</span><span class="n">index_end</span><span class="p">],</span> <span class="p">[</span><span class="mi">33</span><span class="p">,</span> <span class="mi">67</span><span class="p">])</span>
        
        <span class="c1"># Apply mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;total_resolution&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;total_reliability&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;category_resolution&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                <span class="s1">&#39;category_reliability&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                <span class="s1">&#39;category_base_rates&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="p">}</span>
        
        <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="c1"># Classify observations into terciles</span>
        <span class="c1"># Use right=False to match typical tercile definition</span>
        <span class="n">y_true_clean_class</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_true_clean</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">terciles</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Values equal to upper tercile go to category 2</span>
        <span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">y_true_clean</span> <span class="o">==</span> <span class="n">terciles</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">2</span>
        
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">category_resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_categories</span>
        <span class="n">category_reliability</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_categories</span>
        
        <span class="c1"># Calculate climatological base rates for each category</span>
        <span class="n">category_base_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">base_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">category_base_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_rate</span><span class="p">)</span>
        
        <span class="n">total_resolution</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_reliability</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">y_probs_clean</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="c1"># Initialize category sums</span>
            <span class="n">cat_res_k</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">cat_rel_k</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Calculate observed frequency in this bin</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_true_clean_class</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="c1"># Calculate average forecast probability in this bin</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    
                    <span class="c1"># Resolution term (compares y_kb to climatology)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1_res</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2_res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">if</span> <span class="n">category_base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">cat_res_k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1_res</span> <span class="o">+</span> <span class="n">term2_res</span><span class="p">)</span>
                    
                    <span class="c1"># Reliability term (compares y_kb to p_kb)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1_rel</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2_rel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">cat_rel_k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1_rel</span> <span class="o">+</span> <span class="n">term2_rel</span><span class="p">)</span>
            
            <span class="n">category_resolution</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_res_k</span>
            <span class="n">category_reliability</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_rel_k</span>
            <span class="n">total_resolution</span> <span class="o">+=</span> <span class="n">cat_res_k</span>
            <span class="n">total_reliability</span> <span class="o">+=</span> <span class="n">cat_rel_k</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_resolution&#39;</span><span class="p">:</span> <span class="n">total_resolution</span><span class="p">,</span>
            <span class="s1">&#39;total_reliability&#39;</span><span class="p">:</span> <span class="n">total_reliability</span><span class="p">,</span>
            <span class="s1">&#39;category_resolution&#39;</span><span class="p">:</span> <span class="n">category_resolution</span><span class="p">,</span>
            <span class="s1">&#39;category_reliability&#39;</span><span class="p">:</span> <span class="n">category_reliability</span><span class="p">,</span>
            <span class="s1">&#39;category_base_rates&#39;</span><span class="p">:</span> <span class="n">category_base_rates</span>
        <span class="p">}</span>    </div>

    
    
<div class="viewcode-block" id="WAS_Verification.resolution_and_reliability_over_all_grid">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_and_reliability_over_all_grid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolution_and_reliability_over_all_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> 
                                                <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                                               <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                                               <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">,</span> <span class="mf">0.6750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                                               <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Resolution and Reliability scores over all grid points.</span>

<span class="sd">        Based on Weijs (2010), computes scores by aggregating across all grid points.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true_class : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - resolution_sum : float</span>
<span class="sd">                Aggregated resolution score.</span>
<span class="sd">            - reliability_sum : float</span>
<span class="sd">                Aggregated reliability score.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="c1"># y_true_class = self.compute_class(y_true, clim_year_start, clim_year_end)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_classes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">y_bar</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">)]</span>
        <span class="n">resolution_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">if</span> <span class="n">y_bar</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">resolution_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="n">reliability_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_clean_k</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_clean_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span> <span class="k">if</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="n">reliability_sum</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resolution_sum</span><span class="p">,</span> <span class="n">reliability_sum</span></div>


<div class="viewcode-block" id="WAS_Verification.resolution_and_reliability_over_all_grid_per_category">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.resolution_and_reliability_over_all_grid_per_category">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolution_and_reliability_over_all_grid_per_category</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span>
                                                       <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span>
                                                                      <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                                                      <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">,</span> <span class="mf">0.6750</span><span class="p">,</span> <span class="mf">0.800</span><span class="p">,</span>
                                                                      <span class="mf">0.850</span><span class="p">,</span> <span class="mf">0.900</span><span class="p">,</span> <span class="mf">0.950</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;       </span>
<span class="sd">        Assumes y_true_class already contains valid category labels (0, 1, 2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Align datasets</span>
        <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        
        <span class="c1"># Flatten all dimensions</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Mask invalid values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_classes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        
        <span class="n">n_categories</span><span class="p">,</span> <span class="n">n_instances</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="c1"># Base rates (overall climatology)</span>
        <span class="n">base_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">base_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
        
        <span class="c1"># Initialize results</span>
        <span class="n">total_resolution</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">total_reliability</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">category_resolution</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_categories</span>
        <span class="n">category_reliability</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_categories</span>
        
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_categories</span><span class="p">):</span>
            <span class="n">y_probs_k</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">binned_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">y_probs_k</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="n">cat_res_k</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">cat_rel_k</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bin_mask</span> <span class="o">=</span> <span class="n">binned_indices</span> <span class="o">==</span> <span class="n">b</span>
                <span class="n">n_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">n_kb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">y_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">p_kb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_probs_k</span><span class="p">[</span><span class="n">bin_mask</span><span class="p">])</span>
                    
                    <span class="c1"># Resolution</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1_res</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">term2_res</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">base_rates</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                        <span class="n">cat_res_k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1_res</span> <span class="o">+</span> <span class="n">term2_res</span><span class="p">)</span>
                    
                    <span class="c1"># Reliability</span>
                    <span class="k">if</span> <span class="n">y_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y_kb</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">p_kb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">term1_rel</span> <span class="o">=</span> <span class="n">y_kb</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">y_kb</span> <span class="o">/</span> <span class="n">p_kb</span><span class="p">)</span>
                        <span class="n">term2_rel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_kb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_kb</span><span class="p">))</span>
                        <span class="n">cat_rel_k</span> <span class="o">+=</span> <span class="p">(</span><span class="n">n_kb</span> <span class="o">/</span> <span class="n">n_instances</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">term1_rel</span> <span class="o">+</span> <span class="n">term2_rel</span><span class="p">)</span>
            
            <span class="n">category_resolution</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_res_k</span>
            <span class="n">category_reliability</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat_rel_k</span>
            <span class="n">total_resolution</span> <span class="o">+=</span> <span class="n">cat_res_k</span>
            <span class="n">total_reliability</span> <span class="o">+=</span> <span class="n">cat_rel_k</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;total_resolution&#39;</span><span class="p">:</span> <span class="n">total_resolution</span><span class="p">,</span>
            <span class="s1">&#39;total_reliability&#39;</span><span class="p">:</span> <span class="n">total_reliability</span><span class="p">,</span>
            <span class="s1">&#39;category_resolution&#39;</span><span class="p">:</span> <span class="n">category_resolution</span><span class="p">,</span>
            <span class="s1">&#39;category_reliability&#39;</span><span class="p">:</span> <span class="n">category_reliability</span><span class="p">,</span>
            <span class="s1">&#39;category_base_rates&#39;</span><span class="p">:</span> <span class="n">base_rates</span><span class="p">,</span>
            <span class="s1">&#39;total_instances&#39;</span><span class="p">:</span> <span class="n">n_instances</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="WAS_Verification.reliability_diagram">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.reliability_diagram">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reliability_diagram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span>
                           <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.150</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="mf">0.300</span><span class="p">,</span> <span class="mf">0.350</span><span class="p">,</span> <span class="mf">0.400</span><span class="p">,</span> <span class="mf">0.450</span><span class="p">,</span> <span class="mf">0.500</span><span class="p">,</span>
                                          <span class="mf">0.550</span><span class="p">,</span> <span class="mf">0.600</span><span class="p">,</span> <span class="mf">0.650</span><span class="p">,</span> <span class="mf">0.6700</span><span class="p">])):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot Reliability Diagrams for probabilistic forecasts.</span>

<span class="sd">        Visualizes the calibration of forecast probabilities against observed frequencies.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        modelname : str</span>
<span class="sd">            Name of the model for labeling the plot.</span>
<span class="sd">        dir_to_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        bins : array-like, optional</span>
<span class="sd">            Probability bins for discretizing forecast probabilities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BELOW AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;NEAR AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;ABOVE AVERAGE&quot;</span><span class="p">]</span>
        <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="c1"># y_true_class = self.compute_class(y_true, clim_year_start, clim_year_end)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_classes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probabilities</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="c1"># resolution, reliability = self.resolution_and_reliability_over_all_grid(</span>
             <span class="c1"># y_true_class, y_probs, bins</span>
        <span class="c1"># )</span>
        <span class="n">result_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution_and_reliability_over_all_grid_per_category</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
        <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">observed_freqs</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)}</span>
        <span class="n">forecast_counts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_bins</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predicted_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">predicted_probabilities</span><span class="p">[</span><span class="n">tercile</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">observed_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">bin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">bin_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_index</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">bin_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">obs</span> <span class="o">==</span> <span class="n">tercile</span><span class="p">:</span>
                    <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">bin_index</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">],</span>
                <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">],</span>
                <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BELOW AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;NEAR AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;ABOVE AVERAGE&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tercile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reliability Curve&quot;</span><span class="p">)</span>
            <span class="n">non_zero_mask</span> <span class="o">=</span> <span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">non_zero_mask</span><span class="p">):</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">non_zero_mask</span><span class="p">],</span> <span class="n">observed_freqs</span><span class="p">[</span><span class="n">tercile</span><span class="p">][</span><span class="n">non_zero_mask</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Regression Fit&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;r:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Perfect Reliability&quot;</span><span class="p">)</span>
            <span class="n">total_observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observed_classes</span> <span class="o">==</span> <span class="n">tercile</span><span class="p">)</span>
            <span class="n">total_forecasts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_classes</span><span class="p">)</span>
            <span class="n">relative_frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_observed</span> <span class="o">/</span> <span class="n">total_forecasts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">relative_frequency</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Relative Frequency&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">relative_frequency</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">no_skill_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">no_skill_y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">no_skill_x</span> <span class="o">+</span> <span class="n">relative_frequency</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No Skill Line&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">no_skill_x</span> <span class="o">&lt;=</span> <span class="n">relative_frequency</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">no_skill_x</span><span class="p">,</span> <span class="n">no_skill_y</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">no_skill_x</span> <span class="o">&gt;=</span> <span class="n">relative_frequency</span><span class="p">),</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;REL= </span><span class="si">{</span><span class="n">result_all</span><span class="p">[</span><span class="s1">&#39;category_reliability&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.671</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;RES= </span><span class="si">{</span><span class="n">result_all</span><span class="p">[</span><span class="s1">&#39;category_resolution&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="n">forecast_counts</span><span class="p">[</span><span class="n">tercile</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_forecasts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">tercile</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Forecast Probability (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Observed Relative Frequency (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reliability Diagrams </span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">/RELIABILITY_</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">_.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.plot_roc_curves">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_roc_curves">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_roc_curves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">dir_to_save_score</span><span class="p">,</span> <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">,</span>
                        <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot ROC Curves with Confidence Intervals for probabilistic forecasts.</span>

<span class="sd">        Visualizes the Receiver Operating Characteristic for each tercile category.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        modelname : str</span>
<span class="sd">            Name of the model for labeling the plot.</span>
<span class="sd">        dir_to_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        y_true_class : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_probs : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        n_bootstraps : int, optional</span>
<span class="sd">            Number of bootstrap samples for confidence intervals. Default is 200.</span>
<span class="sd">        ci : float, optional</span>
<span class="sd">            Confidence interval level (e.g., 0.95 for 95%). Default is 0.95.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BELOW AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;NEAR AVERAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;ABOVE AVERAGE&quot;</span><span class="p">]</span>
        <span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true_class</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">)</span>
        <span class="c1"># y_true_class = self.compute_class(y_true, clim_year_start, clim_year_end)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">y_true_class</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">y_probs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flat_dim</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">observed_outcomes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">observed_outcomes</span> <span class="o">=</span> <span class="n">observed_outcomes</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">binary_labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_outcomes</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">binary_labels</span><span class="p">,</span> <span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
            <span class="n">tprs_bootstrap</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mean_fpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bootstraps</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">boot_binary_labels</span> <span class="o">=</span> <span class="n">binary_labels</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">boot_predicted_probs</span> <span class="o">=</span> <span class="n">predicted_probs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">boot_binary_labels</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">boot_fpr</span><span class="p">,</span> <span class="n">boot_tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">boot_binary_labels</span><span class="p">,</span> <span class="n">boot_predicted_probs</span><span class="p">)</span>
                <span class="n">interp_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">mean_fpr</span><span class="p">,</span> <span class="n">boot_fpr</span><span class="p">,</span> <span class="n">boot_tpr</span><span class="p">)</span>
                <span class="n">interp_tpr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">tprs_bootstrap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_tpr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tprs_bootstrap</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid bootstrap samples for </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> category.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">tprs_bootstrap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">)</span>
            <span class="n">mean_tpr</span> <span class="o">=</span> <span class="n">tprs_bootstrap</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mean_tpr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">lower_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">upper_tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">tprs_bootstrap</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;ROC curve (AUC = </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="c1"># ax.fill_between(mean_fpr, lower_tpr, upper_tpr, color=&#39;blue&#39;, alpha=0.2,</span>
            <span class="c1">#                 label=f&#39;{int(ci*100)}% CI&#39;)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;No Skill&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ROC Curve for </span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> Category&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC Curves for </span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_score</span><span class="si">}</span><span class="s2">/ROC_</span><span class="si">{</span><span class="n">modelname</span><span class="si">}</span><span class="s2">_.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Ensemble Metrics</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.compute_crps">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_crps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_crps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Continuous Ranked Probability Score (CRPS) for ensemble forecasts.</span>

<span class="sd">        Measures the difference between the forecast ensemble distribution and observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        y_pred : xarray.DataArray</span>
<span class="sd">            Ensemble forecast data with dimensions (T, number, Y, X).</span>
<span class="sd">        member_dim : str, optional</span>
<span class="sd">            Dimension name for ensemble members. Default is &#39;number&#39;.</span>
<span class="sd">        dim : str, optional</span>
<span class="sd">            Dimension to compute CRPS over (typically time). Default is &#39;T&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            CRPS values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xs</span><span class="o">.</span><span class="n">crps_ensemble</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="n">member_dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span></div>


    <span class="c1"># ------------------------</span>
    <span class="c1"># Probabilistic Scoring</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.compute_probabilistic_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_probabilistic_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_probabilistic_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_func</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">,</span><span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="o">**</span><span class="n">score_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a probabilistic scoring function over xarray DataArrays.</span>

<span class="sd">        Computes the specified probabilistic metric across the time dimension for each grid point.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        score_func : callable</span>
<span class="sd">            Probabilistic scoring function to apply (e.g., calculate_rpss, calculate_groc).</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X).</span>
<span class="sd">        prob_pred : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span>   <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">score_func</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">prob_pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index_start&#39;</span><span class="p">:</span> <span class="n">index_start</span><span class="p">,</span> <span class="s1">&#39;index_end&#39;</span><span class="p">:</span> <span class="n">index_end</span><span class="p">,</span> <span class="o">**</span><span class="n">score_kwargs</span><span class="p">},</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span></div>


    <span class="c1"># def compute_probabilistic_score(self, score_func, obs, prob_pred, clim_year_start, clim_year_end):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Apply a probabilistic scoring function over xarray DataArrays.</span>

    <span class="c1">#     Computes the specified probabilistic metric across the time dimension for each grid point.</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     score_func : callable</span>
    <span class="c1">#         Probabilistic scoring function to apply (e.g., calculate_rpss, calculate_groc).</span>
    <span class="c1">#     obs : xarray.DataArray</span>
    <span class="c1">#         Observed data with dimensions (T, Y, X).</span>
    <span class="c1">#     prob_pred : xarray.DataArray</span>
    <span class="c1">#         Forecast probabilities with dimensions (probability, T, Y, X).</span>
    <span class="c1">#     clim_year_start : int or str</span>
    <span class="c1">#         Start year of the climatology period.</span>
    <span class="c1">#     clim_year_end : int or str</span>
    <span class="c1">#         End year of the climatology period.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     xarray.DataArray</span>
    <span class="c1">#         Score values with dimensions (Y, X).</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     index_start = obs.get_index(&quot;T&quot;).get_loc(str(clim_year_start)).start</span>
    <span class="c1">#     index_end = obs.get_index(&quot;T&quot;).get_loc(str(clim_year_end)).stop</span>
    <span class="c1">#     obs, prob_pred = xr.align(obs, prob_pred)</span>
    <span class="c1">#     return xr.apply_ufunc(</span>
    <span class="c1">#         score_func,</span>
    <span class="c1">#         obs,</span>
    <span class="c1">#         prob_pred,</span>
    <span class="c1">#         input_core_dims=[(&#39;T&#39;,), (&#39;probability&#39;, &#39;T&#39;)],</span>
    <span class="c1">#         vectorize=True,</span>
    <span class="c1">#         kwargs={&#39;index_start&#39;: index_start, &#39;index_end&#39;: index_end},</span>
    <span class="c1">#         dask=&#39;parallelized&#39;,</span>
    <span class="c1">#         output_core_dims=[()],</span>
    <span class="c1">#         output_dtypes=[&#39;float&#39;],</span>
    <span class="c1">#         dask_gufunc_kwargs={&quot;allow_rechunk&quot;: True},</span>
    <span class="c1">#     )</span>



    <span class="c1"># ------------------------</span>
    <span class="c1"># Plotting Utilities</span>
    <span class="c1"># ------------------------</span>

<div class="viewcode-block" id="WAS_Verification.plot_model_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_model_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_model_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_metric</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">dir_save_score</span><span class="p">,</span> <span class="n">figure_name</span><span class="o">=</span><span class="s2">&quot;WAS_MLR&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a deterministic score on a map.</span>

<span class="sd">        Creates a geographical plot of the specified metric for a single model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_metric : xarray.DataArray</span>
<span class="sd">            Score values with dimensions (Y, X).</span>
<span class="sd">        score : str</span>
<span class="sd">            Name of the score to plot (e.g., &#39;Pearson&#39;, &#39;MAE&#39;).</span>
<span class="sd">        dir_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        figure_name : str, optional</span>
<span class="sd">            Prefix for the figure filename. Default is &#39;WAS_MLR&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_save_score</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_save_score</span><span class="p">)</span>
        <span class="n">dir_save_score</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">score_meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">model_metric</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">figure_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span>
                              <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">])</span>

        <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir_save_score</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">figure_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.plot_models_score">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.plot_models_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_models_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_metrics</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">dir_save_score</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot multiple model scores on a grid of maps.</span>

<span class="sd">        Creates a subplot grid with geographical plots for each model&#39;s score.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_metrics : dict</span>
<span class="sd">            Dictionary of model names and their corresponding score DataArrays (Y, X).</span>
<span class="sd">        score : str</span>
<span class="sd">            Name of the score to plot (e.g., &#39;Pearson&#39;, &#39;MAE&#39;).</span>
<span class="sd">        dir_save_score : str or Path</span>
<span class="sd">            Directory to save the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_save_score</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_save_score</span><span class="p">)</span>
        <span class="n">dir_save_score</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">score_meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
        <span class="n">n_scores</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_metrics</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_scores</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_scores</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()}</span>
        <span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">score_meta_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">center</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">-</span> <span class="mf">0.12</span><span class="p">,</span>
                                  <span class="n">ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">])</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>  
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">dir_save_score</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2">_all_models.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="c1"># ------------------ Probability Calculation Methods ------------------</span>

<div class="viewcode-block" id="WAS_Verification._ppf_terciles_from_code">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification._ppf_terciles_from_code">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ppf_terciles_from_code</span><span class="p">(</span><span class="n">dist_code</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tercile thresholds (T1, T2) from best-fit distribution parameters.</span>
<span class="sd">    </span>
<span class="sd">        dist_code:</span>
<span class="sd">            1: norm</span>
<span class="sd">            2: lognorm</span>
<span class="sd">            3: expon</span>
<span class="sd">            4: gamma</span>
<span class="sd">            5: weibull_min</span>
<span class="sd">            6: t</span>
<span class="sd">            7: poisson</span>
<span class="sd">            8: nbinom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist_code</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">lognorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">lognorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">expon</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">expon</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">gamma</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">gamma</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">weibull_min</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">weibull_min</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c1"># Note: Renamed &#39;t_dist&#39; to &#39;t&#39; for standard scipy.stats</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c1"># Poisson: poisson.ppf(q, mu, loc=0)</span>
                <span class="c1"># ASSUMPTION: &#39;mu&#39; (mean) is passed as &#39;shape&#39;</span>
                <span class="c1">#             &#39;loc&#39; is passed as &#39;loc&#39;</span>
                <span class="c1">#             &#39;scale&#39; is unused</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                    <span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c1"># Negative Binomial: nbinom.ppf(q, n, p, loc=0)</span>
                <span class="c1"># ASSUMPTION: &#39;n&#39; (successes) is passed as &#39;shape&#39;</span>
                <span class="c1">#             &#39;p&#39; (probability) is passed as &#39;scale&#39;</span>
                <span class="c1">#             &#39;loc&#39; is passed as &#39;loc&#39;</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                    <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="c1"># Fallback if code is not 1-8</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

        
<div class="viewcode-block" id="WAS_Verification.weibull_shape_solver">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.weibull_shape_solver">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weibull_shape_solver</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to find the root of the Weibull shape parameter &#39;k&#39;.</span>
<span class="sd">        We find &#39;k&#39; such that the theoretical variance/mean^2 ratio</span>
<span class="sd">        matches the observed V/M^2 ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Guard against invalid &#39;k&#39; values during solving</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
            
            <span class="c1"># This is the V/M^2 ratio *implied by k*</span>
            <span class="n">implied_v_over_m_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">g2</span> <span class="o">/</span> <span class="p">(</span><span class="n">g1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="c1"># This is the *observed* ratio</span>
            <span class="n">observed_v_over_m_sq</span> <span class="o">=</span> <span class="n">V</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># Return the difference (we want this to be 0)</span>
            <span class="k">return</span> <span class="n">observed_v_over_m_sq</span> <span class="o">-</span> <span class="n">implied_v_over_m_sq</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1"># Handle math errors</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_bestfit">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_bestfit">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tercile_probabilities_bestfit</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">dist_code</span><span class="p">,</span> <span class="n">dof</span> 
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic tercile probabilities using best-fit family per grid cell.</span>

<span class="sd">        Inputs (per grid cell):</span>
<span class="sd">        - best_guess : 1D array over T (hindcast_det or forecast_det)</span>
<span class="sd">        - T1, T2     : scalar terciles from climatological best-fit distribution</span>
<span class="sd">        - dist_code  : int, as in _ppf_terciles_from_code</span>
<span class="sd">        - shape, loc, scale : scalars from climatology fit</span>

<span class="sd">        Strategy:</span>
<span class="sd">        - For each time step, build a predictive distribution of the same family:</span>
<span class="sd">            * Use best_guess[t] to adjust mean / location;</span>
<span class="sd">            * Keep shape parameters from climatology.</span>
<span class="sd">        - Then compute probabilities:</span>
<span class="sd">            P(B) = F(T1), P(N) = F(T2) - F(T1), P(A) = 1 - F(T2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1"># T1 = np.asarray(T1, dtype=float)</span>
        <span class="c1"># T2 = np.asarray(T2, dtype=float)</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="n">best_guess</span><span class="o">.</span><span class="n">size</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span>

        <span class="c1"># Normal: loc = forecast; scale from clim</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>

        <span class="c1"># Lognormal: shape = sigma from clim; enforce mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>      


        <span class="c1"># Exponential: keep scale from clim; shift loc so mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">))</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc_t</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="c1"># Gamma: use shape from clim; set scale so mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Assuming 5 is for Weibull   </span>
        
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
                <span class="c1"># Get the scalar values for this specific element (e.g., grid cell)</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">error_variance</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
                
                <span class="c1"># Handle cases with no variance to avoid division by zero</span>
                <span class="k">if</span> <span class="n">V</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">continue</span> <span class="c1"># Skip to the next element</span>
        
                <span class="c1"># --- 1. Numerically solve for shape &#39;k&#39; ---</span>
                <span class="c1"># We need a reasonable starting guess. 2.0 is common (Rayleigh dist.)</span>
                <span class="n">initial_guess</span> <span class="o">=</span> <span class="mf">2.0</span>
                
                <span class="c1"># fsolve finds the root of our helper function</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">weibull_shape_solver</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">V</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
                <span class="c1"># --- 2. Check for bad solution and calculate scale &#39;lambda&#39; ---</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Solver failed</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">continue</span>
                
                <span class="c1"># With &#39;k&#39; found, we can now algebraically find scale &#39;lambda&#39;</span>
                <span class="c1"># In scipy.stats, scale is &#39;scale&#39;</span>
                <span class="n">lambda_scale</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
        
                <span class="c1"># --- 3. Calculate Probabilities ---</span>
                <span class="c1"># In scipy.stats, shape &#39;k&#39; is &#39;c&#39;</span>
                <span class="c1"># Use the T1 and T2 values for this specific element</span>
                
                <span class="n">c1</span> <span class="o">=</span> <span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">lambda_scale</span><span class="p">)</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">lambda_scale</span><span class="p">)</span>
        
                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="c1"># Student-t: df from clim; scale from clim; loc = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>       
            <span class="c1"># Check if df is valid for variance calculation</span>
            <span class="k">if</span> <span class="n">dof</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Cannot calculate scale, fill with NaNs</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 1. Calculate t-distribution parameters</span>
                <span class="c1"># &#39;loc&#39; (mean) is just the best_guess</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">best_guess</span>
                <span class="c1"># &#39;scale&#39; is calculated from the variance and df</span>
                <span class="c1"># Variance = scale**2 * (df / (df - 2))</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">*</span> <span class="p">(</span><span class="n">dof</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>
                
                <span class="c1"># 2. Calculate probabilities</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="c1"># Assuming 7 is for Poisson</span>
            
            <span class="c1"># --- 1. Set the Poisson parameter &#39;mu&#39; ---</span>
            <span class="c1"># The &#39;mu&#39; parameter is the mean.</span>
            
            <span class="c1"># A warning is strongly recommended if error_variance is different from best_guess</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;error_variance&#39; is not equal to &#39;best_guess&#39;.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Poisson model assumes mean=variance and is likely inappropriate.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consider using Negative Binomial.&quot;</span><span class="p">)</span>
            
            <span class="n">mu</span> <span class="o">=</span> <span class="n">best_guess</span>
        
            <span class="c1"># --- 2. Calculate Probabilities ---</span>
            <span class="c1"># poisson.cdf(k, mu) calculates P(X &lt;= k)</span>
            
            <span class="n">c1</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="c1"># Assuming 8 is for Negative Binomial</span>
            
            <span class="c1"># --- 1. Calculate Negative Binomial Parameters ---</span>
            <span class="c1"># This model is ONLY valid for overdispersion (Variance &gt; Mean).</span>
            <span class="c1"># We will use np.where to set parameters to NaN if V &lt;= M.</span>
            
            <span class="c1"># p = Mean / Variance</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">&gt;</span> <span class="n">best_guess</span><span class="p">,</span> 
                         <span class="n">best_guess</span> <span class="o">/</span> <span class="n">error_variance</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># n = Mean^2 / (Variance - Mean)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">&gt;</span> <span class="n">best_guess</span><span class="p">,</span> 
                         <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">error_variance</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">),</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># --- 2. Calculate Probabilities ---</span>
            <span class="c1"># The nbinom.cdf function will propagate NaNs, correctly</span>
            <span class="c1"># handling the cases where the model was invalid.</span>
            
            <span class="n">c1</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid distribution&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_tercile_probabilities_nonparametric">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_tercile_probabilities_nonparametric">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tercile_probabilities_nonparametric</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_samples</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Non-parametric method using historical error samples.&quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_samples</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">first_tercile</span><span class="p">)</span>
            <span class="n">p_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">first_tercile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">second_tercile</span><span class="p">))</span>
            <span class="n">p_above</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_below</span> <span class="o">+</span> <span class="n">p_between</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_below</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_between</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_above</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_compute_prob">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_compute_prob">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gcm_compute_prob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Predictant</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">clim_year_start</span><span class="p">,</span>
        <span class="n">clim_year_end</span><span class="p">,</span>
        <span class="n">hindcast_det</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">best_code_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_shape_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_loc_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_scale_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile probabilities for deterministic hindcasts.</span>

<span class="sd">        If dist_method == &#39;bestfit&#39;:</span>
<span class="sd">            - Use cluster-based best-fit distributions to:</span>
<span class="sd">                * derive terciles analytically from (best_code_da, best_shape_da, best_loc_da, best_scale_da),</span>
<span class="sd">                * compute predictive probabilities using the same family.</span>

<span class="sd">        Otherwise:</span>
<span class="sd">            - Use empirical terciles from Predictant climatology and the selected</span>
<span class="sd">              parametric / nonparametric method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data (T, Y, X) or (T, Y, X, M).</span>
<span class="sd">        clim_year_start, clim_year_end : int or str</span>
<span class="sd">            Climatology period (inclusive) for thresholds.</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic hindcast (T, Y, X).</span>
<span class="sd">        best_code_da, best_shape_da, best_loc_da, best_scale_da : xarray.DataArray, optional</span>
<span class="sd">            Output from WAS_TransformData.fit_best_distribution_grid, required for &#39;bestfit&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hindcast_prob : xarray.DataArray</span>
<span class="sd">            Probabilities with dims (probability=[&#39;PB&#39;,&#39;PN&#39;,&#39;PA&#39;], T, Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle member dimension if present</span>
        <span class="k">if</span> <span class="s2">&quot;M&quot;</span> <span class="ow">in</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">Predictant</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Ensure dimension order</span>
        <span class="n">Predictant</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>

        <span class="c1"># Spatial mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Climatology subset</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">clim</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough years in climatology period for terciles.&quot;</span><span class="p">)</span>

        <span class="c1"># Error variance for predictive distributions</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">clim</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Empirical terciles (used by non-bestfit methods)</span>
        <span class="n">terciles_emp</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">T1_emp</span> <span class="o">=</span> <span class="n">terciles_emp</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;quantile&quot;</span><span class="p">)</span>
        <span class="n">T2_emp</span> <span class="o">=</span> <span class="n">terciles_emp</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;quantile&quot;</span><span class="p">)</span>
        

        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span>

        <span class="c1"># ---------- BESTFIT: zone-wise optimal distributions ----------</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;bestfit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">best_code_da</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;dist_method=&#39;bestfit&#39; requires best_code_da, best_shape_da_da, best_loc_da, best_scale_da.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># T1, T2 from best-fit distributions (per grid)</span>
            <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ppf_terciles_from_code</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">best_shape_da</span><span class="p">,</span>
                <span class="n">best_loc_da</span><span class="p">,</span>
                <span class="n">best_scale_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Predictive probabilities using same family</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_bestfit</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># ---------- Nonparametric ----------</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1_emp</span><span class="p">,</span>
                <span class="n">T2_emp</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dist_method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
            <span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;PB&quot;</span><span class="p">,</span> <span class="s2">&quot;PN&quot;</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">hindcast_prob</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Verification.gcm_validation_compute">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.gcm_validation_compute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gcm_validation_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models_files_path</span><span class="p">,</span> <span class="n">Obs</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span>
                              <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate multiple General Circulation Model (GCM) forecasts using specified metrics.</span>

<span class="sd">        Computes deterministic, probabilistic, or ensemble-based scores for GCM hindcasts</span>
<span class="sd">        by processing model data from provided file paths and comparing against observations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        models_files_path : dict</span>
<span class="sd">            Dictionary mapping model identifiers (e.g., model names) to file paths of hindcast NetCDF files.</span>
<span class="sd">        Obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        score : str</span>
<span class="sd">            Score to compute, must be a key in self.scores (e.g., &#39;Pearson&#39;, &#39;RPSS&#39;, &#39;ROC_CURVE&#39;, &#39;RELIABILITY_DIAGRAM&#39;).</span>
<span class="sd">        month_of_initialization : int</span>
<span class="sd">            Month of forecast initialization (1-12).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        dir_to_save_roc_reliability : str or Path</span>
<span class="sd">            Directory to save ROC curves and reliability diagram plots.</span>
<span class="sd">        lead_time : list of int, optional</span>
<span class="sd">            Lead times in months to define the forecast season (e.g., [1, 2, 3] for a 3-month season).</span>
<span class="sd">            If None, no season is specified.</span>
<span class="sd">        ensemble_mean : str, optional</span>
<span class="sd">            Ensemble statistic to use for deterministic or probabilistic scores (e.g., &#39;mean&#39;).</span>
<span class="sd">            If None, ensemble mean is computed automatically when required.</span>
<span class="sd">        gridded : bool, optional</span>
<span class="sd">            Whether to perform gridded validation (True) or non-gridded (not implemented). Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or None</span>
<span class="sd">            If score_type is &#39;det_score&#39;, &#39;prob_score&#39;, or &#39;ensemble_score&#39;:</span>
<span class="sd">                Dictionary with model identifiers as keys and xarray.DataArray of scores (dimensions Y, X) as values.</span>
<span class="sd">            If score_type is &#39;all_grid_prob_score&#39; (e.g., ROC_CURVE, RELIABILITY_DIAGRAM):</span>
<span class="sd">                None, as results are saved as plots.</span>
<span class="sd">            If score_type is &#39;all_grid_det_score&#39;:</span>
<span class="sd">                None (not implemented).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the score is not recognized or if non-gridded validation is attempted (not implemented).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
            <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>
        <span class="n">x_metric</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">gridded</span><span class="p">:</span>
            <span class="n">Obs_data_</span> <span class="o">=</span> <span class="n">Obs</span>
            <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">models_files_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">score_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">model_data_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">models_files_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
                <span class="n">year_start_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">year_end_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">model_data_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Obs_data</span> <span class="o">=</span> <span class="n">Obs_data_</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_</span><span class="p">)))</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">Y</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">model_data_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                
                <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data_</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obs_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;det_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_deterministic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">:</span>
                    <span class="c1">### A revoir aussi</span>
                    <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_probabilistic_score</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">5</span><span class="p">],</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span>
                    <span class="p">)</span>
                    <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble score does not require an ensemble mean or median.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">#### A revoir</span>
                        <span class="n">score_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_crps</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">member_dim</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                        <span class="n">x_metric</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_result</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_prob_score&quot;</span><span class="p">:</span>
                    <span class="c1">#### A revoir</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ensemble_mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">model_data</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
                        <span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">proba_forecast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs_data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;ROC_CURVE&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plot_roc_curves</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                             <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">score</span> <span class="o">==</span> <span class="s2">&quot;RELIABILITY_DIAGRAM&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reliability_diagram</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dir_to_save_roc_reliability</span><span class="p">,</span> <span class="n">Obs_data</span><span class="p">,</span> <span class="n">proba_forecast</span><span class="p">,</span>
                                                <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plotting for score </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> is not implemented.&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s2">&quot;all_grid_det_score&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-gridded data validation is not implemented yet.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_metric</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">[</span><span class="n">score</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;det_score&quot;</span><span class="p">,</span> <span class="s2">&quot;prob_score&quot;</span><span class="p">,</span> <span class="s2">&quot;ensemble_score&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WAS_Verification.weighted_gcm_forecasts">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.weighted_gcm_forecasts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">weighted_gcm_forecasts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Obs</span><span class="p">,</span>
        <span class="n">best_models</span><span class="p">,</span>
        <span class="n">scores</span><span class="p">,</span>
        <span class="n">lead_time</span><span class="p">,</span>
        <span class="n">model_dir</span><span class="p">,</span>
        <span class="n">clim_year_start</span><span class="p">,</span>
        <span class="n">clim_year_end</span><span class="p">,</span>
        <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;PRCP&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate weighted ensemble forecasts from selected GCMs based on their performance scores.</span>

<span class="sd">        Combines hindcasts and forecasts from multiple models using weights derived from</span>
<span class="sd">        the GROC score, scales the results to match observed climatology, and computes</span>
<span class="sd">        tercile probabilities.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), used for scaling and probability calculations.</span>
<span class="sd">        best_models : dict</span>
<span class="sd">            Dictionary of model identifiers (keys) to be included in the ensemble.</span>
<span class="sd">        scores : dict</span>
<span class="sd">            Dictionary containing scores (e.g., GROC) for each model, with model identifiers as keys.</span>
<span class="sd">        lead_time : list of int</span>
<span class="sd">            Lead times in months for the forecast season (e.g., [1, 2, 3] for a 3-month season).</span>
<span class="sd">        model_dir : str or Path</span>
<span class="sd">            Directory containing hindcast and forecast NetCDF files.</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for computing tercile thresholds.</span>
<span class="sd">        variable : str, optional</span>
<span class="sd">            Variable name in the NetCDF files (e.g., &#39;PRCP&#39; for precipitation). Default is &#39;PRCP&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            - hindcast_det : xarray.DataArray</span>
<span class="sd">                Weighted deterministic hindcast with dimensions (T, Y, X).</span>
<span class="sd">            - hindcast_prob : xarray.DataArray</span>
<span class="sd">                Tercile probabilities for hindcasts with dimensions (probability, T, Y, X).</span>
<span class="sd">            - forecast_prob : xarray.DataArray</span>
<span class="sd">                Tercile probabilities for forecasts with dimensions (probability, Y, X).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Model files are expected to follow a naming convention like</span>
<span class="sd">          &#39;hindcast_{center}_{variable}_{init_month}_{season}_{lead}.nc&#39;.</span>
<span class="sd">        - The GROC score is used as the weighting metric.</span>
<span class="sd">        - A scaling factor is applied based on the ratio of observed to hindcast mean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span><span class="p">)</span>
        <span class="n">score_sum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">best_models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">score_array</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="s2">&quot;GROC&quot;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">score_array</span> <span class="o">=</span> <span class="n">score_array</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">hindcast_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="p">)</span>
            <span class="n">forecast_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dir</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="p">)</span>
            <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hincast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
            <span class="n">hincast_data</span> <span class="o">=</span> <span class="n">hincast_data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">forecast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
            <span class="n">forecast_data</span> <span class="o">=</span> <span class="n">forecast_data</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">Y</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
                <span class="n">X</span><span class="o">=</span><span class="n">tmp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">hincast_weighted</span> <span class="o">=</span> <span class="n">hincast_data</span> <span class="o">*</span> <span class="n">score_array</span>
            <span class="n">forecast_weighted</span> <span class="o">=</span> <span class="n">forecast_data</span> <span class="o">*</span> <span class="n">score_array</span>
            <span class="k">if</span> <span class="n">hindcast_det</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hincast_weighted</span>
                <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_weighted</span>
                <span class="n">score_sum</span> <span class="o">=</span> <span class="n">score_array</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">+</span> <span class="n">hincast_weighted</span>
                <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">+</span> <span class="n">forecast_weighted</span>
                <span class="n">score_sum</span> <span class="o">=</span> <span class="n">score_sum</span> <span class="o">+</span> <span class="n">score_array</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">/</span> <span class="n">score_sum</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">/</span> <span class="n">score_sum</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">Obs</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Obs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">hindcast_det</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">hindcast_det</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span> <span class="o">*</span> <span class="n">f</span>
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hindcast_det</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">forecast_det</span>
            <span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob</span><span class="p">(</span><span class="n">Obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">)</span>
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gcm_compute_prob_forecast</span><span class="p">(</span><span class="n">Obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">)</span>
            <span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">hindcast_prob</span><span class="p">,</span> <span class="n">forecast_prob</span></div>


<div class="viewcode-block" id="WAS_Verification.classify_percent">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.classify_percent">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify_percent</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Classify a percentage value into predefined categories based on thresholds.</span>

<span class="sd">        Maps a percentage ratio to one of five categories representing deviation from average.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p : float or array-like</span>
<span class="sd">            Percentage value(s) to classify, typically representing a ratio to normal (%).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int or array-like</span>
<span class="sd">            Category code:</span>
<span class="sd">            - 1: Well Above Average (&gt;= 150%)</span>
<span class="sd">            - 2: Above Average (&gt;= 110%)</span>
<span class="sd">            - 3: Near Average (&gt;= 90%)</span>
<span class="sd">            - 4: Below Average (&gt;= 50%)</span>
<span class="sd">            - 5: Well Below Average (&lt; 50%)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">150</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Well Above Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">110</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># Above Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>  <span class="c1"># Near Average</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">4</span>  <span class="c1"># Below Average</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>  <span class="c1"># Well Below Average</span></div>


<div class="viewcode-block" id="WAS_Verification.ratio_to_average">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.ratio_to_average">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ratio_to_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and visualize the ratio of a specific year&#39;s data to the climatological mean.</span>

<span class="sd">        Calculates the percentage ratio of the predictand for a given year relative to</span>
<span class="sd">        the mean over a climatology period, classifies it into categories, and plots the</span>
<span class="sd">        result on a geographical map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period.</span>
<span class="sd">        year : int or str</span>
<span class="sd">            Specific year to compute the ratio for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays a geographical plot of the classified ratios with a custom colormap and legend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="o">/</span> <span class="n">clim_mean</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">mask</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">classified</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">classify_percent</span><span class="p">,</span>
            <span class="n">ratio</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;#1a9641&#39;</span><span class="p">,</span> <span class="s1">&#39;#a6d96a&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffffbf&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdae61&#39;</span><span class="p">,</span> <span class="s1">&#39;#d7191c&#39;</span><span class="p">])</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Well Above Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Above Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Near Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Below Avg&quot;</span><span class="p">,</span> <span class="s2">&quot;Well Below Avg&quot;</span><span class="p">]</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">classified</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
        <span class="n">legend_patches</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_patches</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Ratio to Normal [%]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Verification.calculate_rpss_">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.calculate_rpss_">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_rpss_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_probs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Ranked Probability Skill Score (RPSS) for a single grid point or sample.</span>

<span class="sd">        Compares the Ranked Probability Score (RPS) of the forecast to a climatological</span>
<span class="sd">        reference with uniform probabilities (1/3 for each tercile).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        y_true : array-like of shape (n_samples,)</span>
<span class="sd">            True class labels, already classified into terciles (0: below-normal, 1: near-normal, 2: above-normal).</span>
<span class="sd">        y_probs : array-like of shape (3, n_samples)</span>
<span class="sd">            Forecast probabilities for each tercile category.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">            RPSS score, ranging from -Inf to 1 (1 indicates perfect forecast skill).</span>
<span class="sd">            Returns np.nan if insufficient valid data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y_probs</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">y_true_clean</span> <span class="o">=</span> <span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_probs_clean</span> <span class="o">=</span> <span class="n">y_probs</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
            <span class="n">one_hot</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_true_clean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">cumulative_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">y_probs_clean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cumulative_outcome</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">one_hot</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">cumulative_climatology</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">climatology</span><span class="p">)</span>
            <span class="n">rps_forecast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_forecast</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rps_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">cumulative_climatology</span> <span class="o">-</span> <span class="n">cumulative_outcome</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">rps_forecast</span> <span class="o">/</span> <span class="n">rps_reference</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="WAS_Verification.compute_one_year_rpss">
<a class="viewcode-back" href="../../api.html#wass2s.was_verification.WAS_Verification.compute_one_year_rpss">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_one_year_rpss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute and visualize the Ranked Probability Skill Score (RPSS) for a specific year.</span>

<span class="sd">        Applies the RPSS calculation across a gridded dataset for a single year, using</span>
<span class="sd">        tercile classifications based on a climatology period, and plots the results on a map.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : xarray.DataArray</span>
<span class="sd">            Observed data with dimensions (T, Y, X), where T is time, Y is latitude, and X is longitude.</span>
<span class="sd">        prob_pred : xarray.DataArray</span>
<span class="sd">            Forecast probabilities with dimensions (probability, T, Y, X), where probability includes</span>
<span class="sd">            [&#39;PB&#39;, &#39;PN&#39;, &#39;PA&#39;] (below-normal, near-normal, above-normal).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year of the climatology period for tercile classification.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year of the climatology period for tercile classification.</span>
<span class="sd">        year : int or str</span>
<span class="sd">            Specific year to compute the RPSS for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">            Displays a geographical plot of the RPSS values with a colorbar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_class</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
        <span class="n">prob_pred</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">prob_pred</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_rpss_</span><span class="p">,</span>
            <span class="n">obs</span><span class="p">,</span>
            <span class="n">prob_pred</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[()],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">A_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
        <span class="n">A_</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">,</span>
            <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;RPSS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;extend&#39;</span><span class="p">:</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span>
                <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ticks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ranked Probability Skill Score - </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

           
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>