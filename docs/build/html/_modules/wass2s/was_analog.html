

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_analog &mdash; wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel. 0.3.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1e28cc32"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_analog</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_analog</h1><div class="highlight"><pre>
<span></span><span class="c1"># Core Python Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># Numerical and Data Manipulation Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>

<span class="c1"># Visualization Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>

<span class="c1"># Climate Data API</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cdsapi</span>

<span class="c1"># Machine Learning and Statistical Analysis Libraries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minisom</span><span class="w"> </span><span class="kn">import</span> <span class="n">MiniSom</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sig</span>

<span class="c1"># EOF Analysis and Verification Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xeofs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xskillscore</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Core Python Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="c1"># Numerical and Data Manipulation Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>

<span class="c1"># Visualization Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>

<span class="c1"># Climate Data API</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cdsapi</span>

<span class="c1"># Machine Learning and Statistical Analysis Libraries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minisom</span><span class="w"> </span><span class="kn">import</span> <span class="n">MiniSom</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics.pairwise</span><span class="w"> </span><span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sig</span>

<span class="c1"># EOF Analysis and Verification Libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xeofs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xskillscore</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.utils</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_bias_correction</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="WAS_Analog">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WAS_Analog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analog-based forecasting toolkit for seasonal climate applications.</span>

<span class="sd">    This class orchestrates the end-to-end workflow required to build analog ensembles</span>
<span class="sd">    for Sea-Surface Temperature (SST) predictors and to translate them into deterministic</span>
<span class="sd">    and probabilistic rainfall forecasts over West Africa or any user-defined domain.</span>
<span class="sd">    Supports five analog-selection strategies: Self-Organizing Maps (SOM),</span>
<span class="sd">    correlation ranking, Principal-Component (EOF) similarity, K-Means clustering,</span>
<span class="sd">    and Agglomerative clustering.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save downloaded and processed data files.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Starting year for historical data.</span>
<span class="sd">    year_forecast : int</span>
<span class="sd">        Target forecast year.</span>
<span class="sd">    predictor_vars : list of dict, optional</span>
<span class="sd">        List of dictionaries specifying predictor variables, each containing</span>
<span class="sd">        &#39;reanalysis_name&#39;, &#39;model_name&#39;, &#39;variable&#39;, and &#39;area&#39;.</span>
<span class="sd">        Default is a list with NOAA SST and ERA5 SP, VGRD_850 variables.</span>
<span class="sd">    method_analog : str, optional</span>
<span class="sd">        Analog method to use (&quot;som&quot;, &quot;cor_based&quot;, &quot;bias_based, &quot;pca_based&quot;, &quot;kmeans_based&quot;, &quot;agglomerative_based&quot;). Default is &quot;som&quot;.</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of initialization for forecasts (1-12). If None, uses previous month.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months. If None, defaults to [1, 2, 3, 4, 5].</span>
<span class="sd">    ensemble_mean : str, optional</span>
<span class="sd">        Method for ensemble mean (&quot;mean&quot; or &quot;median&quot;). Default is &quot;mean&quot;.</span>
<span class="sd">    rolling : int, optional</span>
<span class="sd">        Window size for rolling mean. Default is 3.</span>
<span class="sd">    standardize : bool, optional</span>
<span class="sd">        If True, standardize data; otherwise, compute anomalies. Default is True.</span>
<span class="sd">    multivariateEOF : bool, optional</span>
<span class="sd">        If True, use multivariate EOF analysis. Default is False.</span>
<span class="sd">    eof_explained_var : float, optional</span>
<span class="sd">        Fraction of variance to explain with EOF modes. Default is 0.95.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    index_compute : list, optional</span>
<span class="sd">        List of climate indices to compute (e.g., [&#39;NINO34&#39;, &#39;DMI&#39;]).</span>
<span class="sd">    some_grid_size : tuple, optional</span>
<span class="sd">        Grid size for SOM (rows, columns). Default is (None, None) for automatic sizing.</span>
<span class="sd">    some_learning_rate : float, optional</span>
<span class="sd">        Learning rate for SOM training. Default is 0.5.</span>
<span class="sd">    radius : float, optional</span>
<span class="sd">        Neighborhood radius for SOM analog search. Default is 1.0.</span>
<span class="sd">    some_neighborhood_function : str, optional</span>
<span class="sd">        Neighborhood function for SOM (&quot;gaussian&quot;, &quot;mexican_hat&quot;). Default is &quot;gaussian&quot;.</span>
<span class="sd">    some_sigma : float, optional</span>
<span class="sd">        Initial neighborhood radius for SOM. Default is 1.0.</span>
<span class="sd">    some_num_iteration : int, optional</span>
<span class="sd">        Number of iterations for SOM training. Default is 2000.</span>
<span class="sd">    dist_method : str, optional</span>
<span class="sd">        Method for probability calculation (&quot;gamma&quot;, &quot;t&quot;, &quot;normal&quot;, &quot;lognormal&quot;, &quot;nonparam&quot;).</span>
<span class="sd">        Default is &quot;gamma&quot;.</span>
<span class="sd">    n_clusters : int, optional</span>
<span class="sd">        Number of clusters for K-Means and Agglomerative clustering. Default is 4.</span>
<span class="sd">    affinity : str, optional</span>
<span class="sd">        Distance metric for Agglomerative clustering (e.g., &#39;euclidean&#39;, &#39;manhattan&#39;). Default is &#39;euclidean&#39;.</span>
<span class="sd">    linkage : str, optional</span>
<span class="sd">        Linkage criterion for Agglomerative clustering (e.g., &#39;ward&#39;, &#39;complete&#39;, &#39;average&#39;). Default is &#39;ward&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Performance Considerations: For large datasets (e.g., many years or high-dimensional data), the AgglomerativeClustering method (`agglomerative_based`) may be significantly slower than K-Means (`kmeans_based`) or SOM (`som`) due to its computational complexity. Users should consider testing with smaller datasets or reducing the number of clusters when using AgglomerativeClustering.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_Analog.__init__">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_to_save</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_forecast</span><span class="p">,</span>
                 <span class="n">predictor_vars</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;reanalysis_name&#39;</span><span class="p">:</span> <span class="s1">&#39;NOAA&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;NCEP_2&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;SST&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">]},</span>
                                <span class="p">{</span><span class="s1">&#39;reanalysis_name&#39;</span><span class="p">:</span> <span class="s1">&#39;ERA5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;NCEP_2&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;SP&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">]},</span>
                                <span class="p">{</span><span class="s1">&#39;reanalysis_name&#39;</span><span class="p">:</span> <span class="s1">&#39;ERA5&#39;</span><span class="p">,</span> <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="s1">&#39;NCEP_2&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="s1">&#39;VGRD_850&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">]}],</span>
                 <span class="n">method_analog</span><span class="o">=</span><span class="s2">&quot;som&quot;</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_mean</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">rolling</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multivariateEOF</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">eof_explained_var</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">index_compute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">some_grid_size</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">some_learning_rate</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">some_neighborhood_function</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">some_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">some_num_iteration</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span>
                 <span class="n">n_clusters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">affinity</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">dir_to_save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year_start</span> <span class="o">=</span> <span class="n">year_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="o">=</span> <span class="n">year_forecast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span> <span class="o">=</span> <span class="n">predictor_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">=</span> <span class="n">method_analog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="o">=</span> <span class="n">month_of_initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="o">=</span> <span class="n">lead_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span> <span class="o">=</span> <span class="n">ensemble_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eof_explained_var</span> <span class="o">=</span> <span class="n">eof_explained_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multivariateEOF</span> <span class="o">=</span> <span class="n">multivariateEOF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolling</span> <span class="o">=</span> <span class="n">rolling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span> <span class="o">=</span> <span class="n">standardize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span> <span class="o">=</span> <span class="n">clim_year_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span> <span class="o">=</span> <span class="n">clim_year_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span> <span class="o">=</span> <span class="n">index_compute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span> <span class="o">=</span> <span class="n">some_grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_learning_rate</span> <span class="o">=</span> <span class="n">some_learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_neighborhood_function</span> <span class="o">=</span> <span class="n">some_neighborhood_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_sigma</span> <span class="o">=</span> <span class="n">some_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_num_iteration</span> <span class="o">=</span> <span class="n">some_num_iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">=</span> <span class="n">dist_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity</span> <span class="o">=</span> <span class="n">affinity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linkage</span> <span class="o">=</span> <span class="n">linkage</span></div>


<div class="viewcode-block" id="WAS_Analog.calc_index">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calc_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">sst</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate climate indices from SST data.&quot;&quot;&quot;</span>
        <span class="n">sst_indices_name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;NINO34&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3.4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO12&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Ni√±o1+2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;NINO3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO_Global&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;ALL NINO Zone&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;TNA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Northern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="s2">&quot;TSA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Southern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;NAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;North Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="s2">&quot;SAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;South Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;TASI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NAT-SAT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;WTIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Western Tropical Indian Ocean (WTIO)&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s2">&quot;SETIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Southeastern Tropical Indian Ocean (SETIO)&quot;</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;DMI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;WTIO - SETIO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Mediterranean Basin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
            <span class="s2">&quot;M1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">),</span>
            <span class="s2">&quot;M2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;M3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;M3&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;M4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;M4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">),</span>
        <span class="p">}</span>
        
        <span class="n">predictor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sst_indices_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">,</span> <span class="s2">&quot;DMI&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">sst_indices_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sst_region</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_region</span>

        <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;NAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SAT&quot;</span><span class="p">]</span>
        <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;DMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;WTIO&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SETIO&quot;</span><span class="p">]</span>
        
        <span class="n">selected_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">predictor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">predictor</span><span class="p">}</span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">selected_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Analog._postprocess_ersst">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog._postprocess_ersst">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_postprocess_ersst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Post-process ERSST dataset.&quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;zlev&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">keep_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="n">drop_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">drop_vars</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Analog.download_reanalysis">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_reanalysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_reanalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download reanalysis data.&quot;&quot;&quot;</span>
        <span class="n">year_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;reanalysis_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NOLR&quot;</span><span class="p">:</span> <span class="s2">&quot;top_net_thermal_radiation&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">variables_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">months</span><span class="p">])</span>
        <span class="n">store_file_path</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">center</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">areas</span><span class="p">):</span>
            <span class="n">combined_output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">combined_output_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_output_path</span><span class="si">}</span><span class="s2"> exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="n">store_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;NOAA.SST&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">build_iridl_url_ersst</span><span class="p">(</span>
                        <span class="n">year_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span>
                        <span class="n">year_end</span><span class="o">=</span><span class="n">year_end</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
                        <span class="n">run_avg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">month_start</span><span class="o">=</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                        <span class="n">month_end</span><span class="o">=</span><span class="s2">&quot;Dec&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using IRIDL URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s2">&quot;proleptic_gregorian&quot;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s1">&#39;SST&#39;</span><span class="p">})</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_ersst</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;SST&#39;</span><span class="p">:</span> <span class="s1">&#39;sst&#39;</span><span class="p">})</span>
                    <span class="n">store_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved NOAA ERSST data to </span><span class="si">{</span><span class="n">combined_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">store_file_path</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download NOAA.SST: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
        
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">yearly_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">yearly_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">yearly_file_path</span><span class="si">}</span><span class="s2"> exists. Loading existing file.&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                        <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">yearly_file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                        <span class="n">press_level</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-pressure-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                            <span class="s2">&quot;pressure_level&quot;</span><span class="p">:</span> <span class="n">press_level</span><span class="p">,</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;00:00&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-single-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;00:00&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
            
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">))</span>
                
                    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download/process </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
        
            <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concatenating </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> datasets...&quot;</span><span class="p">)</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;expver&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span> <span class="s2">&quot;DLWR&quot;</span><span class="p">,</span> <span class="s2">&quot;NOLR&quot;</span><span class="p">]:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">/</span> <span class="mi">86400</span>
                <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">/</span> <span class="mi">100</span>
                
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">store_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_ds</span>
                <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved combined dataset to </span><span class="si">{</span><span class="n">combined_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">single_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                    <span class="k">if</span> <span class="n">single_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">single_file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted yearly file: </span><span class="si">{</span><span class="n">single_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data combined for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">. Check download success.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">store_file_path</span></div>


<div class="viewcode-block" id="WAS_Analog.download_models">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_models">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download and process seasonal forecast and hindcast data.&quot;&quot;&quot;</span>
        <span class="n">centre_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;BOM_2&quot;</span><span class="p">:</span> <span class="s2">&quot;bom&quot;</span><span class="p">,</span> <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;ecmwf&quot;</span><span class="p">,</span> <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span> <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span> <span class="s2">&quot;METEOFRANCE_9&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;ncep&quot;</span><span class="p">,</span> <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;jma&quot;</span><span class="p">,</span> <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span> <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span>
        <span class="p">}</span>
        <span class="n">system_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;BOM_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;51&quot;</span><span class="p">,</span> <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;604&quot;</span><span class="p">,</span> <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;603&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span> <span class="s2">&quot;METEOFRANCE_9&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span> <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span> <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;35&quot;</span><span class="p">,</span> <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span>
        <span class="p">}</span>
        <span class="n">variables_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NOLR&quot;</span><span class="p">:</span> <span class="s2">&quot;top_thermal_radiation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        <span class="n">areas</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
        <span class="n">selected_centres</span> <span class="o">=</span> <span class="p">[</span><span class="n">centre_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">centers</span><span class="p">]</span>
        <span class="n">selected_systems</span> <span class="o">=</span> <span class="p">[</span><span class="n">system_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">centers</span><span class="p">]</span>

        <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">month</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span>
        <span class="n">lead_time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lead_time</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lead_time must be a list of integers between 1 and 12.&quot;</span><span class="p">)</span>
        <span class="n">year_forecast</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
        <span class="n">hindcast_years</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">dir_to_save</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="n">month_of_initialization</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">)</span>

        <span class="n">store_file_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">store_hdcst_file_path</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">cent</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_centres</span><span class="p">,</span> <span class="n">selected_systems</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">areas</span><span class="p">):</span>
            <span class="n">forecast_file</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;forecast_</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="n">hindcast_file</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;hindcast_</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="si">}{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}{</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
               
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">forecast_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Forecast file </span><span class="si">{</span><span class="n">forecast_file</span><span class="si">}</span><span class="s2"> exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">)</span>
                <span class="n">store_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-pressure-levels&quot;</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;seasonal-monthly-single-levels&quot;</span>
                    <span class="n">forecast_request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_map</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                        <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">)],</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_of_initialization</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;leadtime_month&quot;</span><span class="p">:</span> <span class="n">lead_time</span><span class="p">,</span>
                        <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">]):</span>
                        <span class="n">forecast_request</span><span class="p">[</span><span class="s2">&quot;pressure_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">forecast_request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded forecast: </span><span class="si">{</span><span class="n">forecast_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span> <span class="o">-</span> <span class="mf">273.15</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span> <span class="o">/</span> <span class="mi">100</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span> <span class="s2">&quot;DLWR&quot;</span><span class="p">,</span> <span class="s2">&quot;NOLR&quot;</span><span class="p">]:</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span> <span class="o">/</span> <span class="mi">86400</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span> <span class="ow">and</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds_forecast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;forecast_reference_time&quot;</span> <span class="ow">in</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                    <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_dict</span><span class="p">)</span>


                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">]):</span>
                        <span class="n">ds_forecast</span> <span class="o">=</span> <span class="n">ds_forecast</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;pressure_level&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                    
    
                    <span class="n">ds_forecast</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">))</span>
                    <span class="n">ds_forecast</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">forecast_file</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved processed hindcast to </span><span class="si">{</span><span class="n">forecast_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">store_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_forecast</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">hindcast_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hindcast file </span><span class="si">{</span><span class="n">hindcast_file</span><span class="si">}</span><span class="s2"> exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
                <span class="n">store_hdcst_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-pressure-levels&quot;</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;seasonal-monthly-single-levels&quot;</span>
                    <span class="n">hindcast_request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_map</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                        <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">hindcast_years</span><span class="p">,</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_of_initialization</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;leadtime_month&quot;</span><span class="p">:</span> <span class="n">lead_time</span><span class="p">,</span>
                        <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">]):</span>
                        <span class="n">hindcast_request</span><span class="p">[</span><span class="s2">&quot;pressure_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        
                    <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">hindcast_request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded hindcast: </span><span class="si">{</span><span class="n">hindcast_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span> <span class="o">-</span> <span class="mf">273.15</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span> <span class="o">/</span> <span class="mi">100</span>
                    <span class="k">elif</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span> <span class="s2">&quot;DLWR&quot;</span><span class="p">,</span> <span class="s2">&quot;NOLR&quot;</span><span class="p">]:</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span> <span class="o">/</span> <span class="mi">86400</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span> <span class="ow">and</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds_hindcast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                        

                    <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="s2">&quot;forecast_reference_time&quot;</span> <span class="ow">in</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">coords</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">rename_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                    <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">rename_dict</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables_map</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;HUSS&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD&quot;</span><span class="p">]):</span>
                        <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;pressure_level&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

                    <span class="n">ds_hindcast</span> <span class="o">=</span> <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                    <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
                    <span class="n">ds_hindcast</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">hindcast_file</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved processed hindcast to </span><span class="si">{</span><span class="n">hindcast_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">store_hdcst_file_path</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_hindcast</span>


                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

        <span class="k">return</span> <span class="n">store_hdcst_file_path</span><span class="p">,</span> <span class="n">store_file_path</span></div>


<div class="viewcode-block" id="WAS_Analog.anomaly_timeseries">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.anomaly_timeseries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">anomaly_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute anomalies by removing the climatological mean.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="p">:</span>
            <span class="n">clim_period</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clim_period</span> <span class="o">=</span> <span class="n">ds</span>

        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">clim_period</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">anomaly_slices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
            <span class="n">month_mask</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
            <span class="n">ds_month</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">month_mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">month_mean</span> <span class="o">=</span> <span class="n">clim_mean</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
            <span class="n">ds_anomaly_month</span> <span class="o">=</span> <span class="n">ds_month</span> <span class="o">-</span> <span class="n">month_mean</span>
            <span class="n">anomaly_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_anomaly_month</span><span class="p">)</span>

        <span class="n">ds_anomaly</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">anomaly_slices</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">ds_anomaly</span> <span class="o">=</span> <span class="n">ds_anomaly</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">ds_anomaly</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">ds_anomaly</span> <span class="o">=</span> <span class="n">ds_anomaly</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">ds_anomaly</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds_anomaly</span> <span class="o">=</span> <span class="n">ds_anomaly</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_anomaly</span></div>


<div class="viewcode-block" id="WAS_Analog.standardize_timeseries">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.standardize_timeseries">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">standardize_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standardize the dataset by removing climatological mean and scaling by standard deviation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="p">:</span>
            <span class="n">clim_period</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clim_period</span> <span class="o">=</span> <span class="n">ds</span>

        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">clim_period</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">clim_period</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">clim_std</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clim_std</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="n">standardized_slices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
            <span class="n">month_mask</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span>
            <span class="n">ds_month</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">month_mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">month_mean</span> <span class="o">=</span> <span class="n">clim_mean</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
            <span class="n">month_std</span> <span class="o">=</span> <span class="n">clim_std</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="n">month</span><span class="p">)</span>
            <span class="n">ds_standardized_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds_month</span> <span class="o">-</span> <span class="n">month_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">month_std</span>
            <span class="n">standardized_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_standardized_month</span><span class="p">)</span>

        <span class="n">ds_standardized</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">standardized_slices</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">ds_standardized</span> <span class="o">=</span> <span class="n">ds_standardized</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">ds_standardized</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">ds_standardized</span> <span class="o">=</span> <span class="n">ds_standardized</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;month&quot;</span> <span class="ow">in</span> <span class="n">ds_standardized</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds_standardized</span> <span class="o">=</span> <span class="n">ds_standardized</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_standardized</span></div>


<div class="viewcode-block" id="WAS_Analog.compute_eofs">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.compute_eofs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_eofs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute EOFs and retain modes explaining at least the specified variance.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing EOFs...&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">explained_var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">explained_variance_ratio</span><span class="p">()</span>
        <span class="n">cumulative_var</span> <span class="o">=</span> <span class="n">explained_var</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">n_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumulative_var</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_explained_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected </span><span class="si">{</span><span class="n">n_modes</span><span class="si">}</span><span class="s2"> modes explaining </span><span class="si">{</span><span class="n">cumulative_var</span><span class="p">[</span><span class="n">n_modes</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% variance&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">))</span></div>


<div class="viewcode-block" id="WAS_Analog._detrended_da">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog._detrended_da">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_detrended_da</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">da</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detrend a DataArray by removing the linear trend.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">da</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DataArray must have a time dimension &#39;T&#39; for detrending.&quot;</span><span class="p">)</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">da_detrended</span> <span class="o">=</span> <span class="n">da</span> <span class="o">-</span> <span class="p">(</span><span class="n">trend</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;polyval&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">trend</span><span class="p">)</span> <span class="k">else</span> <span class="n">trend</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">da_detrended</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>\
             <span class="n">trend</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Analog._prepare_data_for_clustering">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog._prepare_data_for_clustering">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_data_for_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_years</span><span class="p">,</span> <span class="n">target_year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper to prepare data (indices or EOFs) for clustering methods.&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>
        <span class="n">data_scaled</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">index_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span><span class="p">:</span>
            <span class="n">ddd_sst</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SST&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
                <span class="n">ddd_sst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detrended_da</span><span class="p">(</span><span class="n">ddd_sst</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ddd_sst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;SST data not found in downloaded datasets for clustering.&quot;</span><span class="p">)</span>
            <span class="n">indices_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span><span class="p">,</span> <span class="n">ddd_sst</span><span class="p">)</span>
            <span class="n">indices_dataset_sel_years</span> <span class="o">=</span> <span class="n">indices_dataset</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">indices_dataset</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_years</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data_scaled</span><span class="p">,</span> <span class="n">index_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrange_indices_for_som</span><span class="p">(</span><span class="n">indices_dataset_sel_years</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multivariateEOF</span><span class="p">:</span>
                <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_detrended_da</span><span class="p">(</span><span class="n">ddd</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">}))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span> <span class="k">else</span> <span class="n">ddd</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ddd</span><span class="p">]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_vars</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
                <span class="n">explained_var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">explained_variance_ratio</span><span class="p">()</span>
                <span class="n">n_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">explained_var</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eof_explained_var</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_modes</span><span class="p">))</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_years</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">month_name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mode_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;mode</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month_name&#39;</span><span class="p">]</span>
                <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;mode_month&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                <span class="n">month_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
                <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">month_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">x</span><span class="p">)))</span>
                <span class="n">df_final</span> <span class="o">=</span> <span class="n">df_pivot</span>
                <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">index_data</span> <span class="o">=</span> <span class="n">df_final</span><span class="o">.</span><span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ddd</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
                        <span class="n">ddd</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detrended_da</span><span class="p">(</span><span class="n">ddd</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_eofs</span><span class="p">(</span><span class="n">ddd</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">unique_years</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">month_name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mode_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;mode</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;month_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;mode_month&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                    <span class="n">month_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
                    <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">month_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">x</span><span class="p">)))</span>
                    <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_final</span><span class="p">,</span> <span class="n">df_pivot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">data_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">index_data</span> <span class="o">=</span> <span class="n">df_final</span><span class="o">.</span><span class="n">index</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaN values found in data for clustering. Imputing with column mean.&quot;</span><span class="p">)</span>
            <span class="n">col_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">))</span>
            <span class="n">data_scaled</span><span class="p">[</span><span class="n">nan_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_means</span><span class="p">[</span><span class="n">nan_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            
        <span class="k">return</span> <span class="n">data_scaled</span><span class="p">,</span> <span class="n">index_data</span></div>


<div class="viewcode-block" id="WAS_Analog.arrange_indices_for_som">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.arrange_indices_for_som">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">arrange_indices_for_som</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Arrange climate indices for SOM training.&quot;&quot;&quot;</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">month_name</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">pivot_var</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[[</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month_name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;month_name&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
            <span class="n">df_pivot</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">])</span>
            <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">df_pivot</span>
        
        <span class="n">vars_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">df_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">pivot_var</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_order</span><span class="p">}</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Jan&#39;</span><span class="p">,</span> <span class="s1">&#39;Feb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mar&#39;</span><span class="p">,</span> <span class="s1">&#39;Apr&#39;</span><span class="p">,</span> <span class="s1">&#39;May&#39;</span><span class="p">,</span> <span class="s1">&#39;Jun&#39;</span><span class="p">,</span> <span class="s1">&#39;Jul&#39;</span><span class="p">,</span> <span class="s1">&#39;Aug&#39;</span><span class="p">,</span> <span class="s1">&#39;Sep&#39;</span><span class="p">,</span> <span class="s1">&#39;Oct&#39;</span><span class="p">,</span> <span class="s1">&#39;Nov&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
        <span class="n">ordered_columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">months</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_order</span><span class="p">]</span>
        
        <span class="n">df_final</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_vars</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">ordered_columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">df_final</span><span class="o">.</span><span class="n">index</span></div>


<div class="viewcode-block" id="WAS_Analog.identify_analogs_bmu">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.identify_analogs_bmu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">identify_analogs_bmu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_year</span><span class="p">,</span> <span class="n">bmu_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify analog years based on SOM Best Matching Units (BMUs).&quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">or</span> <span class="mf">1.0</span>
        <span class="n">neuron_years</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">bmu_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">neuron_years</span><span class="p">[</span><span class="n">coords</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        
        <span class="n">target_coords</span> <span class="o">=</span> <span class="n">bmu_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_year</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_coords</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        
        <span class="n">analogs</span> <span class="o">=</span> <span class="p">[</span><span class="n">year</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">neuron_years</span><span class="p">[</span><span class="n">target_coords</span><span class="p">]</span> <span class="k">if</span> <span class="n">year</span> <span class="o">!=</span> <span class="n">target_year</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">analogs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">bmu_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="n">target_year</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">:</span>
                    <span class="n">analogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">analogs</span></div>


<div class="viewcode-block" id="WAS_Analog.SOM">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.SOM">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">SOM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify similar years using Self-Organizing Maps (SOM).&quot;&quot;&quot;</span>

        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>

        <span class="n">data_scaled</span><span class="p">,</span> <span class="n">index_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_data_for_clustering</span><span class="p">(</span><span class="n">unique_years</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">)</span>
        <span class="n">som_grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span>
        <span class="n">som</span> <span class="o">=</span> <span class="n">MiniSom</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">input_len</span><span class="o">=</span><span class="n">data_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">some_sigma</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">some_learning_rate</span><span class="p">,</span>
            <span class="n">neighborhood_function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">some_neighborhood_function</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span>
        <span class="p">)</span>
        <span class="n">som</span><span class="o">.</span><span class="n">random_weights_init</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>
        <span class="n">som</span><span class="o">.</span><span class="n">train_random</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_scaled</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">some_num_iteration</span><span class="p">)</span>
        
        <span class="n">bmu_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">som</span><span class="o">.</span><span class="n">winner</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data_scaled</span><span class="p">]</span>
        <span class="n">bmu_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span><span class="p">:</span> <span class="n">coords</span> <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">index_data</span><span class="p">,</span> <span class="n">bmu_coords</span><span class="p">)}</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_analogs_bmu</span><span class="p">(</span><span class="n">reference_year</span><span class="p">,</span> <span class="n">bmu_dict</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">similar_years</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_Analog.Bias_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Bias_Based">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Bias_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify similar years using bias-based analog method.&quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>
        <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ddd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in downloaded data.&quot;</span><span class="p">)</span>
       
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>
        <span class="n">sst_reference</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
       
        <span class="n">biases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_reference</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> 
            <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">sst_reference</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">biases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
       
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">biases</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similar</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">])</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">top_2</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_2</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similar_years</span></div>

    
<div class="viewcode-block" id="WAS_Analog.Corr_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Corr_Based">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Corr_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify similar years using correlation-based analog method.&quot;&quot;&quot;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>

        <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">ddd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in downloaded data.&quot;</span><span class="p">)</span>
        
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>
        <span class="n">sst_reference</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
        
        <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_reference</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_reference</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
        
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similar</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">])</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">top_2</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_2</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similar_years</span></div>



    <span class="c1"># def Pca_Based(self, predictant, itrain, ireference_year):</span>
    <span class="c1">#     &quot;&quot;&quot;Identify similar years using PCA-based analog method.&quot;&quot;&quot;</span>
    <span class="c1">#     _, ddd = self.download_and_process()</span>
    <span class="c1">#     ddd = ddd.get(self.predictor_vars[0][&#39;variable&#39;])</span>
    <span class="c1">#     if ddd is None:</span>
    <span class="c1">#         raise ValueError(f&quot;Variable {self.predictor_vars[0][&#39;variable&#39;]} not found in downloaded data.&quot;)</span>
        
    <span class="c1">#     # predictor_ = ddd.fillna(ddd.groupby(&quot;T.month&quot;).mean(&quot;T&quot;, skipna=True))</span>
    <span class="c1">#     # predictor_detrend = sig.detrend(predictor_, axis=0)</span>
    <span class="c1">#     # ddd = xr.DataArray(predictor_detrend, dims=predictor_.dims, coords=predictor_.coords)</span>

    <span class="c1">#     if self.detrend:</span>
    <span class="c1">#         ddd, _ = self._detrended_da(ddd)</span>
    <span class="c1">#     # ddd = ddd.rename({&quot;X&quot;: &quot;lon&quot;, &quot;Y&quot;: &quot;lat&quot;})</span>
    <span class="c1">#     # eof = xe.single.EOF(n_modes=50, use_coslat=True, center=False)</span>
    <span class="c1">#     # eof.fit(ddd.fillna(ddd.mean(dim=&quot;T&quot;, skipna=True)), dim=&quot;T&quot;)</span>
    <span class="c1">#     # scores = eof.scores()</span>
    <span class="c1">#     scores = self.compute_eofs(ddd)</span>
        
    <span class="c1">#     predictant = predictant.copy()</span>
    <span class="c1">#     predictant[&#39;T&#39;] = predictant[&#39;T&#39;].astype(&#39;datetime64[ns]&#39;)</span>

    <span class="c1">#     if ireference_year==2100:</span>
    <span class="c1">#         reference_year = self.year_forecast</span>
    <span class="c1">#         predictant_ = xr.concat([predictant.isel(T=itrain)], dim=&quot;T&quot;)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         reference_year = int(np.unique(predictant.isel(T=ireference_year)[&#39;T&#39;].dt.year))</span>
    <span class="c1">#         predictant_ = xr.concat([predictant.isel(T=itrain)], dim=&quot;T&quot;)</span>

    <span class="c1">#     sst_ref = scores.sel(T=str(reference_year)).stack(score=(&#39;mode&#39;, &#39;T&#39;))       </span>
    <span class="c1">#     unique_years = np.append(np.unique(predictant_[&#39;T&#39;].dt.year),reference_year)</span>

    <span class="c1">#     correlations = []</span>
    <span class="c1">#     for year in unique_years:</span>
    <span class="c1">#         tmp = scores.sel(T=str(year)).stack(score=(&#39;mode&#39;, &#39;T&#39;))</span>
    <span class="c1">#         correlation = xr.corr(tmp, sst_ref, dim=&quot;score&quot;).compute()</span>
    <span class="c1">#         correlations.append(correlation)</span>
        
    <span class="c1">#     similar = xr.concat(correlations, dim=&#39;T&#39;).assign_coords(T=unique_years)</span>
    <span class="c1">#     similar = similar.sortby(similar, ascending=False)</span>
    <span class="c1">#     top_2 = similar.isel(T=slice(1,3))</span>
    <span class="c1">#     similar_years = top_2[&#39;T&#39;].to_numpy()</span>
    <span class="c1">#     print(f&quot;Similar years for {reference_year}: {similar_years}&quot;)</span>
    <span class="c1">#     return similar_years</span>

<div class="viewcode-block" id="WAS_Analog.Pca_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Pca_Based">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Pca_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Identify similar years using PCA-based analog method.&quot;&quot;&quot;</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>
            <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ddd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found in downloaded data.&quot;</span><span class="p">)</span>
           
            <span class="c1"># predictor_ = ddd.fillna(ddd.groupby(&quot;T.month&quot;).mean(&quot;T&quot;, skipna=True))</span>
            <span class="c1"># predictor_detrend = sig.detrend(predictor_, axis=0)</span>
            <span class="c1"># ddd = xr.DataArray(predictor_detrend, dims=predictor_.dims, coords=predictor_.coords)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
                <span class="n">ddd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detrended_da</span><span class="p">(</span><span class="n">ddd</span><span class="p">)</span>
            <span class="c1"># ddd = ddd.rename({&quot;X&quot;: &quot;lon&quot;, &quot;Y&quot;: &quot;lat&quot;})</span>
            <span class="c1"># eof = xe.single.EOF(n_modes=50, use_coslat=True, center=False)</span>
            <span class="c1"># eof.fit(ddd.fillna(ddd.mean(dim=&quot;T&quot;, skipna=True)), dim=&quot;T&quot;)</span>
            <span class="c1"># scores = eof.scores()</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_eofs</span><span class="p">(</span><span class="n">ddd</span><span class="p">)</span>
           
            <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
                <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
                <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
                <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>
            
            <span class="n">ref_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>
            <span class="n">ref_scores</span> <span class="o">=</span> <span class="n">ref_scores</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ref_scores</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>
            <span class="n">sst_ref</span> <span class="o">=</span> <span class="n">ref_scores</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
           
            <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
                <span class="n">tmp_scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">))</span>
                <span class="n">tmp_scores</span> <span class="o">=</span> <span class="n">tmp_scores</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmp_scores</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp_scores</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
                <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
                <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
           
            <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">)</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">top_2</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_2</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">similar_years</span></div>


<div class="viewcode-block" id="WAS_Analog.KMeans_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.KMeans_Based">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">KMeans_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify similar years using K-Means clustering.&quot;&quot;&quot;</span>
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>

        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>

        <span class="n">data_scaled</span><span class="p">,</span> <span class="n">index_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_data_for_clustering</span><span class="p">(</span><span class="n">unique_years</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">)</span>

        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>

        <span class="n">target_year_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_data</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_year_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> not found in index data.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">target_cluster_label</span> <span class="o">=</span> <span class="n">cluster_labels</span><span class="p">[</span><span class="n">target_year_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">similar_years_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">target_cluster_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similar_years_indices</span> <span class="k">if</span> <span class="n">index_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> (K-Means): </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">similar_years</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Analog.Agglomerative_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Agglomerative_Based">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Agglomerative_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify similar years using Agglomerative Clustering.&quot;&quot;&quot;</span>
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ireference_year</span><span class="o">==</span><span class="mi">2100</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>

        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span><span class="n">reference_year</span><span class="p">)</span>

        <span class="n">data_scaled</span><span class="p">,</span> <span class="n">index_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_data_for_clustering</span><span class="p">(</span><span class="n">unique_years</span><span class="p">,</span> <span class="n">reference_year</span><span class="p">)</span>

        <span class="n">agg_clustering</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">affinity</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linkage</span><span class="p">)</span>
        <span class="n">cluster_labels</span> <span class="o">=</span> <span class="n">agg_clustering</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">data_scaled</span><span class="p">)</span>

        <span class="n">target_year_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_data</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_year_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> not found in index data.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">target_cluster_label</span> <span class="o">=</span> <span class="n">cluster_labels</span><span class="p">[</span><span class="n">target_year_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">similar_years_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">target_cluster_label</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similar_years_indices</span> <span class="k">if</span> <span class="n">index_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> (Agglomerative): </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">similar_years</span><span class="p">)</span></div>


    <span class="c1"># def download_and_process(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Download and process reanalysis and forecast data.</span>

    <span class="c1">#     Combines reanalysis and forecast data, applies standardization or anomaly calculation,</span>
    <span class="c1">#     and optionally applies a rolling mean.</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     data_var_concatenated : dict</span>
    <span class="c1">#         Dictionary of concatenated, processed datasets.</span>
    <span class="c1">#     data_var_shifted : dict</span>
    <span class="c1">#         Dictionary of time-shifted, processed datasets.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     lead_time = [1, 2, 3, 4, 5] if self.lead_time is None else self.lead_time</span>
    <span class="c1">#     month_of_initialization = (datetime.now() - relativedelta(months=1)).month if self.month_of_initialization is None else self.month_of_initialization</span>
        
    <span class="c1">#     sst_hist = self.download_reanalysis(force_download=False)</span>
    <span class="c1">#     sst_hdcst, sst_for = self.download_models(force_download=False)</span>

    <span class="c1">#     variables = [item[&#39;variable&#39;] for item in self.predictor_vars]</span>
    <span class="c1">#     print(f&quot;Processing variables: {variables}&quot;)</span>
    <span class="c1">#     data_var_concatenated = {}</span>
    <span class="c1">#     data_var_shifted = {}</span>

    <span class="c1">#     for var in variables:</span>
    <span class="c1">#         if var not in sst_hist or var not in sst_for:</span>
    <span class="c1">#             print(f&quot;Skipping {var}: data not available.&quot;)</span>
    <span class="c1">#             continue  </span>

    <span class="c1">#         sst_hist_ = sst_hist[var]</span>
    <span class="c1">#         sst_hdcst_ = sst_hdcst[var]</span>
    <span class="c1">#         sst_for_ = sst_for[var]</span>

    <span class="c1">#         # process hindcast data</span>
    <span class="c1">#         hindcast = []</span>
    <span class="c1">#         for i in sst_hdcst_[&#39;T&#39;]:</span>
    <span class="c1">#             sst_hdcst_i = sst_hdcst_.sel(T=i)</span>
    <span class="c1">#             base_times = pd.Timestamp(sst_hdcst_i[&#39;T&#39;].values)</span>
    <span class="c1">#             new_times = [base_times + pd.DateOffset(months=int(m)) for m in sst_hdcst_i[&#39;forecastMonth&#39;].values]</span>
    <span class="c1">#             sst_hdcst_i = sst_hdcst_i.assign_coords(forecastMonth=(&quot;forecastMonth&quot;, new_times))</span>
    <span class="c1">#             sst_hdcst_i = sst_hdcst_i.drop_vars(&#39;T&#39;, errors=&#39;ignore&#39;).squeeze().rename({&#39;forecastMonth&#39;: &#39;T&#39;})</span>
    <span class="c1">#             hindcast.append(sst_hdcst_i)</span>
    <span class="c1">#         sst_hdcst_ = xr.concat(hindcast, dim=&#39;T&#39;)          </span>
    <span class="c1">#         sst_hdcst_ = sst_hdcst_.interp(Y=sst_hist_.Y, X=sst_hist_.X, method=&quot;linear&quot;, kwargs={&quot;fill_value&quot;: &quot;extrapolate&quot;})</span>

            
    <span class="c1">#         # process forecast data</span>
    <span class="c1">#         sst_for_ = sst_for_.interp(Y=sst_hist_.Y, X=sst_hist_.X, method=&quot;linear&quot;, kwargs={&quot;fill_value&quot;: &quot;extrapolate&quot;})</span>
    <span class="c1">#         if (isinstance(sst_for_[&#39;T&#39;].values, np.ndarray)):</span>
    <span class="c1">#             base_time = pd.Timestamp(sst_for_[&#39;T&#39;].values[-1])</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             base_time = pd.Timestamp(sst_for_[&#39;T&#39;].values)</span>
    <span class="c1">#         new_times = [base_time + pd.DateOffset(months=int(m)) for m in sst_for_[&#39;forecastMonth&#39;].values]</span>
    <span class="c1">#         sst_for_ = sst_for_.assign_coords(forecastMonth=(&quot;forecastMonth&quot;, new_times))</span>
    <span class="c1">#         sst_for_ = sst_for_.drop_vars(&#39;T&#39;, errors=&#39;ignore&#39;).squeeze().rename({&#39;forecastMonth&#39;: &#39;T&#39;})</span>

    <span class="c1">#         # Correct forecast systematic bias</span>
    <span class="c1">#         biasr = WAS_bias_correction()</span>

    <span class="c1">#         sst_for_bias_corrected = []</span>
    <span class="c1">#         for m in lead_time:</span>
    <span class="c1">#             target_time = base_time + pd.DateOffset(months=m)</span>
    <span class="c1">#             current_target_month = target_time.month</span>

    <span class="c1">#             sst_hist_mean = sst_hist_.where(sst_hist_[&#39;T&#39;].dt.month.isin(current_target_month), drop=True)</span>
    <span class="c1">#             sst_hist_mean = sst_hist_mean.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze()</span>

    <span class="c1">#             sst_hdcst_mean = sst_hdcst_.where(sst_hdcst_[&#39;T&#39;].dt.month.isin(current_target_month), drop=True)</span>
    <span class="c1">#             sst_hdcst_mean = sst_hdcst_mean.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze()</span>
    <span class="c1">#             sst_hist_mean, sst_hdcst_mean  = xr.align(sst_hist_mean, sst_hdcst_mean, join=&quot;inner&quot;)</span>
    <span class="c1">#             sst_for_mean = sst_for_.where(sst_for_[&#39;T&#39;].dt.month.isin(current_target_month), drop=True)</span>
    <span class="c1">#             sst_for_mean = sst_for_mean.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze(&#39;variable&#39;, drop=True)</span>
                
    <span class="c1">#             if var in [&quot;TMIN&quot;, &quot;TEMP&quot;, &quot;TMAX&quot;, &quot;SST&quot;, &quot;HUSS_1000&quot;, &quot;HUSS_925&quot;, &quot;HUSS_850&quot;, &quot;SLP&quot;, &quot;UGRD10&quot;, &quot;VGRD10&quot;, &quot;UGRD_1000&quot;, &quot;UGRD_925&quot;, &quot;UGRD_850&quot;, &quot;VGRD_1000&quot;, &quot;VGRD_925&quot;, &quot;VGRD_850&quot;]:</span>
    <span class="c1">#                 fobj_quant_da = biasr.fitBC(sst_hist_mean, sst_hdcst_mean, method=&#39;QUANT&#39;, qstep=0.01, nboot=10)</span>
    <span class="c1">#                 sst_for_bias_corrected.append(biasr.doBC(sst_for_mean, fobj_quant_da, type=&#39;linear&#39;))</span>
    <span class="c1">#                 # sst_for_bias_corrected.append(sst_for_.where(sst_for_[&#39;T&#39;].dt.month.isin(m), drop=True) - sst_hdcst_mean + sst_hist_mean)</span>
    <span class="c1">#             # if var in [&quot;PRCP&quot;, &quot;DSWR&quot;, &quot;DLWR&quot;, &quot;N.OLR&quot;]:</span>
    <span class="c1">#                 # fobj_quant = qmap.fitQmap(sst_hist_mean, sst_hdcst_mean, method=&#39;QUANT&#39;, wet_day=0.1,  qstep=0.001)</span>
    <span class="c1">#                 # sst_for_bias_corrected.append(sst_for_.where(sst_for_[&#39;T&#39;].dt.month.isin(m), drop=True) * sst_hist_mean / sst_hdcst_mean)</span>
    <span class="c1">#         sst_for_ = xr.concat(sst_for_bias_corrected, dim=&#39;T&#39;).sortby(&quot;T&quot;)</span>

    <span class="c1">#         # Concatenate hist and forecast data</span>
    <span class="c1">#         sst_hist_ = sst_hist_.sel(T=slice(f&quot;{self.year_start}-01&quot;, f&quot;{base_time.year}-{base_time.month:02d}&quot;))</span>
    <span class="c1">#         sst_hist_ = sst_hist_.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze()</span>
    <span class="c1">#         concatenated_ds = xr.concat([sst_hist_, sst_for_], dim=&#39;T&#39;)</span>
    <span class="c1">#         concatenated_ds = concatenated_ds.sortby(&quot;T&quot;)</span>
    <span class="c1">#         concatenated_ds = concatenated_ds.to_dataset(name=var)</span>

    <span class="c1">#         if isinstance(self.rolling, int) and self.rolling &gt; 1:</span>
    <span class="c1">#            print(f&quot;Applied rolling mean with window size {self.rolling} for {var}.&quot;)</span>
    <span class="c1">#            concatenated_ds = concatenated_ds.rolling(T=self.rolling, center=False, min_periods=self.rolling).mean()</span>

    <span class="c1">#         if self.standardize:</span>
    <span class="c1">#             print(f&quot;Standardizing timeseries for {var}.&quot;)</span>
    <span class="c1">#             concatenated_ds_st = self.standardize_timeseries(concatenated_ds)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             print(f&quot;Computing anomalies for {var}.&quot;)</span>
    <span class="c1">#             concatenated_ds_st = self.anomaly_timeseries(concatenated_ds)</span>

    <span class="c1">#         # first_year = concatenated_ds_st.isel(T=0).T.dt.year.item()</span>
    <span class="c1">#         # last_month = concatenated_ds_st.isel(T=-1).T.dt.month.item()</span>

    <span class="c1">#         select_parts = concatenated_ds_st[&#39;T&#39;].size - (self.year_forecast - self.year_start) * 12 </span>

    <span class="c1">#         # if last_month == 12:</span>
    <span class="c1">#         #     start_month = 1</span>
    <span class="c1">#         #     first_year += 1</span>
    <span class="c1">#         # else:</span>
    <span class="c1">#         #     start_month = last_month + 1</span>
            
    <span class="c1">#         concatenated_ds_st = concatenated_ds_st.isel(T=slice(select_parts, None))</span>
            
    <span class="c1">#         # concatenated_ds_st = concatenated_ds_st.sel(T=slice(f&quot;{first_year}-{start_month:02d}&quot;, f&quot;{self.year_forecast}-{last_month:02d}&quot;))</span>
    <span class="c1">#         # if last_month == 12:</span>
    <span class="c1">#         #     new_time = pd.DatetimeIndex([pd.to_datetime(f&quot;{first_year}-01-01&quot;) + pd.DateOffset(months=t) for t in range(len(concatenated_ds_st[&#39;T&#39;]))])</span>
    <span class="c1">#         # else:</span>
    <span class="c1">#         #     new_time = pd.DatetimeIndex([pd.to_datetime(f&quot;{first_year+1}-01-01&quot;) + pd.DateOffset(months=t) for t in range(len(concatenated_ds_st[&#39;T&#39;]))])    </span>

    <span class="c1">#         new_time = pd.DatetimeIndex([pd.to_datetime(f&quot;{self.year_start+1}-01-01&quot;) + pd.DateOffset(months=t) for t in range(len(concatenated_ds_st[&#39;T&#39;]))]) </span>

    <span class="c1">#         ds_shifted = concatenated_ds_st.assign_coords(T=new_time)</span>
    
    <span class="c1">#         data_var_shifted[var] = ds_shifted.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze()</span>
    <span class="c1">#         data_var_concatenated[var] = concatenated_ds_st.to_array().drop_vars([&#39;variable&#39;], errors=&#39;ignore&#39;).squeeze()</span>
    <span class="c1">#     return data_var_concatenated, data_var_shifted</span>


<div class="viewcode-block" id="WAS_Analog.download_and_process">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_and_process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download_and_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Download and process reanalysis and forecast data.&quot;&quot;&quot;</span>
            
            <span class="n">lead_time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span>
            <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">month</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span>
            
            <span class="n">sst_hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_reanalysis</span><span class="p">(</span><span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sst_hdcst</span><span class="p">,</span> <span class="n">sst_for</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_models</span><span class="p">(</span><span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor_vars</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing variables: </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">data_var_concatenated</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data_var_shifted</span> <span class="o">=</span> <span class="p">{}</span>
    
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sst_hist</span> <span class="ow">or</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sst_for</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: data not available.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>  
    
                <span class="n">sst_hist_</span> <span class="o">=</span> <span class="n">sst_hist</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="n">sst_hdcst_</span> <span class="o">=</span> <span class="n">sst_hdcst</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    
                <span class="c1"># --- Process Hindcast Data ---</span>
                <span class="n">hindcast</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sst_hdcst_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]:</span>
                    <span class="n">sst_hdcst_i</span> <span class="o">=</span> <span class="n">sst_hdcst_</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">base_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">sst_hdcst_i</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">new_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_times</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sst_hdcst_i</span><span class="p">[</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                    <span class="n">sst_hdcst_i</span> <span class="o">=</span> <span class="n">sst_hdcst_i</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">,</span> <span class="n">new_times</span><span class="p">))</span>
                    <span class="n">sst_hdcst_i</span> <span class="o">=</span> <span class="n">sst_hdcst_i</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">})</span>
                    <span class="n">hindcast</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sst_hdcst_i</span><span class="p">)</span>
                
                <span class="n">sst_hdcst_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">hindcast</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>           
                <span class="n">sst_hdcst_</span> <span class="o">=</span> <span class="n">sst_hdcst_</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">sst_hist_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">sst_hist_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
    
                <span class="c1"># --- Process Forecast Data ---</span>
                <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">sst_hist_</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">sst_hist_</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">base_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">base_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    
                <span class="n">new_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">,</span> <span class="n">new_times</span><span class="p">))</span>
                <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">})</span>
    
                <span class="c1"># --- Bias Correction ---</span>
                <span class="n">biasr</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="p">()</span>
                <span class="n">sst_for_bias_corrected</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">:</span>
                    <span class="c1"># 1. Calcul correct du mois cible (gestion du cycle 12 -&gt; 1)</span>
                    <span class="n">target_time</span> <span class="o">=</span> <span class="n">base_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">current_target_month</span> <span class="o">=</span> <span class="n">target_time</span><span class="o">.</span><span class="n">month</span>
    
                    <span class="c1"># 2. Filtrage</span>
                    <span class="n">sst_hist_mean</span> <span class="o">=</span> <span class="n">sst_hist_</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sst_hist_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">current_target_month</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sst_hist_mean</span> <span class="o">=</span> <span class="n">sst_hist_mean</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
                    <span class="n">sst_hdcst_mean</span> <span class="o">=</span> <span class="n">sst_hdcst_</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sst_hdcst_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">current_target_month</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sst_hdcst_mean</span> <span class="o">=</span> <span class="n">sst_hdcst_mean</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                    
                    <span class="c1"># 3. Alignement</span>
                    <span class="c1"># Create a set of unique years from the hindcast data</span>
                    <span class="n">years_to_keep</span> <span class="o">=</span> <span class="n">sst_hdcst_mean</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    
                    <span class="c1"># Filter the historical data based on this set of years</span>
                    <span class="n">sst_hist_mean</span> <span class="o">=</span> <span class="n">sst_hist_mean</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sst_hist_mean</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">years_to_keep</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sst_hdcst_mean</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_hist_mean</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                    <span class="n">sst_hist_aligned</span><span class="p">,</span> <span class="n">sst_hdcst_aligned</span>  <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">sst_hist_mean</span><span class="p">,</span> <span class="n">sst_hdcst_mean</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># 4. S√âCURIT√â CRITIQUE : V√©rifier si les donn√©es sont vides apr√®s alignement</span>
                    <span class="k">if</span> <span class="n">sst_hist_aligned</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">sst_hdcst_aligned</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: No overlapping data found for month </span><span class="si">{</span><span class="n">current_target_month</span><span class="si">}</span><span class="s2"> (lead </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">). Skipping bias correction for this step.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span> <span class="c1"># Passe √† l&#39;it√©ration suivante pour √©viter le crash</span>
    
                    <span class="n">sst_for_mean</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">current_target_month</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">sst_for_mean</span> <span class="o">=</span> <span class="n">sst_for_mean</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">,</span> <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">,</span> <span class="s2">&quot;HUSS_925&quot;</span><span class="p">,</span> <span class="s2">&quot;HUSS_850&quot;</span><span class="p">,</span> <span class="s2">&quot;SLP&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD10&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD10&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD_925&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD_850&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD_925&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD_850&quot;</span><span class="p">]:</span>
                        <span class="c1"># Utilisation des variables align√©es (_aligned)</span>
                        <span class="n">fobj_quant_da</span> <span class="o">=</span> <span class="n">biasr</span><span class="o">.</span><span class="n">fitBC</span><span class="p">(</span><span class="n">sst_hist_aligned</span><span class="p">,</span> <span class="n">sst_hdcst_aligned</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;QUANT&#39;</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nboot</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                        <span class="n">sst_for_bias_corrected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">biasr</span><span class="o">.</span><span class="n">doBC</span><span class="p">(</span><span class="n">sst_for_mean</span><span class="p">,</span> <span class="n">fobj_quant_da</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">))</span>
                
                <span class="c1"># --- Concatenation &amp; Post-Processing ---</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sst_for_bias_corrected</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Bias correction failed for all lead times for variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
    
                <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sst_for_bias_corrected</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
    
                <span class="n">sst_hist_</span> <span class="o">=</span> <span class="n">sst_hist_</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_time</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">base_time</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                <span class="n">sst_hist_</span> <span class="o">=</span> <span class="n">sst_hist_</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                
                <span class="n">concatenated_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sst_hist_</span><span class="p">,</span> <span class="n">sst_for_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
                <span class="n">concatenated_ds</span> <span class="o">=</span> <span class="n">concatenated_ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                <span class="n">concatenated_ds</span> <span class="o">=</span> <span class="n">concatenated_ds</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="p">)</span>
    
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolling</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied rolling mean with window size </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">concatenated_ds</span> <span class="o">=</span> <span class="n">concatenated_ds</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rolling</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standardizing timeseries for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">concatenated_ds</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing anomalies for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                    <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anomaly_timeseries</span><span class="p">(</span><span class="n">concatenated_ds</span><span class="p">)</span>
    
                <span class="n">select_parts</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span> 
                <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">select_parts</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                
                <span class="n">new_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">concatenated_ds_st</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]))])</span> 
    
                <span class="n">ds_shifted</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">new_time</span><span class="p">)</span>
        
                <span class="n">data_var_shifted</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_shifted</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">data_var_concatenated</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                
            <span class="k">return</span> <span class="n">data_var_concatenated</span><span class="p">,</span> <span class="n">data_var_shifted</span></div>


<div class="viewcode-block" id="WAS_Analog.compute_model">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.compute_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute deterministic hindcast using the specified analog method.&quot;&quot;&quot;</span>
        <span class="n">method_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;som&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOM</span><span class="p">,</span>
            <span class="s2">&quot;bias_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bias_Based</span><span class="p">,</span>
            <span class="s2">&quot;cor_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Corr_Based</span><span class="p">,</span>
            <span class="s2">&quot;pca_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pca_Based</span><span class="p">,</span>
            <span class="s2">&quot;kmeans_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMeans_Based</span><span class="p">,</span>
            <span class="s2">&quot;agglomerative_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Agglomerative_Based</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid analog method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="si">}</span><span class="s2">. Choose &#39;som&#39;, &#39;bias_based&#39;, &#39;cor_based&#39;, &#39;pca_based&#39;, &#39;kmeans_based&#39;, or &#39;agglomerative_based&#39;.&quot;</span><span class="p">)</span>

        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">method_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="p">](</span><span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">)</span>
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        
        <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">similar_years</span> <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_obs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid similar years found for hindcast.&quot;</span><span class="p">)</span>
        
        <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itest</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">hindcast_det</span></div>


    <span class="c1"># ------------------ Probability Calculation Methods ------------------</span>

<div class="viewcode-block" id="WAS_Analog._ppf_terciles_from_code">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog._ppf_terciles_from_code">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_ppf_terciles_from_code</span><span class="p">(</span><span class="n">dist_code</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return tercile thresholds (T1, T2) from best-fit distribution parameters.</span>
<span class="sd">    </span>
<span class="sd">        dist_code:</span>
<span class="sd">            1: norm</span>
<span class="sd">            2: lognorm</span>
<span class="sd">            3: expon</span>
<span class="sd">            4: gamma</span>
<span class="sd">            5: weibull_min</span>
<span class="sd">            6: t</span>
<span class="sd">            7: poisson</span>
<span class="sd">            8: nbinom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist_code</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">lognorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">lognorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">expon</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">expon</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">gamma</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">gamma</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">weibull_min</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">weibull_min</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c1"># Note: Renamed &#39;t_dist&#39; to &#39;t&#39; for standard scipy.stats</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c1"># Poisson: poisson.ppf(q, mu, loc=0)</span>
                <span class="c1"># ASSUMPTION: &#39;mu&#39; (mean) is passed as &#39;shape&#39;</span>
                <span class="c1">#             &#39;loc&#39; is passed as &#39;loc&#39;</span>
                <span class="c1">#             &#39;scale&#39; is unused</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                    <span class="n">poisson</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                <span class="c1"># Negative Binomial: nbinom.ppf(q, n, p, loc=0)</span>
                <span class="c1"># ASSUMPTION: &#39;n&#39; (successes) is passed as &#39;shape&#39;</span>
                <span class="c1">#             &#39;p&#39; (probability) is passed as &#39;scale&#39;</span>
                <span class="c1">#             &#39;loc&#39; is passed as &#39;loc&#39;</span>
                <span class="k">return</span> <span class="p">(</span>
                    <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                    <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="c1"># Fallback if code is not 1-8</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

        
<div class="viewcode-block" id="WAS_Analog.weibull_shape_solver">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.weibull_shape_solver">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">weibull_shape_solver</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to find the root of the Weibull shape parameter &#39;k&#39;.</span>
<span class="sd">        We find &#39;k&#39; such that the theoretical variance/mean^2 ratio</span>
<span class="sd">        matches the observed V/M^2 ratio.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Guard against invalid &#39;k&#39; values during solving</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g1</span> <span class="o">=</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
            
            <span class="c1"># This is the V/M^2 ratio *implied by k*</span>
            <span class="n">implied_v_over_m_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">g2</span> <span class="o">/</span> <span class="p">(</span><span class="n">g1</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="c1"># This is the *observed* ratio</span>
            <span class="n">observed_v_over_m_sq</span> <span class="o">=</span> <span class="n">V</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="c1"># Return the difference (we want this to be 0)</span>
            <span class="k">return</span> <span class="n">observed_v_over_m_sq</span> <span class="o">-</span> <span class="n">implied_v_over_m_sq</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1"># Handle math errors</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_bestfit">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_bestfit">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tercile_probabilities_bestfit</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">dist_code</span><span class="p">,</span> <span class="n">dof</span> 
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic tercile probabilities using best-fit family per grid cell.</span>

<span class="sd">        Inputs (per grid cell):</span>
<span class="sd">        - best_guess : 1D array over T (hindcast_det or forecast_det)</span>
<span class="sd">        - T1, T2     : scalar terciles from climatological best-fit distribution</span>
<span class="sd">        - dist_code  : int, as in _ppf_terciles_from_code</span>
<span class="sd">        - shape, loc, scale : scalars from climatology fit</span>

<span class="sd">        Strategy:</span>
<span class="sd">        - For each time step, build a predictive distribution of the same family:</span>
<span class="sd">            * Use best_guess[t] to adjust mean / location;</span>
<span class="sd">            * Keep shape parameters from climatology.</span>
<span class="sd">        - Then compute probabilities:</span>
<span class="sd">            P(B) = F(T1), P(N) = F(T2) - F(T1), P(A) = 1 - F(T2).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1"># T1 = np.asarray(T1, dtype=float)</span>
        <span class="c1"># T2 = np.asarray(T2, dtype=float)</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="n">best_guess</span><span class="o">.</span><span class="n">size</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">T2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dist_code</span><span class="p">)</span>

        <span class="c1"># Normal: loc = forecast; scale from clim</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>

        <span class="c1"># Lognormal: shape = sigma from clim; enforce mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>      


        <span class="c1"># Exponential: keep scale from clim; shift loc so mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">))</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">expon</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc_t</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">))</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="c1"># Gamma: use shape from clim; set scale so mean = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Assuming 5 is for Weibull   </span>
        
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
                <span class="c1"># Get the scalar values for this specific element (e.g., grid cell)</span>
                <span class="n">M</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">error_variance</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
                
                <span class="c1"># Handle cases with no variance to avoid division by zero</span>
                <span class="k">if</span> <span class="n">V</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">M</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">continue</span> <span class="c1"># Skip to the next element</span>
        
                <span class="c1"># --- 1. Numerically solve for shape &#39;k&#39; ---</span>
                <span class="c1"># We need a reasonable starting guess. 2.0 is common (Rayleigh dist.)</span>
                <span class="n">initial_guess</span> <span class="o">=</span> <span class="mf">2.0</span>
                
                <span class="c1"># fsolve finds the root of our helper function</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">fsolve</span><span class="p">(</span><span class="n">weibull_shape_solver</span><span class="p">,</span> <span class="n">initial_guess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">V</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        
                <span class="c1"># --- 2. Check for bad solution and calculate scale &#39;lambda&#39; ---</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Solver failed</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">continue</span>
                
                <span class="c1"># With &#39;k&#39; found, we can now algebraically find scale &#39;lambda&#39;</span>
                <span class="c1"># In scipy.stats, scale is &#39;scale&#39;</span>
                <span class="n">lambda_scale</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="n">gamma_function</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
        
                <span class="c1"># --- 3. Calculate Probabilities ---</span>
                <span class="c1"># In scipy.stats, shape &#39;k&#39; is &#39;c&#39;</span>
                <span class="c1"># Use the T1 and T2 values for this specific element</span>
                
                <span class="n">c1</span> <span class="o">=</span> <span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">lambda_scale</span><span class="p">)</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">weibull_min</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">lambda_scale</span><span class="p">)</span>
        
                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="c1"># Student-t: df from clim; scale from clim; loc = best_guess</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>       
            <span class="c1"># Check if df is valid for variance calculation</span>
            <span class="k">if</span> <span class="n">dof</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Cannot calculate scale, fill with NaNs</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 1. Calculate t-distribution parameters</span>
                <span class="c1"># &#39;loc&#39; (mean) is just the best_guess</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">best_guess</span>
                <span class="c1"># &#39;scale&#39; is calculated from the variance and df</span>
                <span class="c1"># Variance = scale**2 * (df / (df - 2))</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">*</span> <span class="p">(</span><span class="n">dof</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dof</span><span class="p">)</span>
                
                <span class="c1"># 2. Calculate probabilities</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

                <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
                <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="c1"># Assuming 7 is for Poisson</span>
            
            <span class="c1"># --- 1. Set the Poisson parameter &#39;mu&#39; ---</span>
            <span class="c1"># The &#39;mu&#39; parameter is the mean.</span>
            
            <span class="c1"># A warning is strongly recommended if error_variance is different from best_guess</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;error_variance&#39; is not equal to &#39;best_guess&#39;.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Poisson model assumes mean=variance and is likely inappropriate.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consider using Negative Binomial.&quot;</span><span class="p">)</span>
            
            <span class="n">mu</span> <span class="o">=</span> <span class="n">best_guess</span>
        
            <span class="c1"># --- 2. Calculate Probabilities ---</span>
            <span class="c1"># poisson.cdf(k, mu) calculates P(X &lt;= k)</span>
            
            <span class="n">c1</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>
            
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>

        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="c1"># Assuming 8 is for Negative Binomial</span>
            
            <span class="c1"># --- 1. Calculate Negative Binomial Parameters ---</span>
            <span class="c1"># This model is ONLY valid for overdispersion (Variance &gt; Mean).</span>
            <span class="c1"># We will use np.where to set parameters to NaN if V &lt;= M.</span>
            
            <span class="c1"># p = Mean / Variance</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">&gt;</span> <span class="n">best_guess</span><span class="p">,</span> 
                         <span class="n">best_guess</span> <span class="o">/</span> <span class="n">error_variance</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># n = Mean^2 / (Variance - Mean)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">error_variance</span> <span class="o">&gt;</span> <span class="n">best_guess</span><span class="p">,</span> 
                         <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">error_variance</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">),</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            
            <span class="c1"># --- 2. Calculate Probabilities ---</span>
            <span class="c1"># The nbinom.cdf function will propagate NaNs, correctly</span>
            <span class="c1"># handling the cases where the model was invalid.</span>
            
            <span class="n">c1</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">-</span> <span class="n">c1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">c2</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid distribution&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_nonparametric">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_nonparametric">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_tercile_probabilities_nonparametric</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_samples</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Non-parametric method using historical error samples.&quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_samples</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">p_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">first_tercile</span><span class="p">)</span>
            <span class="n">p_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">first_tercile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">second_tercile</span><span class="p">))</span>
            <span class="n">p_above</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_below</span> <span class="o">+</span> <span class="n">p_between</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_below</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_between</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_above</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>




<div class="viewcode-block" id="WAS_Analog.compute_prob">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.compute_prob">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_prob</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Predictant</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">clim_year_start</span><span class="p">,</span>
        <span class="n">clim_year_end</span><span class="p">,</span>
        <span class="n">hindcast_det</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">best_code_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_shape_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_loc_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">best_scale_da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile probabilities for deterministic hindcasts.</span>

<span class="sd">        If dist_method == &#39;bestfit&#39;:</span>
<span class="sd">            - Use cluster-based best-fit distributions to:</span>
<span class="sd">                * derive terciles analytically from (best_code_da, best_shape_da, best_loc_da, best_scale_da),</span>
<span class="sd">                * compute predictive probabilities using the same family.</span>

<span class="sd">        Otherwise:</span>
<span class="sd">            - Use empirical terciles from Predictant climatology and the selected</span>
<span class="sd">              parametric / nonparametric method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data (T, Y, X) or (T, Y, X, M).</span>
<span class="sd">        clim_year_start, clim_year_end : int or str</span>
<span class="sd">            Climatology period (inclusive) for thresholds.</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic hindcast (T, Y, X).</span>
<span class="sd">        best_code_da, best_shape_da, best_loc_da, best_scale_da : xarray.DataArray, optional</span>
<span class="sd">            Output from WAS_TransformData.fit_best_distribution_grid, required for &#39;bestfit&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hindcast_prob : xarray.DataArray</span>
<span class="sd">            Probabilities with dims (probability=[&#39;PB&#39;,&#39;PN&#39;,&#39;PA&#39;], T, Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Handle member dimension if present</span>
        <span class="k">if</span> <span class="s2">&quot;M&quot;</span> <span class="ow">in</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">Predictant</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">M</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Ensure dimension order</span>
        <span class="n">Predictant</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>

        <span class="c1"># Spatial mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Climatology subset</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">clim</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough years in climatology period for terciles.&quot;</span><span class="p">)</span>

        <span class="c1"># Error variance for predictive distributions</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">clim</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Empirical terciles (used by non-bestfit methods)</span>
        <span class="n">terciles_emp</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.68</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">T1_emp</span> <span class="o">=</span> <span class="n">terciles_emp</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;quantile&quot;</span><span class="p">)</span>
        <span class="n">T2_emp</span> <span class="o">=</span> <span class="n">terciles_emp</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;quantile&quot;</span><span class="p">)</span>
        

        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span>

        <span class="c1"># ---------- BESTFIT: zone-wise optimal distributions ----------</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;bestfit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">best_code_da</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;dist_method=&#39;bestfit&#39; requires best_code_da, best_shape_da_da, best_loc_da, best_scale_da.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># T1, T2 from best-fit distributions (per grid)</span>
            <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ppf_terciles_from_code</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">best_shape_da</span><span class="p">,</span>
                <span class="n">best_loc_da</span><span class="p">,</span>
                <span class="n">best_scale_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># Predictive probabilities using same family</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_bestfit</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># ---------- Nonparametric ----------</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1_emp</span><span class="p">,</span>
                <span class="n">T2_emp</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dist_method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span>
            <span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;PB&quot;</span><span class="p">,</span> <span class="s2">&quot;PN&quot;</span><span class="p">,</span> <span class="s2">&quot;PA&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">hindcast_prob</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_Analog.forecast">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.forecast">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">best_code_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate deterministic and probabilistic forecasts for the target year.&quot;&quot;&quot;</span>
        <span class="n">predictant</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="n">reference_year</span><span class="p">)</span>
        
        <span class="n">method_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;som&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOM</span><span class="p">,</span>
            <span class="s2">&quot;bias_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Bias_Based</span><span class="p">,</span>
            <span class="s2">&quot;cor_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Corr_Based</span><span class="p">,</span>
            <span class="s2">&quot;pca_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pca_Based</span><span class="p">,</span>
            <span class="s2">&quot;kmeans_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">KMeans_Based</span><span class="p">,</span>
            <span class="s2">&quot;agglomerative_based&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Agglomerative_Based</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid analog method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="si">}</span><span class="s2">. Choose &#39;som&#39;,&#39;bias_based&#39;, &#39;cor_based&#39;, &#39;pca_based&#39;, &#39;kmeans_based&#39;, or &#39;agglomerative_based&#39;.&quot;</span><span class="p">)</span>

        <span class="n">itrain</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span> <span class="ow">and</span> <span class="n">year</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>
        <span class="n">ireference_year</span> <span class="o">=</span> <span class="mi">2100</span>

        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">method_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="p">](</span><span class="n">predictant</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">similar_years</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">similar_years</span><span class="p">)]</span>

        <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">similar_years</span> <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_obs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid similar years found for forecast.&quot;</span><span class="p">)</span>
        
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">T_value</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">T_value</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[M]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_T_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">)</span>
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">new_T_value</span><span class="p">]})</span>
        <span class="n">forecast_det</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.68</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">T1_emp</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2_emp</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span>

        <span class="c1"># ---------- BESTFIT ----------</span>
        <span class="k">if</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;bestfit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">best_code_da</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;dist_method=&#39;bestfit&#39; requires best_code_da, best_shape_da, best_loc_da, best_scale_da.&quot;</span>
                <span class="p">)</span>
            
            <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ppf_terciles_from_code</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">best_shape_da</span><span class="p">,</span>
                <span class="n">best_loc_da</span><span class="p">,</span>
                <span class="n">best_scale_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_bestfit</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">best_code_da</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dof&quot;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># ---------- Nonparametric ----------</span>
        <span class="k">elif</span> <span class="n">dm</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span>
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1_emp</span><span class="p">,</span>
                <span class="n">T2_emp</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;output_sizes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;probability&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                    <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dist_method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similar_years</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span></div>


<div class="viewcode-block" id="WAS_Analog.composite_plot">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.composite_plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">composite_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">plot_predictor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span><span class="n">best_code_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create composite plots of predictors or predictands.&quot;&quot;&quot;</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">similar_years</span><span class="p">,</span> <span class="n">result_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">best_code_da</span><span class="p">,</span> <span class="n">best_shape_da</span><span class="p">,</span> <span class="n">best_loc_da</span><span class="p">,</span> <span class="n">best_scale_da</span><span class="p">)</span>
        <span class="n">result_</span> <span class="o">=</span> <span class="n">result_</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>

        <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        
        <span class="n">sim_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
        <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>
        <span class="n">sim_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        
        <span class="n">sim_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pred_rain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similar_years</span><span class="p">]):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
            <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>
            <span class="n">sim_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">pred_rain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">year</span><span class="p">)</span> <span class="o">/</span> <span class="n">clim_mean</span><span class="p">)</span>
        
        <span class="n">sim__</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sim_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim__</span><span class="p">)</span>
        <span class="n">sim_all</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_all</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;forecast year&#39;</span><span class="p">,</span> <span class="s1">&#39;composite analog&#39;</span><span class="p">]))</span>
        
        <span class="n">pred_rain</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pred_rain</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_predictor</span><span class="p">:</span>
            <span class="n">sim_all</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s2">&quot;aspect&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2"> anomaly&quot;</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">},</span>
                <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">subplot_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;coastlines&#39;</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SST Composites for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#d7191c&#39;</span><span class="p">,</span> <span class="s1">&#39;#fdae61&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffffbf&#39;</span><span class="p">,</span> <span class="s1">&#39;#a6d96a&#39;</span><span class="p">,</span> <span class="s1">&#39;#1a9641&#39;</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors_list</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            
            <span class="n">data_var</span> <span class="o">=</span> <span class="n">pred_rain</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mf">19.5</span><span class="p">))</span>
            <span class="n">n_times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_times</span> <span class="o">+</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>
            
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()}</span>
            <span class="p">)</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data_var</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Season: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_times</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[:</span><span class="n">n_times</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Precipitation Ratio to Normal (%)&#39;</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">,</span> <span class="s1">&#39;90&#39;</span><span class="p">,</span> <span class="s1">&#39;110&#39;</span><span class="p">,</span> <span class="s1">&#39;150&#39;</span><span class="p">,</span> <span class="s1">&#39;200&#39;</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Ratio to Normal Precipitation [%]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>        
        <span class="k">return</span> <span class="n">similar_years</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>