

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_analog &mdash; wass2s 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">wass2s api</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_analog</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_analog</h1><div class="highlight"><pre>
<span></span><span class="c1"># Core Python Libraries</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>

<span class="c1"># Numerical and Data Manipulation Libraries</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>

<span class="c1"># Visualization Libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Climate Data API</span>
<span class="kn">import</span> <span class="nn">cdsapi</span>

<span class="c1"># Machine Learning and Statistical Analysis Libraries</span>
<span class="kn">from</span> <span class="nn">minisom</span> <span class="kn">import</span> <span class="n">MiniSom</span>
<span class="kn">import</span> <span class="nn">somoclu</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lognorm</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sig</span>

<span class="c1"># Deep Learning Libraries</span>
<span class="c1"># import tensorflow as tf</span>
<span class="c1"># from tensorflow.keras import layers, models, backend as K</span>

<span class="c1"># EOF Analysis Library</span>
<span class="kn">import</span> <span class="nn">xeofs</span>

<span class="c1"># verif library</span>
<span class="kn">import</span> <span class="nn">xskillscore</span> <span class="k">as</span> <span class="nn">xs</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>

<span class="kn">from</span> <span class="nn">wass2s.utils</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="WAS_Analog">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_Analog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analog-based forecasting toolkit for seasonal climate applications.</span>

<span class="sd">    This class orchestrates the end-to-end workflow required to build</span>
<span class="sd">    **analog ensembles** for Sea-Surface Temperature (SST) predictors and</span>
<span class="sd">    to translate them into deterministic and probabilistic rainfall</span>
<span class="sd">    forecasts over West Africa (or any user-defined domain).  Three</span>
<span class="sd">    alternative analog-selection strategies are supported:</span>

<span class="sd">    - **Self-Organising Maps** (`method_analog=&quot;som&quot;`, default)  </span>
<span class="sd">    - **Correlation ranking** (`&quot;cor_based&quot;`)  </span>
<span class="sd">    - **Principal-Component (EOF) similarity** (`&quot;pca_based&quot;`)</span>

<span class="sd">    In addition, the class encapsulates data acquisition (reanalysis +</span>
<span class="sd">    seasonal hindcasts), preprocessing, EOF/SOM training, tercile-based</span>
<span class="sd">    probability generation with multiple distributional options</span>
<span class="sd">    (Student-t, Gamma, Gaussian, Log-normal, non-parametric), and a set of</span>
<span class="sd">    convenient visualisation helpers.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save downloaded and processed data files.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Starting year for historical data.</span>
<span class="sd">    year_forecast : int</span>
<span class="sd">        Target forecast year.</span>
<span class="sd">    reanalysis_name : str</span>
<span class="sd">        Name of the reanalysis dataset (e.g., &quot;ERA5.SST&quot; or &quot;NOAA.SST&quot;).</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name of the forecast model (e.g., &quot;ECMWF_51.SST&quot;).</span>
<span class="sd">    method_analog : str, optional</span>
<span class="sd">        Analog method to use (&quot;som&quot;, &quot;cor_based&quot;, or &quot;pca_based&quot;). Default is &quot;som&quot;.</span>
<span class="sd">    best_prcp_models : list, optional</span>
<span class="sd">        List of best precipitation models to consider.</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of initialization for forecasts. If None, uses current month.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months. If None, defaults to [1, 2, 3, 4, 5].</span>
<span class="sd">    ensemble_mean : str, optional</span>
<span class="sd">        Method for ensemble mean (&quot;mean&quot; or &quot;median&quot;). Default is &quot;mean&quot;.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    define_extent : tuple, optional</span>
<span class="sd">        Bounding box as (lon_min, lon_max, lat_min, lat_max) for regional analysis.</span>
<span class="sd">    index_compute : list, optional</span>
<span class="sd">        List of climate indices to compute.</span>
<span class="sd">    some_grid_size : tuple, optional</span>
<span class="sd">        Grid size for SOM (rows, columns). Default is (None, None) which uses automatic sizing.</span>
<span class="sd">    some_learning_rate : float, optional</span>
<span class="sd">        Learning rate for SOM training. Default is 0.5.</span>
<span class="sd">    some_neighborhood_function : str, optional</span>
<span class="sd">        Neighborhood function for SOM (&quot;gaussian&quot;, &quot;mexican_hat&quot;, etc.). Default is &quot;gaussian&quot;.</span>
<span class="sd">    some_sigma : float, optional</span>
<span class="sd">        Initial neighborhood radius for SOM. Default is 1.0.</span>
<span class="sd">    dist_method : str, optional</span>
<span class="sd">        Method for probability calculation (&quot;gamma&quot;, &quot;t&quot;, &quot;normal&quot;, &quot;lognormal&quot;, &quot;nonparam&quot;).</span>
<span class="sd">        Default is &quot;gamma&quot;.</span>
<span class="sd">    </span>
<span class="sd">    Methods:</span>
<span class="sd">    --------</span>
<span class="sd">    download_sst_reanalysis():</span>
<span class="sd">        Downloads sea surface temperature reanalysis data.</span>
<span class="sd">    download_models():</span>
<span class="sd">        Downloads seasonal forecast model data.</span>
<span class="sd">    standardize_timeseries():</span>
<span class="sd">        Standardizes time series data.</span>
<span class="sd">    calc_index():</span>
<span class="sd">        Calculates climate indices from SST data.</span>
<span class="sd">    compute_model():</span>
<span class="sd">        Computes analog forecasts.</span>
<span class="sd">    compute_prob():</span>
<span class="sd">        Computes tercile probabilities from forecasts.</span>
<span class="sd">    forecast():</span>
<span class="sd">        Generates forecasts for a target year.</span>
<span class="sd">    composite_plot():</span>
<span class="sd">        Creates composite plots of forecast results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_to_save</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_forecast</span><span class="p">,</span> <span class="n">reanalysis_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">method_analog</span> <span class="o">=</span><span class="s2">&quot;som&quot;</span><span class="p">,</span> 
                 <span class="n">best_prcp_models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ensemble_mean</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">define_extent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index_compute</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">some_grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">some_learning_rate</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">some_neighborhood_function</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">some_sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span>
                <span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">dir_to_save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year_start</span> <span class="o">=</span> <span class="n">year_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="o">=</span> <span class="n">year_forecast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reanalysis_name</span> <span class="o">=</span> <span class="n">reanalysis_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">=</span> <span class="n">method_analog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="o">=</span> <span class="n">month_of_initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="o">=</span> <span class="n">lead_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span> <span class="o">=</span> <span class="n">ensemble_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span> <span class="o">=</span> <span class="n">clim_year_start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span> <span class="o">=</span> <span class="n">clim_year_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">best_prcp_models</span> <span class="o">=</span> <span class="n">best_prcp_models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="o">=</span> <span class="n">define_extent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span> <span class="o">=</span> <span class="n">index_compute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span> <span class="o">=</span> <span class="n">some_grid_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_learning_rate</span> <span class="o">=</span> <span class="n">some_learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_neighborhood_function</span><span class="o">=</span><span class="n">some_neighborhood_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">some_sigma</span><span class="o">=</span><span class="n">some_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="o">=</span><span class="n">dist_method</span>
    
<div class="viewcode-block" id="WAS_Analog.calc_index">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calc_index">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">sst</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate climate indices from SST data.</span>

<span class="sd">        Computes specified climate indices (e.g., NINO34, DMI) from SST data by averaging over predefined regions</span>
<span class="sd">        or computing differences for derived indices.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indices : list</span>
<span class="sd">            List of climate indices to compute (e.g., [&#39;NINO34&#39;, &#39;DMI&#39;]).</span>
<span class="sd">        sst : xarray.DataArray</span>
<span class="sd">            SST data with dimensions (T, Y, X).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        indices_dataset : xarray.Dataset</span>
<span class="sd">            Dataset containing computed climate indices as variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">sst_indices_name</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;NINO34&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3.4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO12&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Niño1+2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;NINO3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;NINO_Global&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;ALL NINO Zone&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;TNA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Northern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
            <span class="s2">&quot;TSA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Southern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;NAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;North Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="s2">&quot;SAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;South Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;TASI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NAT-SAT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;WTIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Western Tropical Indian Ocean (WTIO)&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="s2">&quot;SETIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Southeastern Tropical Indian Ocean (SETIO)&quot;</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;DMI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;WTIO - SETIO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Mediterranean Basin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
            <span class="s2">&quot;M1&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">),</span>
            <span class="s2">&quot;M2&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="s2">&quot;M2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;M3&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="s2">&quot;M3&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="s2">&quot;M4&quot;</span><span class="p">:</span>  <span class="p">(</span><span class="s2">&quot;M4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">175</span><span class="p">,</span> <span class="o">-</span><span class="mi">125</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">),</span>
        <span class="p">}</span>
        
        <span class="n">predictor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sst_indices_name</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">,</span> <span class="s2">&quot;DMI&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">sst_indices_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sst_region</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_region</span>
              
        <span class="c1"># Compute derived indices</span>
        <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;NAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SAT&quot;</span><span class="p">]</span>
        <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;DMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;WTIO&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SETIO&quot;</span><span class="p">]</span>
        
        <span class="n">selected_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">predictor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">}</span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">selected_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">indices_dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indices_dataset</span></div>


    <span class="k">def</span> <span class="nf">_postprocess_ersst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span> 

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post-process ERSST dataset.</span>

<span class="sd">        Drops unnecessary variables and ensures consistent variable names and coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Input ERSST dataset.</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Name of the variable to keep (e.g., &#39;sst&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds : xarray.Dataset</span>
<span class="sd">            Processed dataset with specified variable and coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Drop unnecessary variables</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;zlev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">keep_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="n">drop_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">drop_vars</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    
<div class="viewcode-block" id="WAS_Analog.download_sst_reanalysis">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_sst_reanalysis">[docs]</a>
    <span class="k">def</span> <span class="nf">download_sst_reanalysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">area</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download Sea Surface Temperature (SST) reanalysis data.</span>

<span class="sd">        Downloads SST data from the specified reanalysis dataset for the given years and spatial area, </span>
<span class="sd">        handling both NOAA ERSST and ERA5 datasets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        area : list, optional</span>
<span class="sd">            Bounding box as [North, West, South, East]. Default is [60, -180, -60, 180].</span>
<span class="sd">        force_download : bool, optional</span>
<span class="sd">            If True, forces re-download even if file exists. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        combined_ds : xarray.Dataset</span>
<span class="sd">            Combined SST dataset for the specified years.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">year_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="c1">#datetime.now().year        </span>
        <span class="n">center_variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reanalysis_name</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center_variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">center_variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Define variable mapping</span>
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="c1"># # Validate center</span>
        <span class="c1"># if center not in [&quot;ERA5&quot;]:</span>
        <span class="c1">#     raise ValueError(f&quot;Unsupported center &#39;{center}&#39;. Supported centers are &#39;ERA5&#39;.&quot;)</span>
    
        <span class="c1"># Define dataset based on center</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-single-levels-monthly-means&quot;</span>
    
        <span class="c1"># Define variable</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="n">variables_1</span><span class="p">[</span><span class="s2">&quot;SST&quot;</span><span class="p">]</span>
    
        <span class="c1"># Prepare save directory</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="c1"># Define all months</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">])</span>
    
        <span class="c1"># Define combined output file path</span>
        <span class="n">combined_output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_SST_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">combined_output_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combined_output_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span>
            <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">combined_ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">center_variable</span> <span class="o">==</span> <span class="s2">&quot;NOAA.SST&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Build IRIDL URL using bounding box [N, W, S, E]</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">build_iridl_url_ersst</span><span class="p">(</span>
                        <span class="n">year_start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span>
                        <span class="n">year_end</span><span class="o">=</span><span class="n">year_end</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>     <span class="c1"># e.g. [10, -15, -5, 15]</span>
                        <span class="n">run_avg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">month_start</span><span class="o">=</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                        <span class="n">month_end</span><span class="o">=</span><span class="s2">&quot;Dec&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using IRIDL URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
                    <span class="c1"># 2) Open dataset with manual processing</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s2">&quot;proleptic_gregorian&quot;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;T&quot;</span><span class="p">})</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                        <span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s1">&#39;SST&#39;</span><span class="p">,</span>  <span class="c1"># Rename variable to match expected name</span>
                    <span class="p">})</span>
                                                                                       
                    <span class="c1"># 6) Post-process</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_ersst</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>                   
                
                    <span class="c1"># 7) Final formatting</span>
                    <span class="c1"># ds_agg = ds.where(ds.T.dt.month == int(seas[1]), drop=True)</span>
                    <span class="c1"># ds_agg = fix_time_coord(ds_agg, seas)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                        <span class="s1">&#39;SST&#39;</span><span class="p">:</span> <span class="s1">&#39;sst&#39;</span><span class="p">,</span>  <span class="c1"># Rename variable to match expected name</span>
                        <span class="p">})</span>
                    <span class="c1"># 8) Save</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
                    <span class="c1"># print(f&quot;Saved NOAA ERSST data to {combined_output_path}&quot;)</span>
                    <span class="k">return</span> <span class="n">ds</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>  <span class="c1"># Initialize once outside the loop for efficiency</span>
        
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">yearly_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_SST_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">yearly_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">yearly_file_path</span><span class="si">}</span><span class="s2"> already exists. Loading existing file.&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                            <span class="c1"># Rename coordinates if necessary</span>
                            <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                            <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load existing file </span><span class="si">{</span><span class="n">yearly_file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="c1"># If loading fails, attempt to re-download</span>
        
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>  <span class="c1"># Request all months at once</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;00:00&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                        <span class="p">}</span>
        
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading SST for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download SST for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
        
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">yearly_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                            <span class="c1"># Rename coordinates for consistency</span>
                            <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">and</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                            <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process </span><span class="si">{</span><span class="n">yearly_file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
        
                <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Concatenating yearly datasets...&quot;</span><span class="p">)</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;expver&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                    <span class="c1"># combined_ds = combined_ds.rename({&quot;lon&quot;: &quot;X&quot;, &quot;lat&quot;: &quot;Y&quot;, &quot;valid_time&quot;: &quot;T&quot;})</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">combined_output_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished. Combined SST dataset saved to </span><span class="si">{</span><span class="n">combined_output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
                    <span class="c1"># remove individual yearly files</span>
                    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">single_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_SST_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                        <span class="k">if</span> <span class="n">single_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">single_file_path</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted yearly file: </span><span class="si">{</span><span class="n">single_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">combined_ds</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No datasets were combined. Please check if downloads were successful.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Analog.download_models">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_models">[docs]</a>
    <span class="k">def</span> <span class="nf">download_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">area</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
            <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download SST seasonal forecast data.</span>

<span class="sd">        Downloads forecast data for specified models, initialization month, lead times, and spatial area.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        area : list, optional</span>
<span class="sd">            Bounding box as [North, West, South, East]. Default is [60, -180, -60, 180].</span>
<span class="sd">        force_download : bool, optional</span>
<span class="sd">            If True, forces re-download even if file exists. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ds_centers : xarray.Dataset</span>
<span class="sd">            Combined forecast dataset across models.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">center_variable</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
        <span class="c1"># 1. Set Current Date and Initialization Month</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">month</span> 
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using current month as initialization month: </span><span class="si">{</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month_of_initialization</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">month_of_initialization</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span>
            
        <span class="c1"># 2. Set Lead Time to Remaining Months if Not Provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># lead_time = list(range(1, 13 - month_of_initialization + 1))</span>
            <span class="n">lead_time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lead time not provided. Using months: </span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month_of_initialization</span><span class="p">]</span><span class="si">}</span><span class="s2"> as initialization month&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate lead_time argument</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lead_time should be a list of integers representing months ahead.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Each lead_time value should be between 1 and 12.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using provided lead times: </span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># 3. Set Forecast Years to Current Year if Not Provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;year_forecast not provided. Using current year: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    
        <span class="c1"># 4. Define Variable Mapping (Only SST)</span>
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="c1"># 5. Extract Center and Variable</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;center_variable should be in the format &#39;CENTER.VARIABLE&#39;, e.g., &#39;ECMWF_51.SST&#39;.&quot;</span><span class="p">)</span>
    
        <span class="c1"># 6. Define Center Mappings</span>
        <span class="n">centre</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;ecmwf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_602&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_2&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMCC_3&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;ncep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;jma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_2&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_3&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="c1"># 7. Define System Mappings</span>
        <span class="n">system</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;51&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_602&quot;</span><span class="p">:</span> <span class="s2">&quot;602&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;603&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;35&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMCC_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="c1"># 8. Select Centres, Systems, Variables</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selected_centre</span> <span class="o">=</span> <span class="p">[</span><span class="n">centre</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span>
            <span class="n">selected_system</span> <span class="o">=</span> <span class="p">[</span><span class="n">system</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span>
            <span class="n">selected_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported center identifier: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="c1"># 9. Prepare Save Directory</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="c1"># 10. Get Abbreviation for Initialization Month</span>
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
    
        <span class="c1"># 11. Construct Season String Based on Lead Times</span>
        <span class="c1">#    Handles month rollover using modulo arithmetic</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="n">month_of_initialization</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>

        <span class="n">ds_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 13. Iterate Over Centres, Systems, Variables</span>
        <span class="k">for</span> <span class="n">cent</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_centre</span><span class="p">,</span> <span class="n">selected_system</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">):</span>
            <span class="c1"># # Only handle SST</span>
            <span class="c1"># if k != &quot;SST&quot;:</span>
            <span class="c1">#     print(f&quot;Skipping variable &#39;{k}&#39; as only SST is supported.&quot;)</span>
            <span class="c1">#     continue</span>
    
            <span class="c1"># 14. Construct File Prefix and Output Filename</span>
            <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span>  <span class="c1"># Changed to &#39;forecast&#39; as per user request</span>
            <span class="n">output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="n">output_filename</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    
            <span class="c1"># 15. Check if File Already Exists</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">output_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#39; already exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                    <span class="n">ds_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>                
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># 12. Initialize CDS API Client</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize CDS API client: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
                
                <span class="c1"># 16. Define Dataset and Request Parameters</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-single-levels&quot;</span>
        
                <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                    <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                    <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                    <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year_forecast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span>
                    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
                    <span class="s2">&quot;leadtime_month&quot;</span><span class="p">:</span> <span class="n">lead_time</span><span class="p">,</span>
                    <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>  <span class="c1"># Corrected from &#39;data_format&#39; to &#39;format&#39;</span>
                    <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                        <span class="p">}</span>
        
                <span class="c1"># 17. Download the Data to a Temporary File</span>
                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">output_filename</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading SST from &#39;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">&#39; for initialization month &#39;</span><span class="si">{</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month_of_initialization</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                          <span class="sa">f</span><span class="s2">&quot;and lead times </span><span class="si">{</span><span class="n">lead_time</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded data to temporary file: &#39;</span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download data for &#39;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
    
                
                <span class="c1"># 18. Load and Process the Dataset</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
                        <span class="c1"># 19. Convert SST from Kelvin to Celsius</span>
                        <span class="k">if</span> <span class="s1">&#39;sst&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                            <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;sst&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>
                            <span class="c1"># ds = ds.rename({&#39;sst&#39;: &#39;SST&#39;})</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converted SST from Kelvin to Celsius.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">30</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="n">ds</span>
                            <span class="c1"># print(&quot;Variable &#39;sea_surface_temperature or total_precipitation&#39; not found in the dataset.&quot;)</span>
                            <span class="c1"># continue  # Skip processing if SST is not found</span>
        
                        <span class="c1"># 20. Apply Ensemble Mean if Specified</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied ensemble &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_mean</span><span class="si">}</span><span class="s2">&#39; across &#39;number&#39; dimension.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble dimension &#39;number&#39; not found. Skipping ensemble mean.&quot;</span><span class="p">)</span>
        
                        <span class="c1"># 21. Rename Coordinates for Consistency</span>
                        <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="s2">&quot;forecast_reference_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected coordinate names in dataset. Skipping coordinate renaming.&quot;</span><span class="p">)</span>
        
                        <span class="c1"># # 22. Reverse Latitude if Necessary</span>
                        <span class="c1"># if &#39;lat&#39; in ds.coords and ds.lat[0] &gt; ds.lat[-1]:</span>
                        <span class="c1">#     ds = ds.sortby(&#39;lat&#39;)</span>
                        <span class="c1">#     print(&quot;Reversed latitude coordinates for consistency.&quot;)</span>
        
                        <span class="c1"># 23. Rename to Standard Dimensions</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Renamed coordinates to standard dimensions: X, Y, T.&quot;</span><span class="p">)</span>
                    
                        <span class="n">ds_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                        
                        <span class="c1"># 24. Save the Processed Dataset</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed and saved dataset to &#39;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process dataset from &#39;</span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># 25. Remove the Temporary Download File</span>
                    <span class="k">if</span> <span class="n">temp_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># pass</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted temporary file: &#39;</span><span class="si">{</span><span class="n">temp_file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">ds_centers</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ds_centers</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;models&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;models&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All requested SST data has been processed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ds_centers</span></div>


<div class="viewcode-block" id="WAS_Analog.standardize_timeseries">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.standardize_timeseries">[docs]</a>
    <span class="k">def</span> <span class="nf">standardize_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standardize the dataset over a specified climatology period.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clim_year_end</span><span class="p">))</span>
            
            <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="c1"># ds = (((ds.groupby(&quot;T.month&quot;) - clim_mean) / clim_std).isel(month=0, drop=True).squeeze())</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;T.month&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">clim_mean</span><span class="p">))</span><span class="c1">#.isel(month=0, drop=True).squeeze())</span>
        <span class="c1"># ds = xr.where((ds &gt; -10) &amp; (ds &lt; 10), ds, np.nan)</span>
        <span class="k">return</span>  <span class="n">ds</span></div>


<div class="viewcode-block" id="WAS_Analog.download_and_process">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.download_and_process">[docs]</a>
    <span class="k">def</span> <span class="nf">download_and_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_variable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download and process SST data for reanalysis and forecast.</span>

<span class="sd">        Combines reanalysis and forecast SST data, standardizes, and applies a rolling mean.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center_variable : str, optional</span>
<span class="sd">            Center-variable identifier (e.g., &#39;ECMWF_51.SST&#39;). Default is None (uses class attributes).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        concatenated_ds_st : xarray.DataArray</span>
<span class="sd">            Standardized and processed SST data.</span>
<span class="sd">        ds_shifted : xarray.DataArray</span>
<span class="sd">            Time-shifted version of the processed SST data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lead_time</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lead_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lead_time</span>            
            
        <span class="n">sst_hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_sst_reanalysis</span><span class="p">(</span>
            <span class="c1"># center_variable=self.reanalysis_name,</span>
            <span class="n">area</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
            <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">month</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">month_of_initialization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">month_of_initialization</span>
       
        <span class="n">sst_for</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_models</span><span class="p">(</span>
            <span class="c1"># center_variable=[self.model_name],</span>
            <span class="n">area</span><span class="o">=</span><span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
            <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">sst_hist</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
            <span class="n">Y</span><span class="o">=</span><span class="n">sst_hist</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Extract the base time</span>
        <span class="n">base_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
        <span class="c1"># Create new times by adding forecast months</span>
        <span class="n">new_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_time</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sst_for_</span><span class="p">[</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        
        <span class="c1"># Assign the new &#39;time&#39; coordinate</span>
        <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">forecastMonth</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">,</span> <span class="n">new_times</span><span class="p">))</span>

        <span class="n">sst_for_</span> <span class="o">=</span> <span class="n">sst_for_</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;forecastMonth&#39;</span><span class="p">:</span><span class="s1">&#39;T&#39;</span><span class="p">})</span>

        <span class="c1"># sst_hist = sst_hist.sel(T=slice(f&quot;{self.year_start}-01&quot;,f&quot;{self.year_forecast}-{(month_of_initialization):02}&quot;))</span>
    
        <span class="n">sst_hist</span> <span class="o">=</span> <span class="n">sst_hist</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">year_start</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_time</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">base_time</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="n">concatenated_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sst_hist</span><span class="p">,</span> <span class="n">sst_for_</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    
        <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">concatenated_ds</span><span class="p">)</span>
        
        <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
        <span class="n">first_year</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">last_month</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">last_month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">concatenated_ds_st</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">new_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">concatenated_ds_st</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))])</span>

        <span class="n">ds_shifted</span> <span class="o">=</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">new_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">concatenated_ds_st</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">ds_shifted</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span></div>



<div class="viewcode-block" id="WAS_Analog.Corr_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Corr_Based">[docs]</a>
    <span class="k">def</span> <span class="nf">Corr_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify similar years using correlation-based analog method.</span>

<span class="sd">        Finds years with high spatial correlation to the reference year&#39;s SST data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed predictand data with dimensions (T, Y, X).</span>
<span class="sd">        ddd : xarray.DataArray</span>
<span class="sd">            SST predictor data with dimensions (T, Y, X).</span>
<span class="sd">        itrain : list</span>
<span class="sd">            Indices of training years.</span>
<span class="sd">        ireference_year : list</span>
<span class="sd">            Indices of the reference year.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similar_years : np.ndarray</span>
<span class="sd">            Array of years similar to the reference year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
            <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
            
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="n">ireference_year</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sst_ireference_year</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
        
        <span class="c1"># Get the unique years from the dataset&#39;s &#39;T&#39; dimension</span>
        <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>

        <span class="c1"># Extract train years</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

        <span class="n">sim_tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_ireference_year</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_ireference_year</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">sim_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_tmp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similar</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Select the first 3 entries</span>
        <span class="n">top_3</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_3</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> are </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similar_years</span></div>


<div class="viewcode-block" id="WAS_Analog.Pca_Based">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.Pca_Based">[docs]</a>
    <span class="k">def</span> <span class="nf">Pca_Based</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify similar years using PCA-based analog method.</span>

<span class="sd">        Uses EOF analysis to compute principal components and finds years with similar scores to the reference year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed predictand data with dimensions (T, Y, X).</span>
<span class="sd">        ddd : xarray.DataArray</span>
<span class="sd">            SST predictor data with dimensions (T, Y, X).</span>
<span class="sd">        itrain : list</span>
<span class="sd">            Indices of training years.</span>
<span class="sd">        ireference_year : list</span>
<span class="sd">            Indices of the reference year.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similar_years : np.ndarray</span>
<span class="sd">            Array of years similar to the reference year.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
            <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>

        <span class="n">predictor_</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predictor_detrend</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">predictor_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ddd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">predictor_detrend</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">predictor_</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">predictor_</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        
        <span class="n">eof</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">eof</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">eof</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span>

        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="n">ireference_year</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sst_ref</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
        <span class="n">sst_ref</span> <span class="o">=</span> <span class="n">sst_ref</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>

        <span class="c1"># Get the unique years from the dataset&#39;s &#39;T&#39; dimension</span>
        <span class="c1"># predictant_ = xr.concat([predictant.isel(T=itrain), predictant.isel(T=ireference_year)], dim=&quot;T&quot;)</span>

        <span class="c1"># Extract train years</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> 
        
        <span class="n">sim_tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
            <span class="n">sst_ref</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
            <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
            <span class="c1"># print(correlation)</span>
            <span class="n">sim_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_tmp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">)</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Select the first 3 entries</span>
        <span class="n">top_3</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_3</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> are </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">similar_years</span></div>

        
        

<div class="viewcode-block" id="WAS_Analog.SOM">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.SOM">[docs]</a>
    <span class="k">def</span> <span class="nf">SOM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">ireference_year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify similar years using Self-Organizing Maps (SOM).</span>

<span class="sd">        Trains a SOM on SST data or climate indices and finds years mapped to the same Best Matching Unit (BMU) as the reference year.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed predictand data with dimensions (T, Y, X).</span>
<span class="sd">        ddd : xarray.DataArray</span>
<span class="sd">            SST predictor data with dimensions (T, Y, X).</span>
<span class="sd">        itrain : list</span>
<span class="sd">            Indices of training years.</span>
<span class="sd">        ireference_year : list</span>
<span class="sd">            Indices of the reference year.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similar_years : np.ndarray</span>
<span class="sd">            Array of years similar to the reference year.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indices_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span><span class="p">,</span> <span class="n">ddd</span><span class="p">)</span>
            
            <span class="c1"># Get the unique years from the dataset&#39;s &#39;T&#39; dimension</span>
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract years</span>
            <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            
            <span class="c1"># List to hold flattened data for each year</span>
            <span class="n">yearly_data</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Loop through each unique year</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
                <span class="c1"># print(&quot;Processing year:&quot;, year)</span>
                
                <span class="c1"># Temporary list to hold data for all variables in this particular year</span>
                <span class="n">index_data_list</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1"># For each data variable, extract and reshape data for this year</span>
                <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">indices_dataset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                    <span class="c1"># print(&quot;  Variable:&quot;, var_name)</span>
                    <span class="n">yearly_sst</span> <span class="o">=</span> <span class="n">indices_dataset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">index_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yearly_sst</span><span class="p">)</span>
                
                <span class="c1"># Stack all variables for the year vertically, then flatten</span>
                <span class="n">index_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">index_data_list</span><span class="p">)</span>
                <span class="n">flattened_array</span> <span class="o">=</span> <span class="n">index_data_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                
                <span class="c1"># Append the flattened array for this year to yearly_data</span>
                <span class="n">yearly_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flattened_array</span><span class="p">)</span>
            
            <span class="c1"># Convert the list of yearly arrays into a 2D NumPy array: (num_years, data_points_per_year)</span>
            <span class="n">sst_yearly_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yearly_data</span><span class="p">)</span>
            
            <span class="c1"># Adjust the list of years to match the length of data we have</span>
            <span class="n">years_complete</span> <span class="o">=</span> <span class="n">unique_years</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">sst_yearly_flat</span><span class="p">)]</span>
            
            <span class="c1"># Handle missing values by filtering out rows (years) that contain NaNs</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sst_yearly_flat</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sst_yearly_flat</span> <span class="o">=</span> <span class="n">sst_yearly_flat</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">years_complete</span> <span class="o">=</span> <span class="n">years_complete</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            
            <span class="c1"># Final scaled data (modify this part as needed if you plan on applying a scaler)</span>
            <span class="n">sst_scaled</span> <span class="o">=</span> <span class="n">sst_yearly_flat</span>
            
            <span class="c1"># Define SOM parameters</span>
            <span class="c1"># n = int(np.sqrt(5*np.sqrt(sst_scaled.shape[1]))) - 2</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}:</span>
                <span class="n">som_grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 10x10 grid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">som_grid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span>
            
            <span class="n">input_len</span> <span class="o">=</span> <span class="n">sst_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Number of features per year (12 * lat * lon)</span>
            <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_learning_rate</span>
            <span class="n">neighborhood_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_neighborhood_function</span>
            <span class="n">some_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_sigma</span>
            
            <span class="c1"># Initialize the SOM</span>
            <span class="n">som</span> <span class="o">=</span> <span class="n">MiniSom</span><span class="p">(</span>
                         <span class="n">x</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                         <span class="n">y</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                         <span class="n">input_len</span><span class="o">=</span><span class="n">input_len</span><span class="p">,</span> 
                         <span class="n">sigma</span><span class="o">=</span><span class="n">some_sigma</span><span class="p">,</span> 
                         <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> 
                         <span class="n">neighborhood_function</span><span class="o">=</span><span class="n">neighborhood_function</span><span class="p">,</span> 
                         <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span>
                         <span class="p">)</span>
            
            <span class="c1"># Initialize the weights</span>
            <span class="n">som</span><span class="o">.</span><span class="n">random_weights_init</span><span class="p">(</span><span class="n">sst_scaled</span><span class="p">)</span>
            
            <span class="c1"># print(&quot;Training SOM...&quot;)</span>
            <span class="c1"># Train the SOM with 1000 iterations (adjust as needed)</span>
            <span class="n">som</span><span class="o">.</span><span class="n">train_random</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sst_scaled</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
            <span class="c1"># print(&quot;SOM training completed.&quot;)</span>
            <span class="c1"># Map each year to its Best Matching Unit (BMU)</span>
            <span class="n">bmu_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">som</span><span class="o">.</span><span class="n">winner</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sst_scaled</span><span class="p">])</span>
            <span class="n">bmu_x</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">bmu_y</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Create a DataFrame for easy plotting</span>
            <span class="n">bmu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years_complete</span><span class="p">,</span>
                <span class="s1">&#39;BMU_X&#39;</span><span class="p">:</span> <span class="n">bmu_x</span><span class="p">,</span>
                <span class="s1">&#39;BMU_Y&#39;</span><span class="p">:</span> <span class="n">bmu_y</span>
            <span class="p">})</span>
            
            <span class="c1"># -------------------- 4. Identifying Similar Years -------------------- #</span>
            <span class="c1"># Define the reference year</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
            
            <span class="c1"># Check if the reference year is in the dataset</span>
            <span class="k">if</span> <span class="n">reference_year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">years_complete</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> is not present in the dataset.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find the index of the reference year</span>
                <span class="n">ref_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">years_complete</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="c1"># Get the BMU of the reference year</span>
                <span class="n">ref_bmu</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[</span><span class="n">ref_index</span><span class="p">]</span>
            
                
                <span class="c1"># Find all years mapped to the same BMU</span>
                <span class="n">similar_years</span> <span class="o">=</span> <span class="n">years_complete</span><span class="p">[(</span><span class="n">bmu_x</span> <span class="o">==</span> <span class="n">ref_bmu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bmu_y</span> <span class="o">==</span> <span class="n">ref_bmu</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years</span><span class="p">[</span><span class="n">similar_years</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> are </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
                <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
            
            <span class="c1"># -------------------- 6a. Parallel Data Preparation with Dask -------------------- #</span>

            
            <span class="n">dddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1"># Convert Xarray DataArray to Dask Array</span>
            <span class="c1"># Adjust chunk sizes based on HPC resources and data dimensions</span>
            <span class="n">sst_dask</span> <span class="o">=</span> <span class="n">dddd</span><span class="c1">#.chunk({&#39;T&#39;: 12, &#39;Y&#39;: 100, &#39;X&#39;: 100})  # Assuming 12 months per year</span>
                      
            <span class="n">predictant_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itrain</span><span class="p">),</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            
            <span class="c1"># Extract years</span>
            <span class="n">unique_years_dask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

            
            <span class="c1"># Flatten spatial dimensions and prepare data for SOM</span>
            <span class="n">yearly_data_dask</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years_dask</span><span class="p">:</span>
                <span class="n">yearly_sst</span> <span class="o">=</span> <span class="n">sst_dask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
                
                <span class="c1"># Check for complete 12 months</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yearly_sst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">monthly_flat</span> <span class="o">=</span> <span class="n">yearly_sst</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">yearly_flat</span> <span class="o">=</span> <span class="n">monthly_flat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">yearly_data_dask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yearly_flat</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> is incomplete and will be skipped.&quot;</span><span class="p">)</span>
            
            <span class="c1"># Convert to NumPy array</span>
            <span class="n">sst_yearly_flat_dask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yearly_data_dask</span><span class="p">)</span>
            <span class="n">years_complete_dask</span> <span class="o">=</span> <span class="n">unique_years_dask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">sst_yearly_flat_dask</span><span class="p">)]</span>
            
            
            <span class="c1"># Handle missing values by removing any years with NaNs</span>
            <span class="n">valid_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sst_yearly_flat_dask</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sst_yearly_flat_dask</span> <span class="o">=</span> <span class="n">sst_yearly_flat_dask</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">years_complete_dask</span> <span class="o">=</span> <span class="n">years_complete_dask</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            <span class="n">sst_scaled_dask</span> <span class="o">=</span> <span class="n">sst_yearly_flat_dask</span>                

            
            <span class="c1"># Initialize SOMoclu</span>

            <span class="c1"># n_rows, n_columns = 20, 20</span>
            <span class="c1"># my_code = np.float32(np.random.uniform(low=0.0, high=1.0, size=(n_columns * n_rows * 4)))</span>
            
            <span class="c1"># som = somoclu.Somoclu(n_columns, n_rows, initialcodebook=my_code, maptype=&quot;planar&quot;, gridtype=&quot;rectangular&quot;, neighborhood=&quot;gaussian&quot;, std_coeff=1.0, initialization=None, verbose=2)</span>
            <span class="c1"># som.train(mydata, epochs=10, scalecooling=&#39;exponential&#39;)</span>
            <span class="c1"># som.view_umatrix(bestmatches=True, labels=labels, filename=&quot;umatrix_output&quot; )</span>
            <span class="c1"># som_state = som.get_surface_state()</span>
            <span class="c1"># my_bmus = som.get_bmus(som_state)</span>

            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}:</span>
                <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_columns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 10x10 grid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span>

            <span class="c1"># somoclu_instance = somoclu.Somoclu(n_columns, n_rows, data=sst_scaled_dask)</span>
            <span class="n">somoclu_instance</span> <span class="o">=</span> <span class="n">somoclu</span><span class="o">.</span><span class="n">Somoclu</span><span class="p">(</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">)</span>

            <span class="c1"># Train SOM</span>
            <span class="n">somoclu_instance</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sst_scaled_dask</span><span class="p">)</span>
            
            <span class="c1"># Get BMUs</span>
            <span class="n">bmus</span> <span class="o">=</span> <span class="n">somoclu_instance</span><span class="o">.</span><span class="n">bmus</span>  <span class="c1"># Shape: (num_samples, 2)</span>
            
            <span class="c1"># Map BMUs to years</span>
            <span class="n">bmu_x_dask</span> <span class="o">=</span> <span class="n">bmus</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">bmu_y_dask</span> <span class="o">=</span> <span class="n">bmus</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># Create DataFrame</span>
            <span class="n">bmu_df_dask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years_complete_dask</span><span class="p">,</span>
                <span class="s1">&#39;BMU_X&#39;</span><span class="p">:</span> <span class="n">bmu_x_dask</span><span class="p">,</span>
                <span class="s1">&#39;BMU_Y&#39;</span><span class="p">:</span> <span class="n">bmu_y_dask</span>
            <span class="p">})</span>
                    
            <span class="c1"># Define the reference year</span>
            <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">ireference_year</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span> <span class="c1">#unique_years_dask[ireference_year][0]  </span>
            
            <span class="c1"># Identify similar years </span>
            <span class="k">if</span> <span class="n">reference_year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> is not present in the dataset.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_bmu_dask</span> <span class="o">=</span> <span class="n">bmu_df_dask</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;BMU_X&#39;</span><span class="p">,</span> <span class="s1">&#39;BMU_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">similar_years_dask</span> <span class="o">=</span> <span class="n">bmu_df_dask</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;BMU_X&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_bmu_dask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> 
                    <span class="p">(</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;BMU_Y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_bmu_dask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">][</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years_dask</span><span class="p">[</span><span class="n">similar_years_dask</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>  
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;similar years for </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> are </span><span class="si">{</span><span class="n">similar_years</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">similar_years</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Student&#39;s t-based method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="c1"># Transform thresholds</span>
            <span class="n">first_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>
            <span class="n">second_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">second_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>

            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_gamma">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_gamma">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_gamma</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gamma-based method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># If any input is NaN, fill with NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>

        <span class="c1"># Convert inputs to arrays</span>
        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>
    
        <span class="c1"># Compute CDF at T1, T2</span>
        <span class="n">cdf_t1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">cdf_t2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
    
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t2</span> <span class="o">-</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_t2</span>

        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_nonparametric">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_nonparametric">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_nonparametric</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_samples</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Non-parametric method (require historical errors)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># best_guess: shape (n_time,)</span>
        <span class="c1"># error_samples: shape (n_time,)</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="c1"># Empirical distribution = best_guess[t] + error_samples[:, t] ---- to see in deep again</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_samples</span><span class="c1">#[:, t]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span>  <span class="c1"># remove NaNs</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Probability(X &lt; T1)</span>
            <span class="n">p_below</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">first_tercile</span><span class="p">)</span>
            <span class="c1"># Probability(T1 &lt;= X &lt; T2)</span>
            <span class="n">p_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">first_tercile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">second_tercile</span><span class="p">))</span>
            <span class="c1"># Probability(X &gt;= T2)</span>
            <span class="n">p_above</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_below</span> <span class="o">+</span> <span class="n">p_between</span><span class="p">)</span>

            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_below</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_between</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_above</span>

        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_normal">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_normal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_normal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normal-based method using the Gaussian CDF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> \
                              <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_Analog.calculate_tercile_probabilities_lognormal">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.calculate_tercile_probabilities_lognormal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_lognormal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lognormal-based method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        
        <span class="c1"># If any input is NaN, fill with NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>
        
        <span class="c1"># Moment matching for lognormal distribution:</span>
        <span class="c1"># Given mean (m) and variance (v), we have:</span>
        <span class="c1"># sigma = sqrt(ln(1 + v/m^2)) and mu = ln(m) - sigma^2/2.</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Use the lognormal CDF from scipy:</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> \
                          <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">pred_prob</span></div>

        
<div class="viewcode-block" id="WAS_Analog.compute_model">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.compute_model">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span>  <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;som&quot;</span><span class="p">:</span>
            
            <span class="n">dddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOM</span><span class="p">(</span><span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">)</span>
            <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dddd</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sim_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itest</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span> 
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;cor_based&quot;</span><span class="p">:</span>

            <span class="n">dddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Corr_Based</span><span class="p">(</span><span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">)</span>
            <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            
            <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dddd</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sim_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itest</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>  
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;pca_based&quot;</span><span class="p">:</span>

            <span class="n">dddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pca_Based</span><span class="p">(</span><span class="n">predictant</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">itrain</span><span class="p">,</span> <span class="n">itest</span><span class="p">)</span>
            <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
            
            <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dddd</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sim_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">hindcast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">itest</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">})</span> 

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid analog method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="si">}</span><span class="s2">. Choose &#39;som&#39;, &#39;pca_based&#39;, or &#39;cor_based&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hindcast_det</span></div>


    <span class="c1"># def compute_prob(self, Predictant, clim_year_start, clim_year_end, hindcast_det):</span>

    <span class="c1">#     index_start = Predictant.get_index(&quot;T&quot;).get_loc(str(clim_year_start)).start</span>
    <span class="c1">#     index_end = Predictant.get_index(&quot;T&quot;).get_loc(str(clim_year_end)).stop</span>
        
    <span class="c1">#     rainfall_for_tercile = Predictant.isel(T=slice(index_start, index_end))</span>
    <span class="c1">#     terciles = rainfall_for_tercile.quantile([0.333, 0.667], dim=&#39;T&#39;)</span>
    <span class="c1">#     error_variance = (Predictant - hindcast_det).var(dim=&#39;T&#39;)</span>
    <span class="c1">#     dof = len(Predictant.get_index(&quot;T&quot;)) - 2</span>
        
    <span class="c1">#     hindcast_prob = xr.apply_ufunc(</span>
    <span class="c1">#         self.calculate_tercile_probabilities,</span>
    <span class="c1">#         hindcast_det,</span>
    <span class="c1">#         error_variance,</span>
    <span class="c1">#         terciles.isel(quantile=0).drop_vars(&#39;quantile&#39;),</span>
    <span class="c1">#         terciles.isel(quantile=1).drop_vars(&#39;quantile&#39;),</span>
    <span class="c1">#         input_core_dims=[(&#39;T&#39;,), (), (), ()],</span>
    <span class="c1">#         vectorize=True,</span>
    <span class="c1">#         kwargs={&#39;dof&#39;: dof},</span>
    <span class="c1">#         dask=&#39;parallelized&#39;,</span>
    <span class="c1">#         output_core_dims=[(&#39;probability&#39;, &#39;T&#39;)],</span>
    <span class="c1">#         output_dtypes=[&#39;float&#39;],</span>
    <span class="c1">#         dask_gufunc_kwargs={&#39;output_sizes&#39;: {&#39;probability&#39;: 3}},</span>
    <span class="c1">#     )</span>
        
    <span class="c1">#     hindcast_prob = hindcast_prob.assign_coords(probability=(&#39;probability&#39;, [&#39;PB&#39;, &#39;PN&#39;, &#39;PA&#39;]))</span>
    <span class="c1">#     return hindcast_prob.transpose(&#39;probability&#39;, &#39;T&#39;, &#39;Y&#39;, &#39;X&#39;)</span>

<div class="viewcode-block" id="WAS_Analog.compute_prob">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.compute_prob">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                     <span class="n">Predictant</span><span class="p">,</span> 
                     <span class="n">clim_year_start</span><span class="p">,</span> 
                     <span class="n">clim_year_end</span><span class="p">,</span> 
                     <span class="n">hindcast_det</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile probabilities using either &#39;t&#39;, &#39;gamma&#39;, &#39;normal&#39;, &#39;lognormal&#39;, or &#39;nonparam&#39;.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        Predictant : xarray.DataArray</span>
<span class="sd">            Observed data array with dimensions (T, Y, X)</span>
<span class="sd">        clim_year_start : int</span>
<span class="sd">            Start year for climatology</span>
<span class="sd">        clim_year_end : int</span>
<span class="sd">            End year for climatology</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic forecast (same shape as Predictant, minus M dimension)</span>
<span class="sd">        method : str, default = &quot;gamma&quot;</span>
<span class="sd">            Method to use for calculating tercile probabilities:</span>
<span class="sd">            - &quot;t&quot;</span>
<span class="sd">            - &quot;gamma&quot;</span>
<span class="sd">            - &quot;normal&quot;</span>
<span class="sd">            - &quot;lognormal&quot;</span>
<span class="sd">            - &quot;nonparam&quot;</span>
<span class="sd">        error_samples : xarray.DataArray or None</span>
<span class="sd">            Only required for non-parametric method, shape (ensemble, T, Y, X) or something similar.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        hindcast_prob : xarray.DataArray</span>
<span class="sd">            Probability for each tercile category (PB, PN, PA)</span>
<span class="sd">            with dimensions (probability=3, T, Y, X).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Select climatology slice</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>

        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

        <span class="c1"># We&#39;ll pass these thresholds to the methods</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>

        <span class="c1"># ---- CHOOSE THE CALC FUNCTION &amp; ARGUMENTS BASED ON &#39;method&#39; ----</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            
            <span class="c1"># Degrees of freedom (only used by &#39;t&#39; methids)</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>
            
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="c1"># kwargs={&#39;dof&#39;: dof},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_normal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_lognormal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span>
            
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">. Choose &#39;t&#39;, &#39;gamma&#39;, &#39;normal&#39;, &#39;lognormal&#39;, or &#39;nonparam&#39;.&quot;</span><span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="WAS_Analog.forecast">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">forecast_year</span><span class="p">):</span>
        <span class="c1"># Set environment variables for reproducibility</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;42&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>  <span class="c1"># Limit OpenMP threads</span>
        
        <span class="c1"># Define the reference year</span>
        <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

        <span class="c1"># Extract years</span>
        <span class="n">unique_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="n">reference_year</span><span class="p">)</span>
        
        <span class="n">_</span><span class="p">,</span> <span class="n">ddd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;som&quot;</span><span class="p">:</span>         

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indices_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_compute</span><span class="p">,</span> <span class="n">ddd</span><span class="p">)</span> 
                                        
                <span class="c1"># List to hold flattened data for each year</span>
                <span class="n">yearly_data</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="c1"># Loop through each unique year</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">:</span>
                    <span class="c1"># print(&quot;Processing year:&quot;, year)</span>
                    
                    <span class="c1"># Temporary list to hold data for all variables in this particular year</span>
                    <span class="n">index_data_list</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="c1"># For each data variable, extract and reshape data for this year</span>
                    <span class="k">for</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">indices_dataset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                        <span class="c1"># print(&quot;  Variable:&quot;, var_name)</span>
                        <span class="n">yearly_sst</span> <span class="o">=</span> <span class="n">indices_dataset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">index_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yearly_sst</span><span class="p">)</span>
                    
                    <span class="c1"># Stack all variables for the year vertically, then flatten</span>
                    <span class="n">index_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">index_data_list</span><span class="p">)</span>
                    <span class="n">flattened_array</span> <span class="o">=</span> <span class="n">index_data_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    
                    <span class="c1"># Append the flattened array for this year to yearly_data</span>
                    <span class="n">yearly_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flattened_array</span><span class="p">)</span>
                
                <span class="c1"># Convert the list of yearly arrays into a 2D NumPy array: (num_years, data_points_per_year)</span>
                <span class="n">sst_yearly_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yearly_data</span><span class="p">)</span>
                
                <span class="c1"># Adjust the list of years to match the length of data we have</span>
                <span class="n">years_complete</span> <span class="o">=</span> <span class="n">unique_years</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">sst_yearly_flat</span><span class="p">)]</span>
                
                <span class="c1"># Handle missing values by filtering out rows (years) that contain NaNs</span>
                <span class="n">valid_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sst_yearly_flat</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sst_yearly_flat</span> <span class="o">=</span> <span class="n">sst_yearly_flat</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
                <span class="n">years_complete</span> <span class="o">=</span> <span class="n">years_complete</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
                
                <span class="c1"># Final scaled data (modify this part as needed if you plan on applying a scaler)</span>
                <span class="n">sst_scaled</span> <span class="o">=</span> <span class="n">sst_yearly_flat</span>
                
                <span class="c1"># Define SOM parameters</span>
                <span class="c1"># n = int(np.sqrt(5*np.sqrt(sst_scaled.shape[1]))) - 2</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}:</span>
                    <span class="n">som_grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># 10x10 grid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">som_grid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span>
                
                <span class="n">input_len</span> <span class="o">=</span> <span class="n">sst_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Number of features per year (12 * lat * lon)</span>
                <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_learning_rate</span>
                <span class="n">neighborhood_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_neighborhood_function</span>
                <span class="n">some_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_sigma</span>
                
                <span class="c1"># Initialize the SOM</span>
                <span class="n">som</span> <span class="o">=</span> <span class="n">MiniSom</span><span class="p">(</span>
                             <span class="n">x</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                             <span class="n">y</span><span class="o">=</span><span class="n">som_grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                             <span class="n">input_len</span><span class="o">=</span><span class="n">input_len</span><span class="p">,</span> 
                             <span class="n">sigma</span><span class="o">=</span><span class="n">some_sigma</span><span class="p">,</span> 
                             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> 
                             <span class="n">neighborhood_function</span><span class="o">=</span><span class="n">neighborhood_function</span><span class="p">,</span> 
                             <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span>
                             <span class="p">)</span>
                
                <span class="c1"># Initialize the weights</span>
                <span class="n">som</span><span class="o">.</span><span class="n">random_weights_init</span><span class="p">(</span><span class="n">sst_scaled</span><span class="p">)</span>
                
                <span class="c1"># print(&quot;Training SOM...&quot;)</span>
                <span class="c1"># Train the SOM with 1000 iterations (adjust as needed)</span>
                <span class="n">som</span><span class="o">.</span><span class="n">train_random</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sst_scaled</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
                <span class="c1"># print(&quot;SOM training completed.&quot;)</span>
                <span class="c1"># Map each year to its Best Matching Unit (BMU)</span>
                <span class="n">bmu_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">som</span><span class="o">.</span><span class="n">winner</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sst_scaled</span><span class="p">])</span>
                <span class="n">bmu_x</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">bmu_y</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># Create a DataFrame for easy plotting</span>
                <span class="n">bmu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years_complete</span><span class="p">,</span>
                    <span class="s1">&#39;BMU_X&#39;</span><span class="p">:</span> <span class="n">bmu_x</span><span class="p">,</span>
                    <span class="s1">&#39;BMU_Y&#39;</span><span class="p">:</span> <span class="n">bmu_y</span>
                <span class="p">})</span>
                            
                <span class="c1"># Check if the reference year is in the dataset</span>
                <span class="k">if</span> <span class="n">reference_year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">years_complete</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> is not present in the dataset.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find the index of the reference year</span>
                    <span class="n">ref_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">years_complete</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="c1"># Get the BMU of the reference year</span>
                    <span class="n">ref_bmu</span> <span class="o">=</span> <span class="n">bmu_indices</span><span class="p">[</span><span class="n">ref_index</span><span class="p">]</span>
                
                    
                    <span class="c1"># Find all years mapped to the same BMU</span>
                    <span class="n">similar_years</span> <span class="o">=</span> <span class="n">years_complete</span><span class="p">[(</span><span class="n">bmu_x</span> <span class="o">==</span> <span class="n">ref_bmu</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bmu_y</span> <span class="o">==</span> <span class="n">ref_bmu</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                    <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years</span><span class="p">[</span><span class="n">similar_years</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
                    <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
                
                <span class="c1"># -------------------- 6a. Parallel Data Preparation with Dask -------------------- #</span>
                <span class="n">dddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># Convert Xarray DataArray to Dask Array</span>
                <span class="c1"># Adjust chunk sizes based on HPC resources and data dimensions</span>
                <span class="n">sst_dask</span> <span class="o">=</span> <span class="n">dddd</span><span class="c1">#.chunk({&#39;T&#39;: 12, &#39;Y&#39;: 100, &#39;X&#39;: 100})  # Assuming 12 months per year</span>
                
                <span class="c1"># Extract years</span>
                <span class="n">unique_years_dask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictant</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
                            
                <span class="c1"># Flatten spatial dimensions and prepare data for SOM</span>
                <span class="n">yearly_data_dask</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">unique_years_dask</span><span class="p">:</span>
                    <span class="n">yearly_sst</span> <span class="o">=</span> <span class="n">sst_dask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
                    
                    <span class="c1"># Check for complete 12 months</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yearly_sst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
                        <span class="n">monthly_flat</span> <span class="o">=</span> <span class="n">yearly_sst</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">yearly_flat</span> <span class="o">=</span> <span class="n">monthly_flat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="n">yearly_data_dask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yearly_flat</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> is incomplete and will be skipped.&quot;</span><span class="p">)</span>
                
                <span class="c1"># Convert to NumPy array</span>
                <span class="n">sst_yearly_flat_dask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yearly_data_dask</span><span class="p">)</span>
                <span class="n">years_complete_dask</span> <span class="o">=</span> <span class="n">unique_years_dask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">sst_yearly_flat_dask</span><span class="p">)]</span>
                
                
                <span class="c1"># Handle missing values by removing any years with NaNs</span>
                <span class="n">valid_idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sst_yearly_flat_dask</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">sst_yearly_flat_dask</span> <span class="o">=</span> <span class="n">sst_yearly_flat_dask</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
                <span class="n">years_complete_dask</span> <span class="o">=</span> <span class="n">years_complete_dask</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
                <span class="n">sst_scaled_dask</span> <span class="o">=</span> <span class="n">sst_yearly_flat_dask</span> 
                
                <span class="c1"># Initialize SOMoclu</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="kc">None</span><span class="p">}:</span>
                    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_columns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 10x10 grid</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">some_grid_size</span>
                
                <span class="n">somoclu_instance</span> <span class="o">=</span> <span class="n">somoclu</span><span class="o">.</span><span class="n">Somoclu</span><span class="p">(</span><span class="n">n_columns</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sst_scaled_dask</span><span class="p">)</span>
                
                <span class="c1"># Train SOM</span>
                <span class="n">somoclu_instance</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
                
                <span class="c1"># Get BMUs</span>
                <span class="n">bmus</span> <span class="o">=</span> <span class="n">somoclu_instance</span><span class="o">.</span><span class="n">bmus</span>  <span class="c1"># Shape: (num_samples, 2)</span>
                
                <span class="c1"># Map BMUs to years</span>
                <span class="n">bmu_x_dask</span> <span class="o">=</span> <span class="n">bmus</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">bmu_y_dask</span> <span class="o">=</span> <span class="n">bmus</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># Create DataFrame</span>
                <span class="n">bmu_df_dask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                    <span class="s1">&#39;Year&#39;</span><span class="p">:</span> <span class="n">years_complete_dask</span><span class="p">,</span>
                    <span class="s1">&#39;BMU_X&#39;</span><span class="p">:</span> <span class="n">bmu_x_dask</span><span class="p">,</span>
                    <span class="s1">&#39;BMU_Y&#39;</span><span class="p">:</span> <span class="n">bmu_y_dask</span>
                <span class="p">})</span>
                           
                <span class="c1"># Identify similar years </span>
                <span class="k">if</span> <span class="n">reference_year</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference year </span><span class="si">{</span><span class="n">reference_year</span><span class="si">}</span><span class="s2"> is not present in the dataset.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ref_bmu_dask</span> <span class="o">=</span> <span class="n">bmu_df_dask</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">reference_year</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;BMU_X&#39;</span><span class="p">,</span> <span class="s1">&#39;BMU_Y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">similar_years_dask</span> <span class="o">=</span> <span class="n">bmu_df_dask</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;BMU_X&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_bmu_dask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> 
                        <span class="p">(</span><span class="n">bmu_df_dask</span><span class="p">[</span><span class="s1">&#39;BMU_Y&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_bmu_dask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">][</span><span class="s1">&#39;Year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>            
                <span class="n">similar_years</span> <span class="o">=</span> <span class="n">similar_years_dask</span><span class="p">[</span><span class="n">similar_years_dask</span> <span class="o">!=</span> <span class="n">reference_year</span><span class="p">]</span>    
                
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;cor_based&quot;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
                <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
                
            <span class="n">sst_ireference_year</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
            <span class="n">sim_tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">[</span><span class="n">unique_years</span><span class="o">!=</span><span class="n">reference_year</span><span class="p">]:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_ireference_year</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_ireference_year</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                <span class="n">sim_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_tmp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">[</span><span class="n">unique_years</span><span class="o">!=</span><span class="n">reference_year</span><span class="p">])</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">similar</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Select the first 3 entries</span>
            <span class="n">top_3</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_3</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span> <span class="o">==</span> <span class="s2">&quot;pca_based&quot;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
                <span class="n">ddd</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>

            <span class="n">predictor_</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">predictor_detrend</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">predictor_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ddd</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">predictor_detrend</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">predictor_</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">predictor_</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">eof</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">eof</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">eof</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span>
            <span class="n">sst_ref</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
            <span class="n">sst_ref</span> <span class="o">=</span> <span class="n">sst_ref</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
            
            <span class="n">sim_tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_years</span><span class="p">[</span><span class="n">unique_years</span><span class="o">!=</span><span class="n">reference_year</span><span class="p">]:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">score</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">))</span>
                <span class="n">sst_ref</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
                <span class="n">correlation</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sst_ref</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">)</span>
                <span class="c1"># print(correlation)</span>
                <span class="n">sim_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_tmp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">unique_years</span><span class="p">[</span><span class="n">unique_years</span><span class="o">!=</span><span class="n">reference_year</span><span class="p">])</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">similar</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Select the first 3 entries</span>
            <span class="n">top_3</span> <span class="o">=</span> <span class="n">similar</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">similar_years</span> <span class="o">=</span> <span class="n">top_3</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid analog method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method_analog</span><span class="si">}</span><span class="s2">. Choose &#39;som&#39;, &#39;pca_based&#39;, or &#39;cor_based&#39;.&quot;</span><span class="p">)</span>
          
        <span class="n">sim_obs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similar_years</span><span class="p">]):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">sim_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_obs</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]})</span>

        <span class="n">T_value_1</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Get the datetime64 value from da1</span>
        <span class="n">month_1</span> <span class="o">=</span> <span class="n">T_value_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[M]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Extract month</span>
        <span class="n">new_T_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forecast_year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month_1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">forecast_det</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="n">new_T_value</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]))</span>
        <span class="n">forecast_det</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_det</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

        <span class="c1"># We&#39;ll pass these thresholds to the methods</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            
            <span class="c1"># Degrees of freedom (only used by &#39;t&#39; methids)</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="c1"># kwargs={&#39;dof&#39;: dof},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_normal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_lognormal</span>
            <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">error_samples</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">})</span>
            <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">. Choose &#39;t&#39;, &#39;gamma&#39;, &#39;normal&#39;, &#39;lognormal&#39;, or &#39;nonparam&#39;.&quot;</span><span class="p">)</span>        
        
        <span class="c1"># forecast_prob = xr.apply_ufunc(</span>
        <span class="c1">#     self.calculate_tercile_probabilities,</span>
        <span class="c1">#     forecast_det,</span>
        <span class="c1">#     error_variance,</span>
        <span class="c1">#     terciles.isel(quantile=0).drop_vars(&#39;quantile&#39;),</span>
        <span class="c1">#     terciles.isel(quantile=1).drop_vars(&#39;quantile&#39;),</span>
        <span class="c1">#     input_core_dims=[(&#39;T&#39;,), (), (), ()],</span>
        <span class="c1">#     vectorize=True,</span>
        <span class="c1">#     kwargs={&#39;dof&#39;: dof},</span>
        <span class="c1">#     dask=&#39;parallelized&#39;,</span>
        <span class="c1">#     output_core_dims=[(&#39;probability&#39;, &#39;T&#39;)],</span>
        <span class="c1">#     output_dtypes=[&#39;float&#39;],</span>
        <span class="c1">#     dask_gufunc_kwargs={&#39;output_sizes&#39;: {&#39;probability&#39;: 3}},</span>
        <span class="c1"># )</span>
        
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        
        <span class="c1"># Unset environment variables</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  
        
        <span class="k">return</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_Analog.composite_plot">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.composite_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">composite_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">plot_predictor</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create composite plots of predictors or predictands.</span>

<span class="sd">        Plots SST composites for the forecast year and similar years, or precipitation ratios relative to climatology.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictant : xarray.DataArray</span>
<span class="sd">            Observed predictand data with dimensions (T, Y, X).</span>
<span class="sd">        clim_year_start : int or str</span>
<span class="sd">            Start year for climatology period.</span>
<span class="sd">        clim_year_end : int or str</span>
<span class="sd">            End year for climatology period.</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic hindcast data with dimensions (T, Y, X).</span>
<span class="sd">        plot_predictor : bool, optional</span>
<span class="sd">            If True, plot SST predictors; otherwise, plot precipitation ratios. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        similar_years : np.ndarray</span>
<span class="sd">            Array of similar years used in the composite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        
        <span class="n">ddd</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">,</span> <span class="n">result_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="mi">1984</span><span class="p">)</span>
        <span class="n">result_</span> <span class="o">=</span> <span class="n">result_</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
         
        <span class="n">reference_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ddd</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">))</span>
        
        <span class="n">sim_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">reference_year</span><span class="p">))</span>
        <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>  
        <span class="n">sim_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        
        <span class="n">sim_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pred_rain</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">similar_years</span><span class="p">]):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">ddd</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>
            <span class="n">sim_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="n">tmmp</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">predictant</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">clim_mean</span>
            <span class="n">pred_rain</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmmp</span><span class="p">)</span>
                 
        <span class="n">sim__</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> 
        <span class="n">sim_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim__</span><span class="p">)</span>
        <span class="n">sim_all</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sim_all</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;forecast year&#39;</span><span class="p">,</span><span class="s1">&#39;composite analog&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">define_extent</span>
            <span class="n">sim_all</span> <span class="o">=</span> <span class="n">sim_all</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sim_all</span> <span class="o">=</span> <span class="n">sim_all</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">))</span>
        <span class="n">pred_rain</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pred_rain</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_predictor</span><span class="p">:</span>
            
            <span class="n">sim_all</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>
                         <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> 
                         <span class="n">row</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> 
                         <span class="n">col</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
                         <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>  <span class="c1"># Adjust size for better readability</span>
                         <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span>
                         <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># Adjust shrink value for a smaller color bar</span>
                         <span class="s2">&quot;aspect&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>  <span class="c1"># Change aspect ratio for a wider color bar</span>
                         <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># Adjust space between plot and color bar</span>
                         <span class="p">},</span>
                         <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Optional: ignores outliers for better contrast</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># # Define the custom colormap</span>
            <span class="c1"># colors_list = [&quot;red&quot;, &quot;grey&quot;, &quot;blue&quot;]  # Define color segments</span>
            <span class="c1"># bounds = [0, 80, 120, 200]  # Define boundaries for the categories</span>
            <span class="c1"># cmap = ListedColormap(colors_list)</span>
            <span class="c1"># norm = BoundaryNorm(bounds, cmap.N)</span>
            
            <span class="c1"># # Assuming &#39;dataset&#39; contains your data</span>
            <span class="c1"># data_var = pred_rain.isel()#dataset[&quot;Precipitation_Flux&quot;]</span>
            
            <span class="c1"># # Number of time steps</span>
            <span class="c1"># n_times = len(data_var[&#39;T&#39;])</span>
            <span class="c1"># n_cols = 3  # Number of columns</span>
            <span class="c1"># n_rows = (n_times + n_cols - 1) // n_cols  # Calculate rows dynamically</span>
            
            <span class="c1"># fig, axes = plt.subplots(</span>
            <span class="c1">#     n_rows, n_cols, </span>
            <span class="c1">#     figsize=(n_cols * 6, n_rows * 4), </span>
            <span class="c1">#     subplot_kw={&#39;projection&#39;: ccrs.PlateCarree()}</span>
            <span class="c1"># )</span>
            
            <span class="c1"># axes = axes.flatten()</span>
            
            <span class="c1"># # Loop through time steps and plot</span>
            <span class="c1"># for i, t in enumerate(data_var[&#39;T&#39;].values):</span>
            <span class="c1">#     ax = axes[i]</span>
            <span class="c1">#     data = data_var.sel(T=t).squeeze()  # Select data for the current time step</span>
                
            <span class="c1">#     im = ax.pcolormesh(</span>
            <span class="c1">#         data[&#39;X&#39;], data[&#39;Y&#39;], data, cmap=cmap, norm=norm, </span>
            <span class="c1">#         transform=ccrs.PlateCarree()</span>
            <span class="c1">#     )</span>
            
            <span class="c1">#     ax.coastlines()</span>
            <span class="c1">#     ax.add_feature(cfeature.LAND, edgecolor=&quot;black&quot;)</span>
            <span class="c1">#     ax.add_feature(cfeature.OCEAN, facecolor=&quot;lightblue&quot;)</span>
            <span class="c1">#     ax.set_title(f&quot;Time: {str(t)[:10]}&quot;)  # Format time as title</span>
            
            <span class="c1"># # Remove unused axes</span>
            <span class="c1"># for j in range(n_times, len(axes)):</span>
            <span class="c1">#     fig.delaxes(axes[j])</span>
            
            <span class="c1"># # Add colorbar outside the plot</span>
            <span class="c1"># cbar_ax = fig.add_axes([0.92, 0.15, 0.02, 0.7])  # [left, bottom, width, height]</span>
            <span class="c1"># cbar = fig.colorbar(im, cax=cbar_ax, orientation=&quot;vertical&quot;)</span>
            <span class="c1"># cbar.set_label(&#39;Ratio to Normal [%]&#39;)</span>
            <span class="c1"># cbar.set_ticks([40, 100, 160])  # Set ticks at middle of each range</span>
            <span class="c1"># cbar.ax.set_yticklabels([&#39;0-80 (Red)&#39;, &#39;80-120 (Grey)&#39;, &#39;&gt;120 (Blue)&#39;])  # Custom labels for each range</span>
            
            <span class="c1"># fig.suptitle(&quot;Ratio to Normal Precipitation&quot;, fontsize=16)</span>
            <span class="c1"># plt.tight_layout(rect=[0, 0, 0.9, 1])  # Leave space for colorbar</span>
            <span class="c1"># plt.show()</span>

            <span class="c1"># Define the custom colormap</span>
            <span class="n">colors_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#d7191c&#39;</span><span class="p">,</span><span class="s1">&#39;#fdae61&#39;</span><span class="p">,</span><span class="s1">&#39;#ffffbf&#39;</span><span class="p">,</span> <span class="s1">&#39;#a6d96a&#39;</span><span class="p">,</span> <span class="s1">&#39;#1a9641&#39;</span><span class="p">]</span>  <span class="c1"># Define color segments </span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>  <span class="c1"># Define boundaries for the categories</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors_list</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
            
            <span class="c1">#---------- Better way to mask using rainfall mean after----------------</span>
            <span class="n">data_var</span> <span class="o">=</span> <span class="n">pred_rain</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="mf">19.5</span><span class="p">))</span>
            
            <span class="c1"># Number of time steps</span>
            <span class="n">n_times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">])</span>
            <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Number of columns</span>
            <span class="n">n_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_times</span> <span class="o">+</span> <span class="n">n_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">n_cols</span>  <span class="c1"># Calculate rows dynamically</span>
            
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> 
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> 
                <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()}</span>
            <span class="p">)</span>
            
            <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            
            <span class="c1"># Loop through time steps and plot</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_var</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data_var</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Select data for the current time step</span>
                
                <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> 
                    <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="p">)</span>
            
                <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Season: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Format time as title</span>
            
            <span class="c1"># Remove unused axes</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_times</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            
            <span class="c1"># Add colorbar and adjust layout</span>

            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[:</span><span class="n">n_times</span><span class="p">],</span>
                                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> 
                                <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                <span class="c1"># shrink=0.5, </span>
                                <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                                <span class="c1"># aspect=40</span>
                               <span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>  <span class="c1"># Set ticks at middle of each range</span>
            <span class="c1"># cbar.ax.set_xticklabels([&#39;0&#39;,&#39;0-90 (Dry)&#39;, &#39;90&#39;,&#39;(Normal)&#39;,&#39;110&#39;, &#39;&gt;110 (Excess)&#39;,&#39;200&#39;])  # Custom labels for each range</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">,</span> <span class="s1">&#39;90&#39;</span><span class="p">,</span><span class="s1">&#39;110&#39;</span><span class="p">,</span> <span class="s1">&#39;150&#39;</span><span class="p">,</span><span class="s1">&#39;200&#39;</span><span class="p">])</span>  <span class="c1"># Custom labels for each range</span>
            
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Ratio to Normal Precipitation [%]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 

        <span class="k">return</span> <span class="n">similar_years</span></div>


<div class="viewcode-block" id="WAS_Analog.plot_indices">
<a class="viewcode-back" href="../../api.html#wass2s.was_analog.WAS_Analog.plot_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_indices</span><span class="p">():</span>
        <span class="k">pass</span></div>
</div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>