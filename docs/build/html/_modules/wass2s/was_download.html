

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_download &mdash; wass2s 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">wass2s.was_download</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_download</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_download</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cdsapi</span>
<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">month_abbr</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">import</span> <span class="nn">cdsapi</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>
<span class="kn">import</span> <span class="nn">h5netcdf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">wass2s.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rioxr</span>

<span class="c1"># Suppress warnings</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;cdsapi&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<div class="viewcode-block" id="WAS_Download">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_Download</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the WAS_Download class.&quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="WAS_Download.ModelsName">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.ModelsName">[docs]</a>
    <span class="k">def</span> <span class="nf">ModelsName</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">centre</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;ecmwf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Jan to Mar</span>
            <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Apr to __ </span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CMCC_3&quot;: &quot;cmcc&quot;,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;ncep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;jma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CFSV2&quot;: &quot;CFS&quot;,</span>
            <span class="c1"># &quot;CMC1&quot;: &quot;cmc1&quot;,</span>
            <span class="c1"># &quot;CMC2&quot;: &quot;cmc2&quot;,</span>
            <span class="c1"># &quot;GFDL&quot;: &quot;gfdl&quot;,</span>
            <span class="c1"># &quot;NASA&quot;: &quot;nasa&quot;,</span>
            <span class="c1"># &quot;NCAR_CCSM4&quot;: &quot;ncar&quot;,</span>
            <span class="c1"># &quot;NMME&quot; : &quot;nmme&quot;</span>
            <span class="s2">&quot;CFSV2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cfsv2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC1_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cmc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cmc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GFDL_1&quot;</span><span class="p">:</span> <span class="s2">&quot;gfdl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NASA_1&quot;</span><span class="p">:</span> <span class="s2">&quot;nasa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCAR_CCSM4_1&quot;</span><span class="p">:</span> <span class="s2">&quot;ncar_ccsm4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NMME_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;nmme&quot;</span>
        <span class="p">},</span>
        <span class="n">variables_1</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">variables_2</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a combined dictionary of model names and variables. </span>
<span class="sd">        For more information on C3S, browse the `MetaData &lt;https://confluence.ecmwf.int/display/CKB/Description+of+the+C3S+seasonal+multi-system&gt;`_.</span>
<span class="sd">        For more information on NMME, browse the `MetaData &lt;https://confluence.ecmwf.int/display/CKB/Description+of+the+C3S+seasonal+multi-system&gt;`_.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            centre (dict): Mapping of model identifiers to model names.</span>
<span class="sd">            variables_1 (dict): Mapping of variable short names to full names for category 1.</span>
<span class="sd">            variables_2 (dict): Mapping of variable short names to full names for category 2.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A combined dictionary with keys as model.variable combinations and values as tuples (model name, variable name).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combined_dict1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centre</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_1</span>
        <span class="p">}</span>
        <span class="n">combined_dict2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centre</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_2</span>
        <span class="p">}</span>
        <span class="n">combined_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">combined_dict1</span><span class="p">,</span> <span class="o">**</span><span class="n">combined_dict2</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">combined_dict</span></div>


<div class="viewcode-block" id="WAS_Download.ReanalysisName">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.ReanalysisName">[docs]</a>
    <span class="k">def</span> <span class="nf">ReanalysisName</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">centre</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ERA5&quot;</span><span class="p">:</span> <span class="s2">&quot;reanalysis ERA5&quot;</span><span class="p">,</span> <span class="s2">&quot;NOAA&quot;</span><span class="p">:</span> <span class="s2">&quot;NOAA ERSST&quot;</span><span class="p">},</span>
        <span class="n">variables_1</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">variables_2</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a combined dictionary of reanalysis names and variables.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            centre (dict): Mapping of reanalysis identifiers to reanalysis names.</span>
<span class="sd">            variables_1 (dict): Mapping of variable short names to full names for category 1.</span>
<span class="sd">            variables_2 (dict): Mapping of variable short names to full names for category 2.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A combined dictionary with keys as reanalysis.variable combinations and values as tuples (reanalysis name, variable name).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combined_dict1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centre</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_1</span>
        <span class="p">}</span>
        <span class="n">combined_dict2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">centre</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centre</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_2</span>
        <span class="p">}</span>
        <span class="n">combined_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">combined_dict1</span><span class="p">,</span> <span class="o">**</span><span class="n">combined_dict2</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">combined_dict</span></div>


<div class="viewcode-block" id="WAS_Download.AgroObsName">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.AgroObsName">[docs]</a>
    <span class="k">def</span> <span class="nf">AgroObsName</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variables</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;precipitation_flux&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_maximum&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_mean&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_minimum&quot;</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a dictionary for agro-meteorological observation variables.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            variables (dict): Mapping of agro variable short names to full names.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary mapping agro variables to their corresponding full names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">variables</span></div>


<div class="viewcode-block" id="WAS_Download.WAS_Download_AgroIndicators_">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_AgroIndicators_">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_AgroIndicators_</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">seas</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">],</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download agro-meteorological indicators for specified variables, years, and months.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            dir_to_save (str): Directory to save the downloaded files.</span>
<span class="sd">            variables (list): List of shorthand variables to download (e.g., [&quot;AGRO.PRCP&quot;, &quot;AGRO.TMAX&quot;]).</span>
<span class="sd">            year_start (int): Start year for the data to download.</span>
<span class="sd">            year_end (int): End year for the data to download.</span>
<span class="sd">            area (list): Bounding box as [North, West, South, East] for clipping.</span>
<span class="sd">            seas (list): List of month strings representing the season (e.g., [&quot;01&quot;, &quot;02&quot;, &quot;03&quot;]- for JanFebMar).</span>
<span class="sd">            force_download (bool): If True, forces download even if file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1_1&quot;</span>
        <span class="n">variable_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;precipitation_flux&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_maximum&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_mean&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_minimum&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">seas</span><span class="p">]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable_mapping</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown variable: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cds_variable</span><span class="p">,</span> <span class="n">statistic</span> <span class="o">=</span> <span class="n">variable_mapping</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>            
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;sis-agrometeorological-indicators&quot;</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">cds_variable</span><span class="p">,</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">statistic</span><span class="p">:</span>
                        <span class="n">request</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">statistic</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">statistic</span><span class="si">}</span><span class="s2">) data for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> and season </span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">zip_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">statistic</span><span class="si">}</span><span class="s2">) data for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">netcdf_file_name</span> <span class="ow">in</span> <span class="n">zip_ref</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">zip_ref</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">netcdf_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                                <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                                
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted ZIP file: </span><span class="si">{</span><span class="n">zip_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">]:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1"># output_path = dir_to_save / f&quot;Obs_{var.split(&#39;.&#39;)[1]}_{year_start}_{year_end}_{season}.nc&quot;</span>
                <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File downloaded and combined dataset for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> is saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Download.WAS_Download_Reanalysis_">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_Reanalysis_">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_Reanalysis_</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">center_variable</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">seas</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">],</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download reanalysis data for specified center-variable combinations, years, and months.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            dir_to_save (str): Directory to save the downloaded files.</span>
<span class="sd">            center_variable (list): List of center-variable identifiers (e.g., [&quot;ERA5.PRCP&quot;, &quot;MERRA2.TEMP&quot;]).</span>
<span class="sd">            year_start (int): Start year for the data to download.</span>
<span class="sd">            year_end (int): End year for the data to download.</span>
<span class="sd">            area (list): Bounding box as [North, West, South, East] for clipping.</span>
<span class="sd">            seas (list): List of month strings representing the season (e.g., [&quot;01&quot;, &quot;02&quot;, &quot;03&quot;] for JanFebMar).</span>
<span class="sd">            force_download (bool): If True, forces download even if file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
        <span class="n">centre</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ERA5&quot;</span><span class="p">:</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="s2">&quot;MERRA2&quot;</span><span class="p">:</span> <span class="s2">&quot;MERRA2&quot;</span><span class="p">}</span>
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">variables_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">selected_centre</span> <span class="o">=</span> <span class="p">[</span><span class="n">centre</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span>
        <span class="n">selected_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">seas</span><span class="p">]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">months</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">cent</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_centre</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">):</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                            <span class="n">press_level</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-pressure-levels-monthly-means&quot;</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="s2">&quot;pressure_level&quot;</span><span class="p">:</span> <span class="n">press_level</span><span class="p">,</span>
                                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;download_format&quot;</span><span class="p">:</span> <span class="s2">&quot;unarchived&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-single-levels-monthly-means&quot;</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;download_format&quot;</span><span class="p">:</span> <span class="s2">&quot;unarchived&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> for year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download data for </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> in year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span> <span class="c1">#ds = xr.open_dataset(file_path)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">,</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">,</span> <span class="s2">&quot;UGRD10&quot;</span><span class="p">,</span> <span class="s2">&quot;VGRD10&quot;</span><span class="p">]:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;expver&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure_level&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="c1"># ds = ds.assign_coords(valid_time=pd.to_datetime(ds.valid_time.astype(str), format=&#39;%Y%m%d&#39;))</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">valid_time</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">valid_time</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;expver&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="c1"># ds = ds.assign_coords(valid_time=pd.to_datetime(ds.valid_time.astype(str), format=&#39;%Y%m%d&#39;))</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">valid_time</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">valid_time</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted yearly file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
                <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                        <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                        <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                        <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                        <span class="n">combined_ds</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                        <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                    <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished, combined dataset for </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># def download_nmme_txt_with_progress(self, url, file_path, chunk_size=1024):</span>
    <span class="c1">#     file_path = Path(file_path)</span>
    <span class="c1">#     response = requests.get(url, stream=True)</span>
    <span class="c1">#     total_size = int(response.headers.get(&#39;content-length&#39;, 0))</span>
        
    <span class="c1">#     with open(file_path, &quot;wb&quot;) as f, tqdm(</span>
    <span class="c1">#         total=total_size, unit=&quot;B&quot;, unit_scale=True, desc=file_path.name</span>
    <span class="c1">#     ) as progress:</span>
    <span class="c1">#         for data in response.iter_content(chunk_size):</span>
    <span class="c1">#             progress.update(len(data))</span>
    <span class="c1">#             f.write(data)</span>

<div class="viewcode-block" id="WAS_Download.download_nmme_txt_with_progress">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.download_nmme_txt_with_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">download_nmme_txt_with_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>   
        <span class="c1"># Check if the URL exists using a HEAD request</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">head</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL returned status code </span><span class="si">{</span><span class="n">head</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">. Skipping download.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking URL: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Skipping download.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">):</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="WAS_Download.days_in_month">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.days_in_month">[docs]</a>
    <span class="k">def</span> <span class="nf">days_in_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">a</span></div>

         
<div class="viewcode-block" id="WAS_Download.parse_cpt_data_optimized">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.parse_cpt_data_optimized">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_cpt_data_optimized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
        
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">times_start</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lons</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">days_in_month_values</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1"># Read all lines into memory once</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cpt:field&#39;</span><span class="p">):</span>
                <span class="c1"># Parse metadata (e.g., time)</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cpt:&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;cpt:T=&#39;</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">t_str</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cpt:T=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">year</span><span class="p">,</span> <span class="n">pot_months</span> <span class="o">=</span> <span class="n">t_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">pot_months</span><span class="p">:</span>
                            <span class="n">start_str</span><span class="p">,</span> <span class="n">end_str</span> <span class="o">=</span> <span class="n">pot_months</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                            <span class="n">start_month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_str</span><span class="p">)</span>
                            <span class="n">end_month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_str</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">start_month</span> <span class="o">&lt;=</span> <span class="n">end_month</span><span class="p">:</span>
                                <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_month</span><span class="p">,</span> <span class="n">end_month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Wrap around: from start_month to December, then January to end_month</span>
                                <span class="n">months</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_month</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">end_month</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                            <span class="n">month</span> <span class="o">=</span> <span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">days_in_mon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">months</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">months</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">month</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pot_months</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">days_in_mon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="n">month</span><span class="p">)</span>
                        
                        <span class="n">days_in_month_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">days_in_mon</span><span class="p">)</span>
                        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
                        
                        <span class="c1">#### Retrieve init start</span>
                        <span class="n">start_str</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;cpt:S=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">yearstart</span><span class="p">,</span> <span class="n">monthstart</span><span class="p">,</span> <span class="n">daystart</span> <span class="o">=</span> <span class="n">start_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="n">times_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">yearstart</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">monthstart</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Parse longitudes (assumed to be the next line)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="n">lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># Read the next 181 lines as a data block</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">181</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="c1"># Join the 181 lines into a single string</span>
                    <span class="n">data_block</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">181</span><span class="p">])</span>
                    <span class="c1"># Parse the block into a 2D array using np.loadtxt</span>
                    <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data_block</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">361</span><span class="p">:</span>  <span class="c1"># 1 latitude + 360 longitudes</span>
                        <span class="c1"># Extract latitudes only once (assuming they’re consistent)</span>
                        <span class="k">if</span> <span class="n">lats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">lats</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># Extract data (excluding latitude column)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
                        <span class="c1"># Replace missing values (e.g., -999.0) with NaN</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">181</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected number of columns in data block&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                

        <span class="c1"># Stack data into a 3D array (time, latitude, longitude)</span>
        <span class="n">data_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
        <span class="c1"># Create an xarray DataArray for convenient analysis</span>
        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data_3d</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">],</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
                <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="p">,</span>
                <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">lons</span>
            <span class="p">},</span>
            <span class="c1"># attrs={</span>
            <span class="c1">#     &#39;units&#39;: &#39;mm/day&#39;,</span>
            <span class="c1">#     &#39;long_name&#39;: &#39;precipitation&#39;</span>
            <span class="c1"># }</span>
        <span class="p">)</span>

        <span class="n">days_in_month_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">days_in_month_values</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">da</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]}</span>
        <span class="p">)</span> 
        <span class="k">return</span> <span class="n">da</span><span class="p">,</span> <span class="n">days_in_month_da</span><span class="p">,</span> <span class="n">times_start</span></div>

    
<div class="viewcode-block" id="WAS_Download.WAS_Download_Models">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_Models">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_Models</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">center_variable</span><span class="p">,</span>
        <span class="n">month_of_initialization</span><span class="p">,</span>
        <span class="n">lead_time</span><span class="p">,</span>
        <span class="n">year_start_hindcast</span><span class="p">,</span>
        <span class="n">year_end_hindcast</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download seasonal forecast model data for specified center-variable combinations, initialization month, lead times, and years.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            dir_to_save (str): Directory to save the downloaded files.</span>
<span class="sd">            center_variable (list): List of center-variable identifiers (e.g., [&quot;ECMWF_51.PRCP&quot;, &quot;UKMO_602.TEMP&quot;]).</span>
<span class="sd">            month_of_initialization (int): Initialization month as an integer (1-12).</span>
<span class="sd">            lead_time (list): List of lead times in months.</span>
<span class="sd">            year_start_hindcast (int): Start year for hindcast data.</span>
<span class="sd">            year_end_hindcast (int): End year for hindcast data.</span>
<span class="sd">            area (list): Bounding box as [North, West, South, East] for clipping.</span>
<span class="sd">            year_forecast (int, optional): Forecast year if downloading forecast data. Defaults to None.</span>
<span class="sd">            ensemble mean (str,optional): it&#39;s can be median, mean or None. Defaults to None. </span>
<span class="sd">            force_download (bool): If True, forces download even if file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">years</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start_hindcast</span><span class="p">,</span> <span class="n">year_end_hindcast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>

        <span class="n">centre</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;ecmwf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Apr to __</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Jan to Mar</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Jan to Mar</span>
            <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Apr to __ </span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CMCC_3&quot;: &quot;cmcc&quot;,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;ncep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;jma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CFSV2&quot;: &quot;cfsv2&quot;,</span>
            <span class="c1"># &quot;CMC1&quot;: &quot;cmc1&quot;,</span>
            <span class="c1"># &quot;CMC2&quot;: &quot;cmc2&quot;,</span>
            <span class="c1"># &quot;GFDL&quot;: &quot;gfdl&quot;,</span>
            <span class="c1"># &quot;NASA&quot;: &quot;nasa&quot;,</span>
            <span class="c1"># &quot;NCAR_CCSM4&quot;: &quot;ncar_ccsm4&quot;,</span>
            <span class="c1"># &quot;NMME&quot; : &quot;nmme&quot;</span>
            <span class="s2">&quot;CFSV2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cfsv2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC1_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cmc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;cmc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GFDL_1&quot;</span><span class="p">:</span> <span class="s2">&quot;gfdl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NASA_1&quot;</span><span class="p">:</span> <span class="s2">&quot;nasa&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCAR_CCSM4_1&quot;</span><span class="p">:</span> <span class="s2">&quot;ncar_ccsm4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NMME_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;nmme&quot;</span>
        <span class="p">}</span>

        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">variables_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">system</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;51&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;604&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;603&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;DWD_2&quot;: &quot;2&quot;,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;35&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CMCC_3&quot;: &quot;3&quot;,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CFSV2&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;CMC1&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;CMC2&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;GFDL&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;NASA&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;NCAR_CCSM4&quot;: &quot;1&quot;,</span>
            <span class="c1"># &quot;NMME&quot; : &quot;1&quot;</span>
            <span class="s2">&quot;CFSV2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC1_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CMC2_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GFDL_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NASA_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NCAR_CCSM4_1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NMME_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span>

        <span class="p">}</span>
        
        <span class="n">nmme</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cfsv2&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc1&quot;</span><span class="p">,</span> <span class="s2">&quot;cmc2&quot;</span><span class="p">,</span> <span class="s2">&quot;gfdl&quot;</span><span class="p">,</span>  <span class="s2">&quot;nasa&quot;</span><span class="p">,</span> <span class="s2">&quot;ncar_ccsm4&quot;</span><span class="p">,</span> <span class="s2">&quot;nmme&quot;</span><span class="p">]</span>
        
        <span class="n">selected_centre</span> <span class="o">=</span> <span class="p">[</span><span class="n">centre</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span>
        <span class="n">selected_system</span> <span class="o">=</span> <span class="p">[</span><span class="n">system</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">center</span><span class="p">]</span>
        <span class="n">selected_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">]</span>

        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[((</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">]</span>
        <span class="n">season</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>
        
        
        <span class="n">store_file_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cent</span><span class="p">,</span> <span class="n">syst</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_centre</span><span class="p">,</span> <span class="n">selected_system</span><span class="p">,</span> <span class="n">selected_var</span><span class="p">):</span>
            <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span> <span class="k">if</span> <span class="n">year_forecast</span> <span class="k">else</span> <span class="s2">&quot;hindcast&quot;</span>

            <span class="k">if</span> <span class="n">cent</span> <span class="ow">in</span> <span class="n">nmme</span><span class="p">:</span> <span class="c1">#### Reconsider an option to download other variable than PRCP, TEMP, and SST from IRIDL &quot;code already available&quot;      </span>

                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                <span class="n">init_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">ic&quot;</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s2">&quot;fcst&quot;</span> <span class="k">if</span> <span class="n">year_forecast</span> <span class="k">else</span> <span class="s2">&quot;hcst&quot;</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;precip&quot;</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s2">&quot;PRCP&quot;</span> <span class="k">else</span> <span class="n">k</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;tmp2m&quot;</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s2">&quot;TEMP&quot;</span> <span class="k">else</span> <span class="n">k</span>
                <span class="n">k</span> <span class="o">=</span> <span class="s2">&quot;sst&quot;</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s2">&quot;SST&quot;</span> <span class="k">else</span> <span class="n">k</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span>
                    <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>                   
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Choose base URL depending on forecast/hindcast and temporal resolution.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lead_time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># Build lead time string using min and max lead time values.</span>
                        <span class="n">lead_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">season_months</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        
                        <span class="k">if</span> <span class="n">year_forecast</span><span class="p">:</span>
                            <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://ftp.cpc.ncep.noaa.gov/International/nmme/seasonal_nmme_forecast_in_cpt_format/&quot;</span>
                            <span class="n">year_range</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://ftp.cpc.ncep.noaa.gov/International/nmme/seasonal_nmme_hindcast_in_cpt_format/&quot;</span>
                            <span class="n">year_range</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1991</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="mi">2020</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">init_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_range</span><span class="si">}</span><span class="s2">.txt&quot;</span>
                        <span class="n">full_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">file_name</span>
                        <span class="n">file_txt_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="n">file_name</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">):</span>
                            <span class="n">da</span><span class="p">,</span> <span class="n">number_day</span><span class="p">,</span> <span class="n">times_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpt_data_optimized</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">download_nmme_txt_with_progress</span><span class="p">(</span><span class="n">full_url</span><span class="p">,</span> <span class="n">file_txt_path</span><span class="p">)</span>
                            <span class="n">da</span><span class="p">,</span> <span class="n">number_day</span><span class="p">,</span> <span class="n">times_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpt_data_optimized</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;precip&quot;</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span> <span class="o">*</span> <span class="n">number_day</span>
                        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">times_start</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">year_forecast</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_hindcast</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">year_end_hindcast</span><span class="p">)))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span> 
                        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished for </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">year_forecast</span><span class="p">:</span>
                            <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://ftp.cpc.ncep.noaa.gov/International/nmme/monthly_nmme_forecast_in_cpt_format/&quot;</span>
                            <span class="n">year_range</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://ftp.cpc.ncep.noaa.gov/International/nmme/monthly_nmme_hindcast_in_cpt_format/&quot;</span>
                            <span class="n">year_range</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1991</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">all_da</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">:</span>
                            <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">init_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_range</span><span class="si">}</span><span class="s2">.txt&quot;</span>
                            <span class="n">full_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">file_name</span>
                            <span class="n">file_txt_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="n">file_name</span>
                            
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">):</span>
                                <span class="n">da_</span><span class="p">,</span> <span class="n">number_day</span><span class="p">,</span> <span class="n">times_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpt_data_optimized</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">download_nmme_txt_with_progress</span><span class="p">(</span><span class="n">full_url</span><span class="p">,</span> <span class="n">file_txt_path</span><span class="p">)</span>
                                <span class="n">da_</span><span class="p">,</span> <span class="n">number_day</span><span class="p">,</span> <span class="n">times_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_cpt_data_optimized</span><span class="p">(</span><span class="n">file_txt_path</span><span class="p">)</span>
                        
                            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;precip&quot;</span><span class="p">:</span>
                                <span class="n">da_</span> <span class="o">=</span> <span class="n">da_</span> <span class="o">*</span> <span class="n">number_day</span>
                                                        
                            
                            <span class="n">all_da</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da_</span><span class="p">)</span>
                        <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_da</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
                       
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;precip&quot;</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="s2">&quot;YE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                        <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">times_start</span><span class="p">)</span>    
   
                        <span class="k">if</span> <span class="n">year_forecast</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_hindcast</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">year_end_hindcast</span><span class="p">)))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">X</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">area</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">area</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span> 
                        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished for </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>                          
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span>
                    <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
                <span class="k">else</span><span class="p">:</span>                
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                            <span class="n">press_level</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-pressure-levels&quot;</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="s2">&quot;pressure_level&quot;</span><span class="p">:</span> <span class="n">press_level</span><span class="p">,</span>
                                <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
                                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">month_of_initialization</span><span class="p">,</span>
                                <span class="s2">&quot;leadtime_month&quot;</span><span class="p">:</span> <span class="n">lead_time</span><span class="p">,</span>
                                <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-monthly-single-levels&quot;</span>
                            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_mean&quot;</span><span class="p">],</span>
                                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>
                                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">month_of_initialization</span><span class="p">,</span>
                                <span class="s2">&quot;leadtime_month&quot;</span><span class="p">:</span> <span class="n">lead_time</span><span class="p">,</span>
                                <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="p">}</span>
        
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        
                        <span class="c1"># Load the NetCDF file and apply area selection if specified</span>
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span><span class="s2">&quot;TMAX&quot;</span><span class="p">,</span><span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span> 
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> 
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span><span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="mi">30</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> 
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>

                        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">/</span><span class="mi">100</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span> 
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> 
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>

                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;UGRD10&quot;</span><span class="p">,</span><span class="s2">&quot;VGRD10&quot;</span><span class="p">,</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span><span class="s2">&quot;DLWR&quot;</span><span class="p">]:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> 
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>

                        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span><span class="s2">&quot;TMAX&quot;</span><span class="p">,</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span><span class="s2">&quot;UGRD10&quot;</span><span class="p">,</span><span class="s2">&quot;VGRD10&quot;</span><span class="p">,</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">,</span><span class="s2">&quot;SLP&quot;</span><span class="p">,</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span><span class="s2">&quot;DLWR&quot;</span><span class="p">]:</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span>
                            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;pressure_level&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;forecastMonth&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                            <span class="k">if</span> <span class="s2">&quot;indexing_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span> 
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;indexing_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span><span class="s2">&quot;forecast_reference_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
            
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted not process file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;T&quot;</span><span class="p">})</span>    
                        <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                        
                        <span class="c1"># Save the combined dataset for the center-variable combination</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download finished, combined dataset for </span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download data for </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">store_file_path</span></div>



<div class="viewcode-block" id="WAS_Download.WAS_Download_AgroIndicators_daily">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_AgroIndicators_daily">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_AgroIndicators_daily</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download daily agro-meteorological indicators for specified variables and years.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            dir_to_save (str): Directory to save the downloaded files.</span>
<span class="sd">            variables (list): List of shorthand variables to download (e.g., [&quot;AGRO.PRCP&quot;, &quot;AGRO.TMAX&quot;]).</span>
<span class="sd">            year_start (int): Start year for the data to download.</span>
<span class="sd">            year_end (int): End year for the data to download.</span>
<span class="sd">            area (list): Bounding box as [North, West, South, East] for clipping.</span>
<span class="sd">            force_download (bool): If True, forces download even if file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>
        <span class="n">months</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1_1&quot;</span>
    
        <span class="c1"># Updated variable mapping with statistic</span>
        <span class="n">variable_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;precipitation_flux&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_maximum&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_mean&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_minimum&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable_mapping</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown variable: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    
            <span class="n">cds_variable</span><span class="p">,</span> <span class="n">statistic</span> <span class="o">=</span> <span class="n">variable_mapping</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Daily_</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Daily_</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.zip&quot;</span>
                
                    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;sis-agrometeorological-indicators&quot;</span>
                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">cds_variable</span><span class="p">,</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span>
                        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
    
                    <span class="c1"># Include the statistic parameter if specified</span>
                    <span class="k">if</span> <span class="n">statistic</span><span class="p">:</span>
                        <span class="n">request</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">statistic</span><span class="p">]</span>
    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">statistic</span><span class="si">}</span><span class="s2">) data for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">zip_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">statistic</span><span class="si">}</span><span class="s2">) data for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
    
                    <span class="c1"># Extract NetCDF files from the ZIP archive</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">netcdf_file_name</span> <span class="ow">in</span> <span class="n">zip_ref</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">zip_ref</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">netcdf_file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                                <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted ZIP file: </span><span class="si">{</span><span class="n">zip_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
                <span class="c1"># Concatenate all daily datasets into a single file</span>
                <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                    <span class="c1"># Convert temperature data from Kelvin to Celsius if needed</span>
                    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">]:</span>
                        <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>  <span class="c1"># Convert from Kelvin to Celsius</span>
    
                    <span class="c1"># Rename dimensions and save to NetCDF</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File downloaded and combined dataset for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> is saved to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Download.WAS_Download_Models_Daily">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_Models_Daily">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_Models_Daily</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">center_variable</span><span class="p">,</span>         <span class="c1"># e.g. [&quot;ECMWF_51.PRCP&quot;, &quot;UKMO_603.TEMP&quot;, ...]</span>
        <span class="n">month_of_initialization</span><span class="p">,</span> <span class="c1"># int: e.g. 2 for February</span>
        <span class="n">day_of_initialization</span><span class="p">,</span>   <span class="c1"># int: e.g. 1 for the 1st day</span>
        <span class="n">leadtime_hour</span><span class="p">,</span>           <span class="c1"># list of strings: e.g. [&quot;24&quot;,&quot;48&quot;,..., &quot;5160&quot;]</span>
        <span class="n">year_start_hindcast</span><span class="p">,</span>
        <span class="n">year_end_hindcast</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download daily/sub-daily seasonal forecast model data (original)</span>
<span class="sd">        using &#39;seasonal-original-single-levels&#39; from the CDS.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            dir_to_save (str or Path): Directory to save the downloaded files.</span>
<span class="sd">            center_variable (list): Each element e.g. &quot;ECMWF_51.PRCP&quot;</span>
<span class="sd">                - left side of &#39;.&#39; is model (ECMWF_51),</span>
<span class="sd">                - right side is variable short code (PRCP).</span>
<span class="sd">            month_of_initialization (int): Initialization month (1-12).</span>
<span class="sd">            day_of_initialization (int): Initialization day (1-31).</span>
<span class="sd">            leadtime_hour (list of str): e.g. [&quot;24&quot;, &quot;48&quot;, ..., &quot;5160&quot;].</span>
<span class="sd">            year_start_hindcast (int): Start year for hindcast data.</span>
<span class="sd">            year_end_hindcast (int): End year for hindcast data.</span>
<span class="sd">            area (list): Bounding box as [North, West, South, East].</span>
<span class="sd">            year_forecast (int, optional): If provided, downloads that single</span>
<span class="sd">                forecast year. Otherwise downloads hindcast for the specified range.</span>
<span class="sd">            ensemble_mean (str, optional): e.g. &quot;mean&quot;, &quot;median&quot;, or None.</span>
<span class="sd">            force_download (bool): Force download if True, even if file exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># 1. Determine whether we are downloading hindcast or forecast.</span>
        <span class="k">if</span> <span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Hindcast range</span>
            <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start_hindcast</span><span class="p">,</span> <span class="n">year_end_hindcast</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;hindcast&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Single forecast year</span>
            <span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">)]</span>
            <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span>
    
        <span class="c1"># 2. Build standard dictionaries for center/system/variables</span>
        <span class="n">centre</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;ecmwf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Apr to __</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;ukmo&quot;</span><span class="p">,</span> <span class="c1"># month of initialization available for forecast are Jan to Mar</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;meteo_france&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;dwd&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;DWD_2&quot;: &quot;dwd&quot;,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;cmcc&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CMCC_3&quot;: &quot;cmcc&quot;,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;ncep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;jma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;eccc&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="n">system</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ECMWF_51&quot;</span><span class="p">:</span> <span class="s2">&quot;51&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_604&quot;</span><span class="p">:</span> <span class="s2">&quot;604&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UKMO_603&quot;</span><span class="p">:</span> <span class="s2">&quot;603&quot;</span><span class="p">,</span>
            <span class="s2">&quot;METEOFRANCE_8&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_21&quot;</span><span class="p">:</span> <span class="s2">&quot;21&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DWD_22&quot;</span><span class="p">:</span> <span class="s2">&quot;22&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;DWD_2&quot;: &quot;2&quot;,</span>
            <span class="s2">&quot;CMCC_35&quot;</span><span class="p">:</span> <span class="s2">&quot;35&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;CMCC_3&quot;: &quot;3&quot;,</span>
            <span class="s2">&quot;NCEP_2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;JMA_3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_4&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ECCC_5&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>  <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span>  <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span>  <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span>  <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span><span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span><span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span>   <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">variables_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span>  <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span>  <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span>  <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span>  <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span>  <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span>  <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1">### Particularity for day of initialization NCEP and JMA</span>
        <span class="n">init_day_dict_jma</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;01&quot;</span><span class="p">:</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">:</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">:</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;04&quot;</span><span class="p">:</span><span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;05&quot;</span><span class="p">:</span><span class="s2">&quot;16&quot;</span><span class="p">,</span> <span class="s2">&quot;06&quot;</span><span class="p">:</span><span class="s2">&quot;15&quot;</span><span class="p">,</span>
            <span class="s2">&quot;07&quot;</span><span class="p">:</span><span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="s2">&quot;08&quot;</span><span class="p">:</span><span class="s2">&quot;14&quot;</span><span class="p">,</span> <span class="s2">&quot;09&quot;</span><span class="p">:</span><span class="s2">&quot;13&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">:</span><span class="s2">&quot;13&quot;</span><span class="p">,</span> <span class="s2">&quot;11&quot;</span><span class="p">:</span><span class="s2">&quot;12&quot;</span><span class="p">,</span> <span class="s2">&quot;12&quot;</span><span class="p">:</span><span class="s2">&quot;12&quot;</span>
        <span class="p">}</span>

        <span class="n">init_day_dict_ncep</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;01&quot;</span><span class="p">:</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">:</span><span class="s2">&quot;05&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">:</span><span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;04&quot;</span><span class="p">:</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;05&quot;</span><span class="p">:</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;06&quot;</span><span class="p">:</span><span class="s2">&quot;05&quot;</span><span class="p">,</span>
            <span class="s2">&quot;07&quot;</span><span class="p">:</span><span class="s2">&quot;05&quot;</span><span class="p">,</span> <span class="s2">&quot;08&quot;</span><span class="p">:</span><span class="s2">&quot;04&quot;</span><span class="p">,</span> <span class="s2">&quot;09&quot;</span><span class="p">:</span><span class="s2">&quot;03&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">:</span><span class="s2">&quot;03&quot;</span><span class="p">,</span> <span class="s2">&quot;11&quot;</span><span class="p">:</span><span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;12&quot;</span><span class="p">:</span><span class="s2">&quot;02&quot;</span>
        <span class="p">}</span>
        
    
        <span class="c1"># 3. Ensure the output directory exists</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">dir_to_save</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">store_file_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># 4. Loop over each center-variable combination</span>
        <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">:</span>
            <span class="c1"># Example: &quot;ECMWF_51.PRCP&quot;</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># e.g. &quot;ECMWF_51&quot;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># e.g. &quot;PRCP&quot;</span>
    
            <span class="c1"># Map to the Copernicus naming</span>
            <span class="n">cent</span> <span class="o">=</span> <span class="n">centre</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">syst</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_1</span><span class="p">:</span>
                <span class="n">var_cds</span> <span class="o">=</span> <span class="n">variables_1</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                <span class="n">var_cds</span> <span class="o">=</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown variable code: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    
            <span class="c1"># Build a single output path</span>
            <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
            
            <span class="c1"># E.g. &quot;hindcast_ecmwf51_PRCP_Feb01_1981-2016_24-5160.nc&quot;</span>
            <span class="n">years_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">years</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">years</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lead_str</span>  <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">leadtime_hour</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">leadtime_hour</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leadtime_hour</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">leadtime_hour</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
            <span class="n">output_file</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dir_to_save</span> <span class="o">/</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}{</span><span class="n">day_of_initialization</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">years_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="p">)</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">output_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_file</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">cent</span> <span class="o">==</span> <span class="s2">&quot;jma&quot;</span> <span class="ow">and</span> <span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">day_of_initialization</span> <span class="o">=</span> <span class="n">init_day_dict_jma</span><span class="p">[</span><span class="n">month_of_initialization</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cent</span> <span class="o">==</span> <span class="s2">&quot;ncep&quot;</span> <span class="ow">and</span> <span class="n">year_forecast</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">day_of_initialization</span> <span class="o">=</span> <span class="n">init_day_dict_ncep</span><span class="p">[</span><span class="n">month_of_initialization</span><span class="p">]</span>
                    
            <span class="c1"># 5. Prepare the request for &#39;seasonal-original-single-levels&#39;</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;seasonal-original-single-levels&quot;</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;originating_centre&quot;</span><span class="p">:</span> <span class="n">cent</span><span class="p">,</span>
                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="n">syst</span><span class="p">,</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">var_cds</span><span class="p">],</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span>  <span class="c1"># list of strings</span>
                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="s2">&quot;day&quot;</span><span class="p">:</span>   <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">day_of_initialization</span><span class="p">)</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                <span class="s2">&quot;leadtime_hour&quot;</span><span class="p">:</span> <span class="n">leadtime_hour</span><span class="p">,</span>  <span class="c1"># e.g. [&quot;24&quot;,&quot;48&quot;,..., &quot;5160&quot;]</span>
                <span class="s2">&quot;data_format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>   <span class="c1"># e.g. [90, -180, -90, 180]</span>
            <span class="p">}</span>
    
            <span class="c1"># Temporary file to download</span>
            <span class="n">temp_file</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;temp_</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    
            <span class="c1"># 6. Download from CDS</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting data from &#39;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">cv</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">temp_file</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded: </span><span class="si">{</span><span class="n">temp_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download data for </span><span class="si">{</span><span class="n">cv</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
    
            <span class="c1"># 7. Post-process with xarray</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">##########################################################</span>
                <span class="c1"># Take in account level pressure for some variables in this part</span>
                <span class="c1">##########################################################</span>
                 
                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
                <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;forecast_period&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">data</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">((</span><span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast_period&#39;</span><span class="p">),</span> <span class="n">time</span><span class="p">))</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast_period&#39;</span><span class="p">))</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;forecast_reference_time&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast_period&#39;</span><span class="p">])</span>
                <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;valid_time&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span>
    
                <span class="c1"># If there&#39;s an ensemble dimension, apply ensemble mean/median if requested</span>
                <span class="k">if</span> <span class="n">ensemble_mean</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ensemble_mean</span><span class="p">)(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
    
                <span class="c1"># For example, flip latitude if needed</span>
                <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span><span class="s2">&quot;TMAX&quot;</span><span class="p">,</span><span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span> <span class="o">-</span> <span class="mf">273.15</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span><span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_index</span><span class="p">()</span>
                    <span class="n">years</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
                    <span class="n">tampon</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">years</span><span class="p">):</span>
                        
                        <span class="c1"># Select the data for the specific year</span>
                        <span class="n">yearly_ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">year</span><span class="p">)</span>
                        
                        <span class="c1"># Calculate differences for the year</span>
                        <span class="n">differences</span> <span class="o">=</span> <span class="p">[</span><span class="n">yearly_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">yearly_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">yearly_ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))]</span>
                        <span class="n">differences</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                        <span class="n">differences</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yearly_ds</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
                        <span class="n">tampon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tampon</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span>

                    <span class="c1">##########################################################</span>
                    <span class="c1"># Include after the processing of SLP, DSWR, DLWR,</span>
                    <span class="c1">##########################################################</span>

                <span class="c1"># Finally, rename the coords to X, Y, T to match my style</span>
                <span class="k">if</span> <span class="s2">&quot;longitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
    
                <span class="c1"># 8. Save the processed data</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
                <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved processed data to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">store_file_path</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cent</span><span class="si">}{</span><span class="n">syst</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_file</span>
        
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading or processing </span><span class="si">{</span><span class="n">temp_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Remove the temporary file</span>
                <span class="k">if</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_file</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted temp file: </span><span class="si">{</span><span class="n">temp_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">store_file_path</span></div>

        
<div class="viewcode-block" id="WAS_Download.WAS_Download_AgroIndicators">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_AgroIndicators">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_AgroIndicators</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">seas</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">],</span>  <span class="c1"># e.g. NDJ = [&quot;11&quot;,&quot;12&quot;,&quot;01&quot;]</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download agro-meteorological indicators for specified variables, years, and months,</span>
<span class="sd">        handling cross-year seasons (e.g., NDJ).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">dir_to_save</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert season months to integers (e.g., [&quot;11&quot;,&quot;12&quot;,&quot;01&quot;] -&gt; [11,12,1])</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">seas</span><span class="p">]</span>
        <span class="c1"># Identify the pivot = the first month in your `seas` list</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Basic mapping</span>
        <span class="n">variable_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;precipitation_flux&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_maximum&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_mean&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;24_hour_minimum&quot;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1_1&quot;</span>
        <span class="n">days</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>

        <span class="c1"># Build a season string for naming (e.g., NDJ)</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">month_str</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return a zero-padded string month from int.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">variable_mapping</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown variable: </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">cds_variable</span><span class="p">,</span> <span class="n">statistic</span> <span class="o">=</span> <span class="n">variable_mapping</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="n">var_short</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># e.g., &quot;PRCP&quot; from &quot;AGRO.PRCP&quot;</span>

            <span class="c1"># Output path for the combined dataset across all years</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_</span><span class="si">{</span><span class="n">var_short</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">force_download</span><span class="p">)</span> <span class="ow">and</span> <span class="n">output_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> already exists. Skipping download.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># We&#39;ll accumulate all partial datasets here</span>
            <span class="n">all_years_datasets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop over each year in the requested range</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Split the months into those belonging to &quot;base&quot; year vs &quot;next&quot; year</span>
                <span class="n">base_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="n">pivot</span><span class="p">]</span>
                <span class="n">next_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">]</span>

                <span class="c1"># 1) Download part A (base-year months), if any</span>
                <span class="k">if</span> <span class="n">base_months</span><span class="p">:</span>
                    <span class="n">months_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">month_str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_months</span><span class="p">]</span>
                    <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_</span><span class="si">{</span><span class="n">var_short</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_partA.zip&quot;</span>

                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">cds_variable</span><span class="p">,</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months_base</span><span class="p">,</span>
                        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">statistic</span><span class="p">:</span>
                        <span class="n">request</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">statistic</span><span class="p">]</span>

                    <span class="c1"># Attempt download</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> months=</span><span class="si">{</span><span class="n">months_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s2">&quot;sis-agrometeorological-indicators&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> year=</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> Part A: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Unzip each netCDF and append</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">nc_name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">z</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">nc_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                                <span class="n">all_years_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span>

                <span class="c1"># 2) Download part B (next-year months), if any and if we have a next year</span>
                <span class="k">if</span> <span class="n">next_months</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_end</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">year_next</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">months_next</span> <span class="o">=</span> <span class="p">[</span><span class="n">month_str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">next_months</span><span class="p">]</span>
                    <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_</span><span class="si">{</span><span class="n">var_short</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_partB_</span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2">.zip&quot;</span>

                    <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">cds_variable</span><span class="p">,</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_next</span><span class="p">),</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months_next</span><span class="p">,</span>
                        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">days</span><span class="p">,</span>
                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                        <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="n">statistic</span><span class="p">:</span>
                        <span class="n">request</span><span class="p">[</span><span class="s2">&quot;statistic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">statistic</span><span class="p">]</span>

                    <span class="c1"># Attempt download</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2"> months=</span><span class="si">{</span><span class="n">months_next</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="s2">&quot;sis-agrometeorological-indicators&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">cds_variable</span><span class="si">}</span><span class="s2"> year=</span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2"> Part B: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># Unzip each netCDF and append</span>
                    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">nc_name</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                            <span class="k">with</span> <span class="n">z</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">nc_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                                <span class="n">all_years_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">)</span>

            <span class="c1"># -----------------------------------------</span>
            <span class="c1"># Post-process &amp; combine all partial years</span>
            <span class="c1"># -----------------------------------------</span>

            <span class="k">if</span> <span class="n">all_years_datasets</span><span class="p">:</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_years_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
                <span class="c1"># If it&#39;s temperature, subtract 273.15 (Kelvin → Celsius)</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;AGRO.TMIN&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;AGRO.TMAX&quot;</span><span class="p">]:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span> <span class="o">-</span> <span class="mf">273.15</span>
    
                <span class="c1"># Now do custom aggregator for NDJ or any cross-year months</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_crossyear</span><span class="p">(</span>
                    <span class="n">ds</span><span class="o">=</span><span class="n">combined_ds</span><span class="p">,</span>
                    <span class="n">season_months</span><span class="o">=</span><span class="n">season_months</span><span class="p">,</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="n">var</span>
                <span class="p">)</span>
    
                <span class="c1"># Finally rename dims</span>
                <span class="c1"># (the aggregator function has already replaced &#39;time&#39; with our &#39;season_year&#39;)</span>
                <span class="k">if</span> <span class="s2">&quot;lon&quot;</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="s2">&quot;lat&quot;</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                    <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
                <span class="c1"># Flip lat </span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">seas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
                <span class="n">combined_ds</span> <span class="o">=</span> <span class="n">combined_ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span> 
                
                <span class="n">combined_ds</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved final dataset for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> to: </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data downloaded for </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

    

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="c1"># Helper for Reanalysis cross-year post-processing (optional)</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_postprocess_reanalysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop extra coords, rename dims, flip lat, etc.</span>
<span class="sd">        Adjust as needed for your MERRA2 or ERA5 quirks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Drop some known extraneous coords</span>
        <span class="n">drop_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;expver&quot;</span><span class="p">,</span> <span class="s2">&quot;pressure_level&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span> <span class="ow">or</span> <span class="n">extra</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                <span class="n">drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">drop_list</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Flip latitude if it exists</span>
        <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">latitude</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1"># rename directly to X, Y</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">})</span>

        <span class="c1"># If &quot;valid_time&quot; is present, rename it to &quot;time&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;valid_time&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">valid_time</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">valid_time</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;valid_time&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">ds</span>

    <span class="k">def</span> <span class="nf">_postprocess_reanalysis_ersst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>       
        <span class="c1"># Drop unnecessary variables</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;zlev&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">keep_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_name</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="n">drop_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="n">drop_vars</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_aggregate_crossyear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">season_months</span><span class="p">,</span> <span class="n">var_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;s</span>
<span class="sd">        Group ds by a custom &#39;season_year&#39; coordinate so that all months</span>
<span class="sd">        in &#39;season_months&#39; belong to one group that may cross Dec→Jan.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            ds (xarray.Dataset or DataArray): The data to aggregate (daily, monthly, etc.).</span>
<span class="sd">            season_months (list[int]): e.g. [11,12,1] for NDJ.</span>
<span class="sd">            var_name (str): e.g. &quot;AGRO.PRCP&quot;, &quot;TEMP&quot;, &quot;TMIN&quot;, etc. </span>
<span class="sd">                           Used to decide &#39;mean&#39; vs &#39;sum&#39;.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            ds_out (xarray.Dataset or DataArray): Aggregated by season, </span>
<span class="sd">                          dimension renamed from &#39;season_year&#39; to &#39;time&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset must have a &#39;time&#39; dimension for aggregation.&quot;</span><span class="p">)</span>
    
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
        <span class="c1"># 1) Tag each time with the &quot;season_year&quot;</span>
        <span class="c1"># If month &gt;= pivot =&gt; same year&#39;s label, else =&gt; year - 1</span>
        <span class="n">season_year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="n">pivot</span><span class="p">,</span>
                                               <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">season_year</span><span class="o">=</span><span class="n">season_year</span><span class="p">)</span>
        
        <span class="c1"># 2) Keep only the months we actually want</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">season_months</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="c1"># 3) Decide mean or sum based on var_name </span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span><span class="s2">&quot;TMAX&quot;</span><span class="p">,</span><span class="s2">&quot;SST&quot;</span><span class="p">,</span><span class="s2">&quot;SLP&quot;</span><span class="p">]):</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">var_name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PRCP&quot;</span><span class="p">,</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span><span class="s2">&quot;DLWR&quot;</span><span class="p">]):</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    
        <span class="c1"># 4) Rename &quot;season_year&quot; to &quot;time&quot;, </span>
        <span class="c1">#    so we end up with a time dimension (representing each seasonal year).</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;season_year&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>
    
        <span class="k">return</span> <span class="n">ds_out</span>


<div class="viewcode-block" id="WAS_Download.WAS_Download_Reanalysis">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_Reanalysis">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_Reanalysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">center_variable</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="p">,</span>
        <span class="n">seas</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">],</span>  <span class="c1"># e.g. NDJ = [&quot;11&quot;,&quot;12&quot;,&quot;01&quot;]</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">run_avg</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download reanalysis data for specified center-variable combinations, years, and months,</span>
<span class="sd">        handling cross-year seasons (e.g., NDJ).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">dir_to_save</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Parse center and variable strings</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>
        <span class="n">vars_</span>   <span class="o">=</span> <span class="p">[</span><span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">cv</span> <span class="ow">in</span> <span class="n">center_variable</span><span class="p">]</span>

        <span class="c1"># Example reanalysis centers</span>
        <span class="n">centre_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ERA5&quot;</span><span class="p">:</span> <span class="s2">&quot;ERA5&quot;</span><span class="p">,</span> <span class="s2">&quot;MERRA2&quot;</span><span class="p">:</span> <span class="s2">&quot;MERRA2&quot;</span><span class="p">}</span>

        <span class="c1"># Single-level monthly means</span>
        <span class="n">variables_1</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span> <span class="s2">&quot;total_precipitation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TEMP&quot;</span><span class="p">:</span> <span class="s2">&quot;2m_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;maximum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;minimum_2m_temperature_in_the_last_24_hours&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD10&quot;</span><span class="p">:</span> <span class="s2">&quot;10m_v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SST&quot;</span><span class="p">:</span> <span class="s2">&quot;sea_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SLP&quot;</span><span class="p">:</span> <span class="s2">&quot;mean_sea_level_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DSWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_solar_radiation_downwards&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DLWR&quot;</span><span class="p">:</span> <span class="s2">&quot;surface_thermal_radiation_downwards&quot;</span><span class="p">,</span>

        <span class="p">}</span>
        <span class="c1"># Pressure-level monthly means</span>
        <span class="n">variables_2</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;HUSS_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_925&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HUSS_850&quot;</span><span class="p">:</span> <span class="s2">&quot;specific_humidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;UGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;u_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_1000&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_925&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VGRD_850&quot;</span><span class="p">:</span> <span class="s2">&quot;v_component_of_wind&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Helper for zero-padded month strings</span>
        <span class="k">def</span> <span class="nf">m2str</span><span class="p">(</span><span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Convert months to integers (e.g. [&quot;11&quot;,&quot;12&quot;,&quot;01&quot;] -&gt; [11,12,1])</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">seas</span><span class="p">]</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># For naming</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">vars_</span><span class="p">):</span>
            <span class="c1"># =================================================================</span>
            <span class="c1"># Special Case: NOAA ERSST from IRIDL</span>
            <span class="c1"># =================================================================</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;NOAA&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;SST&quot;</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force_download</span> <span class="ow">and</span> <span class="n">out_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2"> exists. Skipping.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
        
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Build IRIDL URL using bounding box [N, W, S, E]</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">build_iridl_url_ersst</span><span class="p">(</span>
                        <span class="n">year_start</span><span class="o">=</span><span class="n">year_start</span><span class="p">,</span>
                        <span class="n">year_end</span><span class="o">=</span><span class="n">year_end</span><span class="p">,</span>
                        <span class="n">bbox</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>     <span class="c1"># e.g. [10, -15, -5, 15]</span>
                        <span class="n">run_avg</span><span class="o">=</span><span class="n">run_avg</span><span class="p">,</span>
                        <span class="n">month_start</span><span class="o">=</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
                        <span class="n">month_end</span><span class="o">=</span><span class="s2">&quot;Dec&quot;</span>
                    <span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using IRIDL URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># 2) Open dataset with manual processing</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="n">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;T&quot;</span><span class="p">:</span><span class="s2">&quot;time&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s2">&quot;proleptic_gregorian&quot;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;T&quot;</span><span class="p">})</span>

                    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                            <span class="s1">&#39;sst&#39;</span><span class="p">:</span> <span class="s1">&#39;SST&#39;</span><span class="p">,</span>  <span class="c1"># Rename variable to match expected name</span>
                        <span class="p">})</span>
                                                                                                               
                    <span class="c1"># 6) Post-process</span>
                    <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_reanalysis_ersst</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>                   
                    
                    <span class="c1"># 7) Final formatting</span>
                    <span class="n">ds_agg</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">seas</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">ds_agg</span> <span class="o">=</span> <span class="n">fix_time_coord</span><span class="p">(</span><span class="n">ds_agg</span><span class="p">,</span><span class="n">seas</span><span class="p">)</span>
                    <span class="n">ds_agg</span> <span class="o">=</span> <span class="n">ds_agg</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span>
                            <span class="s1">&#39;SST&#39;</span><span class="p">:</span> <span class="s1">&#39;sst&#39;</span><span class="p">,</span>  <span class="c1"># Rename variable to match expected name</span>
                        <span class="p">})</span>
                    <span class="c1"># 8) Save</span>
                    <span class="n">ds_agg</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved NOAA ERSST data to </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="c1"># # Loop over each reanalysis center/var</span>
        <span class="c1"># for c, v in zip(centers, vars_):</span>
        <span class="c1">#     # e.g. ERA5, PRCP</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">centre_dict</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown center: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">, skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">rean</span> <span class="o">=</span> <span class="n">centre_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">force_download</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2"> already exists. Skipping.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># List to accumulate partial downloads</span>
            <span class="n">combined_datasets</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Iterate over each year in [year_start..year_end]</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Split months</span>
                <span class="n">base_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="n">pivot</span><span class="p">]</span>
                <span class="n">next_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">]</span>

                <span class="c1"># (A) Base-year</span>
                <span class="k">if</span> <span class="n">base_months</span><span class="p">:</span>
                    <span class="n">base_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">m2str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_months</span><span class="p">]</span>
                    <span class="n">partA</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_partA.nc&quot;</span>

                    <span class="c1"># Decide dataset + request</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                        <span class="n">press_level</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># e.g. 925 from &quot;HUSS_925&quot;</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-pressure-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                            <span class="s2">&quot;pressure_level&quot;</span><span class="p">:</span> <span class="n">press_level</span><span class="p">,</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">base_str</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-single-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">base_str</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>

                    <span class="c1"># Download</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">, months=</span><span class="si">{</span><span class="n">base_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">partA</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error for </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, year=</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2"> partA: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span> <span class="k">as</span> <span class="n">dsA</span><span class="p">:</span>
                        <span class="n">dsA</span> <span class="o">=</span> <span class="n">dsA</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="n">dsA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_reanalysis</span><span class="p">(</span><span class="n">dsA</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsA</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">partA</span><span class="p">)</span>

                <span class="c1"># (B) Next-year</span>
                <span class="k">if</span> <span class="n">next_months</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_end</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">year_next</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">next_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">m2str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">next_months</span><span class="p">]</span>
                    <span class="n">partB</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_partB_</span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2">.nc&quot;</span>

                    <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables_2</span><span class="p">:</span>
                        <span class="n">press_level</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-pressure-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_2</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                            <span class="s2">&quot;pressure_level&quot;</span><span class="p">:</span> <span class="n">press_level</span><span class="p">,</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_next</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">next_str</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;reanalysis-era5-single-levels-monthly-means&quot;</span>
                        <span class="n">request</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;product_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;monthly_averaged_reanalysis&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variables_1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
                            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_next</span><span class="p">),</span>
                            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">next_str</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00:00&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">,</span>
                        <span class="p">}</span>

                    <span class="c1"># Download</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">client</span> <span class="o">=</span> <span class="n">cdsapi</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2">, months=</span><span class="si">{</span><span class="n">next_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">client</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">partB</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error for </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, year=</span><span class="si">{</span><span class="n">year_next</span><span class="si">}</span><span class="s2"> partB: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">with</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">partB</span><span class="p">)</span> <span class="k">as</span> <span class="n">dsB</span><span class="p">:</span>
                        <span class="n">dsB</span> <span class="o">=</span> <span class="n">dsB</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                        <span class="n">dsB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_reanalysis</span><span class="p">(</span><span class="n">dsB</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="n">combined_datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsB</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">partB</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">combined_datasets</span><span class="p">:</span>
                <span class="n">dsC</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">combined_datasets</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
            
                <span class="c1"># If T variable -&gt; K to °C</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TMIN&quot;</span><span class="p">,</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span><span class="s2">&quot;TMAX&quot;</span><span class="p">,</span><span class="s2">&quot;SST&quot;</span><span class="p">]:</span>
                    <span class="n">dsC</span> <span class="o">=</span> <span class="n">dsC</span> <span class="o">-</span> <span class="mf">273.15</span>
                
                <span class="c1"># For precipitation or others, the aggregator decides sum vs mean</span>
                <span class="n">dsC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_crossyear</span><span class="p">(</span>
                    <span class="n">ds</span><span class="o">=</span><span class="n">dsC</span><span class="p">,</span>
                    <span class="n">season_months</span><span class="o">=</span><span class="n">season_months</span><span class="p">,</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="n">v</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                    <span class="n">nbjour</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">season_months</span><span class="p">)</span><span class="o">*</span><span class="mi">30</span>
                    <span class="n">dsC</span> <span class="o">=</span> <span class="n">nbjour</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="n">dsC</span>  <span class="c1"># !!!!! Convert to mm/month</span>
                
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DSWR&quot;</span><span class="p">,</span> <span class="s2">&quot;DLWR&quot;</span><span class="p">]:</span>
                    <span class="n">nbjour</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">season_months</span><span class="p">)</span><span class="o">*</span><span class="mi">30</span>
                    <span class="n">dsC</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsC</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nbjour</span><span class="o">*</span><span class="mi">86400</span><span class="p">)</span>  <span class="c1"># Convert to W/m2</span>

                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;SLP&quot;</span><span class="p">:</span>
                    <span class="n">dsC</span> <span class="o">=</span> <span class="n">dsC</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Convert to hPa(mb)</span>

                <span class="n">dsC</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">seas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">dsC</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
                <span class="n">dsC</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsC</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
                <span class="n">dsC</span> <span class="o">=</span> <span class="n">dsC</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
                
                <span class="c1"># Save final</span>
                <span class="n">dsC</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved final reanalysis file: </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data found for </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_Download.WAS_Download_CHIRPSv3">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.WAS_Download.WAS_Download_CHIRPSv3">[docs]</a>
    <span class="k">def</span> <span class="nf">WAS_Download_CHIRPSv3</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_to_save</span><span class="p">,</span>
        <span class="n">variables</span><span class="p">,</span>
        <span class="n">year_start</span><span class="p">,</span>
        <span class="n">year_end</span><span class="p">,</span>
        <span class="n">area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">season_months</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;03&quot;</span><span class="p">,</span> <span class="s2">&quot;04&quot;</span><span class="p">,</span> <span class="s2">&quot;05&quot;</span><span class="p">],</span>
        <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>        
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download CHIRPS v3.0 monthly precipitation for a specified cross-year season</span>
<span class="sd">        from year_start to year_end, optionally clipped to &#39;area&#39;,</span>
<span class="sd">        and aggregate them into a single NetCDF file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span>
        <span class="n">dir_to_save</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">season_months</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">]</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="c1"># Example: &quot;MAM&quot;</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span><span class="p">])</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">out_nc</span> <span class="o">=</span> <span class="n">dir_to_save</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;Obs_PRCP_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        <span class="k">if</span> <span class="n">out_nc</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] </span><span class="si">{</span><span class="n">out_nc</span><span class="si">}</span><span class="s2"> already exists. Skipping.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># We&#39;ll store monthly DataArrays here</span>
        <span class="n">all_data_arrays</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop over years</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Base-year months (&gt;= pivot)</span>
            <span class="n">base_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="n">pivot</span><span class="p">]</span>
            <span class="c1"># Next-year months (&lt; pivot)</span>
            <span class="n">next_months</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">season_months</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">]</span>

            <span class="c1"># Part A: Base-year months</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">base_months</span><span class="p">:</span>
                <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_chirps_monthly</span><span class="p">(</span>
                    <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
                    <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                    <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save</span><span class="p">,</span>
                    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
                    <span class="n">area</span><span class="o">=</span><span class="n">area</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">da</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_data_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

            <span class="c1"># Part B: Next-year months</span>
            <span class="k">if</span> <span class="n">next_months</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">year_next</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">next_months</span><span class="p">:</span>
                    <span class="n">da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_chirps_monthly</span><span class="p">(</span>
                        <span class="n">year</span><span class="o">=</span><span class="n">year_next</span><span class="p">,</span>
                        <span class="n">month</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                        <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save</span><span class="p">,</span>
                        <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span>
                        <span class="n">area</span><span class="o">=</span><span class="n">area</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">da</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">all_data_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_data_arrays</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[WARNING] No CHIRPS data arrays were opened/downloaded.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Concatenate along time</span>
        <span class="n">ds_all</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data_arrays</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;precip&quot;</span><span class="p">)</span>

        <span class="c1"># Aggregate across the cross-year season (summing monthly precipitation)</span>
        <span class="n">ds_season</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_chirps</span><span class="p">(</span><span class="n">ds_all</span><span class="p">,</span> <span class="n">season_months</span><span class="p">)</span>

        <span class="c1"># Rename dims if desired</span>
        <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds_season</span> <span class="o">=</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds_season</span> <span class="o">=</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">ds_season</span> <span class="o">=</span> <span class="n">ds_season</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">})</span>
        <span class="c1"># Write to NetCDF</span>
        <span class="n">ds_season</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">out_nc</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[INFO] Saved seasonal CHIRPS data to </span><span class="si">{</span><span class="n">out_nc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Delete individual monthly TIF files</span>
        <span class="k">for</span> <span class="n">tif_file</span> <span class="ow">in</span> <span class="n">dir_to_save</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;chirps-v3.0.*.tif&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tif_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[CLEANUP] Deleted </span><span class="si">{</span><span class="n">tif_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Could not delete </span><span class="si">{</span><span class="n">tif_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>




    <span class="k">def</span> <span class="nf">_fetch_chirps_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">dir_to_save</span><span class="p">,</span> <span class="n">force_download</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the CHIRPS v3.0 monthly TIF URL for (year, month), </span>
<span class="sd">        download if needed, open as xarray, and optionally clip to &#39;area&#39;.</span>
<span class="sd">        </span>
<span class="sd">        File format is: chirps-v3.0.YYYY.MM.tif</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://data.chc.ucsb.edu/products/CHIRPS/v3.0/monthly/africa/tifs&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;chirps-v3.0.</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">.tif&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">local_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">)</span> <span class="o">/</span> <span class="n">fname</span>
        <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
        
        <span class="c1"># # Download if needed</span>
        <span class="c1"># if (not local_path.exists()) or force_download:</span>
        <span class="c1">#     print(f&quot;[DOWNLOAD] {url}&quot;)</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         with requests.get(url, stream=True, timeout=120) as r:</span>
        <span class="c1">#             r.raise_for_status()</span>
        <span class="c1">#             with open(local_path, &quot;wb&quot;) as f:</span>
        <span class="c1">#                 for chunk in r.iter_content(chunk_size=8192):</span>
        <span class="c1">#                     f.write(chunk)</span>
        <span class="c1">#     except Exception as e:</span>
        <span class="c1">#         print(f&quot;[ERROR] Could not download {url}: {e}&quot;)</span>
        <span class="c1">#         return None</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(f&quot;[SKIP] {fname} is already present. (Use force_download=True to overwrite)&quot;)</span>

        <span class="c1"># Open as xarray via rioxarray</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">rioxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">time_coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">)</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="n">time_coord</span><span class="p">])</span>
            <span class="n">da</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;precip&quot;</span>

            <span class="c1"># If area is provided, clip</span>
            <span class="k">if</span> <span class="n">area</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">north</span><span class="p">,</span> <span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span> <span class="o">=</span> <span class="n">area</span>
                <span class="n">da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span>
                    <span class="n">minx</span><span class="o">=</span><span class="n">west</span><span class="p">,</span>
                    <span class="n">miny</span><span class="o">=</span><span class="n">south</span><span class="p">,</span>
                    <span class="n">maxx</span><span class="o">=</span><span class="n">east</span><span class="p">,</span>
                    <span class="n">maxy</span><span class="o">=</span><span class="n">north</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">da</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Could not open/parse </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_aggregate_chirps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">season_months</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sum monthly precipitation across the cross-year season.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset must have a &#39;time&#39; dimension.&quot;</span><span class="p">)</span>

        <span class="n">pivot</span> <span class="o">=</span> <span class="n">season_months</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Label each time with &#39;season_year&#39;</span>
        <span class="n">season_year</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="n">pivot</span><span class="p">,</span>
                                               <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">season_year</span><span class="o">=</span><span class="n">season_year</span><span class="p">)</span>

        <span class="c1"># Keep only the months we want</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">season_months</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Sum across the months for precipitation</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;season_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Rename season_year -&gt; time</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;season_year&quot;</span><span class="p">:</span> <span class="s2">&quot;time&quot;</span><span class="p">})</span>

        <span class="c1"># Optionally make the new time coordinate more descriptive:</span>
        <span class="n">new_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sy</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">new_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sy</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">pivot</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">)</span>
        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds_out</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">new_times</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ds_out</span></div>



<span class="c1">####</span>

<div class="viewcode-block" id="plot_map">
<a class="viewcode-back" href="../../api.html#wass2s.was_download.plot_map">[docs]</a>
<span class="k">def</span> <span class="nf">plot_map</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Map&quot;</span><span class="p">):</span> <span class="c1"># [west, east, south, north]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a map with specified geographic extent.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - extent: list of float, specifying [west, east, south, north]</span>
<span class="sd">    - title: str, title of the map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create figure and axis for the map</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Set the geographic extent</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> 
    
    <span class="c1"># Add map features</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    
    <span class="c1"># Set title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="c1"># Show plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>




</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>