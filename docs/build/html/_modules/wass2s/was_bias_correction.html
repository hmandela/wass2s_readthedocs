

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_bias_correction &mdash; wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel. 0.3.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1e28cc32"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_bias_correction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_bias_correction</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">PchipInterpolator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">lognorm</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">weibull_min</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>

<div class="viewcode-block" id="WAS_Qmap">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WAS_Qmap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bias correction methods using quantile mapping techniques, adapted from qmap R package.</span>

<span class="sd">    This class provides static methods for fitting and applying various bias correction</span>
<span class="sd">    techniques, including empirical quantile mapping (QUANT), robust quantile mapping (RQUANT),</span>
<span class="sd">    smoothing splines (SSPLIN), parametric transformations (PTF), and distribution-based</span>
<span class="sd">    methods (DIST). The methods support both NumPy arrays (1D, 2D, or 3D) and xarray</span>
<span class="sd">    DataArrays (3D: T, Y, X or similar).</span>

<span class="sd">    All methods handle wet/dry day corrections optionally and are designed for</span>
<span class="sd">    precipitation or similar non-negative variables.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Inputs are expected to be non-negative.</span>
<span class="sd">    - For gridded data, computations are performed column-wise (per grid cell).</span>
<span class="sd">    - xarray support preserves coordinates and attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_Qmap.fitQmap">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmap</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a bias correction model using the specified quantile mapping method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array_like or xarray.DataArray</span>
<span class="sd">            Observed data. If array_like, can be 1D (time), 2D (time, grid), or 3D (T, Y, X).</span>
<span class="sd">            If xarray.DataArray, must be 3D with dimensions (T, Y, X).</span>
<span class="sd">        mod : array_like or xarray.DataArray</span>
<span class="sd">            Modeled data to fit against, same shape as `obs`.</span>
<span class="sd">        method : str</span>
<span class="sd">            Bias correction method. Options: &#39;QUANT&#39;, &#39;RQUANT&#39;, &#39;SSPLIN&#39;, &#39;PTF&#39;, &#39;DIST&#39; (case-insensitive).</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments passed to the specific fitting method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted object containing parameters, class identifier, and metadata for applying correction.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If shapes mismatch, invalid dimensions, or unknown method.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        doQmap : Apply the fitted bias correction to new data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_xarray</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span>
        <span class="n">original_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time_dim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_xarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mod</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xarray DataArrays must be 3D with matching shapes and dimensions (T, Y, X)&quot;</span><span class="p">)</span>
            <span class="n">time_dim</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">obs_stacked</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">mod_stacked</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">mod_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">coords</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">original_dims</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;QUANT&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">fitQmapQUANT</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;RQUANT&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">fitQmapRQUANT</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;SSPLIN&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">fitQmapSSPLIN</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;PTF&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">fitQmapPTF</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DIST&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">fitQmapDIST</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_xarray</span><span class="p">:</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;is_xarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_dim</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_dims</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;original_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_dims</span>
        <span class="k">return</span> <span class="n">fobj</span></div>


<div class="viewcode-block" id="WAS_Qmap.doQmap">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the fitted bias correction to new data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array_like or xarray.DataArray</span>
<span class="sd">            New modeled data to correct, same format and shape structure as fitting data.</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmap`.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments passed to the specific application method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like or xarray.DataArray</span>
<span class="sd">            Bias-corrected data, same type and shape as `x`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If input types or dimensions mismatch the fitted object.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        fitQmap : Fit the bias correction model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;is_xarray&#39;</span> <span class="ow">in</span> <span class="n">fobj</span> <span class="ow">and</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;is_xarray&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input x must be xarray.DataArray when fitted with DataArray&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input x must have matching spatial dimensions&quot;</span><span class="p">)</span>
            <span class="n">time_dim</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span>
            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]</span>
            <span class="n">x_stacked</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">corrected_data</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_doQmap_internal</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">corrected_stacked</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">corrected_data</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">),</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">corrected_stacked</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">corrected</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_doQmap_internal</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>


<div class="viewcode-block" id="WAS_Qmap._doQmap_internal">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap._doQmap_internal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_doQmap_internal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal helper to apply bias correction based on fitted class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D array of data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional arguments for specific methods.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected 2D array.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown fitted class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQmapQUANT&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">doQmapQUANT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQmapRQUANT&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">doQmapRQUANT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQmapSSPLIN&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">doQmapSSPLIN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQmapPTF&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">doQmapPTF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQmapDIST&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">doQmapDIST</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown class: </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_Qmap._to_2d">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap._to_2d">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert input array to 2D (time, grid) format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arr : array_like</span>
<span class="sd">            Input array (0D to 3D).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            2D array.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If more than 3 dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Numpy array must be 1D, 2D, or 3D&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="WAS_Qmap._wet_day_threshold">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap._wet_day_threshold">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_wet_day_threshold</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">wet_day</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute wet day thresholds for observations and model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            Observed data column.</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            Modeled data column.</span>
<span class="sd">        wet_day : bool or float</span>
<span class="sd">            If False, no threshold (0). If True, compute based on wet fraction.</span>
<span class="sd">            If float, use as observation threshold and compute model accordingly.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (model_threshold, obs_threshold)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">p_wet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_wet</span><span class="p">)</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="n">wet_day</span>
            <span class="n">obs_th</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">&gt;=</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="n">p_wet</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_th</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p_wet</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">th_mod</span><span class="p">,</span> <span class="n">th_obs</span></div>


<div class="viewcode-block" id="WAS_Qmap.fitQmapQUANT">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmapQUANT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmapQUANT</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nboot</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit empirical quantile mapping (QUANT) with optional bootstrapping.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        wet_day : bool or float, optional</span>
<span class="sd">            Wet day handling (default False).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            Quantile step size (default 0.01).</span>
<span class="sd">        nboot : int, optional</span>
<span class="sd">            Number of bootstrap samples for observed quantiles (default 1, no bootstrap).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including quantiles and thresholds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="s1">&#39;fitq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span>
               <span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">),</span> <span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)}</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_wet_day_threshold</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">wet_day</span><span class="p">)</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;=</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nboot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">boot_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">probs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot</span><span class="p">)])</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot_q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQmapQUANT&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">,</span> <span class="s1">&#39;wet_day&#39;</span><span class="p">:</span> <span class="n">wet_day</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_Qmap.doQmapQUANT">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmapQUANT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmapQUANT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply empirical quantile mapping (QUANT) correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmapQUANT`.</span>
<span class="sd">        type : str, optional</span>
<span class="sd">            Interpolation kind for `interp1d` (default &#39;linear&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">modq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">fitq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">xi_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
            <span class="n">mask_below</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">th_mod</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_below</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_above</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask_below</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">modq</span><span class="p">,</span> <span class="n">fitq</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">fitq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_above</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">mask_above</span><span class="p">])</span>
            <span class="n">high_mask</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">modq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">high_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span><span class="p">[</span><span class="n">high_mask</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">fitq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">modq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_corrected</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_Qmap.fitQmapRQUANT">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmapRQUANT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmapRQUANT</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nlls</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nboot</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit robust quantile mapping (RQUANT) with local linear fitting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        wet_day : bool or float, optional</span>
<span class="sd">            Wet day handling (default True).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            Quantile step size (default 0.01).</span>
<span class="sd">        nlls : int, optional</span>
<span class="sd">            Number of local quantiles for linear fit (default 10).</span>
<span class="sd">        nboot : int, optional</span>
<span class="sd">            Number of bootstrap samples (default 10).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including quantiles, slopes, and thresholds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="s1">&#39;fitq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span>
               <span class="s1">&#39;slope_bound&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">),</span> <span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_wet_day_threshold</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">wet_day</span><span class="p">)</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;=</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nboot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">boot_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">probs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot</span><span class="p">)])</span>
                <span class="n">obsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot_q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obsq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="n">fitq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">nlls</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">nlls</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">obsq</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fitq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">obsq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">fitq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">intercept</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitq</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;slope_bound&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;slope_bound&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:,</span> <span class="n">col</span><span class="p">],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQmapRQUANT&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">,</span> <span class="s1">&#39;wet_day&#39;</span><span class="p">:</span> <span class="n">wet_day</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_Qmap.doQmapRQUANT">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmapRQUANT">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmapRQUANT</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">slope_bound</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply robust quantile mapping (RQUANT) correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmapRQUANT`.</span>
<span class="sd">        type : str, optional</span>
<span class="sd">            Interpolation kind for `interp1d` (default &#39;linear&#39;).</span>
<span class="sd">        slope_bound : list of float, optional</span>
<span class="sd">            Bounds for extrapolation slopes [min, max] (default [0, inf]).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">modq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">fitq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">low_slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;slope_bound&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">slope_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slope_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">high_slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;slope_bound&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">slope_bound</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slope_bound</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">xi_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
            <span class="n">mask_below</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">th_mod</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_below</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_above</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask_below</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">modq</span><span class="p">,</span> <span class="n">fitq</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_above</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">mask_above</span><span class="p">])</span>
            <span class="n">low_mask</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">modq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">low_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">low_slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">low_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">modq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">high_mask</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">modq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">high_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">high_slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">high_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">modq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_corrected</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_Qmap.fitQmapSSPLIN">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmapSSPLIN">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmapSSPLIN</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit quantile mapping using PCHIP smoothing splines (SSPLIN).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        wet_day : bool or float, optional</span>
<span class="sd">            Wet day handling (default False).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            Quantile step size (default 0.01).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including quantiles and thresholds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span> <span class="s1">&#39;fitq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">)),</span>
               <span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">),</span> <span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)}</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_wet_day_threshold</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">wet_day</span><span class="p">)</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;=</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQmapSSPLIN&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">,</span> <span class="s1">&#39;wet_day&#39;</span><span class="p">:</span> <span class="n">wet_day</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_Qmap.doQmapSSPLIN">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmapSSPLIN">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmapSSPLIN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply quantile mapping correction using PCHIP interpolator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmapSSPLIN`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">modq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">fitq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">xi_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
            <span class="n">mask_below</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">th_mod</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_below</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_above</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask_below</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="n">PchipInterpolator</span><span class="p">(</span><span class="n">modq</span><span class="p">,</span> <span class="n">fitq</span><span class="p">,</span> <span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_above</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">mask_above</span><span class="p">])</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_corrected</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_Qmap.fitQmapPTF">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmapPTF">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmapPTF</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">transfun</span><span class="o">=</span><span class="s1">&#39;power&#39;</span><span class="p">,</span> <span class="n">parini</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cost</span><span class="o">=</span><span class="s1">&#39;RSS&#39;</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit parametric transformation function (PTF) for bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        transfun : str or callable, optional</span>
<span class="sd">            Transformation function: &#39;power&#39;, &#39;power.x0&#39;, &#39;expasympt&#39;, &#39;expasympt.x0&#39;, &#39;scale&#39;, &#39;linear&#39;,</span>
<span class="sd">            or a custom callable (default &#39;power&#39;).</span>
<span class="sd">        parini : list, optional</span>
<span class="sd">            Initial parameter guesses for optimization.</span>
<span class="sd">        cost : str, optional</span>
<span class="sd">            Cost function for optimization: &#39;RSS&#39; or &#39;MAE&#39; (default &#39;RSS&#39;).</span>
<span class="sd">        wet_day : bool or float, optional</span>
<span class="sd">            Wet day handling (default False).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            If set, fit on quantiles with this step; else fit on sorted data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including transformation and thresholds.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown transfun or cost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;transfun&#39;</span><span class="p">:</span> <span class="n">transfun</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">),</span> <span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">)}</span>
        <span class="n">trans_funcs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="n">b</span><span class="p">,</span>
            <span class="s1">&#39;power.x0&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">,</span>
            <span class="s1">&#39;expasympt&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)),</span>
            <span class="s1">&#39;expasympt.x0&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)),</span>
            <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
            <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">transfun</span><span class="p">):</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">transfun</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">trans_funcs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transfun</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown transfun&quot;</span><span class="p">)</span>
            <span class="n">n_params</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_wet_day_threshold</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">wet_day</span><span class="p">)</span>
            <span class="n">th_obs</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_obs&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">wet_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;=</span> <span class="n">th_obs</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_params</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">qstep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
                <span class="n">oq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
                <span class="n">mq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
                <span class="n">oq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parini</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parini_guess</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parini_guess</span> <span class="o">=</span> <span class="n">parini</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">tf</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cost</span> <span class="o">==</span> <span class="s1">&#39;RSS&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">oq</span> <span class="o">-</span> <span class="n">pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cost</span> <span class="o">==</span> <span class="s1">&#39;MAE&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">oq</span> <span class="o">-</span> <span class="n">pred</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown cost&quot;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">parini_guess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQmapPTF&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">,</span> <span class="s1">&#39;wet_day&#39;</span><span class="p">:</span> <span class="n">wet_day</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_Qmap.doQmapPTF">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmapPTF">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmapPTF</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply parametric transformation (PTF) correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmapPTF`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown transfun in fobj.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="n">transfun</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;transfun&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">transfun</span><span class="p">):</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">transfun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trans_funcs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;power&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="n">b</span><span class="p">,</span>
                <span class="s1">&#39;power.x0&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="n">b</span><span class="p">,</span>
                <span class="s1">&#39;expasympt&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)),</span>
                <span class="s1">&#39;expasympt.x0&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)),</span>
                <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span>
            <span class="p">}</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">trans_funcs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">transfun</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown transfun&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">th_mod</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;wet_day_th_mod&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">xi_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
            <span class="n">mask_below</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="n">th_mod</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_below</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_above</span> <span class="o">=</span> <span class="o">~</span><span class="n">mask_below</span>
            <span class="n">xi_corrected</span><span class="p">[</span><span class="n">mask_above</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">(</span><span class="n">xi</span><span class="p">[</span><span class="n">mask_above</span><span class="p">],</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_corrected</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_Qmap.fitQmapDIST">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.fitQmapDIST">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQmapDIST</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="s1">&#39;berngamma&#39;</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit distribution-based quantile mapping (DIST).</span>

<span class="sd">        Uses Bernoulli for wet/dry and a continuous distribution for wet values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        distr : str, optional</span>
<span class="sd">            Wet distribution: &#39;berngamma&#39;, &#39;bernexp&#39;, &#39;bernlnorm&#39;, &#39;bernweibull&#39; (default &#39;berngamma&#39;).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            If set, fit on quantiles; else on full data.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional arguments (unused).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including distributions and transfer functions.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown distr.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;par_o&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;par_m&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;tfun&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;distr&#39;</span><span class="p">:</span> <span class="n">distr</span><span class="p">}</span>
        <span class="n">dist_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;berngamma&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;bernexp&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="p">,</span>
            <span class="s1">&#39;bernlnorm&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="p">,</span>
            <span class="s1">&#39;bernweibull&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">weibull_min</span>
        <span class="p">}</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dist_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">distr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown distr&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">qstep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">qstep</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="n">p_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_o</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">o_pos</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">distr</span> <span class="o">==</span> <span class="s1">&#39;bernlnorm&#39;</span><span class="p">:</span>
                    <span class="n">params_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_pos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_pos</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="n">p_o</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params_o</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">p_m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_pos</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">distr</span> <span class="o">==</span> <span class="s1">&#39;bernlnorm&#39;</span><span class="p">:</span>
                    <span class="n">params_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_pos</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_pos</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="n">p_m</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params_m</span><span class="p">}</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_o</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_m</span><span class="p">)</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">tfun</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">par_o</span><span class="o">=</span><span class="n">par_o</span><span class="p">,</span> <span class="n">par_m</span><span class="o">=</span><span class="n">par_m</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">par_m</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">cdf_m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">par_m</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">par_m</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">*</span><span class="n">par_m</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
                <span class="n">cdf_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cdf_m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">par_o</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cdf_m</span><span class="p">)</span>
                <span class="n">q_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cdf_m</span><span class="p">)</span>
                <span class="n">mask_wet</span> <span class="o">=</span> <span class="n">cdf_m</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">par_o</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">])</span>
                <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdf_m</span><span class="p">[</span><span class="n">mask_wet</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">par_o</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">par_o</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span>
                <span class="n">q_o</span><span class="p">[</span><span class="n">mask_wet</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="o">*</span><span class="n">par_o</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">q_o</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;tfun&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tfun</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQmapDIST&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">}</span></div>

    
<div class="viewcode-block" id="WAS_Qmap.doQmapDIST">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.doQmapDIST">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQmapDIST</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply distribution-based (DIST) correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQmapDIST`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">tfun</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;tfun&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tfun</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_Qmap.evaluate_bias_correction">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.evaluate_bias_correction">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_bias_correction</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">corrected</span><span class="p">,</span> <span class="n">wet_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">extreme_quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate bias correction performance with metrics for dry/wet days and extremes.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array_like or xarray.DataArray</span>
<span class="sd">            Observed data (numpy array or xarray.DataArray, shape (T, Y, X) or (T,)).</span>
<span class="sd">        mod : array_like or xarray.DataArray</span>
<span class="sd">            Modeled (uncorrected) data (same shape as obs).</span>
<span class="sd">        corrected : array_like or xarray.DataArray</span>
<span class="sd">            Bias-corrected data (same shape as obs).</span>
<span class="sd">        wet_threshold : float, optional</span>
<span class="sd">            Threshold for wet days (default 0.1 mm).</span>
<span class="sd">        extreme_quantiles : list of float, optional</span>
<span class="sd">            List of quantiles for extremes (default [0.95, 0.99]).</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or xarray.Dataset</span>
<span class="sd">            A dictionary with evaluation metrics, or xarray.Dataset if input is DataArray.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_xarray</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_xarray</span><span class="p">:</span>
            <span class="c1"># Compute metrics along time dimension, return spatial maps</span>
            <span class="n">dry_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">dry_mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">dry_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrected</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">wet_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">wet_mod</span> <span class="o">=</span> <span class="p">(</span><span class="n">mod</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">wet_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">corrected</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">mean_wet_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">mean_wet_mod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mod</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">mean_wet_corr</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corrected</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">ext_obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">extreme_quantiles</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">ext_mod</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">extreme_quantiles</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            <span class="n">ext_corr</span> <span class="o">=</span> <span class="n">corrected</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">extreme_quantiles</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
            
            <span class="n">ds_dry_wet</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span>
                <span class="s1">&#39;dry_fraction_obs&#39;</span><span class="p">:</span> <span class="n">dry_obs</span><span class="p">,</span>
                <span class="s1">&#39;dry_fraction_mod&#39;</span><span class="p">:</span> <span class="n">dry_mod</span><span class="p">,</span>
                <span class="s1">&#39;dry_fraction_corr&#39;</span><span class="p">:</span> <span class="n">dry_corr</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_obs&#39;</span><span class="p">:</span> <span class="n">wet_obs</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_mod&#39;</span><span class="p">:</span> <span class="n">wet_mod</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_corr&#39;</span><span class="p">:</span> <span class="n">wet_corr</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_obs&#39;</span><span class="p">:</span> <span class="n">mean_wet_obs</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_mod&#39;</span><span class="p">:</span> <span class="n">mean_wet_mod</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_corr&#39;</span><span class="p">:</span> <span class="n">mean_wet_corr</span>
            <span class="p">})</span>

            <span class="n">ds_extreme</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span>
                <span class="s1">&#39;extreme_quantiles_obs&#39;</span><span class="p">:</span> <span class="n">ext_obs</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles_mod&#39;</span><span class="p">:</span> <span class="n">ext_mod</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles_corr&#39;</span><span class="p">:</span> <span class="n">ext_corr</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="n">ds_dry_wet</span><span class="p">,</span> <span class="n">ds_extreme</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For numpy arrays, compute scalar metrics</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            
            <span class="n">dry_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span>
            <span class="n">dry_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mod</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span>
            <span class="n">dry_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corrected</span> <span class="o">&lt;=</span> <span class="n">wet_threshold</span><span class="p">)</span>
            
            <span class="n">wet_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span>
            <span class="n">wet_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mod</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span>
            <span class="n">wet_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corrected</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span>
            
            <span class="n">mean_wet_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">mean_wet_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mod</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">mean_wet_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corrected</span><span class="p">[</span><span class="n">corrected</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">corrected</span> <span class="o">&gt;</span> <span class="n">wet_threshold</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="n">ext_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">extreme_quantiles</span><span class="p">)</span>
            <span class="n">ext_mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">extreme_quantiles</span><span class="p">)</span>
            <span class="n">ext_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">corrected</span><span class="p">,</span> <span class="n">extreme_quantiles</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;dry_fraction_obs&#39;</span><span class="p">:</span> <span class="n">dry_obs</span><span class="p">,</span>
                <span class="s1">&#39;dry_fraction_mod&#39;</span><span class="p">:</span> <span class="n">dry_mod</span><span class="p">,</span>
                <span class="s1">&#39;dry_fraction_corr&#39;</span><span class="p">:</span> <span class="n">dry_corr</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_obs&#39;</span><span class="p">:</span> <span class="n">wet_obs</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_mod&#39;</span><span class="p">:</span> <span class="n">wet_mod</span><span class="p">,</span>
                <span class="s1">&#39;wet_fraction_corr&#39;</span><span class="p">:</span> <span class="n">wet_corr</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_obs&#39;</span><span class="p">:</span> <span class="n">mean_wet_obs</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_mod&#39;</span><span class="p">:</span> <span class="n">mean_wet_mod</span><span class="p">,</span>
                <span class="s1">&#39;mean_wet_corr&#39;</span><span class="p">:</span> <span class="n">mean_wet_corr</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles_obs&#39;</span><span class="p">:</span> <span class="n">ext_obs</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles_mod&#39;</span><span class="p">:</span> <span class="n">ext_mod</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles_corr&#39;</span><span class="p">:</span> <span class="n">ext_corr</span><span class="p">,</span>
                <span class="s1">&#39;extreme_quantiles&#39;</span><span class="p">:</span> <span class="n">extreme_quantiles</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="WAS_Qmap._add_basemap">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap._add_basemap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span></div>

<div class="viewcode-block" id="WAS_Qmap._collect_vars">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap._collect_vars">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_collect_vars</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span></div>

        
<div class="viewcode-block" id="WAS_Qmap.plot_fraction_group">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.plot_fraction_group">[docs]</a>
    <span class="nd">@staticmethod</span>    
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_fraction_group</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">group_prefix</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots dry/wet fraction groups (e.g., &#39;dry_fraction_&#39; or &#39;wet_fraction_&#39;).&quot;&quot;&quot;</span>
        <span class="n">vars_</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_collect_vars</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">group_prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vars_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No variables found for prefix &#39;</span><span class="si">{</span><span class="n">group_prefix</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span>
            <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># hide any empty axes</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_prefix</span><span class="si">}</span><span class="s2"> variables&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

        
<div class="viewcode-block" id="WAS_Qmap.plot_mean_wet_group">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.plot_mean_wet_group">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_mean_wet_group</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plots mean_wet_* variables.&quot;&quot;&quot;</span>
        <span class="n">vars_</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_collect_vars</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;mean_wet_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vars_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No &#39;mean_wet_&#39; variables found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span>
            <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">*</span><span class="n">ncols</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;mean_wet_* variables&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WAS_Qmap.plot_extreme_quantiles_group">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_Qmap.plot_extreme_quantiles_group">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_extreme_quantiles_group</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots extreme_quantiles_* variables, faceting by variable (columns) and quantile (rows).</span>
<span class="sd">        Assumes dims (&#39;quantile&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vars_</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_collect_vars</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;extreme_quantiles_&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vars_</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No &#39;extreme_quantiles_&#39; variables found&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    
        <span class="n">qvals</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quantile&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qvals</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset has no &#39;quantile&#39; coordinate required for extreme_quantiles_* variables.&quot;</span><span class="p">)</span>
    
        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qvals</span><span class="p">)</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vars_</span><span class="p">)</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span>
            <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span>
            <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_</span><span class="p">):</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">qvals</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                <span class="n">slice_da</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
                <span class="n">slice_da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">add_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">WAS_Qmap</span><span class="o">.</span><span class="n">_add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span>
                <span class="n">ttl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">  q=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ttl</span><span class="p">)</span>
        <span class="c1"># Column supertitles</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_</span><span class="p">):</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;extreme_quantiles_* by quantile&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="WAS_bias_correction">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WAS_bias_correction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bias correction methods for climate variables such as temperature or wind speed.</span>

<span class="sd">    This class provides static methods for fitting and applying bias correction</span>
<span class="sd">    techniques suitable for continuous variables that may include negative values</span>
<span class="sd">    or skewed positive values, such as mean adjustment, variance scaling, empirical</span>
<span class="sd">    quantile mapping (non-parametric), and parametric mapping assuming various</span>
<span class="sd">    distributions (normal, lognormal, gamma, weibull). The methods support both</span>
<span class="sd">    NumPy arrays (1D, 2D, or 3D) and xarray DataArrays (3D: time, lat, lon or similar).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Inputs can be negative and are treated as continuous, but for positive skewed data</span>
<span class="sd">      like wind speed, use distributions like &#39;lognormal&#39;, &#39;gamma&#39;, or &#39;weibull&#39;.</span>
<span class="sd">    - No handling for wet/dry days.</span>
<span class="sd">    - For gridded data, computations are performed column-wise (per grid cell).</span>
<span class="sd">    - xarray support preserves coordinates and attributes.</span>
<span class="sd">    - Non-parametric method: &#39;QUANT&#39; (empirical quantile mapping).</span>
<span class="sd">    - Parametric methods: &#39;NORM&#39; (normal), or &#39;DIST&#39; with specified distribution.</span>
<span class="sd">    - Handles NaNs: Ignores NaNs in fitting by filtering them out; if fewer than 2 valid points</span>
<span class="sd">      per grid cell in obs or mod, flags as all_nan and outputs NaNs for that grid in application.</span>
<span class="sd">      NaNs in input data during application are propagated as NaNs in output.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WAS_bias_correction.fitBC">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.fitBC">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitBC</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a bias correction model using the specified method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : array_like or xarray.DataArray</span>
<span class="sd">            Observed data. If array_like, can be 1D (time), 2D (time, grid), or 3D (time, y, x).</span>
<span class="sd">            If xarray.DataArray, must be 3D with dimensions (time, y, x).</span>
<span class="sd">        mod : array_like or xarray.DataArray</span>
<span class="sd">            Modeled data to fit against, same shape as `obs`.</span>
<span class="sd">        method : str</span>
<span class="sd">            Bias correction method. Options: &#39;MEAN&#39;, &#39;VARSCALE&#39;, &#39;QUANT&#39;, &#39;NORM&#39;, &#39;DIST&#39; (case-insensitive).</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments passed to the specific fitting method.</span>
<span class="sd">            For &#39;DIST&#39;, include &#39;distr&#39; (e.g., &#39;lognormal&#39;, &#39;gamma&#39;, &#39;weibull&#39;, default &#39;normal&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted object containing parameters, class identifier, and metadata for applying correction.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If shapes mismatch, invalid dimensions, or unknown method.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        doBC : Apply the fitted bias correction to new data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_xarray</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">)</span>
        <span class="n">original_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time_dim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">spatial_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">is_xarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">mod</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xarray DataArrays must be 3D with matching shapes and dimensions (T, Y, X)&quot;</span><span class="p">)</span>
            <span class="n">time_dim</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">obs_stacked</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">mod_stacked</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="n">obs_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">mod_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">coords</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">original_dims</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">dims</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obs_data</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
            <span class="n">mod_data</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;MEAN&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">fitMean</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;VARSCALE&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">fitVarscale</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;QUANT&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">fitQuant</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;NORM&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">fitDist</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;DIST&#39;</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">fitDist</span><span class="p">(</span><span class="n">obs_data</span><span class="p">,</span> <span class="n">mod_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">is_xarray</span><span class="p">:</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;is_xarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_dim</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spatial_dims</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrs</span>
            <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;original_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_dims</span>
        <span class="k">return</span> <span class="n">fobj</span></div>


<div class="viewcode-block" id="WAS_bias_correction.doBC">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.doBC">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doBC</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the fitted bias correction to new data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array_like or xarray.DataArray</span>
<span class="sd">            New modeled data to correct, same format and shape structure as fitting data.</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitBC`.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional keyword arguments passed to the specific application method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like or xarray.DataArray</span>
<span class="sd">            Bias-corrected data, same type and shape as `x`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If input types or dimensions mismatch the fitted object.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        fitBC : Fit the bias correction model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;is_xarray&#39;</span> <span class="ow">in</span> <span class="n">fobj</span> <span class="ow">and</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;is_xarray&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input x must be xarray.DataArray when fitted with DataArray&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input x must have matching spatial dimensions&quot;</span><span class="p">)</span>
            <span class="n">time_dim</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;time_dim&#39;</span><span class="p">]</span>
            <span class="n">spatial_dims</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;spatial_dims&#39;</span><span class="p">]</span>
            <span class="n">x_stacked</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">spatial_dims</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">values</span>
            <span class="n">corrected_data</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">_doBC_internal</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">corrected_stacked</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">corrected_data</span><span class="p">,</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="n">time_dim</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">),</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span> <span class="n">x_stacked</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">corrected_stacked</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;attrs&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">corrected</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">_to_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">_doBC_internal</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>


<div class="viewcode-block" id="WAS_bias_correction._doBC_internal">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction._doBC_internal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_doBC_internal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal helper to apply bias correction based on fitted class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D array of data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Additional arguments for specific methods.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected 2D array.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown fitted class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitMean&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">doMean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitVarscale&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">doVarscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitQuant&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">doQuant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">cls</span> <span class="o">==</span> <span class="s1">&#39;fitDist&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">WAS_bias_correction</span><span class="o">.</span><span class="n">doDist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown class: </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_bias_correction._to_2d">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction._to_2d">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert input array to 2D (time, grid) format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arr : array_like</span>
<span class="sd">            Input array (0D to 3D).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            2D array.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If more than 3 dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Numpy array must be 1D, 2D, or 3D&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="WAS_bias_correction.fitMean">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.fitMean">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitMean</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit mean additive bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including delta (mean difference).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="s1">&#39;all_nan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">o_valid</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span>
            <span class="n">m_valid</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitMean&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_bias_correction.doMean">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.doMean">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doMean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply mean additive bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitMean`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;delta&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_bias_correction.fitVarscale">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.fitVarscale">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitVarscale</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit variance scaling bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including means and standard deviations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean_o&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="s1">&#39;std_o&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
               <span class="s1">&#39;mean_m&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="s1">&#39;std_m&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
               <span class="s1">&#39;all_nan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">o_valid</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span>
            <span class="n">m_valid</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;mean_o&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;std_o&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;mean_m&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span>
            <span class="n">std_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;std_m&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_m</span> <span class="k">if</span> <span class="n">std_m</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitVarscale&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_bias_correction.doVarscale">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.doVarscale">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doVarscale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply variance scaling bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitVarscale`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;mean_o&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;mean_m&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="s1">&#39;std_o&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;std_m&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_bias_correction.fitQuant">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.fitQuant">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitQuant</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">nboot</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit empirical quantile mapping (non-parametric).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        qstep : float, optional</span>
<span class="sd">            Quantile step size (default 0.01).</span>
<span class="sd">        nboot : int, optional</span>
<span class="sd">            Number of bootstrap samples for observed quantiles (default 1, no bootstrap).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including quantiles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">qstep</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;modq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="s1">&#39;fitq&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nq</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
               <span class="s1">&#39;all_nan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nq</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">o_valid</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span>
            <span class="n">m_valid</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">m_valid</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nboot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">boot_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">o_valid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_valid</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">probs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nboot</span><span class="p">)])</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">boot_q</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">o_valid</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitQuant&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_bias_correction.doQuant">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.doQuant">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doQuant</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply empirical quantile mapping correction (non-parametric).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitQuant`.</span>
<span class="sd">        type : str, optional</span>
<span class="sd">            Interpolation kind for `interp1d` (default &#39;linear&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">modq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;modq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">fitq</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;fitq&#39;</span><span class="p">][:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">interp_func</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">modq</span><span class="p">,</span> <span class="n">fitq</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_func</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corrected</span></div>


<div class="viewcode-block" id="WAS_bias_correction.fitDist">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.fitDist">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fitDist</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit parametric bias correction assuming a specified distribution.</span>

<span class="sd">        Suitable for skewed data like wind speed with &#39;lognormal&#39;, &#39;gamma&#39;, or &#39;weibull&#39;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obs : ndarray</span>
<span class="sd">            2D observed data (time, grid).</span>
<span class="sd">        mod : ndarray</span>
<span class="sd">            2D modeled data (time, grid).</span>
<span class="sd">        distr : str, optional</span>
<span class="sd">            Distribution: &#39;normal&#39;, &#39;lognormal&#39;, &#39;gamma&#39;, &#39;weibull&#39; (default &#39;normal&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Fitted parameters including distribution parameters.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If unknown distribution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;par_o&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;par_m&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;distr&#39;</span><span class="p">:</span> <span class="n">distr</span><span class="p">,</span>
               <span class="s1">&#39;all_nan&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>
        <span class="n">dist_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span>
            <span class="s1">&#39;lognormal&#39;</span><span class="p">:</span> <span class="n">lognorm</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;weibull&#39;</span><span class="p">:</span> <span class="n">weibull_min</span>
        <span class="p">}</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dist_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">distr</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown distribution: </span><span class="si">{</span><span class="n">distr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">o_valid</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span>
            <span class="n">m_valid</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">distr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">distr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lognormal&#39;</span><span class="p">:</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_valid</span><span class="p">)</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_valid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">distr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_valid</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_valid</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">distr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;weibull&#39;</span><span class="p">:</span>
                <span class="n">par_o</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">o_valid</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">par_m</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">m_valid</span><span class="p">,</span> <span class="n">floc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_o</span><span class="p">)</span>
            <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">par_m</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;fitDist&#39;</span><span class="p">,</span> <span class="s1">&#39;par&#39;</span><span class="p">:</span> <span class="n">par</span><span class="p">}</span></div>


<div class="viewcode-block" id="WAS_bias_correction.doDist">
<a class="viewcode-back" href="../../api.html#wass2s.was_bias_correction.WAS_bias_correction.doDist">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">doDist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fobj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply parametric distribution bias correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : ndarray</span>
<span class="sd">            2D data to correct (time, grid).</span>
<span class="sd">        fobj : dict</span>
<span class="sd">            Fitted object from `fitDist`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray</span>
<span class="sd">            Corrected data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">par</span> <span class="o">=</span> <span class="n">fobj</span><span class="p">[</span><span class="s1">&#39;par&#39;</span><span class="p">]</span>
        <span class="n">distr</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;distr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">dist_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;normal&#39;</span><span class="p">:</span> <span class="n">norm</span><span class="p">,</span>
            <span class="s1">&#39;lognormal&#39;</span><span class="p">:</span> <span class="n">lognorm</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="n">gamma</span><span class="p">,</span>
            <span class="s1">&#39;weibull&#39;</span><span class="p">:</span> <span class="n">weibull_min</span>
        <span class="p">}</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dist_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">distr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown distribution: </span><span class="si">{</span><span class="n">distr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;all_nan&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">par_o</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_o&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">par_m</span> <span class="o">=</span> <span class="n">par</span><span class="p">[</span><span class="s1">&#39;par_m&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="o">*</span><span class="n">par_m</span><span class="p">)</span>
            <span class="n">cdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">corrected</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">cdf</span><span class="p">,</span> <span class="o">*</span><span class="n">par_o</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">corrected</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>