

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.utils &mdash; wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel. 0.3.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=1e28cc32"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">calendar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.offsetbox</span><span class="w"> </span><span class="kn">import</span>  <span class="p">(</span><span class="n">OffsetImage</span><span class="p">,</span> <span class="n">AnnotationBbox</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1.inset_locator</span><span class="w"> </span><span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpimg</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.image</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xeofs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xe</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rioxarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rioxr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_compute_predictand</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_bias_correction</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fitter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cdsapi</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">(</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">InsecureRequestWarning</span><span class="p">)</span>


<div class="viewcode-block" id="decode_cf">
<a class="viewcode-back" href="../../api.html#wass2s.utils.decode_cf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">time_var</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode time dimension to CFTime standards.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xarray.Dataset</span>
<span class="sd">        Input dataset containing the time variable to decode.</span>
<span class="sd">    time_var : str</span>
<span class="sd">        Name of the time variable in the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset</span>
<span class="sd">        Dataset with decoded time dimension adhering to CFTime standards.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If the calendar attribute of the time variable is &#39;360&#39;, it is converted to &#39;360_day&#39;</span>
<span class="sd">    to ensure compatibility with CFTime decoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ds</span><span class="p">[</span><span class="n">time_var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;calendar&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;360&quot;</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="n">time_var</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;calendar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;360_day&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">decode_cf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="to_iridl_lat">
<a class="viewcode-back" href="../../api.html#wass2s.utils.to_iridl_lat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_iridl_lat</span><span class="p">(</span><span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert numeric latitude to IRIDL latitude string format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat : float</span>
<span class="sd">        Latitude value in degrees (positive for North, negative for South).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        IRIDL-formatted latitude string (e.g., &#39;10N&#39; for +10, &#39;5S&#39; for -5).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; to_iridl_lat(10)</span>
<span class="sd">    &#39;10N&#39;</span>
<span class="sd">    &gt;&gt;&gt; to_iridl_lat(-5)</span>
<span class="sd">    &#39;5S&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abs_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span> <span class="k">if</span> <span class="n">lat</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;S&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abs_val</span><span class="si">:</span><span class="s2">g</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="to_iridl_lon">
<a class="viewcode-back" href="../../api.html#wass2s.utils.to_iridl_lon">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">to_iridl_lon</span><span class="p">(</span><span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert numeric longitude to IRIDL longitude string format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lon : float</span>
<span class="sd">        Longitude value in degrees (positive for East, negative for West).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        IRIDL-formatted longitude string (e.g., &#39;15E&#39; for +15, &#39;15W&#39; for -15).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; to_iridl_lon(15)</span>
<span class="sd">    &#39;15E&#39;</span>
<span class="sd">    &gt;&gt;&gt; to_iridl_lon(-15)</span>
<span class="sd">    &#39;15W&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abs_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;E&quot;</span> <span class="k">if</span> <span class="n">lon</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;W&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abs_val</span><span class="si">:</span><span class="s2">g</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="build_iridl_url_ersst">
<a class="viewcode-back" href="../../api.html#wass2s.utils.build_iridl_url_ersst">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_iridl_url_ersst</span><span class="p">(</span>
    <span class="n">year_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">year_end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">bbox</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">run_avg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">month_start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
    <span class="n">month_end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a parameterized IRIDL URL for NOAA ERSST dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year for the data request.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year for the data request.</span>
<span class="sd">    bbox : list</span>
<span class="sd">        Bounding box coordinates in the format [North, West, South, East].</span>
<span class="sd">    run_avg : int, optional</span>
<span class="sd">        Number of time steps for running average (default is 3). If None, no running average is applied.</span>
<span class="sd">    month_start : str, optional</span>
<span class="sd">        Starting month for the time range (default is &#39;Jan&#39;).</span>
<span class="sd">    month_end : str, optional</span>
<span class="sd">        Ending month for the time range (default is &#39;Dec&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Constructed IRIDL URL for accessing NOAA ERSST data.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The bounding box is reordered to match IRIDL&#39;s expected format: Y/(south)/(north)/, X/(west)/(east)/.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">north</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">bbox</span>
    <span class="n">south_str</span> <span class="o">=</span> <span class="n">to_iridl_lat</span><span class="p">(</span><span class="n">south</span><span class="p">)</span>
    <span class="n">north_str</span> <span class="o">=</span> <span class="n">to_iridl_lat</span><span class="p">(</span><span class="n">north</span><span class="p">)</span>
    <span class="n">west_str</span> <span class="o">=</span> <span class="n">to_iridl_lon</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="n">east_str</span> <span class="o">=</span> <span class="n">to_iridl_lon</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">t_start_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_start</span><span class="si">}</span><span class="s2">%20</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">t_end_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">month_end</span><span class="si">}</span><span class="s2">%20</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">time_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;T/(</span><span class="si">{</span><span class="n">t_start_str</span><span class="si">}</span><span class="s2">)/(</span><span class="si">{</span><span class="n">t_end_str</span><span class="si">}</span><span class="s2">)/RANGEEDGES/&quot;</span>
    <span class="n">latlon_part</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Y/(</span><span class="si">{</span><span class="n">south_str</span><span class="si">}</span><span class="s2">)/(</span><span class="si">{</span><span class="n">north_str</span><span class="si">}</span><span class="s2">)/RANGEEDGES/&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;X/(</span><span class="si">{</span><span class="n">west_str</span><span class="si">}</span><span class="s2">)/(</span><span class="si">{</span><span class="n">east_str</span><span class="si">}</span><span class="s2">)/RANGEEDGES/&quot;</span>
    <span class="p">)</span>
    <span class="n">runavg_part</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;T/</span><span class="si">{</span><span class="n">run_avg</span><span class="si">}</span><span class="s2">/runningAverage/&quot;</span> <span class="k">if</span> <span class="n">run_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;https://iridl.ldeo.columbia.edu/&quot;</span>
        <span class="s2">&quot;SOURCES/.NOAA/.NCDC/.ERSST/.version5/.sst/&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time_part</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">latlon_part</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">runavg_part</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="s2">&quot;dods&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span></div>


<div class="viewcode-block" id="fix_time_coord">
<a class="viewcode-back" href="../../api.html#wass2s.utils.fix_time_coord">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_time_coord</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">seas</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix time coordinates by extracting year and assigning a fixed month/day.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xarray.Dataset</span>
<span class="sd">        Input dataset with time dimension &#39;T&#39;.</span>
<span class="sd">    seas : tuple</span>
<span class="sd">        Tuple containing season information, where seas[1] is the month (e.g., &#39;11&#39; for November).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset</span>
<span class="sd">        Dataset with updated time coordinates in the format &#39;YYYY-MM-01&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Assumes the input dataset&#39;s time values can be converted to pandas datetime objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">year</span>
    <span class="n">new_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">seas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-01&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">years</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">new_dates</span><span class="p">))</span>
    <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="download_file">
<a class="viewcode-back" href="../../api.html#wass2s.utils.download_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file from a URL to a local path with progress tracking.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL of the file to download.</span>
<span class="sd">    local_path : str or pathlib.Path</span>
<span class="sd">        Local path where the file will be saved.</span>
<span class="sd">    force_download : bool, optional</span>
<span class="sd">        If True, overwrite existing file (default is False).</span>
<span class="sd">    chunk_size : int, optional</span>
<span class="sd">        Size of chunks for streaming download (default is 8192 bytes).</span>
<span class="sd">    timeout : int, optional</span>
<span class="sd">        Timeout for the HTTP request in seconds (default is 120).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pathlib.Path or None</span>
<span class="sd">        Path to the downloaded file, or None if download fails.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Skips download if the file already exists and `force_download` is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">local_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_download</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_path</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DOWNLOAD] </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-length&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total_size</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">progress</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                        <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SUCCESS] Downloaded to </span><span class="si">{</span><span class="n">local_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">local_path</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERROR] Could not download </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="parse_variable">
<a class="viewcode-back" href="../../api.html#wass2s.utils.parse_variable">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract center and variable names from a variable string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        A tuple containing (center, variable).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; parse_variable(&quot;NOAA.SST&quot;)</span>
<span class="sd">    (&#39;NOAA&#39;, &#39;SST&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">variables_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="n">variables_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">center</span><span class="p">,</span> <span class="n">variable</span></div>


<div class="viewcode-block" id="standardize_timeseries">
<a class="viewcode-back" href="../../api.html#wass2s.utils.standardize_timeseries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standardize a dataset over a specified climatology period.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Input dataset or data array to standardize.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year of the climatology period. If None, uses the full time range.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year of the climatology period. If None, uses the full time range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Standardized dataset or data array (z-scores).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Standardization is performed as (ds - mean) / std, where mean and std are</span>
<span class="sd">    computed over the specified climatology period or the entire time dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clim_year_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clim_year_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ds</span> <span class="o">-</span> <span class="n">clim_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">clim_std</span></div>


<div class="viewcode-block" id="reverse_standardize">
<a class="viewcode-back" href="../../api.html#wass2s.utils.reverse_standardize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reverse_standardize</span><span class="p">(</span><span class="n">ds_st</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reverse standardization of a dataset to original units.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds_st : xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Standardized dataset or data array (z-scores).</span>
<span class="sd">    ds : xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Original dataset used to compute standardization parameters.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year of the climatology period. If None, uses the full time range.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year of the climatology period. If None, uses the full time range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Dataset or data array in original units.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Reverses standardization using ds_st * std + mean, where mean and std are</span>
<span class="sd">    computed from the original dataset over the specified period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clim_year_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clim_year_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">clim_std</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds_st</span> <span class="o">*</span> <span class="n">clim_std</span> <span class="o">+</span> <span class="n">clim_mean</span></div>


<div class="viewcode-block" id="anomalize_timeseries">
<a class="viewcode-back" href="../../api.html#wass2s.utils.anomalize_timeseries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">anomalize_timeseries</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute anomalies by subtracting the climatological mean.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Input dataset or data array.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year of the climatology period. If None, uses the full time range.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year of the climatology period. If None, uses the full time range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Anomalized dataset or data array (ds - mean).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Anomalies are computed as ds - mean, where mean is calculated over the</span>
<span class="sd">    specified climatology period or the entire time dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clim_year_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">clim_year_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">clim_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">clim_slice</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clim_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span> <span class="o">-</span> <span class="n">clim_mean</span></div>


<div class="viewcode-block" id="predictant_mask">
<a class="viewcode-back" href="../../api.html#wass2s.utils.predictant_mask">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">predictant_mask</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a mask for predictand data based on rainfall thresholds and latitude.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : xarray.DataArray</span>
<span class="sd">        Input data array with a time dimension &#39;T&#39; and spatial dimensions &#39;Y&#39;, &#39;X&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Mask with 1 where conditions are met, NaN elsewhere.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The mask is set to 1 where mean rainfall &gt; 20 mm and latitude is within Â±19.5 degrees,</span>
<span class="sd">    otherwise NaN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean_rainfall</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean_rainfall</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">19.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="trend_data">
<a class="viewcode-back" href="../../api.html#wass2s.utils.trend_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">trend_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute trends in data using ExtendedEOF.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : xarray.DataArray</span>
<span class="sd">        Input data array with time dimension &#39;T&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Trended data array based on the first mode of ExtendedEOF.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If ExtendedEOF fitting fails.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Missing values are filled with the time mean before fitting.</span>
<span class="sd">    Uses ExtendedEOF with specified parameters (n_modes=2, tau=1, embedding=3, n_pca_modes=20).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data_filled</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">eeof</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">single</span><span class="o">.</span><span class="n">ExtendedEOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">embedding</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_pca_modes</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">eeof</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_filled</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
        <span class="n">scores_ext</span> <span class="o">=</span> <span class="n">eeof</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span>
        <span class="n">data_trends</span> <span class="o">=</span> <span class="n">eeof</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">scores_ext</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data_trends</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to detrend data using ExtendedEOF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="prepare_predictand">
<a class="viewcode-back" href="../../api.html#wass2s.utils.prepare_predictand">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_predictand</span><span class="p">(</span><span class="n">dir_to_save_Obs</span><span class="p">,</span> <span class="n">variables_obs</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">daily</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s2">&quot;prcp&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the predictand dataset from observational data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save_Obs : str</span>
<span class="sd">        Directory path where observational data is stored.</span>
<span class="sd">    variables_obs : list</span>
<span class="sd">        List containing the variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list, optional</span>
<span class="sd">        List of month numbers defining the season (e.g., [6, 7, 8] for JJA).</span>
<span class="sd">    ds : bool, optional</span>
<span class="sd">        If True, return dataset without converting to array (default is True).</span>
<span class="sd">    daily : bool, optional</span>
<span class="sd">        If True, load daily data; otherwise, load seasonal data (default is False).</span>
<span class="sd">    param : Indicate parameter name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset or xarray.DataArray</span>
<span class="sd">        Prepared predictand dataset or data array.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Applies a mask for non-daily data based on rainfall thresholds and latitude.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_obs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">daily</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_save_Obs</span><span class="si">}</span><span class="s1">/Daily_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">.nc&#39;</span>
        <span class="n">rainfall</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">rainfall</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rainfall</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rainfall</span><span class="p">)</span>
        <span class="n">rainfall</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_save_Obs</span><span class="si">}</span><span class="s1">/Obs_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
        <span class="n">rainfall</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">mean_rainfall</span> <span class="o">=</span> <span class="n">rainfall</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mean_rainfall</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">rainfall</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rainfall</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">rainfall</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rainfall</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check in future how to define the variable name other than &#39;prcp&#39;</span>
        <span class="k">return</span> <span class="n">rainfall</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_gridded_predictor">
<a class="viewcode-back" href="../../api.html#wass2s.utils.load_gridded_predictor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_gridded_predictor</span><span class="p">(</span><span class="n">dir_to_data</span><span class="p">,</span> <span class="n">variables_list</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load gridded predictor data for reanalysis or model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_data : str</span>
<span class="sd">        Directory path where predictor data is stored.</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list, optional</span>
<span class="sd">        List of month numbers defining the season.</span>
<span class="sd">    model : bool, optional</span>
<span class="sd">        If True, load model data (hindcast/forecast); otherwise, load reanalysis data (default is False).</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of model initialization (required if model=True).</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months (required if model=True).</span>
<span class="sd">    year_forecast : int, optional</span>
<span class="sd">        Forecast year (required for forecast data if model=True).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Loaded predictor data array renamed to &#39;predictor&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Converts dataset to data array, drops &#39;variable&#39; dimension, and ensures datetime64[ns] time coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">abb_month_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span> <span class="ow">or</span> <span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span> <span class="k">if</span> <span class="n">year_forecast</span> <span class="k">else</span> <span class="s2">&quot;hindcast&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">predictor</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predictor</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;predictor&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_sst_indices">
<a class="viewcode-back" href="../../api.html#wass2s.utils.compute_sst_indices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_sst_indices</span><span class="p">(</span><span class="n">dir_to_data</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">variables_list</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">others_zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Sea Surface Temperature (SST) indices for reanalysis or model data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_data : str</span>
<span class="sd">        Directory path where data is stored.</span>
<span class="sd">    indices : list</span>
<span class="sd">        List of SST indices to compute (e.g., [&#39;NINO34&#39;, &#39;TNA&#39;]).</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list</span>
<span class="sd">        List of month numbers defining the season.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    others_zone : dict, optional</span>
<span class="sd">        Additional custom zones for SST indices with coordinates.</span>
<span class="sd">    model : bool, optional</span>
<span class="sd">        If True, load model data; otherwise, load reanalysis data (default is False).</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months.</span>
<span class="sd">    year_forecast : int, optional</span>
<span class="sd">        Forecast year.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset</span>
<span class="sd">        Dataset containing computed SST indices as variables.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Derived indices like &#39;TASI&#39; and &#39;DMI&#39; are computed as differences of other indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">abb_month_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span> <span class="ow">or</span> <span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span> <span class="k">if</span> <span class="n">year_forecast</span> <span class="k">else</span> <span class="s2">&quot;hindcast&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
    <span class="n">sst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">sst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sst_indices_name</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">,</span> <span class="s2">&quot;DMI&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">sst_indices_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">sst_region</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sst_region</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">sst_region</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_region</span>
    <span class="k">if</span> <span class="n">others_zone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">others_zone</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">others_zone</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="n">sst_region</span> <span class="o">=</span> <span class="n">sst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">])</span>
            <span class="n">sst_region</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">sst_region</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
            <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sst_region</span>
    <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;TASI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;NAT&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SAT&quot;</span><span class="p">]</span>
    <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;DMI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;WTIO&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictor</span><span class="p">[</span><span class="s2">&quot;SETIO&quot;</span><span class="p">]</span>
    <span class="n">selected_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">predictor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">}</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ds</span><span class="p">[</span><span class="n">variable</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">selected_indices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">combined_dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined_dataset</span></div>


<div class="viewcode-block" id="compute_other_indices">
<a class="viewcode-back" href="../../api.html#wass2s.utils.compute_other_indices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_other_indices</span><span class="p">(</span><span class="n">dir_to_data</span><span class="p">,</span> <span class="n">indices_dict</span><span class="p">,</span> <span class="n">variables_list</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute indices for non-SST variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_data : str</span>
<span class="sd">        Directory path where data is stored.</span>
<span class="sd">    indices_dict : dict</span>
<span class="sd">        Dictionary mapping index names to coordinates (label, lon_min, lon_max, lat_min, lat_max).</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list</span>
<span class="sd">        List of month numbers defining the season.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    model : bool, optional</span>
<span class="sd">        If True, load model data; otherwise, load reanalysis data (default is False).</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months.</span>
<span class="sd">    year_forecast : int, optional</span>
<span class="sd">        Forecast year.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.Dataset</span>
<span class="sd">        Dataset containing computed indices as variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">abb_month_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span> <span class="ow">or</span> <span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">file_prefix</span> <span class="o">=</span> <span class="s2">&quot;forecast&quot;</span> <span class="k">if</span> <span class="n">year_forecast</span> <span class="k">else</span> <span class="s2">&quot;hindcast&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">indices_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="n">var_region</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">])</span>
        <span class="n">var_region</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">var_region</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_region</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">predictor</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">combined_dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">data_vars</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined_dataset</span></div>


<div class="viewcode-block" id="retrieve_several_zones_for_PCR">
<a class="viewcode-back" href="../../api.html#wass2s.utils.retrieve_several_zones_for_PCR">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_several_zones_for_PCR</span><span class="p">(</span><span class="n">dir_to_data</span><span class="p">,</span> <span class="n">indices_dict</span><span class="p">,</span> <span class="n">variables_list</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve data for multiple zones for Principal Component Regression (PCR).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_data : str</span>
<span class="sd">        Directory path where data is stored.</span>
<span class="sd">    indices_dict : dict</span>
<span class="sd">        Dictionary mapping index names to coordinates (label, lon_min, lon_max, lat_min, lat_max).</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list</span>
<span class="sd">        List of month numbers defining the season.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    model : bool, optional</span>
<span class="sd">        If True, load model data (hindcast and forecast); otherwise, load reanalysis data (default is False).</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months.</span>
<span class="sd">    year_forecast : int, optional</span>
<span class="sd">        Forecast year.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        List of xarray.DataArray objects, each representing a standardized region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">abb_month_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span> <span class="ow">or</span> <span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">filepath_hdcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        <span class="n">filepath_fcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        <span class="n">data_hdcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath_hdcst</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data_hdcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_hdcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">data_fcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath_fcst</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data_fcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_fcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_hdcst</span><span class="p">,</span> <span class="n">data_fcst</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
    <span class="n">predictor</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">indices_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="n">var_region</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
        <span class="n">var_region</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">var_region</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">predictor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_region</span>
    <span class="n">data_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">predictor</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">data_vars</span></div>


<div class="viewcode-block" id="retrieve_single_zone_for_PCR">
<a class="viewcode-back" href="../../api.html#wass2s.utils.retrieve_single_zone_for_PCR">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_single_zone_for_PCR</span><span class="p">(</span><span class="n">dir_to_data</span><span class="p">,</span> <span class="n">indices_dict</span><span class="p">,</span> <span class="n">variables_list</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_forecast</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve data for a single zone for Principal Component Regression (PCR) with interpolation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_data : str</span>
<span class="sd">        Directory path where data is stored.</span>
<span class="sd">    indices_dict : dict</span>
<span class="sd">        Dictionary mapping a single index name to coordinates (label, lon_min, lon_max, lat_min, lat_max).</span>
<span class="sd">    variables_list : str</span>
<span class="sd">        Variable string in the format &#39;center.variable&#39;.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the data.</span>
<span class="sd">    season : list, optional</span>
<span class="sd">        List of month numbers defining the season.</span>
<span class="sd">    clim_year_start : int, optional</span>
<span class="sd">        Start year for climatology period.</span>
<span class="sd">    clim_year_end : int, optional</span>
<span class="sd">        End year for climatology period.</span>
<span class="sd">    model : bool, optional</span>
<span class="sd">        If True, load model data (hindcast and forecast); otherwise, load reanalysis data (default is False).</span>
<span class="sd">    month_of_initialization : int, optional</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    lead_time : list, optional</span>
<span class="sd">        List of lead times in months.</span>
<span class="sd">    year_forecast : int, optional</span>
<span class="sd">        Forecast year.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Standardized and interpolated data array for the specified region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">variable</span> <span class="o">=</span> <span class="n">parse_variable</span><span class="p">(</span><span class="n">variables_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">abb_month_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">))</span> <span class="o">%</span> <span class="mi">12</span> <span class="ow">or</span> <span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lead_time</span><span class="p">])</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">filepath_hdcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        <span class="c1">### A revoir</span>
        <span class="n">filepath_fcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_month_ini</span><span class="si">}</span><span class="s2">Ic_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">lead_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.nc&quot;</span>
        <span class="n">data_hdcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath_hdcst</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data_hdcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_hdcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="c1">### A revoir</span>
        <span class="n">data_fcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath_fcst</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data_fcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_fcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_hdcst</span><span class="p">,</span> <span class="n">data_fcst</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">season_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)]</span> <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="n">season</span><span class="p">])</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dir_to_data</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">center</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_start</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">year_end</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">season_str</span><span class="si">}</span><span class="s1">.nc&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>

    <span class="n">new_resolution</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">anomalize_timeseries</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">indices_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">,</span> <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="n">var_region</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span><span class="p">),</span> <span class="n">Y</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span><span class="p">))</span>
        <span class="n">Y_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="n">X_new</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_resolution</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]),</span> <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="n">data_vars</span> <span class="o">=</span> <span class="n">var_region</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">Y_new</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X_new</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_vars</span></div>


<div class="viewcode-block" id="plot_map">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_map</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Map&quot;</span><span class="p">,</span> <span class="n">sst_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a map with specified geographic extent and optional SST index boxes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    extent : list</span>
<span class="sd">        Geographic extent in the format [west, east, south, north].</span>
<span class="sd">    title : str, optional</span>
<span class="sd">        Title of the map (default is &#39;Map&#39;).</span>
<span class="sd">    sst_indices : dict, optional</span>
<span class="sd">        Dictionary containing SST index information with keys as index names and</span>
<span class="sd">        values as tuples (label, lon_w, lon_e, lat_s, lat_n).</span>
<span class="sd">    fig_size : tuple, optional</span>
<span class="sd">        Figure size as (width, height) in inches (default is (10, 8)).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses Cartopy for map projection and Matplotlib for plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()},</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sst_indices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">lon_w</span><span class="p">,</span> <span class="n">lon_e</span><span class="p">,</span> <span class="n">lat_s</span><span class="p">,</span> <span class="n">lat_n</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sst_indices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">lon_w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">lon_w</span><span class="p">,</span> <span class="n">lat_s</span><span class="p">),</span> <span class="n">lon_e</span> <span class="o">-</span> <span class="n">lon_w</span><span class="p">,</span> <span class="n">lat_n</span> <span class="o">-</span> <span class="n">lat_s</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lon_w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lat_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_best_models">
<a class="viewcode-back" href="../../api.html#wass2s.utils.get_best_models">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_best_models</span><span class="p">(</span><span class="n">center_variable</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;MAE&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">gcm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">agroparam</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hydro</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># 1. Provide default thresholds if none given</span>
    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pearson&#39;</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;groc&#39;</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">### To complete</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>  <span class="c1"># or any other default you prefer</span>
    
    <span class="c1"># 2. Check if the given metric is in scores</span>
    <span class="n">metric_key</span> <span class="o">=</span> <span class="n">metric</span>  <span class="c1"># for direct indexing</span>
    <span class="k">if</span> <span class="n">metric_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metric &#39;</span><span class="si">{</span><span class="n">metric_key</span><span class="si">}</span><span class="s2">&#39; not found in scores dictionary.&quot;</span><span class="p">)</span>
    
    <span class="n">metric_data</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">metric_key</span><span class="p">]</span>  <span class="c1"># e.g., scores[&quot;MAE&quot;] or scores[&quot;Pearson&quot;]</span>
    
    <span class="c1"># 3. Decide the comparison operator based on the metric</span>
    <span class="c1">#    (MAE typically: &lt; threshold; Pearson typically: &gt; threshold)</span>
    <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;mae&#39;</span><span class="p">:</span>
        <span class="n">cmp_operator</span> <span class="o">=</span> <span class="s1">&#39;lt&#39;</span>  <span class="c1"># less than</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pearson&#39;</span><span class="p">:</span>
        <span class="n">cmp_operator</span> <span class="o">=</span> <span class="s1">&#39;gt&#39;</span>  <span class="c1"># greater than</span>
    <span class="k">elif</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;groc&#39;</span><span class="p">:</span>
        <span class="n">cmp_operator</span> <span class="o">=</span> <span class="s1">&#39;gt&#39;</span>  <span class="c1"># greater than</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmp_operator</span> <span class="o">=</span> <span class="s1">&#39;lt&#39;</span> 
    
    <span class="c1"># 4. Compute the counts</span>
    <span class="n">best_models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">metric_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Compare against threshold</span>
        <span class="k">if</span> <span class="n">cmp_operator</span> <span class="o">==</span> <span class="s1">&#39;lt&#39;</span><span class="p">:</span>
            <span class="n">arr_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">cmp_operator</span> <span class="o">==</span> <span class="s1">&#39;gt&#39;</span><span class="p">:</span>
            <span class="n">arr_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If needed, add more operators (&lt;=, &gt;=, etc.)</span>
            <span class="n">arr_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">best_models</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_count</span>
    
    <span class="c1"># 5. Sort by descending count</span>
    <span class="n">best_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="c1"># 6. Take the top N</span>
    <span class="n">top_n_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">best_models</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="n">top_n</span><span class="p">])</span>
  
    <span class="c1"># Normalize a variable name by removing &quot;.suffix&quot;, removing underscores, and lowercasing</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_var</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1"># &quot;DWD_21&quot; from &quot;DWD_21.PRCP&quot;</span>
        <span class="n">base_no_underscore</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># &quot;DWD21&quot;</span>
        <span class="k">return</span> <span class="n">base_no_underscore</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>           <span class="c1"># &quot;dwd21&quot;</span>
    
    <span class="c1"># Collect matches in the order of the dictionary keys</span>
    <span class="n">selected_vars_in_order</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">gcm</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">top_n_models</span><span class="p">:</span>
            <span class="c1"># Key looks like &quot;eccc_5_JanIc_&quot;; we take only &quot;dwd21&quot;</span>
            <span class="n">key_prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
            
            <span class="c1"># Find all matching variables for this key</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>            
                <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">center_variable</span>
                <span class="k">if</span> <span class="n">normalize_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># Extend the list by all matches (or pick just the first one, depending on your needs)</span>
            <span class="n">selected_vars_in_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">hydro</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">top_n_models</span><span class="p">:</span>
            <span class="c1"># Key looks like &quot;eccc_5_JanIc_&quot;; we take only &quot;dwd21&quot;</span>
            <span class="n">key_prefix</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Find all matching variables for this key</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>            
                <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">center_variable</span>
                <span class="k">if</span> <span class="n">normalize_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># Extend the list by all matches (or pick just the first one, depending on your needs)</span>
            <span class="n">selected_vars_in_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">agroparam</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">top_n_models</span><span class="p">:</span>
            <span class="c1"># Key looks like &quot;eccc_5_JanIc_&quot;; we take only &quot;dwd21&quot;</span>
            <span class="n">key_prefix</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Find all matching variables for this key</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>            
                <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">center_variable</span>
                <span class="k">if</span> <span class="n">normalize_var</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># Extend the list by all matches (or pick just the first one, depending on your needs)</span>
            <span class="n">selected_vars_in_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">top_n_models</span><span class="p">:</span>
            <span class="n">key_prefix</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Find all matching variables for this key</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>            
                <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">center_variable</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">key_prefix</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># Extend the list by all matches (or pick just the first one, depending on your needs)</span>
            <span class="n">selected_vars_in_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>        
    <span class="k">return</span> <span class="n">selected_vars_in_order</span> <span class="c1"># selected_vars</span></div>


<div class="viewcode-block" id="plot_prob_forecasts">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_prob_forecasts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_prob_forecasts</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">forecast_prob</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Below-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-Normal&quot;</span><span class="p">],</span> <span class="n">reverse_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logo_size</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">logo_position</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot probabilistic forecasts with tercile categories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save the plot.</span>
<span class="sd">    forecast_prob : xarray.DataArray</span>
<span class="sd">        Data array containing probability forecasts with a &#39;probability&#39; dimension.</span>
<span class="sd">    model_name : str or numpy.ndarray</span>
<span class="sd">        Name of the model for the plot title.</span>
<span class="sd">    labels : list, optional</span>
<span class="sd">        Labels for the tercile categories (default is [&quot;Below-Normal&quot;, &quot;Near-Normal&quot;, &quot;Above-Normal&quot;]).</span>
<span class="sd">    reverse_cmap : bool, optional</span>
<span class="sd">        If True, reverse the colormap order for categories (default is True).</span>
<span class="sd">    hspace : float, optional</span>
<span class="sd">        Height space between the main plot and the colorbar (default is -0.6).</span>
<span class="sd">    sigma : float, optional</span>
<span class="sd">        Standard deviation for Gaussian smoothing of probabilities (default is None, no smoothing).</span>
<span class="sd">    res : float, optional</span>
<span class="sd">        Resolution for interpolation of the forecast probabilities (default is None, no interpolation). </span>
<span class="sd">    logo : str, optional</span>
<span class="sd">        Path to the logo image to be added to the plot (default is None).</span>
<span class="sd">    logo_size : float, optional</span>
<span class="sd">        Size of the logo image in the plot (default is 0.5).    </span>
<span class="sd">    logo_position : str, optional</span>
<span class="sd">        Position of the logo image in the plot (default is &quot;lower left&quot;).       </span>
<span class="sd">    logo_size : tuple, optional</span>
<span class="sd">        Size of the logo image in the plot as (width, height) in inches (default is (None, None)).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Saves the plot as a PNG file and displays it.</span>
<span class="sd">    Uses custom colormaps for each tercile category.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_X</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">max_X</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">min_Y</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">max_Y</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">num_X</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_X</span> <span class="o">-</span> <span class="n">min_X</span><span class="p">)</span> <span class="o">/</span> <span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_Y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_Y</span> <span class="o">-</span> <span class="n">min_Y</span><span class="p">)</span> <span class="o">/</span> <span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_X</span><span class="p">,</span> <span class="n">max_X</span><span class="p">,</span> <span class="n">num_X</span><span class="p">)</span>
        <span class="n">new_Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_Y</span><span class="p">,</span> <span class="n">max_Y</span><span class="p">,</span> <span class="n">num_Y</span><span class="p">)</span>
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">new_X</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">new_Y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fill_value&#39;</span><span class="p">:</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">}</span>    
                                            <span class="p">)</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create a smoothed copy</span>
        <span class="n">forecast_prob_smoothed</span> <span class="o">=</span> <span class="n">forecast_prob</span> <span class="o">*</span> <span class="mf">0.0</span>  <span class="c1"># Initialize with same shape and coords</span>
        
        <span class="c1"># Smooth each probability layer spatially</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="n">layer_smoothed</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">gaussian_filter</span><span class="p">,</span>
                <span class="n">layer</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]],</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">forecast_prob_smoothed</span><span class="o">.</span><span class="n">loc</span><span class="p">[{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">}]</span> <span class="o">=</span> <span class="n">layer_smoothed</span>
        
        <span class="c1"># Normalize smoothed probabilities to sum to 1 at each grid point</span>
        <span class="n">sum_probs</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
        <span class="n">forecast_prob_smoothed</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span> <span class="o">/</span> <span class="n">sum_probs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sum_probs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        
        <span class="c1"># Replace original with smoothed</span>
        <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span>

    <span class="c1"># Step 1: Extract maximum probability and category</span>
    <span class="n">max_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Maximum probability at each grid point</span>
    <span class="c1"># Fill NaN values with a very low value </span>
    <span class="n">filled_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
    <span class="c1"># Compute argmax</span>
    <span class="n">max_category</span> <span class="o">=</span> <span class="n">filled_prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Create masks for each category</span>
    <span class="n">mask_bn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Below Normal (BN)</span>
    <span class="n">mask_nn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Near Normal (NN)</span>
    <span class="n">mask_an</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># Above Normal (AN)</span>
    
    <span class="c1"># Step 3: Define custom colormaps</span>
    <span class="k">if</span> <span class="n">reverse_cmap</span><span class="p">:</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#fff7bc&quot;</span><span class="p">,</span> <span class="s2">&quot;#fee391&quot;</span><span class="p">,</span> <span class="s2">&quot;#fec44f&quot;</span><span class="p">,</span> <span class="s2">&quot;#fe9929&quot;</span><span class="p">,</span> <span class="s2">&quot;#ec7014&quot;</span><span class="p">,</span> <span class="s2">&quot;#cc4c02&quot;</span><span class="p">,</span> <span class="s2">&quot;#993404&quot;</span><span class="p">,</span> <span class="s2">&quot;#662506&quot;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#d9d9d9&quot;</span><span class="p">,</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">,</span> <span class="s2">&quot;#969696&quot;</span><span class="p">,</span> <span class="s2">&quot;#737373&quot;</span><span class="p">,</span> <span class="s2">&quot;#525252&quot;</span><span class="p">])</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#e5f5f9&quot;</span><span class="p">,</span> <span class="s2">&quot;#ccece6&quot;</span><span class="p">,</span> <span class="s2">&quot;#99d8c9&quot;</span><span class="p">,</span> <span class="s2">&quot;#66c2a4&quot;</span><span class="p">,</span> <span class="s2">&quot;#41ae76&quot;</span><span class="p">,</span> <span class="s2">&quot;#238b45&quot;</span><span class="p">,</span> <span class="s2">&quot;#006d2c&quot;</span><span class="p">,</span> <span class="s2">&quot;#00441b&quot;</span><span class="p">])</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#fff7bc&quot;</span><span class="p">,</span> <span class="s2">&quot;#fee391&quot;</span><span class="p">,</span> <span class="s2">&quot;#fec44f&quot;</span><span class="p">,</span> <span class="s2">&quot;#fe9929&quot;</span><span class="p">,</span> <span class="s2">&quot;#ec7014&quot;</span><span class="p">,</span> <span class="s2">&quot;#cc4c02&quot;</span><span class="p">,</span> <span class="s2">&quot;#993404&quot;</span><span class="p">,</span> <span class="s2">&quot;#662506&quot;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#d9d9d9&quot;</span><span class="p">,</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">,</span> <span class="s2">&quot;#969696&quot;</span><span class="p">,</span> <span class="s2">&quot;#737373&quot;</span><span class="p">,</span> <span class="s2">&quot;#525252&quot;</span><span class="p">])</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;#e5f5f9&quot;</span><span class="p">,</span> <span class="s2">&quot;#ccece6&quot;</span><span class="p">,</span> <span class="s2">&quot;#99d8c9&quot;</span><span class="p">,</span> <span class="s2">&quot;#66c2a4&quot;</span><span class="p">,</span> <span class="s2">&quot;#41ae76&quot;</span><span class="p">,</span> <span class="s2">&quot;#238b45&quot;</span><span class="p">,</span> <span class="s2">&quot;#006d2c&quot;</span><span class="p">,</span> <span class="s2">&quot;#00441b&quot;</span><span class="p">])</span>          
    
    <span class="c1"># Create a figure with GridSpec</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">hspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hspace</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6</span>  <span class="c1"># Default height space if not provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hspace</span> <span class="o">=</span> <span class="n">hspace</span>  <span class="c1"># Use the provided height space</span>

    <span class="k">if</span> <span class="n">logo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logo_size</span><span class="o">=</span>  <span class="p">(</span><span class="s2">&quot;7%&quot;</span><span class="p">,</span><span class="s2">&quot;21%&quot;</span><span class="p">)</span>  <span class="c1"># Default logo size if not provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logo_size</span> <span class="o">=</span> <span class="n">logo_size</span>  <span class="c1"># Use the provided logo size</span>

    <span class="c1"># Define the GridSpec layout</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="n">hspace</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># Main map axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">bn_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">nn_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">an_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># Step 4: Plot each category</span>
   <span class="c1"># def clip_prob(data, mask):</span>
   <span class="c1">#     prob = max_prob.where(mask)</span>
   <span class="c1">#     prob = xr.where(prob &gt; 0.6, 0.6, prob) * 100</span>
   <span class="c1">#     prob = xr.where(prob &lt; 25, 25, prob)</span>
   <span class="c1">#     return prob.values</span>

   <span class="c1"># bn_data = clip_prob(max_prob, mask_bn)</span>
   <span class="c1"># nn_data = clip_prob(max_prob, mask_nn)</span>
   <span class="c1"># an_data = clip_prob(max_prob, mask_an)</span>


    <span class="c1"># Step _: Add  Land colors</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="o">.</span><span class="n">with_scale</span><span class="p">(</span><span class="s2">&quot;50m&quot;</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#fde0dd&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># #dfc27d</span>
    
    <span class="c1"># # Define the data ranges for color normalization  </span>
    <span class="c1"># vmin = 25  # Minimum probability percentage</span>
    <span class="c1"># vmax = 65  # Maximum probability percentage</span>

    <span class="c1"># Plot BN (Below Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bn_data</span><span class="p">)):</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">bn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">85</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">85</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">)</span>
        <span class="n">bn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot NN (Near Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nn_data</span><span class="p">)):</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">nn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">65</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">65</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">)</span>
        <span class="n">nn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot AN (Above Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">an_data</span><span class="p">)):</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">an_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">85</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">85</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">)</span>
        <span class="n">an_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Step 5: Add coastlines and borders and Land</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 6: Add individual colorbars with fixed ticks</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_ticks</span><span class="p">(</span><span class="n">vn</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="mi">86</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ticks</span>

    <span class="c1">#ticks = create_ticks(vn=35, vx=86, step=5)</span>

    <span class="c1"># For BN (Below Normal)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">create_ticks</span><span class="p">(</span><span class="n">vn</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="mi">86</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">cbar_ax_bn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cbar_bn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">bn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_bn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For NN (Near Normal)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">create_ticks</span><span class="p">(</span><span class="n">vn</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="mi">66</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">cbar_ax_nn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cbar_nn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">nn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_nn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For AN (Above Normal)</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">create_ticks</span><span class="p">(</span><span class="n">vn</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span> <span class="n">vx</span><span class="o">=</span><span class="mi">86</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">cbar_ax_an</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">cbar_an</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">an_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_an</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
    
    <span class="c1"># Set the title with the formatted model_name</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>


    <span class="c1"># Step 7: Add logo if provided</span>
    
    <span class="k">if</span> <span class="n">logo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax_logo</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">logo_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Width of the logo    </span>
                            <span class="n">height</span><span class="o">=</span><span class="n">logo_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Height of the logo        </span>
                            <span class="n">loc</span><span class="o">=</span><span class="n">logo_position</span><span class="p">,</span>
                            <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>        
        <span class="n">ax_logo</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">logo</span><span class="p">))</span>
        <span class="n">ax_logo</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span> 

    <span class="c1"># plt.subplots_adjust(top=0.92, bottom=0.08, left=0.08, right=0.92, hspace=0.03, wspace=0.03)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=-</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_prob_forecasts1">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_prob_forecasts1">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_prob_forecasts1</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">forecast_prob</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Below-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-Normal&quot;</span><span class="p">],</span> <span class="n">reverse_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logo_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot probabilistic forecasts with tercile categories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save the plot.</span>
<span class="sd">    forecast_prob : xarray.DataArray</span>
<span class="sd">        Data array containing probability forecasts with a &#39;probability&#39; dimension.</span>
<span class="sd">    model_name : str or numpy.ndarray</span>
<span class="sd">        Name of the model for the plot title.</span>
<span class="sd">    labels : list, optional</span>
<span class="sd">        Labels for the tercile categories (default is [&quot;Below-Normal&quot;, &quot;Near-Normal&quot;, &quot;Above-Normal&quot;]).</span>
<span class="sd">    reverse_cmap : bool, optional</span>
<span class="sd">        If True, reverse the colormap order for categories (default is True).</span>
<span class="sd">    logo : str, optional</span>
<span class="sd">        Path to the logo image to be added to the plot (default is None).</span>
<span class="sd">    logo_size : float, optional</span>
<span class="sd">        Size of the logo image in the plot (default is 0.5).    </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Saves the plot as a PNG file and displays it.</span>
<span class="sd">    Uses custom colormaps for each tercile category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Extract maximum probability and category</span>
    <span class="n">max_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Maximum probability at each grid point</span>
    <span class="c1"># Fill NaN values with a very low value </span>
    <span class="n">filled_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
    <span class="c1"># Compute argmax</span>
    <span class="n">max_category</span> <span class="o">=</span> <span class="n">filled_prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Create masks for each category</span>
    <span class="n">mask_bn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Below Normal (BN)</span>
    <span class="n">mask_nn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Near Normal (NN)</span>
    <span class="n">mask_an</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># Above Normal (AN)</span>
    
    <span class="c1"># Step 3: Define custom colormaps</span>
    <span class="k">if</span> <span class="n">reverse_cmap</span><span class="p">:</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FDAE61&#39;</span><span class="p">,</span> <span class="s1">&#39;#F46D43&#39;</span><span class="p">,</span> <span class="s1">&#39;#D73027&#39;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FFFFE5&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFF7BC&#39;</span><span class="p">,</span> <span class="s1">&#39;#FEE391&#39;</span><span class="p">])</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#ABDDA4&#39;</span><span class="p">,</span> <span class="s1">&#39;#66C2A5&#39;</span><span class="p">,</span> <span class="s1">&#39;#3288BD&#39;</span><span class="p">])</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FDAE61&#39;</span><span class="p">,</span> <span class="s1">&#39;#F46D43&#39;</span><span class="p">,</span> <span class="s1">&#39;#D73027&#39;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FFFFE5&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFF7BC&#39;</span><span class="p">,</span> <span class="s1">&#39;#FEE391&#39;</span><span class="p">])</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#ABDDA4&#39;</span><span class="p">,</span> <span class="s1">&#39;#66C2A5&#39;</span><span class="p">,</span> <span class="s1">&#39;#3288BD&#39;</span><span class="p">])</span>          
    
    <span class="c1"># Create a figure with GridSpec</span>
    <span class="c1"># fig = plt.figure(figsize=(8, 6.5))  # Increased height to accommodate logo</span>
    <span class="c1"># gs = gridspec.GridSpec(3, 3, height_ratios=[15, 0.8, 0.7], hspace=0.2)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>

    <span class="c1"># Main map axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1"># Modify by Mandela</span>
    
    <span class="c1">###################</span>
    <span class="c1">##################</span>

    <span class="c1"># Step 4: Plot each category</span>
    <span class="c1"># Multiply by 100 to convert probabilities to percentages</span>
    
    <span class="c1"># bn_data = (max_prob.where(mask_bn) * 100).values</span>
    <span class="c1"># nn_data = (max_prob.where(mask_nn) * 100).values</span>
    <span class="c1"># an_data = (max_prob.where(mask_an) * 100).values</span>
    
    <span class="c1"># Apply the condition to ensure minimum value of 45% for each category</span>
    <span class="c1"># and a maximum of 60% for BN, NN, and AN</span>
    <span class="c1"># Ensure that the values are at least 45% and at most 60% for each category</span>
    <span class="c1"># and convert to percentage</span>
    <span class="c1"># bn_data = xr.where((max_prob.where(mask_bn) * 100) &lt; 45, 45,</span>
    <span class="c1">#                    xr.where(max_prob.where(mask_bn) * 100 &gt; 60, 60, max_prob.where(mask_bn) * 100)).values</span>
    <span class="c1"># nn_data = xr.where((max_prob.where(mask_nn) * 100) &lt; 45, 45,</span>
    <span class="c1">#                    xr.where(max_prob.where(mask_nn) * 100 &gt; 60, 60, max_prob.where(mask_nn) * 100)).values</span>
    <span class="c1"># an_data = xr.where((max_prob.where(mask_an) * 100) &lt; 45, 45,</span>
    <span class="c1">#                    xr.where(max_prob.where(mask_an) * 100 &gt; 60, 60, max_prob.where(mask_an) * 100)).values    </span>


    <span class="c1"># Step 4: Plot each category</span>
    <span class="n">bn_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                       <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>  
    <span class="n">nn_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">an_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Define the data ranges for color normalization  </span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="mi">35</span>  <span class="c1"># Minimum probability percentage</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="mi">65</span>  <span class="c1"># Maximum probability percentage</span>

    <span class="c1"># Plot BN (Below Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bn_data</span><span class="p">)):</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">bn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">)</span>
        <span class="n">bn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot NN (Near Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nn_data</span><span class="p">)):</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">nn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">)</span>
        <span class="n">nn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot AN (Above Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">an_data</span><span class="p">)):</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">an_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">)</span>
        <span class="n">an_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Step 5: Add coastlines and borders</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
    <span class="c1"># Step 6: Add individual colorbars with fixed ticks</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_ticks</span><span class="p">():</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ticks</span>

    <span class="n">ticks</span> <span class="o">=</span> <span class="n">create_ticks</span><span class="p">()</span>

    <span class="c1"># For BN (Below Normal)</span>
    <span class="n">cbar_ax_bn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cbar_bn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">bn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_bn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For NN (Near Normal)</span>
    <span class="n">cbar_ax_nn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cbar_nn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">nn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_nn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For AN (Above Normal)</span>
    <span class="n">cbar_ax_an</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">cbar_an</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">an_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_an</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
    
    <span class="c1"># Set the title with the formatted model_name</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Step 7: Add logo if provided</span>
    <span class="n">logo_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">logo_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">logo</span><span class="p">)</span>
        <span class="n">addLogo</span> <span class="o">=</span> <span class="n">OffsetImage</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">logo_size</span><span class="p">)</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">AnnotationBbox</span><span class="p">(</span><span class="n">addLogo</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
        <span class="n">logo_ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=-</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_prob_forecasts2">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_prob_forecasts2">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_prob_forecasts2</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">forecast_prob</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Below-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Near-Normal&quot;</span><span class="p">,</span> <span class="s2">&quot;Above-Normal&quot;</span><span class="p">],</span> <span class="n">reverse_cmap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logo_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot probabilistic forecasts with tercile categories.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save the plot.</span>
<span class="sd">    forecast_prob : xarray.DataArray</span>
<span class="sd">        Data array containing probability forecasts with a &#39;probability&#39; dimension.</span>
<span class="sd">    model_name : str or numpy.ndarray</span>
<span class="sd">        Name of the model for the plot title.</span>
<span class="sd">    labels : list, optional</span>
<span class="sd">        Labels for the tercile categories (default is [&quot;Below-Normal&quot;, &quot;Near-Normal&quot;, &quot;Above-Normal&quot;]).</span>
<span class="sd">    reverse_cmap : bool, optional</span>
<span class="sd">        If True, reverse the colormap order for categories (default is True).</span>
<span class="sd">    logo : str, optional</span>
<span class="sd">        Path to the logo image to be added to the plot (default is None).</span>
<span class="sd">    logo_size : float, optional</span>
<span class="sd">        Size of the logo image in the plot (default is 0.5).    </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Saves the plot as a PNG file and displays it.</span>
<span class="sd">    Uses custom colormaps for each tercile category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Step 1: Extract maximum probability and category</span>
    <span class="n">max_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Maximum probability at each grid point</span>
    <span class="c1"># Fill NaN values with a very low value </span>
    <span class="n">filled_prob</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
    <span class="c1"># Compute argmax</span>
    <span class="n">max_category</span> <span class="o">=</span> <span class="n">filled_prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;probability&quot;</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Create masks for each category</span>
    <span class="n">mask_bn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Below Normal (BN)</span>
    <span class="n">mask_nn</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># Near Normal (NN)</span>
    <span class="n">mask_an</span> <span class="o">=</span> <span class="n">max_category</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># Above Normal (AN)</span>
    
    <span class="c1"># Step 3: Define custom colormaps</span>
    <span class="k">if</span> <span class="n">reverse_cmap</span><span class="p">:</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FDAE61&#39;</span><span class="p">,</span> <span class="s1">&#39;#F46D43&#39;</span><span class="p">,</span> <span class="s1">&#39;#D73027&#39;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FFFFE5&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFF7BC&#39;</span><span class="p">,</span> <span class="s1">&#39;#FEE391&#39;</span><span class="p">])</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#ABDDA4&#39;</span><span class="p">,</span> <span class="s1">&#39;#66C2A5&#39;</span><span class="p">,</span> <span class="s1">&#39;#3288BD&#39;</span><span class="p">])</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">BN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;BN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FDAE61&#39;</span><span class="p">,</span> <span class="s1">&#39;#F46D43&#39;</span><span class="p">,</span> <span class="s1">&#39;#D73027&#39;</span><span class="p">])</span> 
        <span class="n">NN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;NN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#FFFFE5&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFF7BC&#39;</span><span class="p">,</span> <span class="s1">&#39;#FEE391&#39;</span><span class="p">])</span>
        <span class="n">AN_cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;AN&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;#ABDDA4&#39;</span><span class="p">,</span> <span class="s1">&#39;#66C2A5&#39;</span><span class="p">,</span> <span class="s1">&#39;#3288BD&#39;</span><span class="p">])</span>          
    
    <span class="c1"># Create a figure with GridSpec</span>
    <span class="c1"># fig = plt.figure(figsize=(8, 6.5))  # Increased height to accommodate logo</span>
    <span class="c1"># gs = gridspec.GridSpec(3, 3, height_ratios=[15, 0.8, 0.7], hspace=0.2)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>

    <span class="c1"># Main map axis</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>

    <span class="c1"># Modify by Mandela</span>
    
    <span class="c1">###################</span>
    <span class="c1">##################</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># Smoothing parameter (Gaussian sigma); </span>
    
    <span class="c1"># Create a smoothed copy</span>
    <span class="n">forecast_prob_smoothed</span> <span class="o">=</span> <span class="n">forecast_prob</span> <span class="o">*</span> <span class="mf">0.0</span>  <span class="c1"># Initialize with same shape and coords</span>
    
    <span class="c1"># Smooth each probability layer spatially</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">probability</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">forecast_prob</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">layer_smoothed</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="n">gaussian_filter</span><span class="p">,</span>
            <span class="n">layer</span><span class="p">,</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]],</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">]],</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">forecast_prob_smoothed</span><span class="o">.</span><span class="n">loc</span><span class="p">[{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">}]</span> <span class="o">=</span> <span class="n">layer_smoothed</span>
    
    <span class="c1"># Normalize smoothed probabilities to sum to 1 at each grid point</span>
    <span class="n">sum_probs</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">)</span>
    <span class="n">forecast_prob_smoothed</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span> <span class="o">/</span> <span class="n">sum_probs</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sum_probs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Replace original with smoothed</span>
    <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">forecast_prob_smoothed</span>

    <span class="c1"># Step 4: Plot each category</span>
    <span class="n">bn_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                       <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_bn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>  
    <span class="n">nn_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_nn</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">an_data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
                   <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="n">max_prob</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask_an</span><span class="p">))</span><span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Define the data ranges for color normalization  </span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="mi">35</span>  <span class="c1"># Minimum probability percentage</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="mi">65</span>  <span class="c1"># Maximum probability percentage</span>

    <span class="c1"># Plot BN (Below Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bn_data</span><span class="p">)):</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">bn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">BN_cmap</span><span class="p">)</span>
        <span class="n">bn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot NN (Near Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">nn_data</span><span class="p">)):</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">nn_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nn_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">NN_cmap</span><span class="p">)</span>
        <span class="n">nn_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Plot AN (Above Normal)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">an_data</span><span class="p">)):</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>
            <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="n">forecast_prob</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">an_data</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">an_plot</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">AN_cmap</span><span class="p">)</span>
        <span class="n">an_plot</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>

    <span class="c1"># Step 5: Add coastlines and borders</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
    <span class="c1"># Step 6: Add individual colorbars with fixed ticks</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_ticks</span><span class="p">():</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ticks</span>

    <span class="n">ticks</span> <span class="o">=</span> <span class="n">create_ticks</span><span class="p">()</span>

    <span class="c1"># For BN (Below Normal)</span>
    <span class="n">cbar_ax_bn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">cbar_bn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">bn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_bn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_bn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For NN (Near Normal)</span>
    <span class="n">cbar_ax_nn</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">cbar_nn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">nn_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_nn</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_nn</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>

    <span class="c1"># For AN (Above Normal)</span>
    <span class="n">cbar_ax_an</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">cbar_an</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">an_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax_an</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s1"> (%)&#39;</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar_an</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">])</span>
    
    <span class="c1"># Set the title with the formatted model_name</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_name_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1"># Step 7: Add logo if provided</span>
    <span class="n">logo_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">logo_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">logo</span><span class="p">)</span>
        <span class="n">addLogo</span> <span class="o">=</span> <span class="n">OffsetImage</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">logo_size</span><span class="p">)</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">AnnotationBbox</span><span class="p">(</span><span class="n">addLogo</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">)</span>
        <span class="n">logo_ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_name_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_tercile">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_tercile">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_tercile</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a tercile map with categories: Below, Normal, Above.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : xarray.DataArray</span>
<span class="sd">        Data array with tercile categories (0: Below, 1: Normal, 2: Above) and dimensions &#39;T&#39;, &#39;Y&#39;, &#39;X&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses a custom colormap and displays a legend for tercile categories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#fc8d59&#39;</span><span class="p">,</span> <span class="s1">&#39;#bdbdbd&#39;</span><span class="p">,</span> <span class="s1">&#39;#99d594&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">lon</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lon</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">lat</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">year</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Observed terciles&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Observed terciles </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ABOVE AVERAGE&#39;</span><span class="p">),</span>
        <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;NEAR AVERAGE&#39;</span><span class="p">),</span>
        <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;BELOW AVERAGE&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="find_best_distribution_grid">
<a class="viewcode-back" href="../../api.html#wass2s.utils.find_best_distribution_grid">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_best_distribution_grid</span><span class="p">(</span><span class="n">rainfall</span><span class="p">,</span> <span class="n">distribution_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the best-fitting distribution for variables data at each grid cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rainfall : xarray.DataArray</span>
<span class="sd">        Precipitation data with a time dimension &#39;T&#39; and spatial dimensions &#39;Y&#39;, &#39;X&#39;.</span>
<span class="sd">    distribution_map : dict, optional</span>
<span class="sd">        Mapping of distribution names to numeric codes. Defaults to:</span>
<span class="sd">        {&#39;norm&#39;: 1, &#39;lognorm&#39;: 2, &#39;expon&#39;: 3, &#39;gamma&#39;: 4, &#39;weibull_min&#39;: 5}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Array with numeric codes for the best-fitting distribution at each grid cell.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses the Fitter library to fit distributions and select the best based on sum-of-squared errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">distribution_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">distribution_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;norm&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;lognorm&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;expon&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s1">&#39;weibull_min&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">find_best_distribution</span><span class="p">(</span><span class="n">precip_data</span><span class="p">,</span> <span class="n">distribution_map</span><span class="p">):</span>
        <span class="n">precip_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">precip_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">precip_data</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Fitter</span><span class="p">(</span><span class="n">precip_data</span><span class="p">,</span> <span class="n">distributions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">distribution_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">best_fit</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_best</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;sumsquare_error&#39;</span><span class="p">)</span>
        <span class="n">best_dist_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">best_fit</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">distribution_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">best_dist_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">best_fit_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
        <span class="n">find_best_distribution</span><span class="p">,</span>
        <span class="n">rainfall</span><span class="p">,</span>
        <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[[</span><span class="s2">&quot;T&quot;</span><span class="p">]],</span>
        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;distribution_map&#39;</span><span class="p">:</span> <span class="n">distribution_map</span><span class="p">},</span>
        <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dask</span><span class="o">=</span><span class="s2">&quot;parallelized&quot;</span><span class="p">,</span>
        <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">best_fit_da</span></div>


<div class="viewcode-block" id="process_model_for_other_params">
<a class="viewcode-back" href="../../api.html#wass2s.utils.process_model_for_other_params">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_model_for_other_params</span><span class="p">(</span><span class="n">agmParamModel</span><span class="p">,</span> <span class="n">dir_to_save</span><span class="p">,</span> <span class="n">hdcst_file_path</span><span class="p">,</span> <span class="n">fcst_file_path</span><span class="p">,</span> <span class="n">obs_hdcst</span><span class="p">,</span> <span class="n">obs_fcst_year</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">year_forecast</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">agrometparam</span><span class="o">=</span><span class="s2">&quot;Onset&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process model hindcast and forecast data for agrometeorological parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    agmParamModel : object</span>
<span class="sd">        Model object with a compute method for processing agrometeorological parameters.</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save processed data.</span>
<span class="sd">    hdcst_file_path : dict</span>
<span class="sd">        Dictionary mapping model names to hindcast file paths.</span>
<span class="sd">    fcst_file_path : dict</span>
<span class="sd">        Dictionary mapping model names to forecast file paths.</span>
<span class="sd">    obs_hdcst : xarray.Dataset</span>
<span class="sd">        Observational hindcast dataset.</span>
<span class="sd">    obs_fcst_year : xarray.Dataset</span>
<span class="sd">        Observational forecast dataset for the specified year.</span>
<span class="sd">    month_of_initialization : int</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the hindcast data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the hindcast data.</span>
<span class="sd">    year_forecast : int</span>
<span class="sd">        Forecast year.</span>
<span class="sd">    nb_cores : int, optional</span>
<span class="sd">        Number of CPU cores for parallel processing (default is 2).</span>
<span class="sd">    agrometparam : str, optional</span>
<span class="sd">        Name of the agrometeorological parameter (default is &#39;Onset&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Tuple of dictionaries (saved_hindcast_paths, saved_forecast_paths) mapping model names to saved file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t_coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
    <span class="n">y_coords</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">Y</span>
    <span class="n">x_coords</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">X</span>

    <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">):</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;T.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">t_coord</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;T.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">dayofyear</span><span class="o">=~</span><span class="p">((</span><span class="n">daily_climatology</span><span class="p">[</span><span class="s1">&#39;dayofyear&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">t_coord</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
    <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/model_data&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">saved_hindcast_paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hdcst_file_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">agrometparam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
            <span class="n">hdcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hdcst_file_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">hdcst</span> <span class="o">=</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="n">hdcst</span> <span class="o">=</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">obs_hdcst_sel</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end</span><span class="p">)))</span>
            <span class="n">obs_hdcst_interp</span> <span class="o">=</span> <span class="n">obs_hdcst_sel</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">hdcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">hdcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">hdcst</span><span class="p">,</span> <span class="n">obs_hdcst_interp</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_ds</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">agpm_model</span> <span class="o">=</span> <span class="n">agmParamModel</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">daily_data</span><span class="o">=</span><span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">),</span> <span class="n">nb_cores</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">agpm_model</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">agrometparam</span><span class="p">)</span>
            <span class="n">ds_processed</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
        <span class="n">saved_hindcast_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path</span>
    <span class="n">saved_forecast_paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fcst_file_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">agrometparam</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
            <span class="n">fcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fcst_file_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">fcst</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">fcst</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="n">fcst</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">obs_fcst_sel</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">))</span>
            <span class="n">obs_fcst_interp</span> <span class="o">=</span> <span class="n">obs_fcst_sel</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">fcst</span><span class="p">,</span> <span class="n">obs_fcst_interp</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_fcst</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_fcst</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ds_filled</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_fcst_</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_fcst_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">agpm_model</span> <span class="o">=</span> <span class="n">agmParamModel</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">daily_data</span><span class="o">=</span><span class="n">ds_filled</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="n">nb_cores</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">agpm_model</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">agrometparam</span><span class="p">)</span>
            <span class="n">ds_processed</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
        <span class="n">saved_forecast_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path</span>
    <span class="k">return</span> <span class="n">saved_hindcast_paths</span><span class="p">,</span> <span class="n">saved_forecast_paths</span></div>



<div class="viewcode-block" id="plot_date">
<a class="viewcode-back" href="../../api.html#wass2s.utils.plot_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_date</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a map of dates, interpreting values as offsets from 2024-01-01.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : xarray.DataArray</span>
<span class="sd">        Data array with values representing days since 2024-01-01, and dimensions &#39;Y&#39;, &#39;X&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Converts colorbar ticks to calendar dates (e.g., &#39;01-Jan&#39;) for readability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()))</span>
    <span class="n">plt_obj</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
        <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span>
            <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
            <span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;aspect&#39;</span><span class="p">:</span> <span class="mi">25</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt_obj</span><span class="o">.</span><span class="n">colorbar</span>
    <span class="n">ticks</span> <span class="o">=</span> <span class="n">cbar</span><span class="o">.</span><span class="n">get_ticks</span><span class="p">()</span>
    <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2024</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tick</span><span class="p">)))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%b&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks</span>
    <span class="p">]</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="verify_station_network">
<a class="viewcode-back" href="../../api.html#wass2s.utils.verify_station_network">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">verify_station_network</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">map_name</span><span class="o">=</span><span class="s2">&quot;Rain-gauge network&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot station locations on a map to verify the station network.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_filtered : pandas.DataFrame</span>
<span class="sd">        DataFrame containing station data with &#39;STATION&#39; column (&#39;LAT&#39;, &#39;LON&#39;) and station names.</span>
<span class="sd">    extent : list</span>
<span class="sd">        Geographic extent in the format [west, east, south, north].</span>
<span class="sd">    map_name : str, optional</span>
<span class="sd">        Title of the map (default is &#39;Rain-gauge network&#39;).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Stations are plotted as red markers with labels, using Cartopy for map features.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lat_row</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_filtered</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">lon_row</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_filtered</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;LON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">station_names</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">lats</span> <span class="o">=</span> <span class="n">lat_row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">lons</span> <span class="o">=</span> <span class="n">lon_row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;cornsilk&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAKES</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">station_names</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lon</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">lat</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">map_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<span class="c1"># Indices definition</span>
<span class="n">sst_indices_name</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;NINO34&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3.4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">170</span><span class="p">,</span> <span class="o">-</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;NINO12&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NiÃ±o1+2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;NINO3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino3&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;NINO4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Nino4&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;NINO_Global&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;ALL NINO Zone&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;TNA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Northern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
    <span class="s2">&quot;TSA&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Tropical Southern Atlantic Index&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;NAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;North Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="s2">&quot;SAT&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;South Atlantic Tropical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;TASI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NAT-SAT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s2">&quot;WTIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Western Tropical Indian Ocean (WTIO)&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;SETIO&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Southeastern Tropical Indian Ocean (SETIO)&quot;</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;DMI&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;WTIO - SETIO&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s2">&quot;MB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Mediterranean Basin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
<span class="p">}</span>


<span class="c1">################################ agroparameters compute ################</span>

<span class="n">onset_criteria</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">},</span>
<span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">},</span>
<span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
<span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
<span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>         <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">},</span>
<span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span><span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">},</span>
    <span class="p">}</span>

<span class="n">onset_dryspell_criteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">30</span><span class="p">},</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">},</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">40</span><span class="p">},</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">45</span><span class="p">},</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>         <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span><span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">,</span> <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span>
<span class="p">}</span>

<span class="n">cessation_criteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span><span class="p">},</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span><span class="p">},</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-10&quot;</span><span class="p">},</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-15&quot;</span><span class="p">},</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-01&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;11-30&quot;</span><span class="p">},</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span> <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span><span class="s2">&quot;01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search&quot;</span><span class="p">:</span> <span class="s2">&quot;10-15&quot;</span><span class="p">,</span> <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span> <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s2">&quot;end_search&quot;</span><span class="p">:</span> <span class="s2">&quot;12-01&quot;</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Default class-level criteria dictionary</span>
<span class="n">cessation_dryspell_criteria</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel100_0mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;06-01&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span>
    <span class="p">},</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel200_100mm&quot;</span><span class="p">,</span> <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;05-15&quot;</span><span class="p">,</span> <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;08-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-05&quot;</span>
    <span class="p">},</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel400_200mm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;05-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-10&quot;</span>
    <span class="p">},</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Sahel600_400mm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;09-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-15&quot;</span>
    <span class="p">},</span>
    <span class="mi">4</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Soudan&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;03-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;07-31&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;11-30&quot;</span>
    <span class="p">},</span>
    <span class="mi">5</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;zone_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Golfe_Of_Guinea&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;02-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cumulative&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;number_dry_days&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;thrd_rain_day&quot;</span><span class="p">:</span> <span class="mf">0.85</span><span class="p">,</span>
        <span class="s2">&quot;end_search1&quot;</span><span class="p">:</span> <span class="s2">&quot;06-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nbjour&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="s2">&quot;date_dry_soil&quot;</span><span class="p">:</span> <span class="s2">&quot;01-01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;10-15&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ETP&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="s2">&quot;Cap_ret_maxi&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;end_search2&quot;</span><span class="p">:</span> <span class="s2">&quot;12-01&quot;</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1">########################## Extended seasonal forecast ##########################################</span>
<span class="n">qmap</span> <span class="o">=</span> <span class="n">WAS_Qmap</span><span class="p">()</span>
<span class="n">qmap_</span> <span class="o">=</span> <span class="n">WAS_bias_correction</span><span class="p">()</span>
<div class="viewcode-block" id="proceed_seasonal_daily_bias_correction">
<a class="viewcode-back" href="../../api.html#wass2s.utils.proceed_seasonal_daily_bias_correction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">proceed_seasonal_daily_bias_correction</span><span class="p">(</span><span class="n">dir_to_save_model</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">hindcast_files</span><span class="p">,</span> <span class="n">forecast_files</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s2">&quot;PRCP&quot;</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">hindcast_files_</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">forecast_files_</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_model</span><span class="si">}</span><span class="s2">/corrected&quot;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hindcast_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hindcast_files</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">varname</span><span class="p">]</span>
        <span class="n">fcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">forecast_files</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">varname</span><span class="p">]</span>
        <span class="n">corrected_hcst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corrected_fcst</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">save_path_hcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_model</span><span class="si">}</span><span class="s2">/corrected/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">hindcast_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">save_path_fcst</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save_model</span><span class="si">}</span><span class="s2">/corrected/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">forecast_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path_hcst</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
                <span class="n">obs_month</span> <span class="o">=</span> <span class="n">observation</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">observation</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">hcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">hcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_month</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">hcst_month</span> <span class="o">=</span> <span class="n">hcst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">hcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span>
                <span class="n">obs_month</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hcst_month</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
                <span class="c1"># obs_month, hcst_month = xr.align(obs_month, hcst_month, join=&#39;inner&#39;)</span>
                <span class="n">fcst_month</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">fcst</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">month</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                    <span class="n">fobj_quant</span> <span class="o">=</span> <span class="n">qmap</span><span class="o">.</span><span class="n">fitQmap</span><span class="p">(</span><span class="n">obs_month</span><span class="p">,</span> <span class="n">hcst_month</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;QUANT&#39;</span><span class="p">,</span> <span class="n">wet_day</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="n">qstep</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
                    <span class="n">hcst_month_corr</span> <span class="o">=</span> <span class="n">qmap</span><span class="o">.</span><span class="n">doQmap</span><span class="p">(</span><span class="n">hcst_month</span><span class="p">,</span> <span class="n">fobj_quant</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                    <span class="n">fcst_month_corr</span> <span class="o">=</span> <span class="n">qmap</span><span class="o">.</span><span class="n">doQmap</span><span class="p">(</span><span class="n">fcst_month</span><span class="p">,</span> <span class="n">fobj_quant</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fobj_quant</span> <span class="o">=</span> <span class="n">qmap_</span><span class="o">.</span><span class="n">fitBC</span><span class="p">(</span><span class="n">obs_month</span><span class="p">,</span> <span class="n">hcst_month</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;QUANT&#39;</span><span class="p">,</span> <span class="n">qstep</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">nboot</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">hcst_month_corr</span> <span class="o">=</span> <span class="n">qmap_</span><span class="o">.</span><span class="n">doBC</span><span class="p">(</span><span class="n">hcst_month</span><span class="p">,</span> <span class="n">fobj_quant</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                    <span class="n">fcst_month_corr</span> <span class="o">=</span> <span class="n">qmap_</span><span class="o">.</span><span class="n">doBC</span><span class="p">(</span><span class="n">fcst_month</span><span class="p">,</span> <span class="n">fobj_quant</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>         
                <span class="n">corrected_hcst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hcst_month_corr</span><span class="p">)</span>
                <span class="n">corrected_fcst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fcst_month_corr</span><span class="p">)</span>
            <span class="n">corrected_hcst_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">corrected_hcst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
            <span class="n">corrected_fcst_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">corrected_fcst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
            <span class="n">corrected_hcst_</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path_hcst</span><span class="p">)</span>
            <span class="n">corrected_fcst_</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path_fcst</span><span class="p">)</span>
            <span class="n">hindcast_files_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path_hcst</span>
            <span class="n">forecast_files_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path_fcst</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path_hcst</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path_fcst</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
            <span class="n">hindcast_files_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path_hcst</span>
            <span class="n">forecast_files_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path_fcst</span> 
    <span class="k">return</span> <span class="n">hindcast_files_</span><span class="p">,</span> <span class="n">forecast_files_</span></div>



<div class="viewcode-block" id="pre_process_biophysical_model">
<a class="viewcode-back" href="../../api.html#wass2s.utils.pre_process_biophysical_model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pre_process_biophysical_model</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">hdcst_file_path</span><span class="p">,</span> 
<span class="n">fcst_file_path</span><span class="p">,</span> <span class="n">obs_hdcst</span><span class="p">,</span> <span class="n">obs_fcst_year</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="p">,</span>
 <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">year_forecast</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="s2">&quot;PRCP&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process model hindcasts and forecasts data for extended seasonal forecasts with biophysical models (Hype, SARRAO).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_to_save : str</span>
<span class="sd">        Directory path to save processed data.</span>
<span class="sd">    hdcst_file_path : dict</span>
<span class="sd">        Dictionary mapping model names to hindcast file paths.</span>
<span class="sd">    fcst_file_path : dict</span>
<span class="sd">        Dictionary mapping model names to forecast file paths.</span>
<span class="sd">    obs_hdcst : xarray.Dataset</span>
<span class="sd">        Observational hindcast dataset.</span>
<span class="sd">    obs_fcst_year : xarray.Dataset</span>
<span class="sd">        Observational forecast dataset for the specified year.</span>
<span class="sd">    month_of_initialization : int</span>
<span class="sd">        Month of model initialization.</span>
<span class="sd">    year_start : int</span>
<span class="sd">        Start year of the hindcast data.</span>
<span class="sd">    year_end : int</span>
<span class="sd">        End year of the hindcast data.</span>
<span class="sd">    year_forecast : int</span>
<span class="sd">        Forecast year.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Tuple of dictionaries (saved_hindcast_paths, saved_forecast_paths) mapping model names to saved file paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">t_coord</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year_forecast</span><span class="si">}</span><span class="s2">-12-31&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
    <span class="n">y_coords</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">Y</span>
    <span class="n">x_coords</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">X</span>

    <span class="k">if</span> <span class="n">calendar</span><span class="o">.</span><span class="n">isleap</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">):</span>
        <span class="c1"># dayofyear = obs_hdcst[&#39;T&#39;].dt.dayofyear</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;T.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">t_coord</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># da_noleap = obs_hdcst.sel(T=~((obs_hdcst[&#39;T&#39;].dt.month == 2) &amp; (obs_hdcst[&#39;T&#39;].dt.day == 29)))</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;T.dayofyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">daily_climatology</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">dayofyear</span><span class="o">=~</span><span class="p">((</span><span class="n">daily_climatology</span><span class="p">[</span><span class="s1">&#39;dayofyear&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">daily_climatology</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">t_coord</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="n">x_coords</span><span class="p">},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">abb_mont_ini</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">month_of_initialization</span><span class="p">)]</span>
    <span class="n">dir_to_save</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/model_data&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_to_save</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">saved_hindcast_paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hdcst_file_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/hindcast_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
            <span class="n">hdcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">hdcst_file_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">hdcst</span> <span class="o">=</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="n">hdcst</span> <span class="o">=</span> <span class="n">hdcst</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">obs_hdcst_sel</span> <span class="o">=</span> <span class="n">obs_hdcst</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end</span><span class="p">)))</span>
            <span class="n">obs_hdcst_interp</span> <span class="o">=</span> <span class="n">obs_hdcst_sel</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">hdcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">hdcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">hdcst</span><span class="p">,</span> <span class="n">obs_hdcst_interp</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_ds</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                <span class="n">ds_filled</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_filled</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">ds_processed</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="n">ds_processed</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
        <span class="n">saved_hindcast_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path</span>
    <span class="n">saved_forecast_paths</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fcst_file_path</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_to_save</span><span class="si">}</span><span class="s2">/forecast_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">abb_mont_ini</span><span class="si">}</span><span class="s2">Ic.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
            <span class="n">fcst</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fcst_file_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;number&#39;</span> <span class="ow">in</span> <span class="n">fcst</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">fcst</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span>
            <span class="n">fcst</span> <span class="o">=</span> <span class="n">fcst</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">obs_fcst_sel</span> <span class="o">=</span> <span class="n">obs_fcst_year</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year_forecast</span><span class="p">))</span>
            <span class="n">obs_fcst_interp</span> <span class="o">=</span> <span class="n">obs_fcst_sel</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">fcst</span><span class="p">,</span> <span class="n">obs_fcst_interp</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_fcst</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_fcst</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="n">dummy</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">Y</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">fcst</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
            <span class="n">ds1_aligned</span><span class="p">,</span> <span class="n">ds2_aligned</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">ds_filled</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
            <span class="n">filled_fcst_</span> <span class="o">=</span> <span class="n">ds1_aligned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">ds2_aligned</span><span class="p">)</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">filled_fcst_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ds_filled</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">==</span><span class="s2">&quot;PRCP&quot;</span><span class="p">:</span>
                <span class="n">ds_filled</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds_filled</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">ds_filled</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>
            <span class="n">ds_processed</span> <span class="o">=</span> <span class="n">ds_processed</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">)</span>
            <span class="n">ds_processed</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[SKIP] </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
        <span class="n">saved_forecast_paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_path</span>
    <span class="k">return</span> <span class="n">saved_hindcast_paths</span><span class="p">,</span> <span class="n">saved_forecast_paths</span></div>



<div class="viewcode-block" id="extraterrestrial_radiation">
<a class="viewcode-back" href="../../api.html#wass2s.utils.extraterrestrial_radiation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extraterrestrial_radiation</span><span class="p">(</span><span class="n">lat_da</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate daily extraterrestrial radiation (Ra) following FAO-56 equations (21â23).</span>

<span class="sd">    Computes the solar radiation at the top of the Earth&#39;s atmosphere, accounting</span>
<span class="sd">    for latitude, day of the year, and solar geometry. Handles polar day/night</span>
<span class="sd">    conditions by setting radiation to zero during polar night.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat_da : xarray.DataArray</span>
<span class="sd">        2D latitude field in degrees, with dimensions (&#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    time : pandas.DatetimeIndex</span>
<span class="sd">        1D array of datetime objects representing the time dimension.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Daily extraterrestrial radiation (Ra) with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;),</span>
<span class="sd">        units MJ m^-2 day^-1, and attributes for units and long name.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Based on FAO-56 Reference Evapotranspiration methodology (Allen et al., 1998).</span>
<span class="sd">    - Polar day/night is handled by setting Ra to 0 where the sunset hour angle is undefined.</span>
<span class="sd">    - The solar constant used is 0.082 MJ m^-2 min^-1, converted to daily values.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Allen, R. G., Pereira, L. S., Raes, D., &amp; Smith, M. (1998). Crop</span>
<span class="sd">    evapotranspiration: Guidelines for computing crop water requirements.</span>
<span class="sd">    FAO Irrigation and Drainage Paper 56.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">lat_da</span><span class="p">)</span>  <span class="c1"># Latitude in radians (Y, X)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">dayofyear</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">})</span>
    <span class="n">Î¸</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">365.25</span>  <span class="c1"># Day angle (rad)</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.033</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Î¸</span><span class="p">)</span>  <span class="c1"># Relative Earth-Sun distance</span>
    <span class="n">Î´</span> <span class="o">=</span> <span class="mf">0.409</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Î¸</span> <span class="o">-</span> <span class="mf">1.39</span><span class="p">)</span>  <span class="c1"># Solar declination (rad)</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">Î´</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>  <span class="c1"># Polar day/night</span>
                            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">Î´</span><span class="p">)))</span>  <span class="c1"># Sunset hour angle (rad)</span>

    <span class="c1"># (24*60/Ï) * G_sc = 37.586 MJ m^-2 day^-1</span>
    <span class="n">Ra</span> <span class="o">=</span> <span class="mf">37.586</span> <span class="o">*</span> <span class="n">dr</span> <span class="o">*</span> <span class="p">(</span><span class="n">ws</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Î´</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Î´</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ws</span><span class="p">))</span>
    <span class="n">Ra</span> <span class="o">=</span> <span class="n">Ra</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="mf">0.</span><span class="p">)</span>  <span class="c1"># Set polar night to 0</span>
    <span class="n">Ra</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Ra&quot;</span>
    <span class="n">Ra</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;MJ m^-2 day^-1&quot;</span><span class="p">,</span> <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Extraterrestrial radiation (daily)&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">Ra</span></div>


<div class="viewcode-block" id="svp">
<a class="viewcode-back" href="../../api.html#wass2s.utils.svp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">svp</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate saturated vapor pressure (es) using FAO-56 Equation 3.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    T : xarray.DataArray or numpy.ndarray</span>
<span class="sd">        Air temperature in degrees Celsius.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray or numpy.ndarray</span>
<span class="sd">        Saturated vapor pressure in kPa, with same shape as input.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - Based on the Tetens equation as presented in FAO-56.</span>
<span class="sd">    - Assumes input temperature is in Celsius.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Allen, R. G., Pereira, L. S., Raes, D., &amp; Smith, M. (1998). Crop</span>
<span class="sd">    evapotranspiration: Guidelines for computing crop water requirements.</span>
<span class="sd">    FAO Irrigation and Drainage Paper 56.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.6108</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">17.27</span> <span class="o">*</span> <span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span> <span class="o">+</span> <span class="mf">237.3</span><span class="p">))</span></div>


<div class="viewcode-block" id="et0_fao56_daily">
<a class="viewcode-back" href="../../api.html#wass2s.utils.et0_fao56_daily">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">et0_fao56_daily</span><span class="p">(</span><span class="n">tmax</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">mlsp</span><span class="p">,</span> <span class="n">dem</span><span class="p">,</span> <span class="n">tdew</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u10</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v10</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute daily reference evapotranspiration (ETâ) using the FAO-56 Penman-Monteith equation.</span>

<span class="sd">    Calculates ETâ for a hypothetical reference crop (grass, 0.12 m height) based on</span>
<span class="sd">    daily meteorological data, following the standardized FAO-56 methodology.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tmax : xarray.DataArray</span>
<span class="sd">        Daily maximum temperature in Â°C, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    tmin : xarray.DataArray</span>
<span class="sd">        Daily minimum temperature in Â°C, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    tdew : xarray.DataArray</span>
<span class="sd">        Daily mean dew point temperature in Â°C, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    u10 : xarray.DataArray, optional</span>
<span class="sd">        Daily mean zonal wind speed at 10 m height in m s^-1, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    v10 : xarray.DataArray, optional</span>
<span class="sd">        Daily mean meridional wind speed at 10 m height in m s^-1, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    wff : xarray.DataArray, optional</span>
<span class="sd">        Daily mean wind speed at 10 m height in m s^-1, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    rs : xarray.DataArray</span>
<span class="sd">        Daily mean incoming solar radiation in W m^-2 or MJ m^-2 day^-1, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    mlsp : xarray.DataArray</span>
<span class="sd">        Daily mean sea-level pressure in hPa, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;).</span>
<span class="sd">    dem : xarray.DataArray</span>
<span class="sd">        Digital elevation model (terrain height) in meters, with dimensions (&#39;Y&#39;, &#39;X&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarray.DataArray</span>
<span class="sd">        Daily reference evapotranspiration (ETâ) in mm day^-1, with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;),</span>
<span class="sd">        and attributes for units and long name.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - All input arrays must be on matching grids with dimensions (&#39;T&#39;, &#39;Y&#39;, &#39;X&#39;) except for</span>
<span class="sd">      `dem`, which is typically (&#39;Y&#39;, &#39;X&#39;) and interpolated to match.</span>
<span class="sd">    - Solar radiation input (`rs`) is automatically converted from W m^-2 to MJ m^-2 day^-1</span>
<span class="sd">      if values exceed 200 (assumed to be in W m^-2).</span>
<span class="sd">    - Wind speed at 10 m is converted to 2 m height using a logarithmic profile.</span>
<span class="sd">    - Soil heat flux (G) is assumed to be zero for daily calculations.</span>
<span class="sd">    - The albedo for the reference crop is fixed at 0.23.</span>
<span class="sd">    - Polar night conditions are handled in the extraterrestrial radiation calculation.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Allen, R. G., Pereira, L. S., Raes, D., &amp; Smith, M. (1998). Crop</span>
<span class="sd">    evapotranspiration: Guidelines for computing crop water requirements.</span>
<span class="sd">    FAO Irrigation and Drainage Paper 56.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># --- 0 Compute extraterrestrial radiation ---</span>
    <span class="n">dem</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">interp_like</span><span class="p">(</span><span class="n">tmax</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fill_value&quot;</span><span class="p">:</span> <span class="s2">&quot;extrapolate&quot;</span><span class="p">})</span>
    <span class="n">lat_da</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">dem</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">dem</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>
    <span class="n">lat_da</span> <span class="o">=</span> <span class="n">lat_da</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">extraterrestrial_radiation</span><span class="p">(</span><span class="n">lat_da</span><span class="p">,</span> <span class="n">tmax</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_index</span><span class="p">())</span>  <span class="c1"># MJ m^-2 day^-1</span>

    <span class="c1"># --- 1 Broadcast static fields ---</span>
    <span class="k">if</span> <span class="p">{</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">}</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tmax</span><span class="o">.</span><span class="n">dims</span><span class="p">):</span>
        <span class="n">dem</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">broadcast_like</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>

    <span class="c1"># --- 2 Temperature terms ---</span>
    <span class="n">tmean</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmax</span> <span class="o">+</span> <span class="n">tmin</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">Î</span> <span class="o">=</span> <span class="mi">4098</span> <span class="o">*</span> <span class="n">svp</span><span class="p">(</span><span class="n">tmean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmean</span> <span class="o">+</span> <span class="mf">237.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Slope of svp curve (kPa Â°C^-1)</span>

    <span class="c1"># --- 3 Pressures ---</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">mlsp</span> <span class="o">/</span> <span class="mf">10.0</span>  <span class="c1"># hPa to kPa</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">P0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.0065</span> <span class="o">*</span> <span class="n">dem</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmean</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">))</span><span class="o">**</span><span class="mf">5.257</span>  <span class="c1"># Hypsometric equation</span>
    <span class="n">PSI</span> <span class="o">=</span> <span class="mf">0.665e-3</span> <span class="o">*</span> <span class="n">P</span>  <span class="c1"># Psychrometric constant (kPa Â°C^-1)</span>

    <span class="c1"># --- 4 Wind ---</span>
    <span class="k">if</span> <span class="n">wff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ws10</span> <span class="o">=</span> <span class="n">wff</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">ws10</span> <span class="o">*</span> <span class="mf">4.87</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">67.8</span> <span class="o">*</span> <span class="mf">10.0</span> <span class="o">-</span> <span class="mf">5.42</span><span class="p">)</span>  <span class="c1"># Wind speed at 2 m</span>
    <span class="k">elif</span> <span class="n">u10</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v10</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># Use u10 and v10 if available</span>
        <span class="n">ws10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">u10</span><span class="p">,</span> <span class="n">v10</span><span class="p">)</span>  <span class="c1"># Wind speed at 10 m</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">ws10</span> <span class="o">*</span> <span class="mf">4.87</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">67.8</span> <span class="o">*</span> <span class="mf">10.0</span> <span class="o">-</span> <span class="mf">5.42</span><span class="p">)</span>  <span class="c1"># Wind speed at 2 m</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;wff&#39; or both &#39;u10&#39; and &#39;v10&#39; must be provided for wind speed calculation.&quot;</span><span class="p">)</span>


    <span class="c1"># --- 5 Vapour pressures ---</span>
    <span class="k">if</span> <span class="n">tdew</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If dew point is not provided, use tmin</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">tmin</span><span class="p">)</span>  <span class="c1"># Actual vapor pressure (kPa)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">tdew</span><span class="p">)</span>  <span class="c1"># Actual vapor pressure (kPa)</span>
    
    <span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="n">svp</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span> <span class="o">+</span> <span class="n">svp</span><span class="p">(</span><span class="n">tmin</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Saturated vapor pressure (kPa)</span>
    <span class="n">vpd</span> <span class="o">=</span> <span class="n">es</span> <span class="o">-</span> <span class="n">ea</span>  <span class="c1"># Vapor pressure deficit (kPa)</span>

    <span class="c1"># --- 6 Radiation ---</span>
    <span class="k">if</span> <span class="n">rs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># Convert W m^-2 to MJ m^-2 day^-1</span>
        <span class="n">Rs</span> <span class="o">=</span> <span class="n">rs</span> <span class="o">*</span> <span class="mi">86400</span> <span class="o">/</span> <span class="mf">1e6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Rs</span> <span class="o">=</span> <span class="n">rs</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.23</span>  <span class="c1"># Albedo</span>
    <span class="n">Rns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">Rs</span>  <span class="c1"># Net shortwave radiation</span>

    <span class="c1"># Clear-sky solar radiation at surface (Eq. 37)</span>
    <span class="n">Rs0</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.75</span> <span class="o">+</span> <span class="mf">2e-5</span> <span class="o">*</span> <span class="n">dem</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mf">4.903e-9</span>  <span class="c1"># Stefan-Boltzmann constant</span>
    <span class="c1"># Net longwave radiation (Eq. 39)</span>
    <span class="n">Rnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">*</span>
           <span class="p">((</span><span class="n">tmax</span> <span class="o">+</span> <span class="mf">273.16</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">+</span> <span class="mf">273.16</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span>
           <span class="p">(</span><span class="mf">0.34</span> <span class="o">-</span> <span class="mf">0.14</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ea</span><span class="p">))</span> <span class="o">*</span>
           <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1.35</span> <span class="o">*</span> <span class="n">Rs</span> <span class="o">/</span> <span class="n">Rs0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.35</span><span class="p">)</span>
    <span class="n">Rn</span> <span class="o">=</span> <span class="n">Rns</span> <span class="o">-</span> <span class="n">Rnl</span>  <span class="c1"># Net radiation</span>
    <span class="n">G</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Soil heat flux (daily scale)</span>

    <span class="c1"># --- 7 Penman-Monteith ---</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mf">0.408</span> <span class="o">*</span> <span class="n">Î</span> <span class="o">*</span> <span class="p">(</span><span class="n">Rn</span> <span class="o">-</span> <span class="n">G</span><span class="p">)</span> <span class="o">+</span> <span class="n">PSI</span> <span class="o">*</span> <span class="p">(</span><span class="mi">900</span> <span class="o">/</span> <span class="p">(</span><span class="n">tmean</span> <span class="o">+</span> <span class="mi">273</span><span class="p">))</span> <span class="o">*</span> <span class="n">u2</span> <span class="o">*</span> <span class="n">vpd</span>
    <span class="n">den</span> <span class="o">=</span> <span class="n">Î</span> <span class="o">+</span> <span class="n">PSI</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.34</span> <span class="o">*</span> <span class="n">u2</span><span class="p">)</span>
    <span class="n">et0</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">et0</span> <span class="o">=</span> <span class="n">et0</span><span class="o">.</span><span class="n">assign_attrs</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;mm day^-1&quot;</span><span class="p">,</span>
                           <span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Reference ET0 (FAO-56 PM)&quot;</span><span class="p">)</span>
    <span class="n">et0</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ET0&quot;</span>
    <span class="k">return</span> <span class="n">et0</span></div>


<span class="c1"># Other commmented code to use after</span>

<span class="c1"># retrieve Zone for PCR</span>

<span class="c1">###### Code to use after in several zones for PCR ##############################</span>
<span class="c1"># pca= xe.single.EOF(n_modes=6, use_coslat=True, standardize=True)</span>
<span class="c1"># pca.fit([i.fillna(i.mean(dim=&quot;T&quot;, skipna=True)).rename({&quot;X&quot;: &quot;lon&quot;, &quot;Y&quot;: &quot;lat&quot;}) for i in predictor], dim=&quot;T&quot;)</span>
<span class="c1"># components = pca.components()</span>
<span class="c1"># scores = pca.scores()</span>
<span class="c1"># expl = pca.explained_variance_ratio()</span>
<span class="c1"># expl</span>



<span class="c1"># def plot_prob_forecats(dir_to_save, forecast_prob, model_name):    </span>
<span class="c1">#     # Step 1: Extract maximum probability and category</span>
<span class="c1">#     max_prob = forecast_prob.max(dim=&quot;probability&quot;, skipna=True)  # Maximum probability at each grid point</span>
<span class="c1">#     # Fill NaN values with a very low value </span>
<span class="c1">#     filled_prob = forecast_prob.fillna(-9999)</span>
<span class="c1">#     # Compute argmax</span>
<span class="c1">#     max_category = filled_prob.argmax(dim=&quot;probability&quot;)</span>
    
<span class="c1">#     # Step 2: Create masks for each category</span>
<span class="c1">#     mask_bn = max_category == 0  # Below Normal (BN)</span>
<span class="c1">#     mask_nn = max_category == 1  # Near Normal (NN)</span>
<span class="c1">#     mask_an = max_category == 2  # Above Normal (AN)</span>
    
<span class="c1">#     # Step 3: Define custom colormaps</span>
<span class="c1">#     BN_cmap = mcolors.LinearSegmentedColormap.from_list(&#39;BN&#39;, [&#39;#FFF5F0&#39;, &#39;#FB6A4A&#39;, &#39;#67000D&#39;])</span>
<span class="c1">#     NN_cmap = mcolors.LinearSegmentedColormap.from_list(&#39;NN&#39;, [&#39;#F7FCF5&#39;, &#39;#74C476&#39;, &#39;#00441B&#39;])</span>
<span class="c1">#     AN_cmap = mcolors.LinearSegmentedColormap.from_list(&#39;AN&#39;, [&#39;#F7FBFF&#39;, &#39;#6BAED6&#39;, &#39;#08306B&#39;])</span>
    
<span class="c1">#     # Create a figure with GridSpec</span>
<span class="c1">#     fig = plt.figure(figsize=(8, 6))</span>
<span class="c1">#     gs = gridspec.GridSpec(2, 3, height_ratios=[15, 0.5])</span>
    
<span class="c1">#     # Main map axis</span>
<span class="c1">#     ax = fig.add_subplot(gs[0, :], projection=ccrs.PlateCarree())</span>
    
<span class="c1">#     # Step 4: Plot each category</span>
<span class="c1">#     # Multiply by 100 to convert probabilities to percentages</span>
<span class="c1">#     bn_data = (max_prob.where(mask_bn) * 100).values</span>
<span class="c1">#     nn_data = (max_prob.where(mask_nn) * 100).values</span>
<span class="c1">#     an_data = (max_prob.where(mask_an) * 100).values</span>
    
<span class="c1">#     # Plot BN (Below Normal)</span>
<span class="c1">#     bn_plot = ax.pcolormesh(</span>
<span class="c1">#         forecast_prob[&#39;X&#39;], forecast_prob[&#39;Y&#39;], bn_data,</span>
<span class="c1">#         cmap=BN_cmap, transform=ccrs.PlateCarree(), alpha=0.9</span>
<span class="c1">#     )</span>
    
<span class="c1">#     # Plot NN (Near Normal)</span>
<span class="c1">#     nn_plot = ax.pcolormesh(</span>
<span class="c1">#         forecast_prob[&#39;X&#39;], forecast_prob[&#39;Y&#39;], nn_data,</span>
<span class="c1">#         cmap=NN_cmap, transform=ccrs.PlateCarree(), alpha=0.9</span>
<span class="c1">#     )</span>
    
<span class="c1">#     # Plot AN (Above Normal)</span>
<span class="c1">#     an_plot = ax.pcolormesh(</span>
<span class="c1">#         forecast_prob[&#39;X&#39;], forecast_prob[&#39;Y&#39;], an_data,</span>
<span class="c1">#         cmap=AN_cmap, transform=ccrs.PlateCarree(), alpha=0.9</span>
<span class="c1">#     )</span>
    
<span class="c1">#     # Step 5: Add coastlines and borders</span>
<span class="c1">#     ax.coastlines()</span>
<span class="c1">#     ax.add_feature(cfeature.BORDERS, linestyle=&#39;:&#39;)</span>
    
<span class="c1">#     # Step 6: Add individual colorbars with ticks at intervals of 5</span>
    
<span class="c1">#     # Function to create ticks at intervals of 5</span>
<span class="c1">#     def create_ticks(data):</span>
<span class="c1">#         data_min = np.nanmin(data)</span>
<span class="c1">#         data_max = np.nanmax(data)</span>
<span class="c1">#         if data_min == data_max:</span>
<span class="c1">#             ticks = [data_min]</span>
<span class="c1">#         else:</span>
<span class="c1">#             # Round min and max to nearest multiples of 5</span>
<span class="c1">#             data_min_rounded = (np.floor(data_min / 5) * 5)+5</span>
<span class="c1">#             data_max_rounded = (np.ceil(data_max / 5) * 5)-5</span>
<span class="c1">#             ticks = np.arange(data_min_rounded, data_max_rounded + 1, 10)</span>
<span class="c1">#         return ticks</span>
    
<span class="c1">#     # For BN (Below Normal)</span>
<span class="c1">#     bn_ticks = create_ticks(bn_data)</span>
    
<span class="c1">#     cbar_ax_bn = fig.add_subplot(gs[1, 0])</span>
<span class="c1">#     cbar_bn = plt.colorbar(bn_plot, cax=cbar_ax_bn, orientation=&#39;horizontal&#39;)</span>
<span class="c1">#     cbar_bn.set_label(&#39;BN (%)&#39;)</span>
<span class="c1">#     cbar_bn.set_ticks(bn_ticks)</span>
<span class="c1">#     cbar_bn.set_ticklabels([f&quot;{tick:.0f}&quot; for tick in bn_ticks])</span>
    
<span class="c1">#     # For NN (Near Normal)</span>
<span class="c1">#     nn_ticks = create_ticks(nn_data)</span>
    
<span class="c1">#     cbar_ax_nn = fig.add_subplot(gs[1, 1])</span>
<span class="c1">#     cbar_nn = plt.colorbar(nn_plot, cax=cbar_ax_nn, orientation=&#39;horizontal&#39;)</span>
<span class="c1">#     cbar_nn.set_label(&#39;NN (%)&#39;)</span>
<span class="c1">#     cbar_nn.set_ticks(nn_ticks)</span>
<span class="c1">#     cbar_nn.set_ticklabels([f&quot;{tick:.0f}&quot; for tick in nn_ticks])</span>
    
<span class="c1">#     # For AN (Above Normal)</span>
<span class="c1">#     an_ticks = create_ticks(an_data)</span>
    
<span class="c1">#     cbar_ax_an = fig.add_subplot(gs[1, 2])</span>
<span class="c1">#     cbar_an = plt.colorbar(an_plot, cax=cbar_ax_an, orientation=&#39;horizontal&#39;)</span>
<span class="c1">#     cbar_an.set_label(&#39;AN (%)&#39;)</span>
<span class="c1">#     cbar_an.set_ticks(an_ticks)</span>
<span class="c1">#     cbar_an.set_ticklabels([f&quot;{tick:.0f}&quot; for tick in an_ticks])</span>
<span class="c1">#     ax.set_title(f&quot;Forecast - {model_name}&quot;, fontsize=14, pad=20)</span>
<span class="c1">#     plt.tight_layout()</span>
<span class="c1">#     plt.savefig(f&quot;{dir_to_save}/Forecast_{model_name}_.png&quot;, dpi=300, bbox_inches=&#39;tight&#39;)</span>
<span class="c1">#     plt.show()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>