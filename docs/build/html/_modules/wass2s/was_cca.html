

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wass2s.was_cca &mdash; wass2s 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            wass2s
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">wass2s.was_download</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wass2s</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">wass2s.was_cca</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for wass2s.was_cca</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">sig</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gamma</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">lognorm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">xeofs</span> <span class="k">as</span> <span class="nn">xe</span>
<span class="kn">from</span> <span class="nn">wass2s.utils</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="WAS_CCA_">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_CCA_</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_pca_modes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_pca</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_CCA class with specified parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - n_modes: Number of canonical modes to compute.</span>
<span class="sd">        - n_pca_modes: Number of PCA modes to use before CCA.</span>
<span class="sd">        - standardize: Whether to standardize the data. Keep it False in our case data already standardize</span>
<span class="sd">        - use_coslat: Whether to use cosine latitude weighting.</span>
<span class="sd">        - use_pca: Whether to perform PCA before CCA.</span>
<span class="sd">        - detrend: Whether to apply detrending to the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="n">n_modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pca_modes</span> <span class="o">=</span> <span class="n">n_pca_modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span> <span class="o">=</span> <span class="n">standardize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_coslat</span> <span class="o">=</span> <span class="n">use_coslat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pca</span> <span class="o">=</span> <span class="n">use_pca</span>
        <span class="c1"># self.detrend = detrend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cca</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">CCA</span><span class="p">(</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
            <span class="n">standardize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">,</span>
            <span class="n">use_coslat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_coslat</span><span class="p">,</span>
            <span class="n">use_pca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pca</span><span class="p">,</span>
            <span class="n">n_pca_modes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pca_modes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="o">=</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="WAS_CCA_.fit_cca">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.fit_cca">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_cca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the CCA model using the training data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preprocess the data</span>
        <span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="c1"># Fit the CCA model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span></div>


    <span class="c1"># def detrend_data(self, data): ### Replace detrend by extendedEOF after</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Detrend the data along the &#39;T&#39; dimension if detrending is enabled.</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     - data: xarray DataArray to be detrended.</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#     - data_detrended: Detrended xarray DataArray.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if self.detrend:</span>
    <span class="c1">#         # Create mask for missing data</span>
    <span class="c1">#         mask = xr.where(np.isnan(data), np.nan, 1)</span>
    <span class="c1">#         # mask = np.where(np.isnan(data.isel(T=0)), np.nan, 1)</span>
    <span class="c1">#         # Fill missing values with zero before detrending</span>
    <span class="c1">#         data_filled = data.fillna(0)</span>
    <span class="c1">#         # Detrend data along &#39;T&#39; axis (axis=0)</span>
    <span class="c1">#         data_detrended = sig.detrend(data_filled, axis=0)</span>
    <span class="c1">#         data_detrended = xr.DataArray(data_detrended, dims=data.dims, coords=data.coords)</span>
    <span class="c1">#         # Apply mask after detrending</span>
    <span class="c1">#         # data_detrended = data_detrended * mask</span>
    <span class="c1">#         return data_detrended</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return data</span>

    <span class="c1"># def preprocess_data(self, X, Y):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Preprocess the data by detrending, masking, and filling missing values.</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     - X: xarray DataArray for predictors.</span>
    <span class="c1">#     - Y: xarray DataArray for predictands.</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#     - X_final: Preprocessed X data.</span>
    <span class="c1">#     - Y_final: Preprocessed Y data.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Apply detrending and masking (masking is now inside detrend_data)</span>
    <span class="c1">#     X_processed = self.detrend_data(X)</span>
    <span class="c1">#     # Fill missing values with mean along &#39;T&#39;</span>
    <span class="c1">#     X_final = X_processed.fillna(X_processed.mean(dim=&quot;T&quot;, skipna=True))</span>

    <span class="c1">#     # Process Y data (assuming we do not detrend Y)</span>
    <span class="c1">#     Y_final = Y.fillna(Y.mean(dim=&quot;T&quot;, skipna=True))</span>

    <span class="c1">#     # Rename dimensions and transpose</span>
    <span class="c1">#     dims_rename = {&quot;X&quot;: &quot;lon&quot;, &quot;Y&quot;: &quot;lat&quot;}</span>
    <span class="c1">#     X_final = X_final.rename(dims_rename).transpose(&#39;T&#39;, &#39;lat&#39;, &#39;lon&#39;)</span>
    <span class="c1">#     Y_final = Y_final.rename(dims_rename).transpose(&#39;T&#39;, &#39;lat&#39;, &#39;lon&#39;)</span>

    <span class="c1">#     return X_final, Y_final</span>

<div class="viewcode-block" id="WAS_CCA_.preprocess_data">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.preprocess_data">[docs]</a>
    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the data by detrending, masking, and filling missing values.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X: xarray DataArray for predictors.</span>
<span class="sd">        - Y: xarray DataArray for predictands.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - X_final: Preprocessed X data.</span>
<span class="sd">        - Y_final: Preprocessed Y data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply detrending to both X and Y</span>
        <span class="n">X_processed</span> <span class="o">=</span> <span class="n">X</span> <span class="c1">#- self.detrend_data(X)</span>
        <span class="n">Y_processed</span> <span class="o">=</span> <span class="n">Y</span> <span class="c1">#- self.detrend_data(Y)</span>

        <span class="c1"># Fill missing values with mean along &#39;T&#39;</span>
        <span class="n">X_final</span> <span class="o">=</span> <span class="n">X_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X_processed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">Y_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">Y_processed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Rename dimensions and transpose</span>
        <span class="n">dims_rename</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">}</span>
        <span class="n">X_final</span> <span class="o">=</span> <span class="n">X_final</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>
        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">Y_final</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_final</span><span class="p">,</span> <span class="n">Y_final</span></div>


<div class="viewcode-block" id="WAS_CCA_.preprocess_test_data">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.preprocess_test_data">[docs]</a>
    <span class="k">def</span> <span class="nf">preprocess_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the test data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_test: xarray DataArray for predictor testing data.</span>
<span class="sd">        - y_test: xarray DataArray for predictand testing data.</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - X_test_prepared: Preprocessed X test data.</span>
<span class="sd">        - y_test_prepared: Preprocessed Y test data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply detrending and masking</span>
        <span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">X_test</span> <span class="c1">#- self.detrend_data(X_train).mean(dim=&quot;T&quot;, skipna=True)</span>
        <span class="n">y_test_processed</span> <span class="o">=</span> <span class="n">y_test</span> 
        
        <span class="c1"># Fill missing values with mean from training data along &#39;T&#39;</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">X_test_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>        
        <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="n">y_test_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Rename dimensions and transpose</span>
        <span class="n">dims_rename</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">}</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">X_test_prepared</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>
        <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="n">y_test_prepared</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_test_prepared</span><span class="p">,</span> <span class="n">y_test_prepared</span></div>


<div class="viewcode-block" id="WAS_CCA_.compute_model">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.compute_model">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the CCA model and generate hindcasts.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>
<span class="sd">        - X_test: xarray DataArray for predictor testing data.</span>
<span class="sd">        - y_test: xarray DataArray for predictand testing data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - hindcast: xarray DataArray containing predictions and errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1"># Fit the CCA model</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
        <span class="c1"># Prepare test data</span>
        <span class="n">X_test_prepared</span><span class="p">,</span> <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_test_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 

        <span class="n">y_pred</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_prepared</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="c1"># Calculate error</span>
        <span class="c1"># error = y_test_prepared - y_pred</span>

        <span class="c1"># Combine prediction and error into a DataArray</span>
        <span class="c1"># hindcast = xr.concat([error, y_pred], dim=&quot;output&quot;)</span>
        <span class="n">hindcast</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
        <span class="c1"># hindcast = hindcast.assign_coords(output=[&#39;error&#39;, &#39;prediction&#39;])</span>

        <span class="k">return</span> <span class="n">hindcast</span></div>


<div class="viewcode-block" id="WAS_CCA_.calculate_tercile_probabilities">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.calculate_tercile_probabilities">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the probability of each tercile category.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">first_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>
            <span class="n">second_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">second_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>

            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_CCA_.calculate_tercile_probabilities_gamma">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.calculate_tercile_probabilities_gamma">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_gamma</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>

        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
        <span class="c1"># If all best_guess are NaN, just fill everything with NaN</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>
    
        <span class="c1"># Convert inputs to arrays (in case they&#39;re lists)</span>
        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
        <span class="c1"># Calculate shape (alpha) and scale (theta) for the Gamma distribution</span>
        <span class="c1"># alpha = (mean^2) / variance</span>
        <span class="c1"># theta = variance / mean</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>
    
        <span class="c1"># Compute CDF at T1, T2 (no loop over n_time)</span>
        <span class="n">cdf_t1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>  <span class="c1"># P(X &lt; T1)</span>
        <span class="n">cdf_t2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>  <span class="c1"># P(X &lt; T2)</span>
    
        <span class="c1"># Fill out the probabilities</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t2</span> <span class="o">-</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_t2</span>

        <span class="n">dof</span><span class="o">=</span><span class="n">dof</span>
    
        <span class="k">return</span> <span class="n">pred_prob</span></div>

    
<div class="viewcode-block" id="WAS_CCA_.compute_prob">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.compute_prob">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes tercile category probabilities for hindcasts over a climatological period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>

        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate degrees of freedom</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compute probabilities using xr.apply_ufunc</span>
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span><span class="p">,</span>
            <span class="n">hindcast_det</span><span class="p">,</span><span class="c1">#.sel(output=&quot;prediction&quot;).drop_vars(&quot;output&quot;).squeeze(),</span>
            <span class="n">error_variance</span><span class="p">,</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
        <span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="WAS_CCA_.forecast">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">Predictor</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">Predictor_for_year</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">Predictor_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictor</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">Predictor</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictor</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Predictant_st</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">Predictant_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant_st</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">Predictant_st</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictant_st</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">Predictor_for_year_</span> <span class="o">=</span> <span class="p">((((</span><span class="n">Predictor_for_year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">Predictor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>

        <span class="c1"># last_trend_X = ((trend_data(standardize_timeseries(Predictor, clim_year_start, clim_year_end))).isel(T=[-3]))</span>
        <span class="n">last_trend_X</span> <span class="o">=</span> <span class="p">((</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictor</span><span class="p">))</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">last_trend_X</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Predictor_for_year_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="c1"># Predictor_for_year__ = Predictor_for_year_.fillna(0)</span>
        <span class="n">Predictor_for_year__</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictor_for_year_</span> <span class="o">-</span> <span class="n">last_trend_X</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Fit the CCA model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">Predictor_</span><span class="p">,</span> <span class="n">Predictant_</span><span class="p">)</span>
            
        <span class="c1"># Prepare test data</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">Predictor_for_year__</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">result_</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
        
        <span class="n">last_trend_Y</span> <span class="o">=</span> <span class="p">((</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictant_st</span><span class="p">))</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">last_trend_Y</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">result_</span> <span class="o">=</span> <span class="p">(</span><span class="n">result_</span> <span class="o">+</span> <span class="n">last_trend_Y</span><span class="p">)</span>
        <span class="n">result_</span> <span class="o">=</span> <span class="n">reverse_standardize</span><span class="p">(</span><span class="n">result_</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> 
        
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant_</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span> <span class="o">=</span> <span class="n">Predictant_</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant_</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span><span class="p">,</span>
            <span class="n">result_</span><span class="p">,</span><span class="c1">#.expand_dims({&#39;T&#39;:1}),</span>
            <span class="n">error_variance</span><span class="p">,</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
            <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
            <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
            <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
            <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,)],</span>
            <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
            <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}},</span>
        <span class="p">)</span>
        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span> <span class="s1">&#39;PN&#39;</span><span class="p">,</span> <span class="s1">&#39;PA&#39;</span><span class="p">]))</span> 
        <span class="k">return</span> <span class="n">result_</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span></div>

        

<div class="viewcode-block" id="WAS_CCA_.plot_cca_results">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA_.plot_cca_results">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cca_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the CCA modes and scores.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X: Optional xarray DataArray for predictors. If provided, the model will be fitted using X and Y.</span>
<span class="sd">        - Y: Optional xarray DataArray for predictands.</span>
<span class="sd">        - n_modes: Number of modes to plot. If None, plots all modes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="c1"># mask.name = None</span>
            
            <span class="n">X_</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            
            <span class="c1"># Fit the model using the provided data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Y_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CCA model has not been fitted yet. Provide X and Y data to fit the model.&quot;</span><span class="p">)</span>

        <span class="c1"># Get components (modes) and scores</span>
        <span class="n">X_modes</span><span class="p">,</span> <span class="n">Y_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">components</span><span class="p">()</span>  <span class="c1"># Spatial patterns</span>
        <span class="n">X_scores</span><span class="p">,</span> <span class="n">Y_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span>    <span class="c1"># Temporal projections (canonical variates)</span>

        <span class="c1"># Get explained variances</span>
        <span class="n">var_explained_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_X_explained_by_X</span><span class="p">()</span>
        <span class="n">var_explained_Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_Y_explained_by_Y</span><span class="p">()</span>
        <span class="n">var_explained_Y_by_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_Y_explained_by_X</span><span class="p">()</span>

        <span class="c1"># Determine number of modes to plot</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>

        <span class="c1"># Mode indices start from 1 in xeofs</span>
        <span class="n">mode_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_modes</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">n_modes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mode_indices</span><span class="p">):</span>

            <span class="c1"># First Column: Plot X_modes</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">X_mode</span> <span class="o">=</span> <span class="n">X_modes</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">X_mode</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">)</span>
            <span class="n">var_X</span> <span class="o">=</span> <span class="n">var_explained_X</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_X</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance explained)&#39;</span><span class="p">)</span>

            <span class="c1"># Second Column: Plot X_scores and Y_scores</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">X_score</span> <span class="o">=</span> <span class="n">X_scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">Y_score</span> <span class="o">=</span> <span class="n">Y_scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">var_Y_X</span> <span class="o">=</span> <span class="n">var_explained_Y_by_X</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_score</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">X_score</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X Score&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_score</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">Y_score</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y Score&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1">#### line Canonical Variate = 0</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scores for Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_Y_X</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance Y explained by X)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Canonical Variate&#39;</span><span class="p">)</span>

            <span class="c1"># Third Column: Plot Y_modes</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">Y_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_modes</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">))</span><span class="o">*</span><span class="n">mask</span>
            <span class="n">Y_mode</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">)</span>
            <span class="n">var_Y</span> <span class="o">=</span> <span class="n">var_explained_Y</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Y Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_Y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance explained)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>




<div class="viewcode-block" id="WAS_CCA">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA">[docs]</a>
<span class="k">class</span> <span class="nc">WAS_CCA</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_pca_modes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_pca</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the WAS_CCA class with specified parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - n_modes: Number of canonical modes to compute.</span>
<span class="sd">        - n_pca_modes: Number of PCA modes to use before CCA.</span>
<span class="sd">        - standardize: Whether to standardize the data. Keep it False in our case data already standardize</span>
<span class="sd">        - use_coslat: Whether to use cosine latitude weighting.</span>
<span class="sd">        - use_pca: Whether to perform PCA before CCA.</span>
<span class="sd">        - detrend: Whether to apply detrending to the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span> <span class="o">=</span> <span class="n">n_modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pca_modes</span> <span class="o">=</span> <span class="n">n_pca_modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">standardize</span> <span class="o">=</span> <span class="n">standardize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_coslat</span> <span class="o">=</span> <span class="n">use_coslat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pca</span> <span class="o">=</span> <span class="n">use_pca</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">=</span> <span class="n">dist_method</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cca</span> <span class="o">=</span> <span class="n">xe</span><span class="o">.</span><span class="n">cross</span><span class="o">.</span><span class="n">CCA</span><span class="p">(</span>
            <span class="n">n_modes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span><span class="p">,</span>
            <span class="n">standardize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">,</span>
            <span class="n">use_coslat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_coslat</span><span class="p">,</span>
            <span class="n">use_pca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pca</span><span class="p">,</span>
            <span class="n">n_pca_modes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pca_modes</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="o">=</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="WAS_CCA.fit_cca">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.fit_cca">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_cca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the CCA model using the training data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preprocess the data</span>
        <span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="c1"># Fit the CCA model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_final</span><span class="p">,</span> <span class="n">y_train_final</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">)</span></div>


    <span class="c1"># def detrend_data(self, data): ### Replace detrend by extendedEOF after</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Detrend the data along the &#39;T&#39; dimension if detrending is enabled.</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     - data: xarray DataArray to be detrended.</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#     - data_detrended: Detrended xarray DataArray.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if self.detrend:</span>
    <span class="c1">#         # Create mask for missing data</span>
    <span class="c1">#         mask = xr.where(np.isnan(data), np.nan, 1)</span>
    <span class="c1">#         # mask = np.where(np.isnan(data.isel(T=0)), np.nan, 1)</span>
    <span class="c1">#         # Fill missing values with zero before detrending</span>
    <span class="c1">#         data_filled = data.fillna(0)</span>
    <span class="c1">#         # Detrend data along &#39;T&#39; axis (axis=0)</span>
    <span class="c1">#         data_detrended = sig.detrend(data_filled, axis=0)</span>
    <span class="c1">#         data_detrended = xr.DataArray(data_detrended, dims=data.dims, coords=data.coords)</span>
    <span class="c1">#         # Apply mask after detrending</span>
    <span class="c1">#         # data_detrended = data_detrended * mask</span>
    <span class="c1">#         return data_detrended</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         return data</span>

    <span class="c1"># def preprocess_data(self, X, Y):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Preprocess the data by detrending, masking, and filling missing values.</span>

    <span class="c1">#     Parameters:</span>
    <span class="c1">#     - X: xarray DataArray for predictors.</span>
    <span class="c1">#     - Y: xarray DataArray for predictands.</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#     - X_final: Preprocessed X data.</span>
    <span class="c1">#     - Y_final: Preprocessed Y data.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     # Apply detrending and masking (masking is now inside detrend_data)</span>
    <span class="c1">#     X_processed = self.detrend_data(X)</span>
    <span class="c1">#     # Fill missing values with mean along &#39;T&#39;</span>
    <span class="c1">#     X_final = X_processed.fillna(X_processed.mean(dim=&quot;T&quot;, skipna=True))</span>

    <span class="c1">#     # Process Y data (assuming we do not detrend Y)</span>
    <span class="c1">#     Y_final = Y.fillna(Y.mean(dim=&quot;T&quot;, skipna=True))</span>

    <span class="c1">#     # Rename dimensions and transpose</span>
    <span class="c1">#     dims_rename = {&quot;X&quot;: &quot;lon&quot;, &quot;Y&quot;: &quot;lat&quot;}</span>
    <span class="c1">#     X_final = X_final.rename(dims_rename).transpose(&#39;T&#39;, &#39;lat&#39;, &#39;lon&#39;)</span>
    <span class="c1">#     Y_final = Y_final.rename(dims_rename).transpose(&#39;T&#39;, &#39;lat&#39;, &#39;lon&#39;)</span>

    <span class="c1">#     return X_final, Y_final</span>

<div class="viewcode-block" id="WAS_CCA.preprocess_data">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.preprocess_data">[docs]</a>
    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the data by detrending, masking, and filling missing values.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X: xarray DataArray for predictors.</span>
<span class="sd">        - Y: xarray DataArray for predictands.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - X_final: Preprocessed X data.</span>
<span class="sd">        - Y_final: Preprocessed Y data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply detrending to both X and Y</span>
        <span class="n">X_processed</span> <span class="o">=</span> <span class="n">X</span> <span class="c1">#- self.detrend_data(X)</span>
        <span class="n">Y_processed</span> <span class="o">=</span> <span class="n">Y</span> <span class="c1">#- self.detrend_data(Y)</span>

        <span class="c1"># Fill missing values with mean along &#39;T&#39;</span>
        <span class="n">X_final</span> <span class="o">=</span> <span class="n">X_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X_processed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">Y_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">Y_processed</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Rename dimensions and transpose</span>
        <span class="n">dims_rename</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">}</span>
        <span class="n">X_final</span> <span class="o">=</span> <span class="n">X_final</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>
        <span class="n">Y_final</span> <span class="o">=</span> <span class="n">Y_final</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_final</span><span class="p">,</span> <span class="n">Y_final</span></div>


<div class="viewcode-block" id="WAS_CCA.preprocess_test_data">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.preprocess_test_data">[docs]</a>
    <span class="k">def</span> <span class="nf">preprocess_test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess the test data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_test: xarray DataArray for predictor testing data.</span>
<span class="sd">        - y_test: xarray DataArray for predictand testing data.</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - X_test_prepared: Preprocessed X test data.</span>
<span class="sd">        - y_test_prepared: Preprocessed Y test data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply detrending and masking</span>
        <span class="n">X_test_processed</span> <span class="o">=</span> <span class="n">X_test</span> <span class="c1">#- self.detrend_data(X_train).mean(dim=&quot;T&quot;, skipna=True)</span>
        <span class="n">y_test_processed</span> <span class="o">=</span> <span class="n">y_test</span> 
        
        <span class="c1"># Fill missing values with mean from training data along &#39;T&#39;</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">X_test_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>        
        <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="n">y_test_processed</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Rename dimensions and transpose</span>
        <span class="n">dims_rename</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">}</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">X_test_prepared</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>
        <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="n">y_test_prepared</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">dims_rename</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_test_prepared</span><span class="p">,</span> <span class="n">y_test_prepared</span></div>


<div class="viewcode-block" id="WAS_CCA.compute_model">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.compute_model">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the CCA model and generate hindcasts.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X_train: xarray DataArray for predictor training data.</span>
<span class="sd">        - y_train: xarray DataArray for predictand training data.</span>
<span class="sd">        - X_test: xarray DataArray for predictor testing data.</span>
<span class="sd">        - y_test: xarray DataArray for predictand testing data.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - hindcast: xarray DataArray containing predictions and errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1"># Fit the CCA model</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            
        <span class="c1"># Prepare test data</span>
        <span class="n">X_test_prepared</span><span class="p">,</span> <span class="n">y_test_prepared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_test_data</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 

        <span class="n">y_pred</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_test_prepared</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="c1"># Calculate error</span>
        <span class="c1"># error = y_test_prepared - y_pred</span>

        <span class="c1"># Combine prediction and error into a DataArray</span>
        <span class="c1"># hindcast = xr.concat([error, y_pred], dim=&quot;output&quot;)</span>
        <span class="n">hindcast</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
        <span class="c1"># hindcast = hindcast.assign_coords(output=[&#39;error&#39;, &#39;prediction&#39;])</span>

        <span class="k">return</span> <span class="n">hindcast</span></div>


    <span class="c1"># --------------------------------------------------------------------------</span>
    <span class="c1">#  Probability Calculation Methods</span>
    <span class="c1"># --------------------------------------------------------------------------</span>
<div class="viewcode-block" id="WAS_CCA.calculate_tercile_probabilities">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.calculate_tercile_probabilities">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">,</span> <span class="n">dof</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Student&#39;s t-based method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">first_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>
            <span class="n">second_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">second_tercile</span> <span class="o">-</span> <span class="n">best_guess</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_std</span>

            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_t</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_CCA.calculate_tercile_probabilities_gamma">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.calculate_tercile_probabilities_gamma">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_gamma</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gamma-based method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>

        <span class="n">best_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">error_variance</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">error_variance</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="n">best_guess</span>

        <span class="n">cdf_t1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">cdf_t2</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cdf_t2</span> <span class="o">-</span> <span class="n">cdf_t1</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">cdf_t2</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_CCA.calculate_tercile_probabilities_nonparametric">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.calculate_tercile_probabilities_nonparametric">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_nonparametric</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_samples</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Non-parametric method (requires historical errors).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_time</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                <span class="k">continue</span>

            <span class="n">dist</span> <span class="o">=</span> <span class="n">best_guess</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_samples</span>  
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span>  
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">p_below</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">first_tercile</span><span class="p">)</span>
            <span class="n">p_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">dist</span> <span class="o">&gt;=</span> <span class="n">first_tercile</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">second_tercile</span><span class="p">))</span>
            <span class="n">p_above</span>   <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_below</span> <span class="o">+</span> <span class="n">p_between</span><span class="p">)</span>

            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_below</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_between</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_above</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_CCA.calculate_tercile_probabilities_normal">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.calculate_tercile_probabilities_normal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_normal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normal-based method using the Gaussian CDF.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span> <span class="o">-</span> \
                              <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
            <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">error_std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>


<div class="viewcode-block" id="WAS_CCA.calculate_tercile_probabilities_lognormal">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.calculate_tercile_probabilities_lognormal">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">calculate_tercile_probabilities_lognormal</span><span class="p">(</span><span class="n">best_guess</span><span class="p">,</span> <span class="n">error_variance</span><span class="p">,</span> <span class="n">first_tercile</span><span class="p">,</span> <span class="n">second_tercile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lognormal-based method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span>
        <span class="n">pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_time</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">best_guess</span><span class="p">))</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">error_variance</span><span class="p">)):</span>
            <span class="n">pred_prob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">pred_prob</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">error_variance</span> <span class="o">/</span> <span class="p">(</span><span class="n">best_guess</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">best_guess</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">-</span> \
                          <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">first_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="n">pred_prob</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">second_tercile</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pred_prob</span></div>

    
<div class="viewcode-block" id="WAS_CCA.compute_prob">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.compute_prob">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_prob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute tercile probabilities using self.dist_method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Predictant : xarray.DataArray (T, Y, X)</span>
<span class="sd">            Observed data.</span>
<span class="sd">        clim_year_start : int</span>
<span class="sd">        clim_year_end : int</span>
<span class="sd">            The start and end years for the climatology.</span>
<span class="sd">        hindcast_det : xarray.DataArray</span>
<span class="sd">            Deterministic forecast with dims (output=2, T, Y, X).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hindcast_prob : xarray.DataArray</span>
<span class="sd">            dims (probability=3, T, Y, X) =&gt; [PB, PN, PA].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1) Identify climatology slice</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span>   <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

        <span class="n">T1</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>

        <span class="c1"># 2) Distinguish distribution method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_normal</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_lognormal</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">hindcast_det</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dist_method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">. &quot;</span>
                             <span class="s2">&quot;Must be one of [&#39;t&#39;,&#39;gamma&#39;,&#39;normal&#39;,&#39;lognormal&#39;,&#39;nonparam&#39;].&quot;</span><span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span><span class="s1">&#39;PN&#39;</span><span class="p">,</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="WAS_CCA.forecast">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.forecast">[docs]</a>
    <span class="k">def</span> <span class="nf">forecast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">Predictor</span><span class="p">,</span> <span class="n">hindcast_det</span><span class="p">,</span> <span class="n">Predictor_for_year</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">Predictor_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictor</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">Predictor</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictor</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Predictant_st</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
        <span class="n">Predictant_</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant_st</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">Predictant_st</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">Predictant_st</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">Predictor_for_year_</span> <span class="o">=</span> <span class="p">((((</span><span class="n">Predictor_for_year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">Predictor</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;Y&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>

        <span class="c1"># last_trend_X = ((trend_data(standardize_timeseries(Predictor, clim_year_start, clim_year_end))).isel(T=[-3]))</span>
        <span class="c1"># last_trend_X = ((trend_data(Predictor)).isel(T=[-3]))</span>
        <span class="c1"># last_trend_X[&#39;T&#39;] = Predictor_for_year_[&#39;T&#39;]</span>
        <span class="c1"># Predictor_for_year__ = Predictor_for_year_.fillna(0)</span>
        <span class="c1"># Predictor_for_year__ = (Predictor_for_year_ - last_trend_X).fillna(0)</span>

        <span class="n">Predictor_for_year__</span> <span class="o">=</span> <span class="n">Predictor_for_year_</span>

        <span class="c1"># Fit the CCA model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">Predictor_</span><span class="p">,</span> <span class="n">Predictant_</span><span class="p">)</span>
            
        <span class="c1"># Prepare test data</span>
        <span class="n">X_test_prepared</span> <span class="o">=</span> <span class="n">Predictor_for_year__</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="s2">&quot;lat&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">)</span>

        <span class="c1"># Predict</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_prepared</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">result_</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">})</span>
        
        <span class="c1"># last_trend_Y = ((trend_data(Predictant_st)).isel(T=[-3]))</span>
        <span class="c1"># last_trend_Y[&#39;T&#39;] = result_[&#39;T&#39;]</span>
        <span class="c1"># result_ = (result_ + last_trend_Y)</span>
       
        <span class="n">result_</span> <span class="o">=</span> <span class="n">reverse_standardize</span><span class="p">(</span><span class="n">result_</span><span class="p">,</span> <span class="n">Predictant</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> 
        
        <span class="c1"># 2) Compute thresholds T1, T2 from climatology</span>
        <span class="n">index_start</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_start</span><span class="p">))</span><span class="o">.</span><span class="n">start</span>
        <span class="n">index_end</span>   <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">rainfall_for_tercile</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">index_start</span><span class="p">,</span> <span class="n">index_end</span><span class="p">))</span>
        <span class="n">terciles</span> <span class="o">=</span> <span class="n">rainfall_for_tercile</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">T2</span> <span class="o">=</span> <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">)</span>
        <span class="n">error_variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span><span class="p">)</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

        <span class="n">year</span> <span class="o">=</span> <span class="n">Predictor_for_year</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[Y]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1970</span>  <span class="c1"># Convert from epoch</span>
        <span class="n">T_value_1</span> <span class="o">=</span> <span class="n">Predictant</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Get the datetime64 value from da1</span>
        <span class="n">month_1</span> <span class="o">=</span> <span class="n">T_value_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[M]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Extract month</span>
        <span class="n">new_T_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month_1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">forecast_expanded</span> <span class="o">=</span> <span class="n">result_</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">([</span><span class="n">new_T_value</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]))</span>
        <span class="n">forecast_expanded</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forecast_expanded</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        
        
        <span class="c1"># # Expand single prediction to T=1 so probability methods can handle it</span>
        <span class="c1"># forecast_expanded = result_.expand_dims(</span>
        <span class="c1">#     T=[pd.Timestamp(Predictor_for_year.coords[&#39;T&#39;].values).to_pydatetime()]</span>
        <span class="c1"># )</span>

        <span class="c1"># 3) Tercile probabilities</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;t&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Predictant</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span>


            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_expanded</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dof&#39;</span><span class="p">:</span> <span class="n">dof</span><span class="p">},</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;gamma&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_gamma</span>

            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_expanded</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}}</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_normal</span>

            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_expanded</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}}</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_lognormal</span>

            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">forecast_expanded</span><span class="p">,</span>
                <span class="n">error_variance</span><span class="p">,</span>
                <span class="n">T1</span><span class="p">,</span>
                <span class="n">T2</span><span class="p">,</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}}</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span> <span class="o">==</span> <span class="s2">&quot;nonparam&quot;</span><span class="p">:</span>
            <span class="n">calc_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tercile_probabilities_nonparametric</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">Predictant</span> <span class="o">-</span> <span class="n">hindcast_det</span>
            <span class="n">error_samples</span> <span class="o">=</span> <span class="n">error_samples</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">})</span>
            <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">apply_ufunc</span><span class="p">(</span>
                <span class="n">calc_func</span><span class="p">,</span>
                <span class="n">result_</span><span class="p">,</span>
                <span class="n">error_samples</span><span class="p">,</span>
                <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
                <span class="n">terciles</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span><span class="s1">&#39;quantile&#39;</span><span class="p">),</span>
                <span class="n">input_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;T&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,),</span> <span class="p">(),</span> <span class="p">()],</span>
                <span class="n">output_core_dims</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">)],</span>
                <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dask</span><span class="o">=</span><span class="s1">&#39;parallelized&#39;</span><span class="p">,</span>
                <span class="n">output_dtypes</span><span class="o">=</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">dask_gufunc_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;output_sizes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;allow_rechunk&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid dist_method: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_method</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PB&#39;</span><span class="p">,</span><span class="s1">&#39;PN&#39;</span><span class="p">,</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span>
        <span class="n">hindcast_prob_out</span> <span class="o">=</span> <span class="n">hindcast_prob</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="c1">#.drop_vars(&#39;T&#39;).squeeze()</span>

        <span class="c1"># Return [error, prediction] plus tercile probabilities</span>
        <span class="k">return</span> <span class="n">forecast_expanded</span><span class="p">,</span> <span class="n">hindcast_prob_out</span>  </div>

        

<div class="viewcode-block" id="WAS_CCA.plot_cca_results">
<a class="viewcode-back" href="../../wass2s.html#wass2s.was_cca.WAS_CCA.plot_cca_results">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cca_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the CCA modes and scores.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - X: Optional xarray DataArray for predictors. If provided, the model will be fitted using X and Y.</span>
<span class="sd">        - Y: Optional xarray DataArray for predictands.</span>
<span class="sd">        - n_modes: Number of modes to plot. If None, plots all modes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Y</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">([</span><span class="s1">&#39;T&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="c1"># mask.name = None</span>
            
            <span class="n">X_</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">Y_</span> <span class="o">=</span> <span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">trend_data</span><span class="p">(</span><span class="n">standardize_timeseries</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">))[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
            
            <span class="c1"># Fit the model using the provided data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_cca</span><span class="p">(</span><span class="n">X_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Y_</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The CCA model has not been fitted yet. Provide X and Y data to fit the model.&quot;</span><span class="p">)</span>

        <span class="c1"># Get components (modes) and scores</span>
        <span class="n">X_modes</span><span class="p">,</span> <span class="n">Y_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">components</span><span class="p">()</span>  <span class="c1"># Spatial patterns</span>
        <span class="n">X_scores</span><span class="p">,</span> <span class="n">Y_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">scores</span><span class="p">()</span>    <span class="c1"># Temporal projections (canonical variates)</span>

        <span class="c1"># Get explained variances</span>
        <span class="n">var_explained_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_X_explained_by_X</span><span class="p">()</span>
        <span class="n">var_explained_Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_Y_explained_by_Y</span><span class="p">()</span>
        <span class="n">var_explained_Y_by_X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cca_model</span><span class="o">.</span><span class="n">fraction_variance_Y_explained_by_X</span><span class="p">()</span>

        <span class="c1"># Determine number of modes to plot</span>
        <span class="k">if</span> <span class="n">n_modes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_modes</span>

        <span class="c1"># Mode indices start from 1 in xeofs</span>
        <span class="n">mode_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_modes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create subplots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_modes</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_modes</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">n_modes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mode_indices</span><span class="p">):</span>

            <span class="c1"># First Column: Plot X_modes</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">X_mode</span> <span class="o">=</span> <span class="n">X_modes</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">X_mode</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">)</span>
            <span class="n">var_X</span> <span class="o">=</span> <span class="n">var_explained_X</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;X Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_X</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance explained)&#39;</span><span class="p">)</span>

            <span class="c1"># Second Column: Plot X_scores and Y_scores</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">X_score</span> <span class="o">=</span> <span class="n">X_scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">Y_score</span> <span class="o">=</span> <span class="n">Y_scores</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">var_Y_X</span> <span class="o">=</span> <span class="n">var_explained_Y_by_X</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_score</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">X_score</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X Score&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_score</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">Y_score</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y Score&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1">#### line Canonical Variate = 0</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scores for Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_Y_X</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance Y explained by X)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Canonical Variate&#39;</span><span class="p">)</span>

            <span class="c1"># Third Column: Plot Y_modes</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">Y_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y_modes</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">))</span><span class="o">*</span><span class="n">mask</span>
            <span class="n">Y_mode</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">)</span>
            <span class="n">var_Y</span> <span class="o">=</span> <span class="n">var_explained_Y</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Y Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">var_Y</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">% variance explained)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>