

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Models and Cross-Validation &mdash; wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel. 0.3.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=1e28cc32"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Verification Module" href="Verification.html" />
    <link rel="prev" title="Preprocessing Modules" href="Preprocessing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Download.html">Data Download &amp; Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html">Preprocessing Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#computing-predictands">Computing Predictands</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#agro-climatic-seasonality">Agro-Climatic Seasonality</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#spell-analysis-dry-wet">Spell Analysis (Dry/Wet)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#etccdi-temperature-extremes">ETCCDI Temperature Extremes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#etccdi-precipitation-extremes">ETCCDI Precipitation Extremes</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#input-data-formats">Input Data Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#merging-gridded-data-with-observations">Merging Gridded Data with Observations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#prerequisites-data-formats">Prerequisites &amp; Data Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#class-initialization">Class Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#merging-methods">Merging Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#visualization">Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#usage-example">Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#bias-correction-modules">Bias Correction Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#id1">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#precipitation-bias-correction-was-qmap">Precipitation Bias Correction (WAS_Qmap)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#continuous-bias-correction-was-bias-correction">Continuous Bias Correction (WAS_bias_correction)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#data-transformation-skewness-analysis">Data Transformation &amp; Skewness Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#prerequisites-input-data">Prerequisites &amp; Input Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#skewness-detection-and-handling">Skewness Detection and Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#distribution-fitting-clustering-approach">Distribution Fitting (Clustering Approach)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Preprocessing.html#id2">Visualization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Models and Cross-Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linear-regression-and-regularization-models">Linear Regression and Regularization Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-features">Key Features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#linear-regression">Linear Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ridge-regression-l2-regularization">Ridge Regression (L2 Regularization)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lasso-regression-l1-regularization">Lasso Regression (L1 Regularization)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elasticnet-l1-l2-regularization">ElasticNet (L1 + L2 Regularization)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#probabilistic-calculation-methods">Probabilistic Calculation Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#advanced-machine-learning-models">Advanced Machine Learning Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Key Features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#support-vector-regression-svr">Support Vector Regression (SVR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multi-layer-perceptron-mlp">Multi-Layer Perceptron (MLP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stacking-ensemble-rf-xgb-mlp">Stacking Ensemble (RF + XGB + MLP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multivariate-adaptive-regression-splines-mars">Multivariate Adaptive Regression Splines (MARS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimization-methods">Optimization Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eof-analysis-principal-component-regression">EOF Analysis &amp; Principal Component Regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eof-analysis-was-eof">EOF Analysis (WAS_EOF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#principal-component-regression-was-pcr">Principal Component Regression (WAS_PCR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cca-models">CCA Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analog-forecasting-methods">Analog Forecasting Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quantifying-uncertainty-via-cross-validation">Quantifying Uncertainty via Cross-Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#estimating-prediction-uncertainty">Estimating Prediction Uncertainty</a></li>
<li class="toctree-l2"><a class="reference internal" href="Verification.html">Verification Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html">Multi-Model Ensemble (MME) Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html#data-preparation">1. Data Preparation</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html#weighted-ensembles-linear">2. Weighted Ensembles (Linear)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html#min-et-al-2009-probabilistic-mme">3. Min et al. (2009) Probabilistic MME</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html#machine-learning-ensembles">4. Machine Learning Ensembles</a></li>
<li class="toctree-l2"><a class="reference internal" href="mme.html#calibration-postprocessing">5. Calibration &amp; Post‑Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="ImplementWASNextGen.html">Implementation of WAS-NextGen Approaches</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">wass2s: A python-based tool for seasonal climate forecast in West Africa and the Sahel.</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="Usage.html">Usage</a></li>
      <li class="breadcrumb-item active">Models and Cross-Validation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/Models.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="models-and-cross-validation">
<h1>Models and Cross-Validation<a class="headerlink" href="#models-and-cross-validation" title="Link to this heading"></a></h1>
<p>The Models modules provide a comprehensive suite of statistical and machine learning models for climate prediction, including linear models, EOF-based models, canonical correlation analysis (CCA), analog methods, and multi-model ensemble (MME) techniques.</p>
<p>These models are designed to handle both deterministic and probabilistic forecasts, with support for hyperparameter tuning. Models are evaluated using cross-validation schemes.</p>
<p>The models modules are organized into several classes, each implementing a specific type of model:</p>
<ol class="arabic simple">
<li><p><strong>Machine Learning Models</strong>: This includes linear models such as multiple linear regression, logistic regression and regularized models like ridge, lasso, elastic-net. Additionally, more advanced models are available, including support vector regression, random forests, XGBoost, and neural networks.</p></li>
<li><p><strong>EOF and PCR Models</strong>: For dimensionality reduction and regression using principal components.</p></li>
<li><p><strong>CCA Models</strong>: For identifying relationships between two multivariate datasets.</p></li>
<li><p><strong>Analog Methods</strong>: For finding historical analogs to current conditions.</p></li>
<li><p><strong>Multi-Model Ensemble (MME) Techniques</strong>: For combining predictions from multiple models.</p></li>
</ol>
</section>
<section id="linear-regression-and-regularization-models">
<h1>Linear Regression and Regularization Models<a class="headerlink" href="#linear-regression-and-regularization-models" title="Link to this heading"></a></h1>
<p>These modules provide classes for spatially distributed linear regression modeling of climate variables. It is designed to handle large xarray datasets using <strong>Dask</strong> for parallelization and <strong>Scikit-Learn</strong> for model fitting.</p>
<section id="key-features">
<h2>Key Features<a class="headerlink" href="#key-features" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Parallel Computing</strong>: Fits models pixel-by-pixel or cluster-by-cluster in parallel.</p></li>
<li><p><strong>Hyperparameter Optimization</strong>: Supports Grid Search, Randomized Search, and <strong>Bayesian Optimization (Optuna)</strong>.</p></li>
<li><p><strong>Probabilistic Output</strong>: Converts deterministic predictions into <strong>Tercile Probabilities</strong> (Below Normal, Normal, Above Normal) using parametric or non-parametric methods.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="linear-regression">
<h1>Linear Regression<a class="headerlink" href="#linear-regression" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_LinearRegression_Model</span></code></p>
<p>A baseline Ordinary Least Squares (OLS) model. It does not use regularization, making it fast but potentially prone to overfitting if predictors are correlated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_LinearRegression_Model</span>

<span class="c1"># 1. Initialize</span>
<span class="c1"># nb_cores: Number of parallel workers</span>
<span class="c1"># dist_method: Method for probability calculation (&#39;gamma&#39;, &#39;normal&#39;, &#39;nonparam&#39;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">WAS_LinearRegression_Model</span><span class="p">(</span><span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>

<span class="c1"># 2. Compute Hindcasts (Training &amp; Testing on historical data)</span>
<span class="c1"># X_train, y_train: Training period</span>
<span class="c1"># X_test, y_test: Evaluation period</span>
<span class="n">hindcast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="c1"># 3. Compute Probabilities (Terciles)</span>
<span class="c1"># clim_year_start/end define the reference period for &quot;Normal&quot;</span>
<span class="n">prob_forecast</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_prob</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">observed_rainfall</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="ridge-regression-l2-regularization">
<h1>Ridge Regression (L2 Regularization)<a class="headerlink" href="#ridge-regression-l2-regularization" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_Ridge_Model</span></code></p>
<p>Ridge regression adds an L2 penalty to the loss function, shrinking coefficients. It is useful when predictors are highly correlated (multicollinearity).</p>
<p><strong>Optimization Modes</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode='grid'</span></code>: Optimizes alpha independently for <strong>every single pixel</strong>. (Slow, detailed).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mode='cluster'</span></code>: Clusters pixels into homogeneous zones and optimizes alpha <strong>per zone</strong>. (Fast, robust).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_Ridge_Model</span>

<span class="c1"># Initialize with Bayesian Optimization (Optuna)</span>
<span class="n">ridge</span> <span class="o">=</span> <span class="n">WAS_Ridge_Model</span><span class="p">(</span>
    <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">hyperparam_optimizer</span><span class="o">=</span><span class="s1">&#39;bayesian&#39;</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">50</span>
<span class="p">)</span>

<span class="c1"># Compute optimal hyperparameters (alpha)</span>
<span class="n">alpha_map</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span>
    <span class="n">predictand</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span>
<span class="p">)</span>

<span class="c1"># Run the model</span>
<span class="n">hindcast</span> <span class="o">=</span> <span class="n">ridge</span><span class="o">.</span><span class="n">compute_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_map</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="lasso-regression-l1-regularization">
<h1>Lasso Regression (L1 Regularization)<a class="headerlink" href="#lasso-regression-l1-regularization" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_Lasso_Model</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">WAS_LassoLars_Model</span></code></p>
<p>Lasso adds an L1 penalty, which can force coefficients to zero. This effectively performs <strong>feature selection</strong>, keeping only the most important predictors.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">WAS_Lasso_Model</span></code>: Standard Coordinate Descent implementation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WAS_LassoLars_Model</span></code>: Uses <strong>Least Angle Regression (LARS)</strong>. Better for high-dimensional data or when <cite>n_features &gt; n_samples</cite>.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_LassoLars_Model</span>

<span class="n">lasso</span> <span class="o">=</span> <span class="n">WAS_LassoLars_Model</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Automatically finds alpha using cross-validation (CV) if not provided</span>
<span class="n">hindcast</span> <span class="o">=</span> <span class="n">lasso</span><span class="o">.</span><span class="n">compute_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="elasticnet-l1-l2-regularization">
<h1>ElasticNet (L1 + L2 Regularization)<a class="headerlink" href="#elasticnet-l1-l2-regularization" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_ElasticNet_Model</span></code></p>
<p>Combines the properties of Ridge and Lasso. It is often the most robust choice for climate data as it handles correlated predictors (Ridge) while selecting features (Lasso).</p>
<p><strong>Hyperparameters</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alpha</span></code>: Total regularization strength.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">l1_ratio</span></code>: Balance between Lasso (1.0) and Ridge (0.0).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_ElasticNet_Model</span>

<span class="n">enet</span> <span class="o">=</span> <span class="n">WAS_ElasticNet_Model</span><span class="p">(</span>
    <span class="n">l1_ratio_range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="c1"># Search space for mixing ratio</span>
    <span class="n">hyperparam_optimizer</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>  <span class="c1"># Use Randomized Search</span>
    <span class="n">n_iter</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>

<span class="c1"># Compute hyperparameters (returns alpha map and l1_ratio map)</span>
<span class="n">alpha_map</span><span class="p">,</span> <span class="n">l1_map</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">enet</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="mi">1981</span><span class="p">,</span> <span class="mi">2010</span><span class="p">)</span>

<span class="c1"># Forecast</span>
<span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">enet</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">Predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast</span><span class="p">,</span>
    <span class="n">Predictor_for_year</span><span class="o">=</span><span class="n">X_next_year</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_map</span><span class="p">,</span>
    <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_map</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="probabilistic-calculation-methods">
<h1>Probabilistic Calculation Methods<a class="headerlink" href="#probabilistic-calculation-methods" title="Link to this heading"></a></h1>
<p>All models include a <code class="docutils literal notranslate"><span class="pre">compute_prob</span></code> method to convert deterministic outputs into probabilities for:</p>
<ol class="arabic simple">
<li><p><strong>Below Normal (PB)</strong></p></li>
<li><p><strong>Normal (PN)</strong></p></li>
<li><p><strong>Above Normal (PA)</strong></p></li>
</ol>
<p>Supported Distribution Methods (<code class="docutils literal notranslate"><span class="pre">dist_method</span></code>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'normal'</span></code>: Assumes errors are Gaussian.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'gamma'</span></code>: Fits a Gamma distribution (good for precipitation).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'lognormal'</span></code>: Fits a Log-Normal distribution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'weibull_min'</span></code>: Fits a Weibull distribution.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'bestfit'</span></code>: Uses the distribution map from <code class="docutils literal notranslate"><span class="pre">WAS_TransformData</span></code> to use the optimal distribution per pixel.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'nonparam'</span></code>: Non-parametric estimation based on historical error rank (no distribution assumption).</p></li>
</ul>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example: Using Best-Fit Distribution</span>
<span class="c1"># best_code, best_shape, etc. come from the Data Transformation module</span>
<span class="n">prob_da</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_prob</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">det_forecast</span><span class="p">,</span>
    <span class="n">best_code_da</span><span class="o">=</span><span class="n">best_code</span><span class="p">,</span>
    <span class="n">best_shape_da</span><span class="o">=</span><span class="n">best_shape</span><span class="p">,</span>
    <span class="n">best_loc_da</span><span class="o">=</span><span class="n">best_loc</span><span class="p">,</span>
    <span class="n">best_scale_da</span><span class="o">=</span><span class="n">best_scale</span>
<span class="p">)</span>

<span class="c1"># Plotting Probability of Above Normal</span>
<span class="n">prob_da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="s1">&#39;PA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="advanced-machine-learning-models">
<h1>Advanced Machine Learning Models<a class="headerlink" href="#advanced-machine-learning-models" title="Link to this heading"></a></h1>
<p>This module implements non-linear regression models optimized for spatiotemporal climate data. Unlike standard linear models, these classes capture complex relationships between predictors (e.g., SSTs) and predictands (e.g., rainfall).</p>
<section id="id1">
<h2>Key Features<a class="headerlink" href="#id1" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Spatial Clustering</strong>: Models can be trained on homogeneous zones (clusters) rather than pixel-by-pixel, reducing noise and computational cost.</p></li>
<li><p><strong>Hyperparameter Optimization (HPO)</strong>: Integrated support for <strong>Grid Search</strong>, <strong>Randomized Search</strong>, and <strong>Bayesian Optimization (Optuna)</strong>.</p></li>
<li><p><strong>Stacking Ensembles</strong>: Advanced architectures combining Random Forest, XGBoost, and MLP.</p></li>
<li><p><strong>Probabilistic Forecasts</strong>: Converts deterministic predictions into tercile probabilities.</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="support-vector-regression-svr">
<h1>Support Vector Regression (SVR)<a class="headerlink" href="#support-vector-regression-svr" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_SVR</span></code></p>
<p>Implements Support Vector Regression with spatial clustering. It effectively handles non-linearities using kernels (RBF, Polynomial).</p>
<p><strong>Parameters</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kernel</span></code>: ‘linear’, ‘poly’, ‘rbf’, or ‘all’ (to search all).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_clusters</span></code>: Number of spatial clusters for training.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">optimization_method</span></code>: ‘grid’, ‘random’, or ‘bayesian’.</p></li>
</ul>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_SVR</span>

<span class="c1"># 1. Initialize with Bayesian Optimization</span>
<span class="n">svr_model</span> <span class="o">=</span> <span class="n">WAS_SVR</span><span class="p">(</span>
    <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span>
    <span class="n">optimization_method</span><span class="o">=</span><span class="s1">&#39;bayesian&#39;</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">30</span>
<span class="p">)</span>

<span class="c1"># 2. Compute Hyperparameters (Clustering + HPO)</span>
<span class="c1"># Returns maps of C, epsilon, gamma broadcasted to the grid</span>
<span class="n">C_map</span><span class="p">,</span> <span class="n">eps_map</span><span class="p">,</span> <span class="n">deg_map</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">kernel_map</span><span class="p">,</span> <span class="n">gamma_map</span> <span class="o">=</span> <span class="n">svr_model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span>
    <span class="n">predictand</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span>
<span class="p">)</span>

<span class="c1"># 3. Forecast Next Year</span>
<span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">svr_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">Predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_da</span><span class="p">,</span> <span class="c1"># Pre-computed hindcast for error stats</span>
    <span class="n">Predictor_for_year</span><span class="o">=</span><span class="n">X_next_year</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="n">eps_map</span><span class="p">,</span>
    <span class="n">C</span><span class="o">=</span><span class="n">C_map</span><span class="p">,</span>
    <span class="n">kernel_array</span><span class="o">=</span><span class="n">kernel_map</span><span class="p">,</span>
    <span class="n">degree_array</span><span class="o">=</span><span class="n">deg_map</span><span class="p">,</span>
    <span class="n">gamma_array</span><span class="o">=</span><span class="n">gamma_map</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="multi-layer-perceptron-mlp">
<h1>Multi-Layer Perceptron (MLP)<a class="headerlink" href="#multi-layer-perceptron-mlp" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_MLP</span></code></p>
<p>Implements a Neural Network regressor (using <code class="docutils literal notranslate"><span class="pre">sklearn.neural_network.MLPRegressor</span></code>). It is particularly useful for capturing high-dimensional, non-linear interactions.</p>
<p><strong>Key Features</strong>:</p>
<ul class="simple">
<li><p><strong>Pipeline</strong>: Automatically handles scaling of target variables (<code class="docutils literal notranslate"><span class="pre">TransformedTargetRegressor</span></code>).</p></li>
<li><p><strong>Search Space</strong>: Optimizes hidden layer sizes, activation functions, and learning rates.</p></li>
</ul>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_MLP</span>

<span class="c1"># 1. Initialize</span>
<span class="n">mlp_model</span> <span class="o">=</span> <span class="n">WAS_MLP</span><span class="p">(</span>
    <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">optimization_method</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>

<span class="c1"># 2. Train &amp; Optimize</span>
<span class="c1"># Returns maps of hidden_layer_sizes, activation, etc.</span>
<span class="n">hl</span><span class="p">,</span> <span class="n">act</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">mlp_model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span>
    <span class="n">predictand</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span>
<span class="p">)</span>

<span class="c1"># 3. Forecast</span>
<span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">mlp_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">Predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_da</span><span class="p">,</span>
    <span class="n">Predictor_for_year</span><span class="o">=</span><span class="n">X_next_year</span><span class="p">,</span>
    <span class="n">hl_array</span><span class="o">=</span><span class="n">hl</span><span class="p">,</span>
    <span class="n">act_array</span><span class="o">=</span><span class="n">act</span><span class="p">,</span>
    <span class="n">lr_array</span><span class="o">=</span><span class="n">lr</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="stacking-ensemble-rf-xgb-mlp">
<h1>Stacking Ensemble (RF + XGB + MLP)<a class="headerlink" href="#stacking-ensemble-rf-xgb-mlp" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_RandomForest_XGBoost_Stacking_MLP</span></code></p>
<p>A state-of-the-art ensemble method that stacks tree-based models with a neural network meta-learner.</p>
<p><strong>Architecture</strong>:</p>
<ol class="arabic simple">
<li><p><strong>Base Layer</strong>: Random Forest Regressor + XGBoost Regressor.</p></li>
<li><p><strong>Meta Layer</strong>: Multi-Layer Perceptron (MLP).</p></li>
</ol>
<p>The base models make predictions, and the MLP learns how to best combine them to minimize error.</p>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_RandomForest_XGBoost_Stacking_MLP</span>

<span class="c1"># 1. Initialize</span>
<span class="n">stacking_model</span> <span class="o">=</span> <span class="n">WAS_RandomForest_XGBoost_Stacking_MLP</span><span class="p">(</span>
    <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># Fewer clusters due to high model complexity</span>
    <span class="n">optimization_method</span><span class="o">=</span><span class="s1">&#39;bayesian&#39;</span><span class="p">,</span>
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>

<span class="c1"># 2. Compute Hyperparameters</span>
<span class="c1"># Optimizes RF trees, XGB depth, and MLP structure simultaneously</span>
<span class="n">best_params_map</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">stacking_model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span>
    <span class="n">predictand</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span>
<span class="p">)</span>

<span class="c1"># 3. Forecast</span>
<span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">stacking_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">Predictor</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_da</span><span class="p">,</span>
    <span class="n">Predictor_for_year</span><span class="o">=</span><span class="n">X_next_year</span><span class="p">,</span>
    <span class="n">best_param_da</span><span class="o">=</span><span class="n">best_params_map</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="multivariate-adaptive-regression-splines-mars">
<h1>Multivariate Adaptive Regression Splines (MARS)<a class="headerlink" href="#multivariate-adaptive-regression-splines-mars" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_MARS_Model</span></code></p>
<p>Implements MARS (Multivariate Adaptive Regression Splines), which models non-linearities by fitting piecewise linear basis functions (hinges). It automatically selects important variables and interactions.</p>
<p><strong>Key Parameters</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_terms</span></code>: Maximum number of basis functions.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_degree</span></code>: Maximum degree of interaction (1=additive, 2=interactions).</p></li>
</ul>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_MARS_Model</span>

<span class="c1"># 1. Initialize</span>
<span class="n">mars_model</span> <span class="o">=</span> <span class="n">WAS_MARS_Model</span><span class="p">(</span>
    <span class="n">nb_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">max_terms</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
    <span class="n">max_degree</span><span class="o">=</span><span class="mi">2</span> <span class="c1"># Allow pairwise interactions</span>
<span class="p">)</span>

<span class="c1"># 2. Compute Hindcasts (No separate HPO step needed for standard MARS)</span>
<span class="n">hindcast</span> <span class="o">=</span> <span class="n">mars_model</span><span class="o">.</span><span class="n">compute_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="optimization-methods">
<h1>Optimization Methods<a class="headerlink" href="#optimization-methods" title="Link to this heading"></a></h1>
<p>All classes (except MARS/Poisson) allow selecting the optimization strategy via <code class="docutils literal notranslate"><span class="pre">optimization_method</span></code>:</p>
<ul class="simple">
<li><p><strong>‘grid’</strong>: Exhaustive search over <code class="docutils literal notranslate"><span class="pre">param_grid</span></code>. Reliable but slow.</p></li>
<li><p><strong>‘random’</strong>: Randomized search. Faster, good for high-dimensional spaces.</p></li>
<li><p><strong>‘bayesian’</strong>: Uses <strong>Optuna</strong> (TPE Sampler) to intelligently search the hyperparameter space. Recommended for complex models like Stacking and MLP.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">BaseOptimizer</span></code> class handles the logic, ensuring compatibility with Scikit-Learn pipelines and custom regressors.</p>
</section>
<section id="eof-analysis-principal-component-regression">
<h1>EOF Analysis &amp; Principal Component Regression<a class="headerlink" href="#eof-analysis-principal-component-regression" title="Link to this heading"></a></h1>
<p>This module provides tools for dimensionality reduction using Empirical Orthogonal Functions (EOFs) and integrates them into a Principal Component Regression (PCR) framework. This is standard practice in climate prediction to handle high-dimensional predictor fields (e.g., global SSTs).</p>
<p>Dependencies:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xeofs</span></code>: For efficient EOF computation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wass2s.was_linear_models</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">wass2s.was_machine_learning</span></code>: For regression back-ends.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="eof-analysis-was-eof">
<h1>EOF Analysis (WAS_EOF)<a class="headerlink" href="#eof-analysis-was-eof" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_EOF</span></code></p>
<p>Performs EOF analysis on spatiotemporal data (e.g., SST anomalies). It wraps the <code class="docutils literal notranslate"><span class="pre">xeofs</span></code> package with additional climate-specific utilities like detrending and latitude weighting.</p>
<p><strong>Features</strong>:</p>
<ul class="simple">
<li><p><strong>Cosine Latitude Weighting</strong>: Corrects for area distortion in latitude-longitude grids.</p></li>
<li><p><strong>Detrending</strong>: Removes linear trends before analysis (optional).</p></li>
<li><p><strong>Automatic Mode Selection</strong>: Selects the number of modes based on a target cumulative explained variance (e.g., 90%).</p></li>
</ul>
<p><strong>Usage Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_EOF</span>

<span class="c1"># Initialize EOF model</span>
<span class="c1"># Retain enough modes to explain 90% variance</span>
<span class="n">eof_solver</span> <span class="o">=</span> <span class="n">WAS_EOF</span><span class="p">(</span>
    <span class="n">opti_explained_variance</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="n">detrend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Fit the model</span>
<span class="c1"># predictor must be xarray with dims (T, Y, X)</span>
<span class="n">eofs</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">exp_var</span><span class="p">,</span> <span class="n">singular_vals</span> <span class="o">=</span> <span class="n">eof_solver</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sst_anomaly_da</span><span class="p">)</span>

<span class="c1"># Plot the EOF patterns</span>
<span class="n">eof_solver</span><span class="o">.</span><span class="n">plot_EOF</span><span class="p">(</span><span class="n">eofs</span><span class="p">,</span> <span class="n">exp_var</span><span class="p">)</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="principal-component-regression-was-pcr">
<h1>Principal Component Regression (WAS_PCR)<a class="headerlink" href="#principal-component-regression-was-pcr" title="Link to this heading"></a></h1>
<p><strong>Class</strong>: <code class="docutils literal notranslate"><span class="pre">WAS_PCR</span></code></p>
<p>A wrapper class that combines EOF analysis (for predictors) with any regression model (Linear, Ridge, Lasso, SVR, etc.).</p>
<p><strong>Workflow</strong>:</p>
<ol class="arabic simple">
<li><p><strong>Fit EOF</strong>: Computes EOFs of the high-dimensional predictor (e.g., SST field).</p></li>
<li><p><strong>Transform</strong>: Projects the predictor onto the EOFs to get Principal Components (PCs).</p></li>
<li><p><strong>Regression</strong>: Uses the PCs as features to train the regression model against the predictand (e.g., local rainfall).</p></li>
</ol>
<p><strong>Parameters</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">regression_model</span></code>: An instance of any WAS regression model (e.g., <code class="docutils literal notranslate"><span class="pre">WAS_LinearRegression_Model</span></code>, <code class="docutils literal notranslate"><span class="pre">WAS_Lasso_Model</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_modes</span></code>: (Optional) Hard limit on number of modes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">opti_explained_variance</span></code>: (Optional) Variance threshold for mode selection.</p></li>
</ul>
<p><strong>Usage Example: PCR with Lasso</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_PCR</span><span class="p">,</span> <span class="n">WAS_Lasso_Model</span>

<span class="c1"># 1. Define the Regression Model</span>
<span class="n">lasso_model</span> <span class="o">=</span> <span class="n">WAS_Lasso_Model</span><span class="p">(</span>
    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span>
    <span class="n">n_clusters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">hyperparam_optimizer</span><span class="o">=</span><span class="s1">&#39;bayesian&#39;</span>
<span class="p">)</span>

<span class="c1"># 2. Define the PCR Wrapper</span>
<span class="c1"># This will reduce the SST field to PCs explaining 85% variance</span>
<span class="n">pcr_model</span> <span class="o">=</span> <span class="n">WAS_PCR</span><span class="p">(</span>
    <span class="n">regression_model</span><span class="o">=</span><span class="n">lasso_model</span><span class="p">,</span>
    <span class="n">opti_explained_variance</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span>
    <span class="n">detrend</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># 3. Compute Hyperparameters (Lasso Alpha)</span>
<span class="c1"># Note: This step is now happening in PC-space, not Grid-space</span>
<span class="n">alpha_map</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">pcr_model</span><span class="o">.</span><span class="n">reg_model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span>
    <span class="n">predictand</span><span class="o">=</span><span class="n">rainfall_da</span><span class="p">,</span>
    <span class="n">predictor</span><span class="o">=</span><span class="n">pcr_model</span><span class="o">.</span><span class="n">_prepare_pcs</span><span class="p">(</span><span class="n">sst_da</span><span class="p">,</span> <span class="n">sst_da</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c1"># Manually projecting for HPO step</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span>
<span class="p">)</span>

<span class="c1"># 4. Forecast</span>
<span class="c1"># Automatically handles EOF projection of the forecast year</span>
<span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">pcr_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">Predictant</span><span class="o">=</span><span class="n">rainfall_da</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1981</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2010</span><span class="p">,</span>
    <span class="n">Predictor</span><span class="o">=</span><span class="n">sst_da</span><span class="p">,</span>              <span class="c1"># Full field (T, Y, X)</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_da</span><span class="p">,</span>
    <span class="n">Predictor_for_year</span><span class="o">=</span><span class="n">sst_next_year</span><span class="p">,</span> <span class="c1"># Full field for target year</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_map</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Example Usage: Seasonal Forecasting Based on Observational Data</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="c1">## Define the directory to save the data</span>
<span class="n">dir_to_save_reanalysis</span> <span class="o">=</span> <span class="s2">&quot;/path/to/save_reanalysis&quot;</span>
<span class="n">dir_to_save_agroindicators</span> <span class="o">=</span> <span class="s2">&quot;/path/to/save_agroindicators&quot;</span>

<span class="c1">## Define the climatology  year range and the season</span>
<span class="n">clim_year_start</span> <span class="o">=</span> <span class="mi">1991</span>
<span class="n">clim_year_end</span> <span class="o">=</span> <span class="mi">2020</span>
<span class="n">seas_reanalysis</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">]</span>
<span class="n">seas_agroindicators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;05&quot;</span><span class="p">,</span> <span class="s2">&quot;06&quot;</span><span class="p">,</span> <span class="s2">&quot;07&quot;</span><span class="p">]</span>

<span class="c1">## Define the variables to download</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">]</span>

<span class="c1">## Define the center and the predictor variables</span>
<span class="n">center_variable</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ERA5.SST&quot;</span><span class="p">]</span>

<span class="c1">## Define the extent for reanalysis</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span> <span class="c1"># [North, West, South, East]</span>

<span class="c1">## Define the extent for Observation</span>
<span class="n">extent_obs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="c1"># [North, West, South, East]</span>

<span class="c1">## Download the predictors and the predictand</span>
<span class="n">downloader</span> <span class="o">=</span> <span class="n">WAS_Download</span><span class="p">()</span>

<span class="c1">## Download the predictors</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">WAS_Download_Reanalysis</span><span class="p">(</span>
    <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save_reanalysis</span><span class="p">,</span>
    <span class="n">center_variable</span><span class="o">=</span><span class="n">center_variable</span><span class="p">,</span>
    <span class="n">year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">year_end</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
    <span class="n">seas</span><span class="o">=</span><span class="n">seas_reanalysis</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1">## Download the predictand</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">WAS_Download_AgroIndicators</span><span class="p">(</span>
    <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save_agroindicators</span><span class="p">,</span>
    <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AGRO.PRCP&quot;</span><span class="p">],</span>
    <span class="n">year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">year_end</span><span class="o">=</span><span class="mi">2024</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">extent_obs</span><span class="p">,</span>
    <span class="n">seas</span><span class="o">=</span><span class="n">seas_agroindicators</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Case 1: Used SST index as a predictor</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare predictand and predictors</span>
<span class="n">predictand</span> <span class="o">=</span> <span class="n">prepare_predictand</span><span class="p">(</span><span class="n">dir_to_save_agroindicators</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">seas_agroindicators</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">daily</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Prepare predictors</span>
<span class="c1">## Print available SST indices</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sst_indices_name</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<span class="c1">## Choose yours</span>
<span class="n">sst_index_name</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NINO34&#39;</span><span class="p">,</span><span class="s1">&#39;TNA&#39;</span><span class="p">,</span> <span class="s1">&#39;TSA&#39;</span><span class="p">,</span> <span class="s1">&#39;DMI&#39;</span><span class="p">]</span>

<span class="c1">## Plot the SST index zone</span>
<span class="n">plot_map</span><span class="p">([</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sst_indices</span> <span class="o">=</span> <span class="n">sst_index_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Index Zone&quot;</span><span class="p">,</span><span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="c1">## Compute the SST indices</span>
<span class="n">predictors</span> <span class="o">=</span> <span class="n">compute_sst_indices</span><span class="p">(</span><span class="n">dir_to_save_reanalysis</span><span class="p">,</span> <span class="n">sst_index_name</span><span class="p">,</span> <span class="n">center_variable</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">seas_reanalysis</span><span class="p">)</span>

<span class="c1">## Compute variance inflation factor to see multicolinearity between predictors</span>

<span class="n">vif_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;feature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span>
<span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">VIF</span><span class="p">(</span><span class="n">predictors</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predictors</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
<span class="c1">## Print VIF values</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vif_data</span><span class="p">)</span>

<span class="c1">## Set a threshold for VIF</span>
<span class="n">vif_threshold</span> <span class="o">=</span> <span class="mi">5</span>
<span class="c1"># Remove features with VIF greater than the threshold</span>
<span class="n">low_vif_predictors</span> <span class="o">=</span> <span class="n">vif_data</span><span class="p">[</span><span class="n">vif_data</span><span class="p">[</span><span class="s2">&quot;VIF&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vif_threshold</span><span class="p">][</span><span class="s2">&quot;feature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">filtered_predictors</span> <span class="o">=</span> <span class="n">predictors</span><span class="p">[</span><span class="n">low_vif_predictors</span><span class="p">]</span><span class="o">.</span><span class="n">to_array</span><span class="p">()</span>
<span class="n">filtered_predictors</span> <span class="o">=</span> <span class="n">filtered_predictors</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">)</span>

<span class="c1"># Initialize the model class</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">WAS_LinearRegression_Model</span><span class="p">(</span><span class="n">nb_cores</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;lognormal&quot;</span><span class="p">)</span>
<span class="c1"># Assuming predictand follows a lognormal distribution. otherwise, normal, student-t or gamma are available. used dist_method=&quot;normal&quot; or dist_method=&quot;t&quot; or dist_method=&quot;gamma&quot;.</span>

<span class="c1"># Perform cross-validation</span>
<span class="n">was_cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)),</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">hindcast_det</span><span class="p">,</span> <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">was_cv</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">predictand</span><span class="p">,</span> <span class="n">filtered_predictorsisel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
<span class="c1"># clim_year_start and clim_year_end are the years used to compute the climatology.</span>

<span class="c1"># Initialize the model class</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">WAS_Ridge_Model</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">nb_cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Compute alpha parameters</span>
<span class="n">alpha</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span><span class="n">predictand</span><span class="p">,</span> <span class="n">filtered_predictors</span><span class="p">)</span>

<span class="c1"># Perform cross-validation</span>
<span class="n">was_cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)),</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">hindcast_det_Ridge</span><span class="p">,</span> <span class="n">hindcast_prob_Ridge</span> <span class="o">=</span> <span class="n">was_cv</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">predictand</span><span class="p">,</span> <span class="n">filtered_predictors</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

<span class="c1"># Make a forecast</span>
<span class="n">forecast_det_Ridge</span><span class="p">,</span> <span class="n">forecast_prob_Ridge</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">predictand</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">filtered_predictors</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">hindcast_det_Ridge</span><span class="p">,</span> <span class="n">filtered_predictors</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Case 2: Used PCRs as a predictor</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set your own zones ( zones not available in built-in)</span>
<span class="c1"># define zone as dict : {&#39;zone_name_key&#39;: (&#39;Explicit_Zone_name&#39;, lon_min, lon_max, lat_min, lat_max)}</span>
<span class="n">zones_for_PCR</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">)}</span>

<span class="c1"># Set number of modes</span>
<span class="n">n_modes</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># ElasticNet hyperparameters range</span>
<span class="n">alpha_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">l1_ratio_range</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9999</span><span class="p">]</span>

<span class="c1"># Initialize the model class</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">WAS_PCR_Model</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">alpha_range</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">nb_cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plot_map</span><span class="p">([</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sst_indices</span> <span class="o">=</span> <span class="n">zones_for_PCR</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predictors Area&quot;</span><span class="p">,</span><span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Retrieve predictor data for the defined zone</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">retrieve_single_zone_for_PCR</span><span class="p">(</span><span class="n">dir_to_save_Reanalysis</span><span class="p">,</span> <span class="n">zones_for_PCR</span><span class="p">,</span> <span class="n">variables_reanalysis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">season</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>

<span class="c1"># Load WAS_EOF Class</span>
<span class="n">eof_model</span> <span class="o">=</span> <span class="n">WAS_EOF</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">use_coslat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Load predictor, compute EOFs and retrieve component, scores and explained variances</span>
<span class="n">s_eofs</span><span class="p">,</span> <span class="n">s_pcs</span><span class="p">,</span> <span class="n">s_expvar</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">eof_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">predictor</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">,</span>  <span class="n">clim_year_start</span><span class="o">=</span><span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="n">clim_year_end</span><span class="p">)</span>

<span class="c1"># Plot EOFs and explained variances</span>
<span class="n">eof_model</span><span class="o">.</span><span class="n">plot_EOF</span><span class="p">(</span><span class="n">s_eofs</span><span class="p">,</span> <span class="n">s_expvar</span><span class="p">)</span>

<span class="c1"># Perform Cross-validation with elastic-net</span>

<span class="c1">## Load class for model</span>
<span class="n">regression_model</span> <span class="o">=</span> <span class="n">WAS_ElasticNet_Model</span><span class="p">(</span><span class="n">alpha_range</span> <span class="o">=</span> <span class="n">alpha_range</span><span class="p">,</span> <span class="n">l1_ratio_range</span> <span class="o">=</span> <span class="n">l1_ratio_range</span><span class="p">,</span> <span class="n">nb_cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;lognormal&quot;</span><span class="p">)</span>
<span class="n">pcr_model</span> <span class="o">=</span> <span class="n">WAS_PCR</span><span class="p">(</span><span class="n">regression_model</span><span class="o">=</span><span class="n">regression_model</span><span class="p">,</span> <span class="n">n_modes</span><span class="o">=</span><span class="n">n_modes</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">## Compute alpha parameters</span>
<span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">regression_model</span><span class="o">.</span><span class="n">compute_hyperparameters</span><span class="p">(</span><span class="n">predictand</span><span class="p">,</span> <span class="n">s_pcs</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">))</span>
<span class="c1">## Perform cross-validation</span>
<span class="n">was_cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)),</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">hindcast_det</span><span class="p">,</span> <span class="n">hindcast_prob</span> <span class="o">=</span> <span class="n">was_cv</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">pcr_model</span><span class="p">,</span> <span class="n">predictand</span><span class="p">,</span> <span class="n">s_pcs</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;features&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">),</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="cca-models">
<h1>CCA Models<a class="headerlink" href="#cca-models" title="Link to this heading"></a></h1>
<p>The <cite>was_cca.py</cite> module provides classes for Canonical Correlation Analysis (CCA):</p>
<ul class="simple">
<li><p><cite>WAS_CCA</cite>: Performs CCA to identify relationships between two multivariate datasets.</p></li>
</ul>
<p><strong>Initialization</strong></p>
<ul class="simple">
<li><p><cite>n_modes</cite>: Number of CCA modes to retain.</p></li>
<li><p><cite>n_pca_modes</cite>: Number of PCA modes to use for dimensionality reduction.</p></li>
<li><p><cite>dist_method</cite>: distribution method for probability computations.</p></li>
</ul>
<p><strong>Methods</strong></p>
<ul class="simple">
<li><p><cite>compute_model</cite>: Fits the CCA model and makes predictions.</p></li>
<li><p><cite>compute_prob</cite>: Computes tercile probabilities for the predictions.</p></li>
</ul>
<p><strong>Example Usage: Recalibrating Seasonal Forecast Outputs from Global Climate Models (GCMs)</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Filter model names to identify precipitation-related models</span>
<span class="n">center_variable</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ECMWF_51.PRCP&quot;</span><span class="p">]</span>

<span class="c1"># Specify the directory to save downloaded model data</span>
<span class="n">dir_to_save_model</span> <span class="o">=</span> <span class="s2">&quot;/path/to/save&quot;</span>

<span class="c1"># Define the month for model initialization (March)</span>
<span class="n">month_of_initialization</span> <span class="o">=</span> <span class="s2">&quot;03&quot;</span>

<span class="c1"># Define lead times corresponding to seasonal forecast targets (MJJ season in this case)</span>
<span class="n">lead_time</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="s2">&quot;03&quot;</span><span class="p">,</span> <span class="s2">&quot;04&quot;</span><span class="p">]</span>

<span class="c1"># Define the hindcast period for model data (years 1993 to 2016)</span>
<span class="n">year_start_model</span> <span class="o">=</span> <span class="mi">1993</span>
<span class="n">year_end_model</span> <span class="o">=</span> <span class="mi">2016</span>

<span class="c1"># Set the bounding box for the area of interest (latitude and longitude bounds)</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>  <span class="c1"># [Northern, Western, Southern and Eastern]</span>

<span class="c1"># Define if you want to download forecast or hindcast</span>
<span class="n">year_forecast</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Define if you want all members of ensemble or doing an ensemble mean</span>
<span class="n">ensemble_mean</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>

<span class="c1"># Specify whether to overwrite existing files when downloading data</span>
<span class="n">force_download</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Define the climatology year range</span>
<span class="n">clim_year_start</span> <span class="o">=</span> <span class="mi">1993</span>
<span class="n">clim_year_end</span> <span class="o">=</span> <span class="mi">2016</span>

<span class="c1"># Download the GCM data</span>
<span class="n">downloader</span> <span class="o">=</span> <span class="n">WAS_Download</span><span class="p">()</span>
<span class="c1"># Download hindcast data</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">WAS_Download_Models</span><span class="p">(</span>
    <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save_model</span><span class="p">,</span>
    <span class="n">center_variable</span><span class="o">=</span><span class="n">center_variable</span><span class="p">,</span>
    <span class="n">month_of_initialization</span><span class="o">=</span><span class="n">month_of_initialization</span><span class="p">,</span>
    <span class="n">lead_time</span><span class="o">=</span><span class="n">lead_time</span><span class="p">,</span>
    <span class="n">year_start_hindcast</span><span class="o">=</span><span class="n">year_start_model</span><span class="p">,</span>
    <span class="n">year_end_hindcast</span><span class="o">=</span><span class="n">year_end_model</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
    <span class="n">year_forecast</span><span class="o">=</span><span class="n">year_forecast</span><span class="p">,</span>
    <span class="n">ensemble_mean</span><span class="o">=</span><span class="n">ensemble_mean</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span>
<span class="p">)</span>
<span class="n">year_forecast</span> <span class="o">=</span> <span class="mi">2024</span>
<span class="c1"># Download forecast data</span>
<span class="n">downloader</span><span class="o">.</span><span class="n">WAS_Download_Models</span><span class="p">(</span>
    <span class="n">dir_to_save</span><span class="o">=</span><span class="n">dir_to_save_model</span><span class="p">,</span>
    <span class="n">center_variable</span><span class="o">=</span><span class="n">center_variable</span><span class="p">,</span>
    <span class="n">month_of_initialization</span><span class="o">=</span><span class="n">month_of_initialization</span><span class="p">,</span>
    <span class="n">lead_time</span><span class="o">=</span><span class="n">lead_time</span><span class="p">,</span>
    <span class="n">year_start_forecast</span><span class="o">=</span><span class="n">year_start_model</span><span class="p">,</span>
    <span class="n">year_end_forecast</span><span class="o">=</span><span class="n">year_end_model</span><span class="p">,</span>
    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
    <span class="n">year_forecast</span><span class="o">=</span><span class="n">year_forecast</span><span class="p">,</span>
    <span class="n">ensemble_mean</span><span class="o">=</span><span class="n">ensemble_mean</span><span class="p">,</span>
    <span class="n">force_download</span><span class="o">=</span><span class="n">force_download</span>
<span class="p">)</span>

<span class="c1"># Initialize CCA model</span>
<span class="n">was_cca</span> <span class="o">=</span> <span class="n">WAS_CCA</span><span class="p">(</span><span class="n">n_modes</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_pca_modes</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;lognormal&quot;</span><span class="p">)</span>

<span class="c1"># Define zone as dict : {&#39;zone_name_key&#39;: (&#39;Explicit_Zone_name&#39;, lon_min, lon_max, lat_min, lat_max)}</span>
<span class="n">defined_zone</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">)}</span>
<span class="c1"># Plot the zone</span>
<span class="n">plot_map</span><span class="p">([</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sst_indices</span> <span class="o">=</span> <span class="n">defined_zone</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predictors Area&quot;</span><span class="p">,</span><span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Retrieve predictor data for the defined zone</span>
<span class="n">center_variable_model</span> <span class="o">=</span> <span class="s2">&quot;ECMWF_51.PRCP&quot;</span>
<span class="n">predictors</span> <span class="o">=</span> <span class="n">retrieve_single_zone_for_PCR</span><span class="p">(</span><span class="n">dir_to_save_model</span><span class="p">,</span> <span class="n">defined_zone</span><span class="p">,</span> <span class="n">center_variable_model</span><span class="p">,</span> <span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">month_of_initialization</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lead_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">predictors</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">predictor</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_model</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_model</span><span class="p">)))[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
<span class="c1"># Plot the CCA modes and scores</span>
<span class="n">was_cca</span><span class="o">.</span><span class="n">plot_cca_results</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">predictor</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_model</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_model</span><span class="p">))),</span> <span class="n">clim_year_start</span><span class="o">=</span><span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="o">=</span><span class="n">clim_year_end</span><span class="p">)</span>

<span class="c1"># Perform cross-validation for each model</span>
<span class="n">was_cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_model</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_model</span><span class="p">)))</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)),</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">hindcast_det_cca</span><span class="p">,</span> <span class="n">hindcast_prob_cca</span> <span class="o">=</span> <span class="n">was_cv</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span><span class="n">was_cca</span><span class="p">,</span> <span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_model</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">year_end_model</span><span class="p">))),</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">)</span>
<span class="n">forecast_det_cca</span><span class="p">,</span> <span class="n">forecast_prob_cca</span> <span class="o">=</span> <span class="n">was_cca</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">predictand</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year_start_model</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">year_end_model</span><span class="p">))),</span> <span class="n">clim_year_start</span><span class="p">,</span> <span class="n">clim_year_end</span><span class="p">,</span> <span class="n">predictor</span><span class="p">,</span> <span class="n">hindcast_det_cca</span><span class="p">,</span> <span class="n">predictor</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="analog-forecasting-methods">
<h1>Analog Forecasting Methods<a class="headerlink" href="#analog-forecasting-methods" title="Link to this heading"></a></h1>
<p>The <cite>was_analog.py</cite> module provides the <cite>WAS_Analog</cite> class for analog-based forecasting using various techniques to identify historical analogs to current conditions for prediction, particularly for seasonal rainfall forecasts using sea surface temperature (SST) data.</p>
<p><strong>Initialization Parameters</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dir_to_save</span></code> (str): Directory path to save downloaded and processed data files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">year_start</span></code> (int): Starting year for historical data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">year_forecast</span></code> (int): Target forecast year.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reanalysis_name</span></code> (str): Reanalysis dataset name (e.g., “ERA5.SST” or “NOAA.SST”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model_name</span></code> (str): Forecast model name (e.g., “ECMWF_51.SST”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method_analog</span></code> (str, default=”som”): Analog method to use (“som”, “cor_based”, “pca_based”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">best_prcp_models</span></code> (list, optional): List of best precipitation models. Default is None.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">month_of_initialization</span></code> (int, optional): Forecast initialization month. Default is None (uses current month).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lead_time</span></code> (list, optional): Lead times in months. Default is None (uses [1, 2, 3, 4, 5]).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ensemble_mean</span></code> (str, default=”mean”): Ensemble mean method (“mean” or “median”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clim_year_start</span></code> (int, optional): Start year for climatology period.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clim_year_end</span></code> (int, optional): End year for climatology period.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">define_extent</span></code> (tuple, optional): Bounding box as (lon_min, lon_max, lat_min, lat_max) for regional analysis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">index_compute</span></code> (list, optional): Climate indices to compute (e.g., [“NINO34”, “DMI”]).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">some_grid_size</span></code> (tuple, default=(None, None)): SOM grid dimensions (rows, cols); None uses automatic sizing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">some_learning_rate</span></code> (float, default=0.5): Learning rate for SOM training.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">some_neighborhood_function</span></code> (str, default=”gaussian”): Neighborhood function for SOM (“gaussian”, etc.).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">some_sigma</span></code> (float, default=1.0): Initial neighborhood radius for SOM.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dist_method</span></code> (str, default=”gamma”): Probability method (“gamma”, “t”, “normal”, “lognormal”, “nonparam”).</p></li>
</ul>
<p><strong>Key Methods</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">download_sst_reanalysis()</span></code>: Downloads and processes SST reanalysis data from the specified center for the given years and area.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">download_models()</span></code>: Downloads seasonal forecast model data for the specified model, initialization month, and lead times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">standardize_timeseries()</span></code>: Standardizes time series data over a specified climatology period.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">calc_index()</span></code>: Computes specified climate indices (e.g., NINO34, DMI) from SST data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_model()</span></code>: Identifies historical analogs using the specified method and computes deterministic forecasts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compute_prob()</span></code>: Calculates tercile probabilities (Below Normal, Near Normal, Above Normal) using the specified distribution method.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forecast()</span></code>: Generates deterministic and probabilistic forecasts for the target year, returning processed SST data, similar years, deterministic forecast, and probabilistic forecast.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">composite_plot()</span></code>: Creates composite plots of forecast results, optionally including the predictor (SST) visualization.</p></li>
</ul>
<p><strong>Example Usage</strong></p>
<p>Basic analog forecast setup:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_analog</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_Analog</span>

<span class="c1"># Initialize analog model</span>
<span class="n">analog_model</span> <span class="o">=</span> <span class="n">WAS_Analog</span><span class="p">(</span>
    <span class="n">dir_to_save</span><span class="o">=</span><span class="s2">&quot;./s2s_data/analog&quot;</span><span class="p">,</span>
    <span class="n">year_start</span><span class="o">=</span><span class="mi">1990</span><span class="p">,</span>
    <span class="n">year_forecast</span><span class="o">=</span><span class="mi">2025</span><span class="p">,</span>
    <span class="n">reanalysis_name</span><span class="o">=</span><span class="s2">&quot;NOAA.SST&quot;</span><span class="p">,</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;ECMWF_51.SST&quot;</span><span class="p">,</span>
    <span class="n">method_analog</span><span class="o">=</span><span class="s2">&quot;som&quot;</span><span class="p">,</span>
    <span class="n">month_of_initialization</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span>
    <span class="n">define_extent</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
    <span class="n">index_compute</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NINO34&quot;</span><span class="p">,</span> <span class="s2">&quot;DMI&quot;</span><span class="p">],</span>
    <span class="n">dist_method</span><span class="o">=</span><span class="s2">&quot;gamma&quot;</span>
<span class="p">)</span>

<span class="c1"># Download and process data</span>
<span class="n">sst_hist</span><span class="p">,</span> <span class="n">sst_for</span> <span class="o">=</span> <span class="n">analog_model</span><span class="o">.</span><span class="n">download_and_process</span><span class="p">()</span>

<span class="c1"># Generate forecast</span>
<span class="n">ddd</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">analog_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">predictant</span><span class="o">=</span><span class="n">rainfall_data</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_data</span><span class="p">,</span>
    <span class="n">forecast_year</span><span class="o">=</span><span class="mi">2025</span>
<span class="p">)</span>

<span class="c1"># Create composite plot</span>
<span class="n">similar_years</span> <span class="o">=</span> <span class="n">analog_model</span><span class="o">.</span><span class="n">composite_plot</span><span class="p">(</span>
    <span class="n">predictant</span><span class="o">=</span><span class="n">rainfall_data</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_data</span><span class="p">,</span>
    <span class="n">plot_predictor</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p><strong>Cross-Validation Example</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_analog</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_Cross_Validator</span>

<span class="c1"># Perform cross-validation</span>
<span class="n">was_analog_cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rainfall</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)),</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">hindcast_analog_det</span><span class="p">,</span> <span class="n">hindcast_analog_prob</span> <span class="o">=</span> <span class="n">was_analog_cv</span><span class="o">.</span><span class="n">cross_validate</span><span class="p">(</span>
    <span class="n">analog_model</span><span class="p">,</span>
    <span class="n">rainfall</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2020</span>
<span class="p">)</span>

<span class="c1"># Generate forecast using cross-validated hindcast</span>
<span class="n">ddd</span><span class="p">,</span> <span class="n">similar_years</span><span class="p">,</span> <span class="n">forecast_det</span><span class="p">,</span> <span class="n">forecast_prob</span> <span class="o">=</span> <span class="n">analog_model</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span>
    <span class="n">predictant</span><span class="o">=</span><span class="n">rainfall</span><span class="p">,</span>
    <span class="n">clim_year_start</span><span class="o">=</span><span class="mi">1991</span><span class="p">,</span>
    <span class="n">clim_year_end</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span>
    <span class="n">hindcast_det</span><span class="o">=</span><span class="n">hindcast_analog_det</span><span class="p">,</span>
    <span class="n">forecast_year</span><span class="o">=</span><span class="mi">2025</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure <cite>WAS_Cross_Validator</cite> is correctly imported from the <cite>wass2s.was_analog</cite> module and that the <cite>rainfall</cite> variable is an xarray DataArray with appropriate dimensions (T, Y, X).</p>
</div>
</section>
<section id="quantifying-uncertainty-via-cross-validation">
<h1>Quantifying Uncertainty via Cross-Validation<a class="headerlink" href="#quantifying-uncertainty-via-cross-validation" title="Link to this heading"></a></h1>
<p>Cross-validation schemes are used to assess model performance and to quantify uncertainty. <cite>wass2s</cite> uses a cross-validation scheme that splits the data into training, omit, and test periods. The scheme is a variation of the <cite>K-Fold</cite> cross-validation scheme, but it is tailored for time series data throughout <cite>CustomTimeSeriesSplit</cite> and <cite>WAS_Cross_Validator</cite> class. The scheme is illustrated in the figure below (Figure 1).</p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="_images/cvv.png"><img alt="Cross-validation scheme used in wass2s" src="_images/cvv.png" style="width: 693.0px; height: 303.09999999999997px;" />
</a>
<figcaption>
<p><span class="caption-text">Cross-validation scheme used in wass2s</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The figure shows how we split our data (1981-2010) to validate the model. Each row is a “fold” or a test run.</p>
<ul class="simple">
<li><p><strong>Pink (Training)</strong>: Years we use to train the model. For example, in the first row, we train on 1986-2010.</p></li>
<li><p><strong>Yellow (Omit)</strong>: A buffer years we skip to avoid cheating. Climate data has patterns over time, so we don’t want to train on a years right after/before the one we’re predicting, which would make the model look better than it really is. In this case we’ve omitted four years (in the first row, we skip 1982-1985).</p></li>
<li><p><strong>White (Predict)</strong>: The year we predict. In the first row, we predict 1981.</p></li>
</ul>
<p><strong>CustomTimeSeriesSplit</strong></p>
<p>A custom splitter for time series data that accounts for temporal dependencies.</p>
<p><strong>Initialization</strong></p>
<ul class="simple">
<li><p><cite>n_splits</cite>: Number of splits for cross-validation.</p></li>
</ul>
<p><strong>Methods</strong></p>
<ul class="simple">
<li><p><cite>split</cite>: Generates indices for training and test sets, omitting a specified number of samples after the test index.</p></li>
<li><p><cite>get_n_splits</cite>: Returns the number of splits.</p></li>
</ul>
<p><strong>WAS_Cross_Validator</strong></p>
<p>A wrapper class that uses the custom splitter to perform cross-validation with various models.</p>
<p><strong>Initialization</strong></p>
<ul class="simple">
<li><p><cite>n_splits</cite>: Number of splits for cross-validation.</p></li>
<li><p><cite>nb_omit</cite>: Number of samples to omit from training after the test index.</p></li>
</ul>
<p><strong>Methods</strong></p>
<ul class="simple">
<li><p><cite>get_model_params</cite>: Retrieves parameters for the model’s <cite>compute_model</cite> method.</p></li>
<li><p><cite>cross_validate</cite>: Performs cross-validation and computes deterministic hindcast and tercile probabilities.</p></li>
</ul>
<p><strong>Example Usage</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wass2s.was_cross_validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">WAS_Cross_Validator</span>

<span class="c1"># Initialize the cross-validator</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">WAS_Cross_Validator</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nb_omit</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>A better example will be provided in the next sections.</p>
</section>
<section id="estimating-prediction-uncertainty">
<h1>Estimating Prediction Uncertainty<a class="headerlink" href="#estimating-prediction-uncertainty" title="Link to this heading"></a></h1>
<p>The cross-validation makes out-of-sample predictions for each fold’s prediction period, and errors are calculated by comparing predictions to actual values. These errors are collected across all folds.</p>
<p>Running the statistical models—e.g. multiple linear regression—yields the most likely value of the predictand (best-guess) for the coming season.</p>
<p>Because seasonal outlooks are inherently probabilistic, we must go beyond this single best-guess and quantify the likelihood of other possible outcomes.</p>
<p>wass2s does so by analysing the cross-validation errors described earlier. The method explicitly takes the statistical distribution of the predictand into account.</p>
<p>If, for instance, the predictand is approximately Gaussian, we assume the predicted values follow a normal distribution whose mean is the single best-guess and whose variance equals the cross-validated error variance.</p>
<p>Comparing that forecast probability-density function with the climatological density (see the example in Figure 2) lets us integrate the areas that fall below-normal (values below the 1st tercile), near-normal (values between the 1st and 3rd terciles), and above-normal (values above the 3rd tercile).</p>
<p>These integrals are the tercile probabilities ultimately delivered to users.</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="_images/generation_proba.png"><img alt="Generation of probabilistic forecasts" src="_images/generation_proba.png" style="width: 439.59999999999997px; height: 322.7px;" />
</a>
<figcaption>
<p><span class="caption-text">Figure 2: Generation of probabilistic forecasts</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Classification-based statistical models—such as logistic regression,
extended logistic regression and support vector classification—do <strong>not</strong>
generate continuous probabilistic forecasts over a full distribution of outcomes as indicated above.
Instead, they classify the predictand into discrete categories based on
climatological terciles (below-normal, near-normal, above-normal) and
estimate the probability associated with each class.</p>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Preprocessing.html" class="btn btn-neutral float-left" title="Preprocessing Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Verification.html" class="btn btn-neutral float-right" title="Verification Module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Mandela C. M. HOUNGNIBO.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>